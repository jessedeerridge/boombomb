<!DOCTYPE html> 
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>bombjessebusters</title>
<style>
  :root{
    --card-w:24px; --card-h:40px; --card-gap:3px;
    --char-w:40px; --char-h:60px;
    --item-w:50px; --item-h:75px;
    --con-w: var(--item-w); --con-h: var(--item-h); 
    --di-w:70px; --di-h:65px;
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¦‹ãˆã¦ã„ã‚‹æ ã¯å›ºå®šã€‚å†…éƒ¨ã ã‘åºƒã’ã‚‹ */
    --table-h:96px; --header-h:8px;
    --content-h: calc(var(--table-h) - var(--header-h) - 6px);
    --content-extra: 18px;
    --font-card:16px; --font-weight:bold;
  }

  *,*::before,*::after{box-sizing:border-box}
  
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff;color:#111}
  header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eee}
  h1{margin:0;font-size:18px}
  .small{font-size:12px;opacity:.75}
  .bold{font-weight:700}

  main{padding:10px 12px;display:flex;gap:12px; overflow:visible;}
  .col{flex:1;min-width:0; overflow:visible;}
  .side{width:38%;max-width:420px}

  .join-box{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  .join-box input{padding:8px;border:1px solid #ddd;border-radius:6px; font-size:16px;}
  .btn{padding:8px 12px;border:1px solid #ddd;border-radius:8px;background:#f8f8f8;cursor:pointer}
  .btn.primary{background:#111;color:#fff;border-color:#111}
  .btn.small{padding:6px 10px;font-size:12px}
  .btn.big{padding:12px 14px;font-size:16px}
  .btn.ghost{background:transparent}
  .hidden{display:none!important}

  .fab{position:fixed;right:12px;bottom:12px;width:48px;height:48px;border-radius:50%;display:grid;place-items:center;background:#111;color:#fff;cursor:pointer;z-index:900}
  .menu{position:fixed;right:12px;bottom:64px;display:flex;flex-direction:column;gap:6px;background:#fff;border:1px solid #eee;border-radius:10px;padding:8px;box-shadow:0 12px 24px rgba(0,0,0,.08);z-index:210}
  .menu .btn{width:220px;text-align:left}

  /* â˜… ãƒ›ã‚¹ãƒˆå·¦ä¸‹ã®å·¥å…·ãƒœã‚¿ãƒ³ */
  .host-tool{position:fixed;left:12px;bottom:12px;width:48px;height:48px;border-radius:50%;display:grid;place-items:center;background:#111;color:#fff;cursor:pointer;z-index:10}

  .items-bar{display:flex;align-items:center;gap:8px;margin-top:0}
  .items{display:flex;gap:6px;align-items:center;overflow-x:auto}
  .item{
    position:relative; width:var(--item-w);height:var(--item-h);
    border:1px solid #ddd;border-radius:8px;background:#fff;
    background-size:cover;background-position:center;cursor:pointer;flex:0 0 auto
  }
  .item.used{background:#fff url('./itemback.jpg') center/cover no-repeat}
  /* â˜… M12ï¼šã‚¢ã‚¤ãƒ†ãƒ ã®ä¸‹ã«ä»˜ã‘ã‚‹å°å‹æ•°å€¤ãƒãƒƒã‚¸ */
  .num-badge{
    position:absolute; left:50%; transform:translateX(-50%);
   bottom:-14px; min-width:18px; height:18px; padding:0 4px;
    border-radius:9px; border:1px solid #ddd; background:#fff;
    font-size:12px; line-height:18px; text-align:center;
   box-shadow:0 2px 6px rgba(0,0,0,.12); pointer-events:none;
  }


 .di{ margin-left:auto;width:var(--di-w);height:var(--di-h);border-radius:10px;ã€€border:none;ã€€background:#fff;
    background-size:cover;background-position:center;cursor:pointer;flex:0 0 auto ;background-size:contain;}

/* â–¼ æ•°å€¤ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤ºå¸¯ï¼ˆã‚¢ã‚¤ãƒ†ãƒ ä¸‹ãªã©ï¼‰ */
  .numlane { display:flex; gap:6px; margin-top:6px; align-items:center; overflow-x:auto; }
  .numcard { width:32px; height:48px; border-radius:6px; border:1px solid #ddd; background:#fff center/cover no-repeat; flex:0 0 auto; }
  .numdeck { width:32px; height:48px; border-radius:6px; border:1px dashed #bbb; background:#fff url('./numberdeck.png') center/70% no-repeat; cursor:pointer; user-select:none; display:grid; place-items:center; }
  .numrest { font-size:11px; opacity:.7; margin-left:2px; }

  /* â˜… å³2/å·¦2/å³4/å·¦4 ã‚’æ¨ªå‘ãã«ï¼ˆæ¨ªé•·ï¼‰ */
  .rulecard { width:48px; height:32px; border-radius:6px; border:1px solid #ddd; background:#fff center/contain no-repeat; flex:0 0 auto; }

  /* â˜… æ•°å€¤ã‚«ãƒ¼ãƒ‰ã®ã€Œé‡ã­ã€ç”¨ãƒ›ãƒ«ãƒ€ãƒ¼ï¼†ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
  .numcard-holder { position:relative; width:32px; height:48px; flex:0 0 auto; }
  .numcard.overlay { position:absolute; left:2px; top:2px; opacity:1; }
  .numcard.overlay:nth-child(3){ left:4px; top:4px; opacity:0.85; }
  .numcard.overlay:nth-child(4){ left:6px; top:6px; opacity:0.8; }
 .conlane { display:flex; gap:6px; margin-top:6px; align-items:center; overflow-x:auto; }
  .concard {
    /* ã“ã“ã‹ã‚‰å¤‰æ›´ */ width:var(--con-w, var(--item-w, 50px)); height:var(--con-h, var(--item-h, 75px)); /* ã“ã“ã¾ã§å¤‰æ›´ */
    border-radius:8px; border:1px solid #ddd;
    background:#fff center/cover no-repeat; flex:0 0 auto; cursor:pointer;
  }

  #conZoomOverlay{
    position:fixed; inset:0; background:rgba(0,0,0,.4);
    display:flex; align-items:center; justify-content:center;
    z-index:9999;
  }
  .conzoom-wrap{ position:relative; }
 .conzoom-card{
    /* ã“ã“ã‹ã‚‰å¤‰æ›´ */ width:var(--con-w, var(--item-w, 50px)); height:var(--con-h, var(--item-h, 75px)); /* ã“ã“ã¾ã§å¤‰æ›´ */
    transform:scale(2); transform-origin:center;
    border-radius:12px; border:2px solid #fff; background:#fff center/cover no-repeat;
    box-shadow:0 10px 30px rgba(0,0,0,.35); cursor:pointer;
  }
  .conzoom-menu{
    position:absolute; top:50%; left:50%;
    translate:-50% calc(-50% + 120px);
    background:#fff; border:1px solid #ddd; border-radius:10px;
    padding:8px 10px; display:flex; gap:8px; z-index:10000;
    box-shadow:0 6px 20px rgba(0,0,0,.2);
  }
  .conzoom-menu button{
    font-size:14px; padding:6px 10px; border-radius:8px;
    border:1px solid #ccc; background:#f7f7f7; cursor:pointer;
  }
  
  /* â˜… ãƒŸãƒƒã‚·ãƒ§ãƒ³12ï¼šã‚¢ã‚¤ãƒ†ãƒ ã®â€œå¤–å´ã®çœŸä¸‹â€ã«ä¸¦ã¹ã‚‹å¸¯ */
  .num-under{
    display:grid;
    grid-auto-flow:column;
    grid-auto-columns:var(--item-w); /* ã‚¢ã‚¤ãƒ†ãƒ å¹…ã«åˆã‚ã›ã¦1åˆ—=1ã‚¢ã‚¤ãƒ†ãƒ  */
    gap:6px;               /* .items ã® gap ã¨åˆã‚ã›ã‚‹ */
    margin-top:4px;        /* ã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ã™ãä¸‹ã«è¡¨ç¤º */
    align-items:start;
    justify-content:start;
    width:max-content;     /* ã¯ã¿å‡ºã—å¯¾ç­–ï¼šå†…å®¹å¹…ã«åˆã‚ã›ã‚‹ */
  }
  .num-under .slot{
    width:var(--item-w);
    display:grid;
    place-items:center;    /* ä¸­å¤®é…ç½® */
  }
  .num-under .numcard-holder{
    position:relative;
    width:32px; height:48px;
  }
  
  .tables{display:flex;flex-direction:column;gap:8px;margin-top:6px;overflow:visible;position:relative;margin-left:-12px;}
  .table{
    position:relative;border:1px dashed #ddd;border-radius:10px;
    padding:0 8px;height:var(--table-h);display:block;background:#fff;
    overflow:hidden;width:max-content;z-index:0;
 transition: none; 
  }
  .table.anim-h{
  transition: height .25s ease;  /* â† å¿…è¦æ™‚ã ã‘ä»˜ã‘ã‚‹ */
}
  .table.elevated{ z-index:200; }

  .t-header{height:var(--header-h);display:flex;align-items:center;gap:6px;font-size:12px;margin-top:0;}
  .title{text-decoration:underline;padding-right:4px}

  .t-content{
    position:absolute;left:8px;right:8px;top:calc(var(--header-h) + 2px);bottom:calc(4px - var(--content-extra));
    display:flex;gap:8px;align-items:flex-start;min-height:var(--content-h);overflow:visible;
  }

  .char-card{
    width:var(--char-w);height:var(--char-h);background-size:cover;background-position:center;border-radius:6px;border:1px solid #ddd;
    cursor:pointer;user-select:none;flex:0 0 auto;
  }
  /* â–¼ M61: åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ã®ä¸‹ã«ç½®ãæ¥µå°ã‚­ãƒ£ãƒ© */
  .m61-mini{
    width:24px; height:30px;            /* ã¨ã¦ã‚‚å°ã•ã */
    border:1px solid #ddd; border-radius:4px;
    background:#f3f4f6 center/cover no-repeat;
    margin:2px auto 0; user-select:none; cursor:pointer;
  }
  .m61-mini.blank{ background:#f3f4f6; border:1px dashed #d1d5db; cursor:default; }
  /* ç¸¦ç©ã¿ãƒ©ãƒƒãƒ‘ãƒ¼ */
  .m61-stack{ display:flex; flex-direction:column; align-items:center; width:var(--char-w); }

  /* â˜… #13ï¼šã‚­ãƒ£ãƒ©ã¨ä¸‹éƒ¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¸¦ç©ã¿ã™ã‚‹ãŸã‚ã®ãƒ©ãƒƒãƒ‘ãƒ¼ */
  .char-col{
    display:flex; flex-direction:column; align-items:center; gap:2px;
    width:var(--char-w); flex:0 0 auto;
  }
  
  .char-card.blank{background:#f3f4f6;border:1px dashed #d1d5db;cursor:default;}

  .hand{
    display:flex;align-items:flex-start;gap:var(--card-gap);
    overflow-y:visible; overflow-x:visible;
    flex:0 0 auto;position:relative;
    max-height:calc(var(--content-h) - 2px + var(--content-extra));
    padding-bottom:2px;
  }

  .card-wrap{position:relative;width:var(--card-w);min-height:calc(var(--card-h) + 36px);flex:0 0 auto;}
  .card{
    width:var(--card-w);height:var(--card-h);border-radius:6px;border:1px solid #ddd;position:absolute;left:0;top:0;
    background:#bbb;display:flex;align-items:flex-start;justify-content:center;cursor:pointer;user-select:none
  }
  .card.back{background:#fff url('./codeback.jpg') center/cover no-repeat;border-color:#ccc}
    .card.back .num{display:none;}   /* â† è£çŠ¶æ…‹ã§ã¯æ•°å­—ã‚’éš ã™ */
  .card.open{background:#000}
  /* â˜… ã‚¢ã‚¤ãƒ†ãƒ 2ï¼šé¸æŠå¯èƒ½ã‚«ãƒ¼ãƒ‰ã®é’æ  */
  .card.i2-selectable{outline:2px dashed #38bdf8; outline-offset:-1px;}

  .num{position:absolute;top:2px;left:0;right:0;text-align:center;font-size:var(--font-card);font-weight:var(--font-weight);color:#fff;line-height:1;text-shadow:0 1px 0 rgba(0,0,0,.15)}
  .img-bottom{position:absolute;left:1px;right:1px;bottom:1px;height:18px;border-radius:0 0 6px 6px;background-size:cover;background-position:center}

  .badge-fixed{position:absolute;left:0;right:0;top:calc(var(--card-h) + 2px);display:flex;flex-direction:column;align-items:center;z-index:10000;pointer-events:auto;}
  .alpha{width:var(--card-w);text-align:center;font-size:11px;user-select:none;line-height:1;background:#6b21a8;color:#fff;border:1px solid #4c1d95;border-radius:6px;padding:2px 0;cursor:pointer}
  .tok-col{display:flex;flex-direction:column;gap:2px;margin-top:2px}
.token{
    font-size:11px; line-height:1;
    border-radius:4px;
    /* æ­£æ–¹å½¢ãƒ»ä¸­å¤®æƒãˆ */
    display:inline-grid; place-items:center;
    width:20px; height:20px;   /* â† çµ±ä¸€ã‚µã‚¤ã‚ºï¼ˆ2æ¡OKï¼‰ */
    padding:0;                 /* ä¸­å¤®ã´ã£ãŸã‚Šã« */
  }  /* â–¼â–¼ å¤‰æ›´1ï¼šï¼ ã¨ â‰  ã®è‰²ã‚’å…¥ã‚Œæ›¿ãˆ â–¼â–¼ */
  .token.equal{background:#cfe8ff;color:#000}
  body[data-seated="no"] .token { display: none !important; }

  .token.black{background:#000;color:#fff}
  .token.x1{background:#e5e7eb;color:#000}
  .token.noteq{background:#ffedd5;color:#000}

/* â–¼ ãƒŸãƒƒã‚·ãƒ§ãƒ³å°‚ç”¨ãƒˆãƒ¼ã‚¯ãƒ³ */
  .token.yellow { background:#000; color:#ffd400; }  /* é»„ã‚³ãƒ¼ãƒ‰ã€Œâ–§ã€ */
  .token.x2 { background:#e5e7eb; color:#000; }      /* x2 */
  .token.x3 { background:#e5e7eb; color:#000; }      /* x3 */
  .token.even { background:#cfe8ff; color:#000; }    /* å¶æ•° 2/4 */
  .token.odd  { background:#e75480; color:#000; }    /* å¥‡æ•° 1/3 */
.token.yellowX { background:#ffd400; color:#000; }

.marker,.blink{
  position:absolute;left:0;right:0;top:-12px;
  text-align:center;font-size:14px;line-height:1;
  z-index:12000; pointer-events:none;
}
.blink{ animation: blink 0.6s linear infinite; }
@keyframes blink{ 0%,100%{opacity:0} 50%{opacity:1} }

/* â˜… #22ï¼šåå‰ã®ä¸‹ã«ç½®ãã€Œé¸æŠãƒœã‚¿ãƒ³ Ã—3ã€ */
.pick3{ display:flex; gap:4px; margin-left:8px; }
.pickbtn{
  width:22px; height:22px; border:1px dashed #999; border-radius:4px;
  background:#fff; display:grid; place-items:center; font-size:12px; line-height:1;
  color:#000; user-select:none; cursor:pointer;
}
.pickbtn.readonly{ opacity:.6; cursor:default; }

/* â–¼â–¼ ã“ã“ã‹ã‚‰ è¿½åŠ  â–¼â–¼ */
.m22-panel{
  display:flex; gap:6px; align-items:center; flex-wrap:wrap;
  margin-top:6px;
}
.m22-panel .cap{ font-size:12px; opacity:.75; margin-right:6px; }
.m22-panel .token{ cursor:pointer; }
.m22-panel .token.disabled{ opacity:.35; cursor:default; }

.m22-under{
  display:flex; gap:2px; margin-top:2px;
}
.m22-under .token{ width:20px; height:20px; }

/* â˜… #50ï¼šã‚­ãƒ£ãƒ©ä¸‹ã®æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆ4åˆ—ã§æŠ˜è¿”ã—ï¼‰ */
.m50-under{
  display:grid;
 grid-template-columns:repeat(3, 20px);
  gap:2px;
  margin-top:2px;
}
.m50-under .token{ width:20px; height:20px; }
  
  /* ãƒŸãƒƒã‚·ãƒ§ãƒ³27ï¼šã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ç›´ä¸‹ã«ä¸¦ã¹ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³è¡Œ */
  .m27-row{
    display:flex; gap:6px; margin-top:4px; align-items:center;
  }
  .m27-row .cap{ font-size:12px; opacity:.75; margin-right:6px; }
  .m27-row .token{ cursor:pointer; }


/* â˜… #22ï¼šæƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³è¡¨ï¼ˆ3Ã—4ï¼‰â€” é»’ãƒˆãƒ¼ã‚¯ãƒ³ + å³ã« x0/x1/x2 */
.info22{
  position:fixed; left:50%; bottom:12px; transform:translateX(-50%);
  background:#fff; border:1px solid #eee; border-radius:10px; box-shadow:0 10px 24px rgba(0,0,0,.12);
  padding:8px; z-index:100;
  display:grid; grid-template-columns:repeat(4, auto); gap:8px; /* â† 3è¡ŒÃ—4åˆ—ã«ãªã‚‹ */
}
.info22 .cell{
  display:flex; align-items:center; gap:6px;
  border:1px dashed #bbb; border-radius:6px; padding:6px 8px; background:#fff; font-size:12px;}
.info22 .cell .token{ width:22px; height:22px; } /* æ—¢å­˜ã® .token ã‚’æµç”¨ï¼ˆé»’ï¼‰ */
.info22 .xlabel{ font-family:ui-monospace, SFMono-Regular, Menlo, monospace; opacity:.8; }
/* x0 ã‚»ãƒ«ã‚’è–„ãã—ã¦ã‚¯ãƒªãƒƒã‚¯ä¸å¯ã«ã™ã‚‹ */
.info22 .cell.disabled { opacity: 0.5; pointer-events: none;ã€€}

/* â˜… ãƒã‚§ãƒƒã‚¯è¡¨ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«1ã®çœŸä¸Šï¼‰ */
.checklist{
  display:flex; gap:6px; margin:0 0 0 10px; align-items:center;
}
.check-item{
  position:relative; width:30px; height:30px;
  border:1px dashed #999; border-radius:4px;
  background:#fff; display:grid; place-items:center;
  font-size:12px; user-select:none; color:#000;
}
.check-mark{
  position:absolute; inset:0; margin:auto;
  width:18px; height:18px; border-radius:50%;
  background:rgba(34,197,94,.35);
  pointer-events:none;
}
  
  .pop-layer{ position:fixed;inset:0;z-index:2147483647;pointer-events:none; }
.mini-pop{
  position:fixed;
  z-index:100;
  background:#fff;
  border:1px solid #eee;
  border-radius:8px;
  padding:6px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
  display:flex;
  gap:6px;
  pointer-events:auto;
  flex-wrap:wrap;
  max-width:min(300vw,320px);
  transform: translateX(-24px); /* â† å·¦ã«å°‘ã—å¯„ã›ã‚‹ */
}
  .bottom-pop{left:50%;transform:translateX(-50%);bottom:10px;}

  /* â˜… ç”»é¢ä¸‹éƒ¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«é»’æ ãƒãƒƒã‚¸ï¼ˆã‚¢ã‚¤ãƒ†ãƒ 16è¡¨ç¤ºï¼‰ */
  .global-reveal{position:fixed;left:50%;bottom:10px;transform:translateX(-50%);z-index:2147483647;}
  .global-reveal .token{cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,.12);}

  /* è¿½åŠ ï¼šã‚¢ã‚¤ãƒ†ãƒ 16ã®ã‚µã‚¤ãƒ‰è¡¨ç¤º */
  .i16-side{
    position:absolute; left:calc(100% + 6px); top:50%; transform:translateY(-50%);
    z-index:2147483000;
  }

/* è¿½åŠ ï¼šã‚¢ã‚¤ãƒ†ãƒ 16ã®é»’ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚«ãƒ¼ãƒ‰ã®çœŸä¸‹ã«è¡¨ç¤º */
.i16-below{
  position:absolute;
  left:50%;
  top:calc(100% + 4px);
  transform:translateX(-50%);
  z-index:2147483000;
}

/* è¿½åŠ ï¼šã‚¢ã‚¤ãƒ†ãƒ 16ä½¿ç”¨æ™‚ã¯ã‚«ãƒ¼ãƒ‰æœ¬ä½“ã‚’ä¸Šã«æŒã¡ä¸Šã’ã‚‹ */
.i16-lift{
  transform: translateY(-35px);
}
    
  .panel{display:flex;flex-direction:column;gap:10px}
  .list{border:1px solid #eee;border-radius:10px;padding:8px}
  .list h3{margin:0 0 6px 0;font-size:13px}
  .name{padding:4px 6px;border-radius:6px}
  .muted{opacity:.6}
  .mission{border:1px solid #eee;border-radius:10px;padding:10px}
  .mission h3{margin:0 0 8px 0;font-size:14px}

  .mission-footer{margin-top:12px;border-top:1px solid #eee;padding-top:8px}
  .mission-footer .line{font-size:13px;line-height:1.5}
  .mission-footer .line + .line{margin-top:4px}

  .restart-pop,.start-pop{
    position:fixed;left:50%;top:50%;transform:translate(-50%, -50%);
    background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.12);
    padding:14px;z-index:220;display:flex;flex-direction:column;gap:10px;min-width:280px
  }
  .seat-pop{
    position:fixed;left:50%;bottom:10px;transform:translateX(-50%);
background:#a1adbf;
border:1px solid #eee;border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.12);
    padding:10px;z-index:220;display:flex;flex-direction:column;gap:10px;min-width:280px
  }
  .start-pop .row,.seat-pop .row{display:flex;gap:8px;align-items:center}
  .start-pop label,.seat-pop label{width:84px;font-size:13px}
  .start-pop select{flex:1;padding:8px;border:1px solid #ddd;border-radius:8px;background:#fff}
  .restart-actions{display:flex;gap:8px;align-items:center}
  .restart-actions .btn:first-child{font-size:11px;padding:4px 8px}
  .restart-actions .btn.big{flex:1}

  .tabs{display:flex;gap:6px;flex-wrap:wrap}
  .tab{padding:6px 10px;border:1px solid #ddd;border-radius:999px;cursor:pointer;user-select:none}
  .tab.active{background:#111;color:#fff;border-color:#111}
  .tab.disabled{opacity:.35;pointer-events:none}

 @media (max-width: 860px){
    main{flex-direction:column}
    .side{width:100%;max-width:none}
  }

/* â–¼â–¼ ç”»é¢ä¸‹éƒ¨ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ”ãƒƒã‚«ãƒ¼ â–¼â–¼ */
.mp{
  position:fixed; left:0; right:0; bottom:0;
  background:#fff; border-top:1px solid #eee;
  box-shadow:0 -10px 24px rgba(0,0,0,.08);
  z-index:2147483600;
  /* â† iPhoneã®ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ã«åˆã‚ã›ã¦ä½™ç™½ã‚’å–ã‚‹ï¼ˆå·¦å³/ä¸‹ï¼‰ */
  padding-top:8px;
  padding-right: max(10px, env(safe-area-inset-right));
  padding-bottom: calc(8px + env(safe-area-inset-bottom));
  padding-left:  max(10px, env(safe-area-inset-left));
}
.mp-inner{
  max-width:100%;
  width:100%;
  margin:0 auto;
}
.mp-row{ display:flex; gap:10px; align-items:flex-start; margin:8px 0; }
.mp-label{ width:64px; font-size:12px; opacity:.75; line-height:2; }

/* â˜… æ¨ª6åˆ—å›ºå®šãƒ»å³ç«¯ãŒåˆ‡ã‚Œãªã„ã‚ˆã† minmax(0,1fr) ã‚’ä½¿ç”¨ */
.mp-grid{
  display:grid;
  grid-template-columns: repeat(6, minmax(0, 1fr)); /* 6åˆ—å›ºå®š */
  gap:6px;
  max-height:50vh;
  overflow-y:auto;
  overflow-x:hidden;
}

/* â˜… æ­£æ–¹å½¢ãƒœã‚¿ãƒ³ï¼ˆä¸­èº«ãŒã¯ã¿å‡ºã•ãªã„ã‚ˆã† min-width:0 ã‚‚ä»˜ä¸ï¼‰ */
.mp-grid .btn{
  width:100%;
  min-width:0;            /* â† ã“ã‚ŒãŒç„¡ã„ã¨å³ç«¯ãŒæŠ¼ã—å‡ºã•ã‚ŒãŒã¡ */
  text-align:center;
  padding:10px 0;
  aspect-ratio:1 / 1;
  font-size:16px;
}

/* å°ã•ã„ç«¯æœ«ã§å°‘ã—ã ã‘è©°ã‚ã‚‹ï¼ˆä»»æ„ï¼‰ */
@media (max-width: 360px){
  .mp-grid{ gap:4px; }
  .mp-grid .btn{ font-size:14px; padding:8px 0; }
}

.mp-actions{ display:flex; justify-content:flex-end; margin-top:6px; }
/* â–²â–² ç”»é¢ä¸‹éƒ¨ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ”ãƒƒã‚«ãƒ¼ â–²â–² */

.code-link{ text-decoration: underline; cursor: pointer; }

  /* â–¼â–¼ nano è¡Œï¼ˆitemsBar ã®ã™ãä¸‹ï¼‰ â–¼â–¼ */
.nano-row{
  position:relative;
  height:56px;           /* nano ã®é«˜ã•ã¶ã‚“ */
    margin:4px 0 0 0;   /* items ã¨ checklist ã®â€œé–“â€ã«ç½®ã */
  z-index:2147483601;    /* ã»ã¼æœ€å‰é¢ã€‚ãŸã ã— pop ã‚ˆã‚Šã¯ä¸‹ã§OK */
}
.m43-nano{
  position:absolute;     /* è¡Œã®ä¸­ã§å·¦å³ã ã‘åˆã‚ã›ã‚‹ */
  width:56px; height:56px;
  background-size:contain; background-repeat:no-repeat; background-position:center;
  pointer-events:auto;   /* ã‚¯ãƒªãƒƒã‚¯ã§å›åãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
}


  
 /* â–¼â–¼ ãƒŸãƒƒã‚·ãƒ§ãƒ³44ï¼ˆé…¸ç´ ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰ â–¼â–¼ */
.token.ox{
  background:none;   /* â† èƒŒæ™¯è‰²ã‚’æ¶ˆã™ */
  color:transparent; /* â† ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚‚æ¶ˆã™ */
  background-image:url('./ox.png');
  background-size:contain;
  background-repeat:no-repeat;
}
 .ox-row{
   display:flex; flex-wrap:nowrap; gap:2px; margin-top:0; /* â† æ¨ªä¸€åˆ—ï¼†ç¸¦ä½ç½®ã¯JSã§åˆ¶å¾¡ */
   max-width:none;                 /* â† æŠ˜ã‚Šè¿”ã—ç¦æ­¢ */
   width:max-content;              /* â† ä¸­èº«å¹…ã«åˆã‚ã›ã‚‹ */
   flex:0 0 auto;
   align-self:flex-start;
 }
.ox-row.ox-pool{ align-items:center; gap:6px; max-width:none; }
.ox-side{
 width:var(--item-w); height:var(--item-h);
  border-radius:8px; border:1px solid #ddd;
  background:#fff url('./ox2.jpg') center/cover no-repeat;
  flex:0 0 auto;
}
.ox-wrap{
  display:flex; flex-wrap:wrap; gap:2px;
  /* 1è¡Œã‚ãŸã‚Š15å€‹ï¼ˆå¹…20pxÃ—15 + ã‚®ãƒ£ãƒƒãƒ—2pxÃ—14ï¼‰ */
  max-width:calc(20px * 15 + 2px * 14);
}
/* â–¼â–¼ ãƒŸãƒƒã‚·ãƒ§ãƒ³66ï¼šã‚¹ãƒ†ãƒ¼ã‚¸ï¼‹åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ï¼ˆåå­—ï¼‰ â–¼â–¼ */
.m66-layer{
  position:relative;
  display:grid;
  gap:6px;
  place-items:center;
  margin-top:6px;
  z-index:1; /* tables(0) ã‚ˆã‚Šä¸Šï¼šchecklistã‚ˆã‚Šä¸Šã«æ¥ã‚‹ */
}
.m66-line{ display:flex; align-items:center; justify-content:center; gap:6px; }

.m66-slot{
  width:var(--con-w); height:var(--con-h);
  border-radius:8px; border:1px dashed #bbb;
  display:grid; place-items:center;
}
.m66-slot .concard{
  width:var(--con-w); height:var(--con-h);
  border-radius:8px; border:1px solid #ddd;
  background:#fff center/cover no-repeat; cursor:pointer;
}

/* ã‚¹ãƒ†ãƒ¼ã‚¸æœ¬ä½“ï¼šã‚«ãƒ¼ãƒ‰2å€ï¼†æ¨ªå‘ãè¡¨ç¤ºï¼ˆrotateï¼‰ */
.m66-stagebox{ position:relative; }
.m66-stage{
  width: calc(var(--con-w) * 3.5);
  height: calc(var(--con-h) * 1.6);
  border-radius:12px; border:1px solid #ddd;
  background:#fff center/cover no-repeat;
  user-select:none;
}

/* å³ä¸Šãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆï¼ˆéšåˆ‡æ›¿ï¼‰ */
.m66-hot{
  position:absolute; right:2px; top:2px;
  width:12px; height:12px; cursor:pointer; z-index:2;
}

/* ãƒ©ãƒ“ãƒƒãƒˆï¼ˆ1åŒ¹ã®ã¿ã€ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã«å‡ºã™ï¼‰ */
.m66-rabit{
  position:absolute; left:50%; top:50%;
  width:30px; height:45px;
  background:url('./rabit.png') center/contain no-repeat;
  pointer-events:none;
  transform: translate(-50%, -50%) /* è¦‹ãŸç›®ã®æ¨ªå‘ãã«åˆã‚ã›å¾®èª¿æ•´ */
}
/* â–²â–² ãƒŸãƒƒã‚·ãƒ§ãƒ³66 â–²â–² */

.card.captain-card {
  border: 4px solid #000;   /* å¤ªã„é»’æ  */
  border-radius: 6px;       /* æ—¢å­˜ã®è§’ä¸¸ã‚’ç¶­æŒ */
}

/* è¿½åŠ ï¼ˆæ­£ä½“ã‚«ãƒ¼ãƒ‰ç”¨ï¼‰ */
.char-card.captain-card {
  border: 2px solid #000;
  border-radius: 6px;
}


.code-label{ margin-right:6px; }
.copy-btn.copied{
  background:#16a34a;  /* æˆåŠŸã£ã½ã„ç·‘ */
  color:#fff;
  border-color:#16a34a;
}



/* æ—¢å­˜ main ã«è¿½è¨˜ï¼ˆposition ã‚’ä»˜ä¸ï¼‰ */
main{
  padding:10px 12px;
  display:flex;
  gap:12px;
  overflow:visible;
  position: relative;
  isolation: isolate; /* ç–‘ä¼¼è¦ç´ ã®å±¤ã‚’ç‹¬ç«‹ */
}

/* å…¥å®¤ç”»é¢ã ã‘ï¼šç”»åƒã‚’åŠé€æ˜ã«æ•·ã */
main:has(#lobby.hidden)::before{
  content:"";
  position:absolute; inset:0;
  background: url('./bbback.jpg') center/cover no-repeat;
  opacity: .4;           /* â†é€æ˜åº¦ã€‚0=å®Œå…¨é€æ˜, 1=ä¸é€æ˜ */
  z-index: 0;
  pointer-events: none;  /* ã‚¯ãƒªãƒƒã‚¯ã‚’é‚ªé­”ã—ãªã„ */
}

/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯å¸¸ã«å‰é¢ï¼†ä¸é€æ˜ */
main:has(#lobby.hidden) > *{
  position: relative;
  z-index: 1;
}

/* ç”»é¢ã„ã£ã±ã„ã«è¦‹ã›ãŸã„å ´åˆã ã‘ */
main:has(#lobby.hidden){
  min-height: calc(100vh - 56px);
}

.tab{
  padding:6px 10px;
  border:1px solid #ddd;
  border-radius:999px;
  cursor:pointer;
  user-select:none;
  position: relative; /* â† è¿½åŠ ï¼šæ“¬ä¼¼è¦ç´ ã®åŸºæº–ã«ã™ã‚‹ */
}

/* å¸­ã‚¿ãƒ–ï¼šä½¿ç”¨ä¸­ã¯æ•°å­—ã®ä¸Šã«âœ•ã‚’é‡ã­ã¦è¡¨ç¤º */
.tab.disabled::after{
  content: 'âœ•';
  position: absolute;
  inset: 0;
  display: grid;
  place-items: center;
  font-size: 18px;     /* âœ•ã®å¤§ãã•ã¯å¿…è¦ã«å¿œã˜ã¦èª¿æ•´ */
  font-weight: 700;
  color: #b91c1c;      /* è½ã¡ç€ã„ãŸèµ¤ã€‚å¥½ã¿ã§å¤‰æ›´å¯ */
  pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã‚’å¦¨ã’ãªã„ */
}

/* PCå¹…ã§ã¯ .di ã‚’ã‚«ãƒ¼ãƒ‰ç¾¤ã®ã™ãå³ã«å¯„ã›ã‚‹ */
@media (min-width: 861px){
  .di{ margin-left: 8px; }  /* â† auto ã‚’ä¸Šæ›¸ã */
}

/* ã‚¹ãƒãƒ›å¹…ã§ã¯å¾“æ¥ã©ãŠã‚Šå³ç«¯ã«å¯„ã›ã‚‹ */
@media (max-width: 860px){
  .di{ margin-left: auto; }
}


/* â˜… ãƒŸãƒƒã‚·ãƒ§ãƒ³å®Œäº†ãƒãƒƒãƒ— */
.mission-complete-pop{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-150%, -50%) scale(var(--mc-scale,1)); /* ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ•°å¯¾å¿œ */
  background: rgba(20,20,20,.92);
  color: #fff;
  border-radius: 16px;
  padding: 18px 28px;
  font-size: 24px;
  font-weight: 800;
  letter-spacing: .02em;
  white-space: nowrap;            /* â˜… æ”¹è¡Œã•ã›ãªã„ */
  box-shadow: 0 18px 40px rgba(0,0,0,.35);
  z-index: 2147483647;
  pointer-events: auto;
  will-change: transform;
  animation: missionSlideIn .55s cubic-bezier(.22,.84,.44,1) forwards;
}
@keyframes missionSlideIn{
  to{ transform: translate(-50%, -50%); } /* ç”»é¢ä¸­å¤®ã¸ */
}




/* â–¼ å…¥å®¤å¾Œãƒ¡ã‚¤ãƒ³ç”»é¢ï¼šboomback.jpg ã‚’è–„ãèƒŒæ™¯ã« */
main:not(:has(#lobby.hidden))::before {
  content: "";
  position: absolute;
  inset: 0;
  background: url('./boomback.jpg') center/cover no-repeat;
  opacity: 0.1;            /* é€æ˜åº¦ï¼š0=å®Œå…¨é€æ˜, 1=ä¸é€æ˜ã€‚ãŠå¥½ã¿ã§èª¿æ•´ */
  z-index: 0;
  pointer-events: none;    /* ã‚¯ãƒªãƒƒã‚¯æ“ä½œã‚’é‚ªé­”ã—ãªã„ */
}
main:not(:has(#lobby.hidden)) > * {
  position: relative;
  z-index: 1;
}

/* â–¼ ãƒŸãƒƒã‚·ãƒ§ãƒ³èª¬æ˜ (#missionFooter) ã¯å¸¸ã«ç™½ã„ä¸‹åœ°ã§ç”»åƒã‚’é®æ–­ */
#missionFooter{
  position: relative;
  z-index: 10;      /* èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼(::before)ã‚ˆã‚Šå‰é¢ */
  background: #fff;/* â† ã“ã“ã‚’ none â†’ #fff ã«ã™ã‚‹ï¼ˆå®Œå…¨ã«ä¸é€æ˜ï¼‰ */
  /* å¿…è¦ãªã‚‰èª­ã¿ã‚„ã™ã•å‘ä¸Šç”¨ã«ï¼š
  box-shadow: 0 -4px 12px rgba(0,0,0,.06) inset;
  */
}

.card-wrap.m42-hide-origin,
.card-wrap.m42-hide-origin .card,
.card-wrap.m42-hide-origin .num,
.card-wrap.m42-hide-origin .img-bottom {
  visibility: hidden !important;
}



/* â˜… M42: -2 ç”¨ é»’ãƒãƒƒãƒ— */
.m42minus2-pop{
  position: fixed;
  left: 50%; top: 50%;
  transform: translate(-50%, -50%);
  background: #000;
  color: #fff;
  border-radius: 12px;
  padding: 16px 20px;
  z-index: 2147483647;
  min-width: 280px;
  text-align: left;
  pointer-events: auto;             /* â† ã‚¯ãƒªãƒƒã‚¯å¯ */
}
.m42minus2-pop .line12{ font-size: 12pt; line-height: 1.6; }
.m42minus2-pop .line8 { font-size: 8pt;  line-height: 1.6; opacity:.9; }


/* â˜… M42: â‡… ç”¨ é»’ãƒãƒƒãƒ—ï¼ˆ-2 ã¨åŒæ§˜ã®è¦‹ãŸç›®ï¼‰ */
.m42swap-pop{
  position: fixed;
  left: 50%; top: 50%;
  transform: translate(-50%, -50%);
  background: #000;
  color: #fff;
  border-radius: 12px;
  padding: 16px 20px;
  z-index: 2147483647;
  min-width: 280px;
  text-align: left;
  pointer-events: auto;             /* â† ã‚¯ãƒªãƒƒã‚¯å¯ */
}
.m42swap-pop .line12{ font-size: 12pt; line-height: 1.6; }
.m42swap-pop .line8 { font-size: 8pt;  line-height: 1.6; opacity:.9; }


.range-label {
  font-size: 12px;
  font-weight: 600;
  color: #333;
}



















</style>
</head>
<body>
<header>
  <h1>BOMBã€€BUSTERS</h1>
  <div class="small" id="roomInfo"></div>
</header>

<main>
  <div class="col">
<div class="join-box" id="joinBox">
  <!-- â˜…è¿½åŠ ï¼šåå‰ï¼ˆ4æ–‡å­—ä»¥å†…ï¼‰â€»æœªå…¥åŠ›ã§ã‚‚å…¥å®¤å¯ -->
  <input id="userName" placeholder="åå‰ï¼ˆ4æ–‡å­—ä»¥å†…ï¼‰" maxlength="4" />
  <input id="roomCode" placeholder="ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰" maxlength="12" />
  <button class="btn primary" id="btnJoin">å…¥å®¤</button>
  <button class="btn ghost" id="btnRandom">è‡ªå‹•ã‚³ãƒ¼ãƒ‰</button>
</div>


    <div id="lobby" class="hidden">

      <div class="items-bar hidden" id="itemsBar">
        <div class="items" id="items"></div>
        <div class="di" id="di"></div>
      </div>

      <div class="tables" id="tables"></div>

<div id="missionFooter" class="mission-footer hidden">
  <div id="m22PickPanel" class="m22-panel hidden">
    <span class="cap">æœªæ‰€æŒã®æ•°å­—ã‹ã‚‰æœ€å¤§2ã¤é¸æŠï¼š</span>
  </div>

  <div id="missionDetailTitle" class="bold line"></div>
  <div id="missionDetailBody"></div>
</div>

<div id=""> <!-- è¦ªã‚’æ–°è¨­ã—ã¦ stacking context ã‚’åˆ†ã‘ã‚‹ -->
      <button class="fab hidden" id="gear" title="è¨­å®š">âš™</button>
      <div class="menu hidden" id="menuPopup">
        <button class="btn" id="btnSit">å¸­ã«åº§ã‚‹</button>
        <button class="btn" id="btnLeaveSeat">å¸­ã‚’ç«‹ã¤</button>
        <button class="btn" id="btnPickMission">ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’é¸ã¶</button>
      </div>
    </div>
  </div>

  <div class="col side">
    <div class="panel">
    </div>
  </div>
</main>

<!-- â–¼â–¼ ç”»é¢ä¸‹éƒ¨ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ”ãƒƒã‚«ãƒ¼ â–¼â–¼ -->
<div id="missionPicker" class="mp hidden">
  <div class="mp-inner">
    <div class="mp-row">
      <div class="mp-label">äººæ•°</div>
      <div id="mpCounts" class="tabs"></div>
    </div>
    <div class="mp-row">
      <div class="mp-label">ãƒŸãƒƒã‚·ãƒ§ãƒ³</div>
      <div id="mpMissions" class="mp-grid"></div>
    </div>
    <div class="mp-actions">
      <button class="btn small ghost" id="btnMpBack">æˆ»ã‚‹</button>
    </div>
  </div>
</div>
<!-- â–²â–² ç”»é¢ä¸‹éƒ¨ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ”ãƒƒã‚«ãƒ¼ â–²â–² -->

<div id="miniPop" class="mini-pop hidden"></div>
<div id="popLayer" class="pop-layer"></div>
<!-- â˜… ã‚¢ã‚¤ãƒ†ãƒ 16ã®è¡¨ç¤ºå…ˆï¼ˆç”»é¢ä¸‹éƒ¨ï¼‰ -->
<div id="globalReveal" class="global-reveal hidden"></div>
<!-- â˜… ãƒ›ã‚¹ãƒˆå·¦ä¸‹ å·¥å…·ã‚¢ã‚¤ã‚³ãƒ³ -->
<button id="hostTool" class="host-tool hidden" title="å·¥å…·">ğŸ”§</button>

<div id="restartPop" class="restart-pop hidden">
  <div style="font-size:14px">ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ</div>
  <div class="restart-actions">
    <button class="btn" id="btnRestartOk">ã‚„ã‚Šç›´ã™</button>
    <button class="btn big" id="btnRestartCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<div id="startPop" class="start-pop hidden">
  <div class="row"><label>äººæ•°</label>
    <select id="selCount"><option>2</option><option>3</option><option selected>4</option><option>5</option><option>6</option></select>
  </div>
  <div class="row"><label>ãƒŸãƒƒã‚·ãƒ§ãƒ³</label>
<select id="selMission">
  <option value="1">#1 çˆ†å¼¾ï¼ˆèµ¤ã‚³ãƒ¼ãƒ‰ï¼‰</option><option value="2">#2 é»„ã‚³ãƒ¼ãƒ‰</option><option value="3">#3 ã•ã‚‰ã„çˆ†å¼¾</option>
  <option value="4">#4</option><option value="5">#5</option><option value="6">#6</option><option value="7">#7</option>
  <option value="8">#8</option>
  <option value="9">#9 aaa</option>
  <option value="10">#10 bbb</option>
  <option value="11">#11 ccc</option>
  <option value="12">#12</option>
  <option value="42">#42</option><option value="43">#43</option>
  <option value="49">#49</option>
</select>
  </div>
  <div class="row" style="justify-content:flex-end">
    <button class="btn small" id="btnStartOk">OK</button>
    <button class="btn small ghost" id="btnStartCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>


  
<div id="seatPop" class="seat-pop hidden">
  <div class="row"><label>å¸­ã‚’é¸æŠ</label><div id="seatTabs" class="tabs"></div></div>
  <div class="row" style="justify-content:flex-end">
    <button class="btn small ghost" id="btnSeatCancel">è¦³æˆ¦</button>
  </div>
</div>
<div id="m42Minus2Pop" class="m42minus2-pop hidden">
  <div class="line12">åŒã˜æ•°å­—ã®ã‚«ãƒ¼ãƒ‰ã‚’2æšé¸ã¼ã†ã€‚</div>
  <div class="line12">ãã‚Œã‚’å…ƒã«æˆ»ã™ã‚“ã ã€‚</div>
  <div class="line8">ã‚ã‹ã£ãŸã‚‰ã€ç”»é¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€é–‰ã˜ã‚‹ã€‚</div>
</div>

<!-- ã“ã“ã«ï¼ˆ-2 ç”¨ã® #m42Minus2Pop ãŒã‚ã‚‹ãªã‚‰ï¼‰ãã®ç›´å¾Œã«è¿½åŠ  -->
<div id="m42SwapPop" class="m42swap-pop hidden">
  <div class="line12">é•ã†æ•°å­—ã®ã‚«ãƒ¼ãƒ‰ã‚’2æšé¸ã¼ã†ã€‚</div>
  <div class="line12">ãã‚Œã‚‰ã®å ´æ‰€ã‚’å…¥ã‚Œæ›¿ãˆã‚‹ã‚“ã ã€‚</div>
  <div class="line8">ã‚ã‹ã£ãŸã‚‰ã€ç”»é¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€é–‰ã˜ã‚‹ã€‚</div>
</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, get, set, update, remove, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyBpSx_lEcg1j9ExMJsVl5lBqAxOCfmFmSnI",
  authDomain: "chat-68c4c.firebaseapp.com",
  databaseURL: "https://chat-68c4c-default-rtdb.firebaseio.com",
  projectId: "chat-68c4c",
  storageBucket: "chat-68c4c.appspot.com",
  messagingSenderId: "172284325975",
  appId: "1:172284325975:web:6f9bdd77e822c0ea39dd92"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);
// â–¼ è¿½åŠ ï¼šã‚µãƒ¼ãƒãƒ¼æ™‚åˆ»ï¼ˆã‚ªãƒ•ã‚»ãƒƒãƒˆï¼‰ã‚’å–å¾—ã—ã¦çµ±ä¸€æ™‚è¨ˆã‚’ä½œã‚‹
let _serverOffsetMs = 0;
onValue(ref(db, '.info/serverTimeOffset'), (snap)=>{
  _serverOffsetMs = Number(snap.val() || 0);
});
const serverNow = ()=> Date.now() + _serverOffsetMs;
/* State */
const state = {
  roomCode:null, userId:crypto.randomUUID(), userName:'', // â˜…æœªå…¥åŠ›ãªã‚‰å…¥å®¤æ™‚ã«æ¡ç•ª
  isHost:false, mode:null, gameStarted:false, seatedTable:null, watching:null, seatPick:null,
  m22GaveOnce:false, // â˜… #22ï¼šè‡ªåˆ†ãŒæ¸¡ã—ãŸä¸€å›ã‚¬ãƒ¼ãƒ‰ï¼ˆå³æ™‚é€£æ‰“å¯¾ç­–ï¼‰
  _lastMissionId:null};
// â–¼ #13 ãƒ˜ãƒƒãƒ€ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³ã®é…å»¶æ›´æ–°ç”¨ã‚¬ãƒ¼ãƒ‰ï¼ˆãƒ¬ãƒ³ãƒ€ãƒ¼ä¸­ã«DBã‚’æ›¸ã‹ãªã„ãŸã‚ï¼‰
let m13HeaderUpdateScheduled = false;
let m13HeaderClearIndices = null; // null â†’ Set(index)ï¼ˆæ¶ˆã™å¯¾è±¡ã®ãƒ†ãƒ¼ãƒ–ãƒ«indexã‚’è²¯ã‚ã‚‹ï¼‰
state._mpAutoOnce = false;  // ã€Œå‚åŠ ã€å¾Œã«è‡ªå‹•ã§ãƒ”ãƒƒã‚«ãƒ¼ã‚’é–‹ã„ãŸã‹ï¼ˆãƒ›ã‚¹ãƒˆã®ã¿ï¼‰  


/* Elements */
const roomInfo = document.getElementById('roomInfo');
const joinBox= document.getElementById('joinBox');
const inputName = document.getElementById('userName'); // â˜…è¿½åŠ 
const inputCode = document.getElementById('roomCode');

const btnJoin = document.getElementById('btnJoin');
const btnRandom=document.getElementById('btnRandom');

const lobby   = document.getElementById('lobby');
// â–¼ è¿½åŠ ï¼šã‚¯ã‚¤ãƒƒã‚¯ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ”ãƒƒã‚«ãƒ¼èµ·å‹•ãƒœã‚¿ãƒ³
const btnOpenPicker = document.getElementById('btnOpenPicker');

const itemsBar= document.getElementById('itemsBar');
const itemsEl = document.getElementById('items');
const diEl    = document.getElementById('di');

try{
  const qs = new URLSearchParams(location.search);
  const qRoom = (qs.get('room')||'').trim();
  const qName = (qs.get('name')||'').trim();
  if (qRoom) inputCode.value = qRoom.slice(0, 12);
  if (qName) inputName.value = qName.slice(0, 4);
}catch(_e){}
  if (!inputName.value) {
  try {
    const saved = localStorage.getItem("savedUserName");
    if (saved) inputName.value = saved.slice(0, 4);
  } catch(_e){}
}
const tablesEl= document.getElementById('tables');
const gear    = document.getElementById('gear');
const menuPop = document.getElementById('menuPopup');
const btnSit  = document.getElementById('btnSit');
const btnLeave= document.getElementById('btnLeaveSeat');
// â–¼ ã‚„ã‚Šç›´ã™ã‚’å»ƒæ­¢ã—ã€ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ”ãƒƒã‚¯ã«å¤‰æ›´
const btnPickMission = document.getElementById('btnPickMission');
// â–¼ æ—¢å­˜ã®restartPopç³»ã¯æ®‹ã™ãŒä½¿ç”¨ã—ãªã„ï¼ˆäº’æ›ç¶­æŒï¼‰
const restartPop=document.getElementById('restartPop');
const btnRestartOk=document.getElementById('btnRestartOk');
const btnRestartCancel=document.getElementById('btnRestartCancel');

// â–¼ ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ”ãƒƒã‚«ãƒ¼è¦ç´ 
const mp = document.getElementById('missionPicker');
const mpCounts = document.getElementById('mpCounts');
const mpMissions = document.getElementById('mpMissions');
const btnMpBack = document.getElementById('btnMpBack');


const miniPop = document.getElementById('miniPop');
document.addEventListener('click', (e)=>{
  state._lastClickX = e.clientX;
  state._lastClickY = e.clientY;
}, true);


const startPop=document.getElementById('startPop');
const selCount=document.getElementById('selCount');
const selMission=document.getElementById('selMission');
const btnStartOk=document.getElementById('btnStartOk');
const btnStartCancel=document.getElementById('btnStartCancel');


const missionFooter = document.getElementById('missionFooter');
const missionDetailTitle = document.getElementById('missionDetailTitle');
const missionDetailBody  = document.getElementById('missionDetailBody');
const m22PickPanel = document.getElementById('m22PickPanel');

const seatPop = document.getElementById('seatPop');
const seatTabs= document.getElementById('seatTabs');
const btnSeatCancel=document.getElementById('btnSeatCancel');



/* Pop layer */
const popLayer = document.getElementById('popLayer');
/* global reveal */
const globalReveal = document.getElementById('globalReveal');
/* host tool */
const hostTool = document.getElementById('hostTool');
const m42Minus2Pop = document.getElementById('m42Minus2Pop');

/* â˜… é–‹ãï¼é–‰ã˜ã‚‹ */
function openM42Minus2Pop(){
  if (!m42Minus2Pop) return;
  m42Minus2Pop.classList.remove('hidden');

  const close = ()=> {
    m42Minus2Pop.classList.add('hidden');
    m42Minus2Pop.onclick = null;
    // â˜… åŒæœŸé–‰ã˜ï¼šèª°ã‹ãŒé–‰ã˜ãŸã‚‰å…¨å“¡é–‰ã˜ã‚‹
    update(ref(db, `rooms/${state.roomCode}/meta`), { m42M2Pop: null });
  };
  m42Minus2Pop.onclick = close;

  setTimeout(()=>{
    const onDoc = (ev)=>{
      if (!m42Minus2Pop.contains(ev.target)) {
        close();
        document.removeEventListener('click', onDoc, true);
      }
    };
    document.addEventListener('click', onDoc, { once:true, capture:true });
  }, 0);
}


const m42SwapPop = document.getElementById('m42SwapPop');

/* â˜… é–‹ãï¼é–‰ã˜ã‚‹ï¼šâ‡… ç”¨ */
/* â˜… é–‹ãï¼é–‰ã˜ã‚‹ï¼šâ‡… ç”¨ */
function openM42SwapPop(){
  if (!m42SwapPop) return;
  m42SwapPop.classList.remove('hidden');

  const close = ()=> {
    m42SwapPop.classList.add('hidden');
    m42SwapPop.onclick = null;
    // â˜… åŒæœŸé–‰ã˜
    update(ref(db, `rooms/${state.roomCode}/meta`), { m42SwapPop: null });
  };
  m42SwapPop.onclick = close;

  setTimeout(()=>{
    const onDoc = (ev)=>{
      if (!m42SwapPop.contains(ev.target)) {
        close();
        document.removeEventListener('click', onDoc, true);
      }
    };
    document.addEventListener('click', onDoc, { once:true, capture:true });
  }, 0);
}



// å…±æœ‰ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³Audioè¦ç´ ã‚’å¿…ãš1å€‹ã ã‘ä½¿ã†
function getCountdownAudio(){
  let a = document.getElementById('sfxCountdown');
  if (!a) {
    a = document.createElement('audio');
    a.id = 'sfxCountdown';
    a.preload = 'auto';
    a.src = './countdown.mp3';
    // crossOriginã¯ä¸è¦
    a.style.display = 'none';
    a.setAttribute('playsinline', '');
    a.setAttribute('webkit-playsinline', '');
    a.playsInline = true;
    document.body.appendChild(a);
  }
  return a;
}


/* â˜… è¿½åŠ ï¼šcomp.mp3 ç”¨ã® Audio è¦ç´ ã‚’ç”¨æ„ */
function getCompAudio(){
  let a = document.getElementById('sfxComp');
  if (!a) {
    a = document.createElement('audio');
    a.id = 'sfxComp';
    a.preload = 'auto';
    a.src = './comp.mp3';
    a.style.display = 'none';
    a.setAttribute('playsinline', '');
    a.setAttribute('webkit-playsinline', '');
    a.playsInline = true;
    document.body.appendChild(a);
  }
  return a;
}

/* â˜… è¿½åŠ ï¼šsptimer.mp3 ç”¨ã® Audio è¦ç´ ã‚’ç”¨æ„ */
function getSpTimerAudio(){
  let a = document.getElementById('sfxSpTimer');
  if (!a) {
    a = document.createElement('audio');
    a.id = 'sfxSpTimer';
    a.preload = 'auto';
    a.src = './sptimer.mp3';
    a.style.display = 'none';
    a.setAttribute('playsinline', '');
    a.setAttribute('webkit-playsinline', '');
    a.playsInline = true;
    document.body.appendChild(a);
  }
  return a;
}



let _audioUnlocked = false;
window.addEventListener('pointerdown', async function _unlockOnce(){
  if (_audioUnlocked) return;
  _audioUnlocked = true;
  window.removeEventListener('pointerdown', _unlockOnce);

  const a = getCountdownAudio();
  try {
    a.muted = true;
    a.currentTime = 0;
    await a.play();   // ç„¡éŸ³ã§ä¸€ç¬å†ç”Ÿ
    a.pause();
    a.muted = false;
    a.load();         // Safariå¯¾ç­–
  } catch(_e){}
  /* â˜… è¿½åŠ ï¼šcomp.mp3 ã‚‚ç„¡éŸ³ã§ä¸€ç¬å†ç”Ÿã—ã¦è§£éŒ  */
  const ac = getCompAudio();
  try {
    ac.muted = true;
    ac.currentTime = 0;
    await ac.play();
    ac.pause();
    ac.muted = false;
    ac.load();         // Safariå¯¾ç­–
  } catch(_e){}
  /* â˜… è¿½åŠ ï¼šsptimer.mp3 ã‚‚ç„¡éŸ³ã§ä¸€ç¬å†ç”Ÿã—ã¦è§£éŒ  */
  const at = getSpTimerAudio();
  try {
    at.muted = true;
    at.currentTime = 0;
    await at.play();
    at.pause();
    at.muted = false;
    at.load();         // Safariå¯¾ç­–
  } catch(_e){}

});




/* helpers */
function hiragana(len=4){
  const h=[..."ã‚ã„ã†ãˆãŠã‹ããã‘ã“ã•ã—ã™ã›ããŸã¡ã¤ã¦ã¨ãªã«ã¬ã­ã®ã¯ã²ãµã¸ã»ã¾ã¿ã‚€ã‚ã‚‚ã‚„ã‚†ã‚ˆã‚‰ã‚Šã‚‹ã‚Œã‚ã‚ã‚’ã‚“"];
  return Array.from({length:len},()=>h[Math.random()*h.length|0]).join('');
}
const H=(el,b)=> el.classList.toggle('hidden', !!b);
function pos(el,x,y){el.style.left=x+'px';el.style.top=y+'px';}
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1))|0;[a[i],a[j]]=[a[j],a[i]]}return a}
function cssNum(name){const v=getComputedStyle(document.documentElement).getPropertyValue(name).trim(); return parseFloat(v.replace('px',''))||0;}
const now=()=>Date.now();
  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿ã£ãŸã¾ã¾DOMã‚’æ›´æ–°ã™ã‚‹ã‚¬ãƒ¼ãƒ‰
  function withScrollHold(fn){
    const x = window.scrollX, y = window.scrollY;
    const prev = document.documentElement.style.scrollBehavior;
    document.documentElement.style.scrollBehavior = 'auto';
    try { return fn(); }
    finally{
      window.scrollTo(x, y);
      document.documentElement.style.scrollBehavior = prev;
    }
  }
function buildRoomLink(){
  const url = new URL(location.href);
  url.searchParams.set('room', state.roomCode || '');
  return url.toString();
}


async function copyText(text){
 try{
   await navigator.clipboard.writeText(text);
    alert('COPYã—ã¾ã—ãŸ');
  }catch(_e){
    // å¤±æ•—æ™‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    prompt('ã‚³ãƒ”ãƒ¼ã§ããªã„å ´åˆã¯ã“ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', text);
  }
}
  
/* ==== ãƒŸãƒƒã‚·ãƒ§ãƒ³ç´ æå®šç¾© ==== */
const MATERIALS = {
  redCodes : [1,2,3,4,5,6,7,8,9,10,11].map(n=> n + 0.5),
  yellowCodes : [1,2,3,4,5,6,7,8,9,10,11].map(n=> n + 0.1),
  numbers : [1,2,3,4,5,6,7,8,9,10,11,12]
};
// â˜… ä¿®æ­£ï¼šæ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«
const imgNumber = n => `./s${n}.jpg`;
const imgBack   = `./numbercardback.jpg`;
const imgRule   = name => `./${name}.jpg`; // right2/left2/right4/left4
const imgConstraint = L => `./${String(L).toLowerCase()}.jpg`;
const imgConstraintBack = () => `./conback.jpg`;
const imgChallenge = id => `./${id}.png`;

/* ===== æ•°å€¤ã‚«ãƒ¼ãƒ‰ä¸€æ„ç®¡ç†ï¼†é‡ã­è¡¨ç¤ºãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
/* åŒã˜æ•°å­—ã®ã‚«ãƒ¼ãƒ‰ãŒåŒæ™‚ã«å­˜åœ¨ã—ãªã„ã‚ˆã†ã«ç®¡ç†ã™ã‚‹ */
const NUMCARD_REG = new Map(); // n -> { holder:HTMLDivElement, count:number }

/* === å‰ã®ã‚²ãƒ¼ãƒ ã®è¡¨ç¤ºç‰©ã‚’å…¨ã¦æƒé™¤ã™ã‚‹ === */
function clearMissionOverlays(){
document.querySelectorAll('.numlane').forEach(n => {
  if (n.id !== 'm11Row') n.remove();  // m11Rowã¯æ®‹ã™
});
 
  document.querySelectorAll('.num-pin').forEach(pin => pin.remove());
  document.querySelectorAll('.num-under').forEach(n => n.remove()); // â˜… è¿½åŠ 
  // â˜… ãƒŸãƒƒã‚·ãƒ§ãƒ³22ï¼šæƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³è¡¨ã‚’ç¢ºå®Ÿã«æ¶ˆã™
  const info22 = document.getElementById('info22');
  if (info22) info22.remove();
    // â˜… ãƒŸãƒƒã‚·ãƒ§ãƒ³27ï¼šã‚¢ã‚¤ãƒ†ãƒ ç›´ä¸‹ã®è¡Œã‚’ç¢ºå®Ÿã«æ¶ˆã™
  const m27 = document.getElementById('m27Row');
  if (m27) m27.remove();
  // â˜…è¿½åŠ ï¼šåˆ¶ç´„ç³»UIï¼ˆ#34/#32/#37ï¼‰ã‚’ä¸¸ã”ã¨æƒé™¤
  document.querySelectorAll('.conlane').forEach(n => n.remove());   // ä¾‹ï¼šm34HandRow/m34CenterRow/m32ConRowã¯conlane
  ['m34HandRow','m34CenterRow','m32ConRow','conZoomOverlay'].forEach(id=>{
  const m44 = document.getElementById('m44OxPool'); if (m44) m44.remove(); // â† ox2ã®è¡Œã‚’ç¢ºå®Ÿã«æƒé™¤
  });

  document.getElementById('m57Grid')?.remove();       // 3Ã—4ã‚°ãƒªãƒƒãƒ‰
  document.querySelectorAll('.m57-grid').forEach(n=>n.remove()); // äº’æ›
  document.getElementById('m57Sel')?.remove();        // diå·¦ã®é¸æŠè¡¨ç¤º
  // â˜… M59ï¼šæ•°å€¤å¸¯ï¼†nanoã‚’æƒé™¤
document.querySelectorAll('.m59-row').forEach(n => n.remove());
  document.getElementById('m59Nano')?.remove();

  // â˜… M61ï¼šå„ãƒ†ãƒ¼ãƒ–ãƒ«å·¦ã®åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ã‚’æƒé™¤
  document.querySelectorAll('.m61-con').forEach(n => n.remove());

  
  // â˜… M44ï¼šé…¸ç´ UIã‚’å®Œå…¨æƒé™¤ï¼ˆãƒ—ãƒ¼ãƒ«=ox2 ã¨å„ãƒ†ãƒ¼ãƒ–ãƒ«æ‰€æŒè¡Œï¼‰
  const m44 = document.getElementById('m44OxPool');
  if (m44) m44.remove();               // å·¦ã® ox2 ã‚’å«ã‚€ãƒ—ãƒ¼ãƒ«è¡Œ
  document.querySelectorAll('.ox-row').forEach(n => n.remove()); // å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ‰€æŒè¡Œ
  
  // ãƒ†ãƒ¼ãƒ–ãƒ«ã®é«˜ã•ã‚’åŸºæº–ã«æˆ»ã™ï¼ˆM44ã§ä¸Šã’ãŸã‚‚ã®ã‚’è§£é™¤ï¼‰
  document.querySelectorAll('.table').forEach(tb=>{
    tb.style.removeProperty('--table-h');
  });
  
  NUMCARD_REG.clear();
}

/** mountParenté…ä¸‹ã« n ã®ã‚«ãƒ¼ãƒ‰ã‚’ã€Œæ–°è¦ä½œæˆ or æ—¢å­˜ã«é‡ã­ã€ */
function placeNumberCard(n, mountParent){
  const existing = NUMCARD_REG.get(n);
  if (existing) {
   // â˜… æ—¢å­˜ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’æ–°ã—ã„è¦ªã¸â€œç§»å‹•â€ã™ã‚‹ï¼ˆDOMå¤–ã§ã‚‚OKï¼‰
    mountParent.appendChild(existing);
    return;
  }
  const holder = document.createElement('div');
  holder.className = 'numcard-holder';
  const base = document.createElement('div');
  base.className = 'numcard';
  base.style.backgroundImage = `url('${imgNumber(n)}')`;
 holder.appendChild(base);
  mountParent.appendChild(holder);
  NUMCARD_REG.set(n, holder);
}

/** æœªä½¿ç”¨ï¼ˆï¼ç¾åœ¨ãƒ†ãƒ¼ãƒ–ãƒ«ä¸Šã«å­˜åœ¨ã—ãªã„ï¼‰æ•°å­—ã‹ã‚‰ count æšé¸ã¶ */
function pickUnusedNumbers(count){
  const used = new Set(NUMCARD_REG.keys());
  const pool = MATERIALS.numbers.filter(x => !used.has(x));
  shuffle(pool);
  return pool.slice(0, count);
}

/* === ãƒŸãƒƒã‚·ãƒ§ãƒ³12ç”¨ï¼šå„ã‚¢ã‚¤ãƒ†ãƒ ã®â€œå¤–å´ã®çœŸä¸‹â€ã«ä¸€æšãšã¤ === */
function distributeNumbersToItemsCentered(eachCount=1){
  const itemsBar = document.getElementById('itemsBar');
  const items    = document.querySelectorAll('#items .item');
  if(!itemsBar || items.length===0) return;

  // æ—¢å­˜ã‚’æƒé™¤ï¼ˆãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚„ã‚Šç›´ã—æ™‚ã®äºŒé‡ç”Ÿæˆé˜²æ­¢ï¼‰
  const old = document.querySelector('.num-under');
  if(old) old.remove();

  // ãƒ¬ãƒ¼ãƒ³ã‚’ä½œæˆã—ã¦ã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ç›´ä¸‹ã«æŒ¿å…¥
  const under = document.createElement('div');
  under.className = 'num-under';
  itemsBar.insertAdjacentElement('afterend', under);

  // æœªä½¿ç”¨æ•°å­—ã‹ã‚‰å¿…è¦æšæ•°ã¶ã‚“æŠ½é¸
  const need  = items.length * eachCount;
  const picks = pickUnusedNumbers(need);

  // ã‚¢ã‚¤ãƒ†ãƒ æ•°ã«åˆã‚ã›ã¦åŒæ•°ã®ã‚¹ãƒ­ãƒƒãƒˆã‚’ç”¨æ„ã—ã€ä¸­å¤®ã«ã‚«ãƒ¼ãƒ‰ã‚’é…ç½®
  let p = 0;
  items.forEach(()=> {
    const slot = document.createElement('div');
    slot.className = 'slot';
    under.appendChild(slot);

    for(let k=0; k<eachCount; k++){
      const n = picks[p++]; if(n==null) break;
      // placeNumberCard ã¯ holder ã‚’ä½œã£ã¦ mountParent ã«è¿½åŠ ã™ã‚‹
      placeNumberCard(n, slot);
    }
  });
}


/* â˜…â˜…â˜… èµ¤/é»„ã‚³ãƒ¼ãƒ‰æŠ½é¸ãƒ˜ãƒ«ãƒ‘ãƒ¼ â˜…â˜…â˜… */
function pickK(arr, k){
  const a = arr.slice(); shuffle(a);
  return a.slice(0, Math.max(0, Math.min(k, a.length)));
}

/**
 * ãƒŸãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã®ã€Œèµ¤/é»„ã®æ··å…¥ä»•æ§˜ã€ã‚’ã“ã“ã§å®šç¾©
 */
function buildMixPlan(missionId){
  const plans = {
    8:  [
    {type:'redChoose', from:2, take:1},
    {type:'yellowChoose', from:3, take:2},
    ],    
    9:  [
      {type:'redPick',    k:1},
      {type:'yellowPick', k:2},
    ],
    10: [
      {type:'redPick',    k:1},
      {type:'yellowPick', k:4},
    ],
    11: [
      {type:'redPick',    k:2},
    ],
    12: [
      {type:'redPick',    k:1},
      {type:'yellowPick', k:4},
    ],
  13: [ /* #13 ã¯å°‚ç”¨é…å¸ƒã‚’ã™ã‚‹ã®ã§ã“ã“ã§ã¯èµ¤ã‚’æ··ãœãªã„ */ ],
  14: [
    {type:'redPick', k:2},
    {type:'yellowChoose', from:3, take:2},
  ],
  15: [
    {type:'redChoose', from:3, take:1},
  ],
  16: [
    {type:'redPick', k:1},
    {type:'yellowChoose', from:3, take:2},
  ],
  17: [
    {type:'redChoose', from:3, take:2},
  ],
  18: [
    {type:'redPick', k:2},
  ],
  19: [
    {type:'redPick', k:1},
    {type:'yellowChoose', from:3, take:2},
  ],
  20: [
    {type:'redPick', k:2},
    {type:'yellowPick', k:2},
  ],
  21: [
    {type:'redChoose', from:2, take:1},
  ],
  22: [
    {type:'redPick',    k:1},
    {type:'yellowPick', k:4},
  ],
  23: [  // èµ¤3-
    {type:'redChoose', from:3, take:1},
  ],
  24: [  // èµ¤2
    {type:'redPick', k:2},
  ],
  25: [  // èµ¤2
    {type:'redPick', k:2},
  ],
  26: [  // èµ¤2
    {type:'redPick', k:2},
  ],
  27: [  // èµ¤1 é»„4
    {type:'redPick',    k:1},
    {type:'yellowPick', k:4},
  ],
  28: [  // èµ¤2 é»„4
    {type:'redPick',    k:2},
    {type:'yellowPick', k:4},
  ],
 29: [  // èµ¤3
    {type:'redPick', k:3},
  ],

  30: [  // èµ¤2-1ã€é»„4
    {type:'redChoose',  from:2, take:1},
    {type:'yellowPick', k:4},
  ],

  31: [  // èµ¤3-2
    {type:'redChoose', from:3, take:2},
  ],

  32: [  // èµ¤2
    {type:'redPick', k:2},
  ],

  33: [  // èµ¤3-2
    {type:'redChoose', from:3, take:2},
  ],

  34: [  // èµ¤1
    {type:'redPick', k:1},
  ],

  35: [  // èµ¤3-2 é»„4
    {type:'redChoose',  from:3, take:2},
    {type:'yellowPick', k:4},
  ],

  36: [  // èµ¤3-1 é»„2
    {type:'redChoose',  from:3, take:1},
    {type:'yellowPick', k:2},
  ],
37: [  // èµ¤2
  {type:'redPick', k:2},
],
38: [  // èµ¤2
  {type:'redPick', k:2},
],
39: [  // èµ¤3-2 é»„4
  {type:'redChoose', from:3, take:2},
  {type:'yellowPick', k:4},
],
40: [  // èµ¤3
  {type:'redPick', k:3},
],
41: [  // èµ¤3-1
  {type:'redChoose', from:3, take:1},
],
42: [  // èµ¤3-1 é»„4
  {type:'redChoose', from:3, take:1},
  {type:'yellowPick', k:4},
],
  43: [  // èµ¤3
    {type:'redPick', k:3},
  ],
  44: [  // èµ¤3-1
    {type:'redChoose', from:3, take:1},
  ],
  45: [  // èµ¤2
    {type:'redPick', k:2},
  ],
46: [  // é»„4ï¼ˆ5.1,6.1,7.1,8.1 å›ºå®šï¼‰
    { type:'yellowFixed', list:[5.1, 6.1, 7.1, 8.1] },
  ],
  47: [  // èµ¤3-2
    {type:'redChoose', from:3, take:2},
  ],
  48: [  // èµ¤2 é»„3
    {type:'redPick', k:2},
  ],
  49: [  // èµ¤2
    {type:'redPick', k:2},
  ],
  50: [  // èµ¤2 é»„2
    {type:'redPick', k:2},
    {type:'yellowPick', k:2},
  ],
     50: [  // èµ¤2 é»„2
      {type:'redPick', k:2},
      {type:'yellowPick', k:2},
    ],
    // â–¼â–¼ ã“ã“ã‹ã‚‰è¿½åŠ  â–¼â–¼
    51: [  // èµ¤1
      {type:'redPick', k:1},
    ],
    52: [  // èµ¤3
      {type:'redPick', k:3},
 ],
    53: [  // èµ¤2
      {type:'redPick', k:2},
    ],
    54: [  // ï¼ˆæŒ‡å®šãªã— â†’ ç©ºé…åˆ—ï¼‰
    ],
    55: [  // èµ¤2
      {type:'redPick', k:2},
    ],
    56: [  // èµ¤3-2
      {type:'redChoose', from:3, take:2},
    ],
    57: [  // èµ¤1
      {type:'redPick', k:1},
    ],
    58: [  // èµ¤2
      {type:'redPick', k:2},
    ],
    59: [  // èµ¤3-2
      {type:'redChoose', from:3, take:2},
    ],
    60: [  // èµ¤3-2
      {type:'redChoose', from:3, take:2},
    ],
    61: [  // èµ¤1
      {type:'redPick', k:1},
    ],
    62: [  // èµ¤2
      {type:'redPick', k:2},
    ],
    63: [  // èµ¤2
      {type:'redPick', k:2},
    ],
    64: [  // èµ¤1
      {type:'redPick', k:1},
    ],
    65: [  // èµ¤3
      {type:'redPick', k:3},
    ],
    66: [  // èµ¤2 é»„2
      {type:'redPick', k:2},
      {type:'yellowPick', k:2},
    ],
};
return plans[missionId] || [];

}

/**
 * ãƒŸãƒƒã‚¯ã‚¹å®Ÿè¡Œ
 */
function executeMixPlan(planList){
  const toAdd = [];
  const mixLines = [];
  const chooseLines = [];

  planList.forEach(p=>{
    if(p.type==='redPick'){
      const cand = pickK(MATERIALS.redCodes, p.k);
      cand.forEach(n=> toAdd.push({num:n, kind:'red'}));
      mixLines.push('<span style="color:red;">â—</span>' + cand.map(v=>`[${v}]`).join(''));
    }
    if(p.type==='yellowPick'){
      const cand = pickK(MATERIALS.yellowCodes, p.k);
      cand.forEach(n=> toAdd.push({num:n, kind:'yellow'}));
ã€€     mixLines.push('<span style="color:gold;">â–§</span>' + cand.map(v=>`[${v}]`).join(''));
    }
        if(p.type==='yellowFixed'){
      const cand = (p.list || []).slice();
      cand.forEach(n => toAdd.push({ num:n, kind:'yellow' }));
      mixLines.push('<span style="color:gold;">â–§</span>' + cand.map(v=>`[${v}]`).join(''));
    }
    if(p.type==='redChoose'){
      const cand = pickK(MATERIALS.redCodes, p.from);
      chooseLines.push(`<span style="color:red;">â—</span> ${cand.map(v=>`[${v}]`).join(' ')} ã®ã†ã¡${p.take}ã¤`);
      const take = pickK(cand, p.take);
      take.forEach(n=> toAdd.push({num:n, kind:'red'}));
    }
    if(p.type==='yellowChoose'){
      const cand = pickK(MATERIALS.yellowCodes, p.from);
      chooseLines.push(`<span style="color:gold;">â–§</span> ${cand.map(v=>`[${v}]`).join(' ')} ã®ã†ã¡${p.take}ã¤`);
      const take = pickK(cand, p.take);
      take.forEach(n=> toAdd.push({num:n, kind:'yellow'}));
    }
  });

  return { toAdd, mixLines, chooseLines };
}

/* pop positioning */
function placeInsideViewport(div, x, y){
  popLayer.appendChild(div);
  const pad = 8;
  pos(div, x + 6, y + 6);
  let r = div.getBoundingClientRect();
  if (r.right > innerWidth - pad){ const nx = Math.max(pad, x - r.width - 6); pos(div, nx, y + 6); r = div.getBoundingClientRect(); }
  if (r.left < pad) pos(div, pad, r.top);
  if (r.top < pad) pos(div, r.left, pad);
  if (r.bottom > innerHeight - pad) pos(div, r.left, Math.max(pad, innerHeight - r.height - pad));
}
function openOneMini(x,y,label,cb){
  const div=document.createElement('div'); div.className='mini-pop';
  div.addEventListener('click', e=>e.stopPropagation());
  const b=document.createElement('button'); b.className='btn small'; b.textContent=label;
  b.onclick=()=>{ if(div.isConnected) div.remove(); cb&&cb(); };
  div.appendChild(b); placeInsideViewport(div,x,y);
}
function openMenu(x,y, entries){
  const div=document.createElement('div'); div.className='mini-pop';
  div.addEventListener('click', e=>e.stopPropagation());
  entries.forEach(ent=>{
    const b=document.createElement('button');
    b.className='btn small';
    if (ent && ent.html){ 
      b.innerHTML = ent.html;                // â˜… è¿½åŠ ï¼šHTMLã§è¦‹ãŸç›®ã‚’å·®ã—æ›¿ãˆ
      if (ent.ariaLabel) b.setAttribute('aria-label', ent.ariaLabel);
    } else {
      b.textContent = (ent?.label ?? '');
    }
    if (ent && typeof ent.action === 'function') {
      b.onclick = ()=>{ if(div.isConnected) div.remove(); try{ ent.action(); }catch(_e){} };
    } else {
      b.disabled = true;
      b.classList.add('ghost');
    }
    div.appendChild(b);
  });
  placeInsideViewport(div, x, y);
}


function openMenuAtClick(entries){
  const x = (state._lastClickX ?? innerWidth/2);
  const y = (state._lastClickY ?? innerHeight/2);
  openMenu(x, y, entries);
}

function openBottomMenu(entries){
  const div=document.createElement('div'); div.className='mini-pop bottom-pop';
  div.addEventListener('click', (e)=>{ e.stopPropagation(); });
  entries.forEach(ent=>{ const b=document.createElement('button'); b.className=`btn small ${ent?.className||''}`; b.textContent=ent.label; b.onclick=async ()=>{ if(div.isConnected) div.remove(); await ent.action?.(); }; div.appendChild(b); });
  popLayer.appendChild(div);
}


/* enter */
btnRandom.onclick = ()=>{ inputCode.value = String(Math.random()*1e4|0).padStart(4,'0'); };
btnJoin.onclick   = ()=>{
  const nm = (inputName?.value || '').trim();
  // â˜…åå‰ã¯4æ–‡å­—ä»¥å†…ã€‚æœªå…¥åŠ›ãªã‚‰ã²ã‚‰ãŒãª4æ–‡å­—ã‚’è‡ªå‹•æ¡ç•ª
  state.userName = nm ? nm.slice(0,4) : hiragana(4);
  try { localStorage.setItem("savedUserName", state.userName); } catch(_e){}

  // â˜…ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰æœªå…¥åŠ›ãªã‚‰0225ã«ã™ã‚‹
  if (!inputCode.value.trim()) {
    inputCode.value = '0225';
  }

  enter('player');
};


async function enter(mode){
  const code=(inputCode.value||"").trim();
  if(!code){ alert('ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  state.roomCode = code; state.mode=mode;

  const roomRef = ref(db, `rooms/${code}`);
  const snap=await get(roomRef);
  if(!snap.exists()){ state.isHost=true; await set(roomRef, baseRoom(state.userId)); }
  else{ state.isHost = snap.val()?.hostId === state.userId; }

  await set(ref(db, `rooms/${code}/players/${state.userId}`), {
    name: state.userName,
    at: Date.now(),
    online: true,
    lastSeen: Date.now()
  });
  onDisconnect(ref(db, `rooms/${code}/players/${state.userId}`)).update({
    online: false,
    lastSeen: Date.now()
  });
  listenRoom(code);
  // â˜… è‡ªå‹•é›¢å¸­ã®é…å»¶ã‚¯ãƒªã‚¢å½¹ï¼ˆJanitorï¼‰ã‚’èµ·å‹•
  H(joinBox,true); H(lobby,false); H(gear,false); updateHeaderInfo();
}

function updateHeaderInfo(){
  if (!state.roomCode){
    roomInfo.textContent = '';
    return;
  }
  // ã€Œã‚³ãƒ¼ãƒ‰ï¼šXXXXã€ï¼‹å³ã«ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚„ãƒãƒƒãƒ—ã¯ä½¿ã‚ãªã„ï¼‰
  const html = `
    <span class="code-label">${state.roomCode}</span>
    <button id="btnCopyLink" class="btn small copy-btn" aria-live="polite">COPY</button>
    ã€€${state.userName}
  `;
  roomInfo.innerHTML = html;

  const btn = document.getElementById('btnCopyLink');
  if (btn){
    btn.onclick = async ()=>{
      const link = buildRoomLink();
      try{
        await navigator.clipboard.writeText(link);
        // æ ï¼ˆãƒœã‚¿ãƒ³ï¼‰ã®ä¸­èº«ã‚’ã€ŒCOPIEDã€ã«å¤‰æ›´
        btn.textContent = 'COPIED';
        btn.classList.add('copied');
        // 1.8ç§’å¾Œã«å…ƒã«æˆ»ã™
        setTimeout(()=>{
          btn.textContent = 'COPY';
          btn.classList.remove('copied');
        }, 1800);
      }catch(_e){
        // å¤±æ•—æ™‚ã‚‚ãƒãƒƒãƒ—ã¯å‡ºã•ãªã„ã€‚æ–‡è¨€ã ã‘çŸ­ãé€šçŸ¥ã€‚
        btn.textContent = 'ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“â€¦';
        setTimeout(()=>{ btn.textContent = 'COPY'; }, 1800);
      }
    };
  }
}

/* room base */
function baseRoom(hostId){
  return { createdAt: Date.now(), hostId, started:false, tableCount:0, tables:[], items:[], di:{value:0,max:6}, captainTable:null, mission:null,
    players:{}, spectators:{},
    meta:{ itemUses:{i1:0,i2:0,i12:0,i14:0}, tokenCounts:{equal:0,noteq:0,x1:0}, i2Flow:null, i18Flow:null, i16Badge:null,
      /* â–¼â–¼ ï¼šãƒŸãƒƒã‚·ãƒ§ãƒ³44ç”¨ çŠ¶æ…‹ â–¼â–¼ */
      oxItem: 0,         // ã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ä¸‹ï¼ˆå…¨ä½“ãƒ—ãƒ¼ãƒ«ï¼‰ã®é…¸ç´ ãƒˆãƒ¼ã‚¯ãƒ³æ•°
      oxByTable: {}      // å„ãƒ†ãƒ¼ãƒ–ãƒ«ã”ã¨ã®é…¸ç´ ãƒˆãƒ¼ã‚¯ãƒ³æ‰€æŒæ•° { [tableIndex]: number }
      /* â–²â–² ï¼šãƒŸãƒƒã‚·ãƒ§ãƒ³44ç”¨ çŠ¶æ…‹ â–²â–² */
    },
    lastActiveAt: Date.now()
  };}

/* watch */
function listenRoom(code){
  onValue(ref(db, `rooms/${code}`),(snap)=>{
    const v=snap.val(); state.watching=v;
  // â˜… #22: æ–°ã—ã„ã‚²ãƒ¼ãƒ /ãƒŸãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ä¸€åº¦ãã‚Šã‚¬ãƒ¼ãƒ‰ã‚’è§£é™¤ï¼ˆå…¨ç«¯æœ«ï¼‰
  const curId = (v?.mission?.id|0) || 0;
  if (state._prevMissionId !== curId) {
    window.m22_alreadyShown = false;   // â† è‡ªå‹•ãƒãƒƒãƒ—ã‚’å†è¨±å¯
    state.m22GaveOnce = false;         // â† å¿µã®ãŸã‚ãƒ­ãƒ¼ã‚«ãƒ«ã®æ¸¡ã—æ¸ˆã¿ã‚‚ã‚¯ãƒªã‚¢
    state._spTimerOn = false;   
    state._prevMissionId = curId;
  state._mcShownMissionId = 0;

  }
    if (state._mcTimer){ try{ clearTimeout(state._mcTimer); }catch(_e){} state._mcTimer = null; } // â˜… å¾…æ©Ÿã‚¿ã‚¤ãƒãƒ¼ã‚’ç¢ºå®Ÿã«è§£é™¤

   /* â˜… è¿½åŠ ï¼šãƒªã‚»ãƒƒãƒˆæ¤œçŸ¥ï¼ˆæœªé–‹å§‹ï¼†ãƒŸãƒƒã‚·ãƒ§ãƒ³æœªé¸æŠï¼‰â†’ åº§å¸­ãƒãƒƒãƒ—ã‚’ç¢ºå®Ÿã«å‡ºã™ */
   const isReset = v && (v.started === false) && (v.mission == null);
   if (isReset) {
     // DBåº§å¸­ãŒå…¨æ¶ˆã—ã®é–“ã«ãƒ­ãƒ¼ã‚«ãƒ«ãŒæ®‹ã£ã¦ã„ã‚‹ã¨æŠ‘æ­¢ã•ã‚Œã‚‹ãŸã‚ã€å…ˆã«ã‚¯ãƒªã‚¢
     state.seatedTable = null;
     // UIå´ã®åº§å¸­çŠ¶æ…‹ã‚‚å¿µã®ãŸã‚ã€Œæœªç€å¸­ã€ã«
     try { document.body.setAttribute('data-seated', 'no'); } catch(_e){}
    // ã¾ã é–‹ã„ã¦ã„ãªã‘ã‚Œã°é–‹ãï¼ˆæç”»ã¨ç«¶åˆã—ãªã„ã‚ˆã†æ¬¡ã‚¿ã‚¹ã‚¯ã§å®Ÿè¡Œï¼‰
     if (seatPop.classList.contains('hidden')) {
       setTimeout(()=> { btnSit.onclick(); }, 0);
     }
   }
if (v) {
  const p = Object.keys(v.players || {}).length;
  const s = Object.keys(v.spectators || {}).length;
  const empty = (p === 0 && s === 0);
  const justCreated = (Date.now() - (v.createdAt || 0) < 2000); // ä½œæˆã‹ã‚‰2ç§’ä»¥å†…ã¯å‰Šé™¤ã—ãªã„
  if (empty && !justCreated) {
   // æœ€å¾Œã«èª°ã‹ãŒã„ãŸæ™‚åˆ»ã‚’è¨˜éŒ²ã—ã€30åˆ†çµŒéå¾Œã«å‰Šé™¤
    const lastActive = v.lastActiveAt || Date.now();
   const elapsed = Date.now() - lastActive;
    if (elapsed >= 30 * 60 * 1000) {
      remove(ref(db, `rooms/${code}`));
      return;
   } else {
      // activeæ™‚åˆ»æ›´æ–°
      update(ref(db, `rooms/${code}`), { lastActiveAt: Date.now() });
    }
  }
}    
    withScrollHold(()=> {
      renderItemsAndDi(v);
  renderSfx(v);                 // â˜… è¿½åŠ ï¼šSFXåŒæœŸå†ç”Ÿ

      renderM29(v);
      renderM34(v);
      renderTables(v);


      // å¸­ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã„ã¦ã„ã‚Œã°ã€ä»–ç«¯æœ«ã®ç€å¸­/é›¢å¸­ã‚’å³æ™‚åæ˜ 
      if (!seatPop.classList.contains('hidden')) { renderSeatTabs(v); }
      if (v?.meta?.m22_infoShown === true) {
        showInfo22Panel(v);   // ã¾ã ç„¡ã‘ã‚Œã°ä¸€åº¦ã ã‘ç”Ÿæˆï¼ˆã‚ã‚Œã°ä½•ã‚‚ã—ãªã„ï¼‰
        refreshInfo22(v);     // æ—¢å­˜ãƒ‘ãƒãƒ«ã® x0/x1/x2 ã¨ disabled ã‚’æ›´æ–°
      }
      if (state.seatedTable == null && v?.started && !state.gameStarted && seatPop.classList.contains('hidden')) {
        btnSit.onclick();
      }
      renderMissionPanels(v);
      renderGlobalReveal(v);
      renderHostTool(v);
  renderMissionComplete(v);

    });
    // â˜… è¿½åŠ ï¼šãƒŸãƒƒã‚·ãƒ§ãƒ³å†é¸æŠã§ã‚‚æœªç€å¸­è€…ã«å¸­ãƒãƒƒãƒ—ã‚’å‡ºã™ï¼ˆãƒ›ã‚¹ãƒˆä»¥å¤–ã‚‚ï¼‰
   const midNow  = (v?.mission?.id|0);
    const midPrev = (state._lastMissionId|0);
if (state.seatedTable == null && midNow && midNow !== midPrev && seatPop.classList.contains('hidden')) {
     btnSit.onclick();
    }
    state.gameStarted=!!v?.started;
    state._lastMissionId = midNow;    renderM18(v);
    renderM39(v);
    renderM9(v);
     renderM11(v);
    renderM12(v);
    renderM15(v);
    renderM16(v);
    renderM19(v);
    renderM29(v);
    renderM30(v);
renderM31(v);
   renderM30Audio(v);
   renderM42Audio(v);
    renderM32(v);
    renderM36(v);
    renderM37(v);
    renderM23(v);
    renderM26(v);
    renderM42(v);
    renderM43(v);
    renderM44(v);
    renderM49(v);
    renderM53(v);
    renderM54(v);
    renderM57(v);
renderM55(state.watching);
    renderM59(v);
    renderM61(v);
    renderM62(v);
    renderM63(v);
    renderM65(v);
    renderM66(v);
enforceM31to66(v);


    
    // â–¼ ãƒ›ã‚¹ãƒˆåˆ¤å®šã‚’æœ€æ–°åŒ–
    state.isHost = (v?.hostId === state.userId);
    // â˜… è¿½åŠ ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒ1äººã ã‘ãªã‚‰ã€ãã®äººã‚’è‡ªå‹•ã§ãƒ›ã‚¹ãƒˆã«ã™ã‚‹
    const playerIds = Object.keys(v.players || {});
    if (playerIds.length === 1 && v.hostId !== playerIds[0]) {
     update(ref(db, `rooms/${code}`), { hostId: playerIds[0] });
    }

    // â–¼ ãƒ›ã‚¹ãƒˆä»¥å¤–ã«ã¯ã€ŒãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’é¸ã¶ã€ãƒœã‚¿ãƒ³è‡ªä½“ã‚’éè¡¨ç¤º
    H(btnPickMission, !state.isHost);
// æ¡ä»¶ï¼šãƒ›ã‚¹ãƒˆ && æœªé–‹å§‹ && ã¾ã ãƒŸãƒƒã‚·ãƒ§ãƒ³æœªé¸æŠ && ã¾ã æœªå®Ÿè¡Œ
    // v.started ã¯ falseã€v.mission ã¯ null ã§å…¥ã£ã¦ãã‚‹
    /* ã“ã“ã‹ã‚‰è¿½åŠ  */
    if (state.isHost && !v?.started && !v?.mission && !state._mpAutoOnce) {
      openMissionPicker();        // ä¸‹éƒ¨ãƒ”ãƒƒã‚«ãƒ¼ã‚’è¡¨ç¤º
      state._mpAutoOnce = true;   // ä»¥å¾Œã¯é–‹ã‹ãªã„
    }
    // â–¼ è¿½åŠ ï¼šãƒ›ã‚¹ãƒˆãªã‚‰é–‹å§‹å‰å¾Œã„ã¤ã§ã‚‚ã‚¯ã‚¤ãƒƒã‚¯ãƒ”ãƒƒã‚«ãƒ¼ã‚’ä½¿ãˆã‚‹
    updateHeaderInfo();
    // â˜… è‡ªåˆ†ã®å¸­ãŒDBä¸Šã§æ¶ˆãˆã¦ã„ãŸã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã‚‚ã‚¯ãƒªã‚¢ï¼ˆã‚„ã‚Šç›´ã—ç›´å¾Œã®æ®‹ç•™é˜²æ­¢ï¼‰
    const myIdxNow = (v?.tables||[]).findIndex(T => T.playerId === state.userId);
    if (myIdxNow < 0) state.seatedTable = null;
  });
}


// â–¼ ãƒ†ãƒ¼ãƒ–ãƒ«é«˜ã•ã®å·®åˆ†é©ç”¨ï¼ˆå¤‰åŒ–ãŒã‚ã‚‹æ™‚ã ã‘æ›´æ–°ï¼†ãã®æ™‚ã ã‘ã‚¢ãƒ‹ãƒ¡ï¼‰
// â–¼ ãƒ†ãƒ¼ãƒ–ãƒ«é«˜ã•ã®å·®åˆ†é©ç”¨ï¼ˆâ€œç›´å‰è«–ç†å€¤â€ã§åˆ¤å®šï¼‰
// ãƒ»åˆå›ã¯ã‚¢ãƒ‹ãƒ¡ã—ãªã„
// ãƒ»åŒã˜å€¤ãªã‚‰ä½•ã‚‚ã—ãªã„
// ãƒ»å¢—ãˆã‚‹æ™‚ã ã‘ã‚¢ãƒ‹ãƒ¡ï¼ˆæ¸›ã‚‹æ™‚ã¯ç¬æ™‚åæ˜ ã§ãƒãƒ©ã¤ãé˜²æ­¢ï¼‰
function applyTableHeight(box, needPx){
  const prevStr = box.dataset.prevH || "";           // ç›´å‰è«–ç†å€¤ï¼ˆæ–‡å­—åˆ—ï¼‰
  const prev = prevStr === "" ? null : parseInt(prevStr, 10);

  if (prev !== null && prev === needPx) return;      // å¤‰åŒ–ãªã—

  const doAnimate = (prev !== null) && (needPx > prev);

  if (doAnimate){
    box.classList.add('anim-h');
  } else {
    box.classList.remove('anim-h');                  // åˆå›ã‚„ç¸®ã‚€æ™‚ã¯å³æ™‚åæ˜ 
  }

  box.style.setProperty('--table-h', `${needPx}px`);
  box.style.height = `${needPx}px`;

  box.dataset.prevH = String(needPx);                // æ¬¡å›æ¯”è¼ƒç”¨ã«ä¿å­˜

  if (doAnimate){
    setTimeout(()=> box.classList.remove('anim-h'), 300);
  }
}


  // â–¼â–¼ ã‚«ãƒ¼ãƒ‰ä¸‹ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆ.tok-colï¼‰ã®â€œå®Ÿæ¸¬ä¸‹ç«¯â€ã«åˆã‚ã›ã¦ã€å¿…è¦æ™‚ã®ã¿ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä¼¸ã°ã™ â–¼â–¼
// å¯¾è±¡ï¼šæ•°å­— / x1ãƒ»x2ãƒ»x3 / å¶æ•° / å¥‡æ•° / ï¼ / â‰  ï¼ˆ= .tok-col ã«ä¸¦ã¶ .tokenï¼‰
function growForCardTokens(box, basePx = 96, padPx = 6){
  // ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã®å„ã‚«ãƒ¼ãƒ‰ãƒãƒƒã‚¸ç›´ä¸‹ã«ã‚ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³åˆ—ã‚’å…¨éƒ¨è¦‹ã‚‹
  const cols = box.querySelectorAll('.badge-fixed .tok-col');
  if (!cols.length) return;

  let needs = false;
  let maxBottom = 0;
  const rBox = box.getBoundingClientRect();

  cols.forEach(col=>{
    const cnt = col.querySelectorAll('.token').length | 0;
    // â€•â€•â€• 1è¡Œï¼ˆ=1å€‹ï¼‰ä»¥ä¸‹ãªã‚‰ä¸€åˆ‡ã‚¹ãƒ©ã‚¤ãƒ‰ã—ãªã„
    if (cnt >= 2){
      needs = true;
      const r = col.getBoundingClientRect();
      maxBottom = Math.max(maxBottom, r.bottom);
    }
  });

  if (!needs) return; // 2å€‹ä»¥ä¸Šã®åˆ—ãŒç„¡ã‘ã‚Œã°ä½•ã‚‚ã—ãªã„ï¼ˆã‚¢ãƒ‹ãƒ¡ã‚‚ç™ºç”Ÿã—ãªã„ï¼‰

  // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸Šç«¯ã‹ã‚‰â€œæœ€ã‚‚ä¸‹ã«å‡ºãŸãƒˆãƒ¼ã‚¯ãƒ³åˆ—ã®ä¸‹ç«¯â€ã¾ã§ã®é«˜ã•ã«å°‘ã—ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¶³ã™
  const needPx = Math.max(basePx, Math.ceil(maxBottom - rBox.top + padPx));
  applyTableHeight(box, needPx);
}
// â–²â–² ã‚«ãƒ¼ãƒ‰ä¸‹ãƒˆãƒ¼ã‚¯ãƒ³ã§ã®è‡ªå‹•ä¼¸é•· â–²â–²

  
/* mission panels */
function renderMissionPanels(v){
  if(!v?.mission){
    // å³ã‚µã‚¤ãƒ‰ã® missionBox ã‚’å»ƒæ­¢ã—ãŸã®ã§æœªé¸æŠè¡¨ç¤ºã¯å‡ºã•ãªã„
    missionDetailTitle.textContent = '';
    missionDetailBody.innerHTML = '';
    H(missionFooter, true);
    return;
  }
  missionDetailTitle.textContent = v.mission.display?.[0] || '';
  missionDetailBody.innerHTML = (v.mission.display||[]).slice(1)
    .map(line=>`<div class="line">${line}</div>`).join('');

  /* ã“ã“ã‹ã‚‰è¿½åŠ ï¼š#50 å°‚ç”¨ OKã‚¿ãƒ–ï¼†èµ¤/é»„ã®ã¿ [?] ãƒã‚¹ã‚¯ï¼ˆå…¨å“¡ã«åŒæœŸï¼‰ */
  if ((v?.mission?.id|0) === 50) {
  document.querySelectorAll('.check-mark').forEach(el=>{
    el.style.background = 'none';
  });
    
    const hidden = v?.meta?.m50_hidden === true;

    // èµ¤/é»„ã®æ•°å€¤ã ã‘ [ ? ] ã«ã™ã‚‹é–¢æ•°ï¼ˆ"â—" or "â–§" ã‚’å«ã‚€è¡Œã® [ ... ] ã ã‘ç½®æ›ï¼‰
    const maskRedYellowInDetails = (root)=>{
      root.querySelectorAll('.line').forEach(line=>{
        const t = line.textContent || '';
        if (t.includes('â—') || t.includes('â–§')) {
          line.textContent = t.replace(/\[[^\]]+\]/g, '[?]');
        }
      });
    };

    // æ—¢ã«éš ã™ãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ãŸã‚‰å³ãƒã‚¹ã‚¯
    if (hidden) {
      maskRedYellowInDetails(missionDetailBody);
    } else {
      // ã¾ã ãªã‚‰ã€ŒOKã€ã‚¿ãƒ–ã‚’1å›ã ã‘å‡ºã™ï¼ˆè©³ç´°ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è¡¨ç¤ºï¼‰
      if (!missionDetailBody.dataset.m50Hooked) {
        missionDetailBody.dataset.m50Hooked = '1';
        missionDetailBody.addEventListener('click', (ev)=>{
         if (((state?.watching?.mission?.id|0) !== 50)) return;
          if (document.getElementById('m50OkTab')) return;
          const okBtn = document.createElement('button');
          okBtn.id = 'm50OkTab';
          okBtn.className = 'tab';
          okBtn.textContent = 'OK';
          okBtn.onclick = async (e)=>{
            e.stopPropagation();
            // å…¨å“¡ã«åæ˜ ï¼šDBã«ãƒ•ãƒ©ã‚°ã‚’æ›¸ãè¾¼ã‚€
            await update(ref(db, `rooms/${state.roomCode}/meta`), { m50_hidden: true });
          };
          missionDetailBody.appendChild(okBtn);
        }, { once:false });
      }
    }
  }
  
  H(missionFooter, !v.started);
}



/* ===== Items & DI ===== */
function renderItemsAndDi(v){
  if(!v || !v.started){ H(itemsBar,true); return; }
  // â˜… #23ï¼šåºƒã’ã‚‹å‰ã¯ã€Œã‚¢ã‚¤ãƒ†ãƒ ã®ã¿ã€éè¡¨ç¤ºï¼ˆDIã¯æ®‹ã™ï¼‰
  // â˜… #42ï¼šâ˜ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—èµ·å‹•ä¸­ï¼‰ã¯ã‚¢ã‚¤ãƒ†ãƒ ã¨DIã‚’ä¸€æ™‚çš„ã«éè¡¨ç¤º
  let hideItems = false;
  let hideDi = false;
  {
    const flags = v?.mission?.flags || {};
    const isM42 = ((v?.mission?.id|0) === 42);
    const m23OnlyHideItems = !!(flags.m23_hideItemsUntilSpread && !v?.meta?.m23_spread);
    hideItems = m23OnlyHideItems || (isM42 && !!v?.meta?.m42_on);
    hideDi    = (isM42 && !!v?.meta?.m42_on);

    // ãƒãƒ¼è‡ªä½“ã¯å¸¸ã«è¡¨ç¤ºï¼ˆm42ã®ç®±ã‚’ç½®ããŸã‚ï¼‰ã€å¿…è¦ã«å¿œã˜ã¦ä¸­èº«ã ã‘éš ã™
    H(itemsBar, false);
    H(itemsEl, hideItems);
    H(diEl, hideDi);
  }


  // â˜… è¿½åŠ ï¼šèª¤ã‚¯ãƒªã‚¢ãƒ»èª¤é…ç½®ã®å®‰å…¨ã‚¬ãƒ¼ãƒ‰ï¼ˆã“ã“ã‹ã‚‰ï¼‰
  if (itemsEl.contains(diEl)) itemsBar.appendChild(diEl);   // di ãŒ items å†…ã«ç´›ã‚Œã¦ã„ãŸã‚‰æ•‘å‡º
  if (!itemsBar.contains(diEl)) itemsBar.appendChild(diEl); // di ãŒãƒãƒ¼ã‹ã‚‰æ¶ˆãˆã¦ã„ãŸã‚‰å¾©å¸°
  // â˜… è¿½åŠ ï¼šèª¤ã‚¯ãƒªã‚¢ãƒ»èª¤é…ç½®ã®å®‰å…¨ã‚¬ãƒ¼ãƒ‰ï¼ˆã“ã“ã¾ã§ï¼‰

  itemsEl.innerHTML='';
  const itemNodes = []; // â˜… ãƒãƒ¼ãƒ‰å‚ç…§ã‚’ä¿æŒ

  (v.items||[]).forEach((it, idx)=>{
    const flags = v?.mission?.flags || {};
    const div=document.createElement('div'); div.className='item' + (it.used?' used':'');
    if(!it.used){
      // #15: æœ€åˆã¯è£å‘ãè¡¨ç¤ºï¼ˆä½¿ç”¨å¯ã ãŒ faceUp===false ã®é–“ã¯è£é¢ã‚¢ãƒ¼ãƒˆã‚’è¡¨ç¤ºï¼‰
      if(flags.itemsFaceDownStart && it.faceUp===false){
        div.style.backgroundImage = `url("./itemback.jpg")`;
      }else{
        div.style.backgroundImage = `url("./item${it.no}.jpg")`;
      }
    }


 // â˜… è¿½åŠ ï¼šã‚¢ã‚¤ãƒ†ãƒ 16ã®æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚«ãƒ¼ãƒ‰ã®çœŸä¸‹ã«è¡¨ç¤º
if(it.no===16 && v?.meta?.i16Badge && v.meta.i16Badge.num!=null){
  const below = document.createElement('div');
  below.className = 'i16-below';
  const tok = document.createElement('div');
  tok.className = 'token black';
  tok.textContent = String(v.meta.i16Badge.num);
  tok.title = 'ã‚¯ãƒªãƒƒã‚¯ã§æ“ä½œ';
  tok.onclick = (ev)=>{
    openMenu(ev.clientX, ev.clientY, [
      {label:'æ¶ˆã™', action: async ()=>{ await update(ref(db, `rooms/${state.roomCode}/meta`), { i16Badge: null }); }}
    ]);
  };
  below.appendChild(tok);
  div.appendChild(below);

  // è¿½åŠ ï¼šã‚«ãƒ¼ãƒ‰ã‚’ä¸Šã«æŒã¡ä¸Šã’ã¦ä¸‹ã®ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã—ã§è¦‹ãˆã‚‹ã‚ˆã†ã«
  div.classList.add('i16-lift');
}

    div.onclick=(ev)=>{
     const flags = state.watching?.mission?.flags || {};
     // ä½¿ç”¨æ¸ˆã¿ â†’ ã€Œè¡¨ã«ã™ã‚‹ã€ã ã‘
      if(it.used){
        openOneMini(ev.clientX, ev.clientY, 'è¡¨ã«ã™ã‚‹', async ()=>{
          await update(ref(db, `rooms/${state.roomCode}/items/${idx}`), {used:false});
        });
      }else{
        // ãƒŸãƒƒã‚·ãƒ§ãƒ³15 && è£å‘ã â†’ æ‹¡å¤§ã•ã›ãšã€Œè¡¨ã«ã™ã‚‹ã€ã ã‘
        if((state.watching?.mission?.id|0) === 15 && flags.itemsFaceDownStart && it.faceUp===false){
         openOneMini(ev.clientX, ev.clientY, 'è¡¨ã«ã™ã‚‹', async ()=>{
           await update(ref(db, `rooms/${state.roomCode}/items/${idx}`), {faceUp:true});
          });
        }else{
         // é€šå¸¸é€šã‚Šæ‹¡å¤§ï¼ˆè¡¨çŠ¶æ…‹ or ä»–ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼‰
         const canFaceUp = !!(flags.itemsFaceDownStart && it.faceUp===false);
          openItemZoom(it.no, idx, { canFaceUp });
        }
     }
    };

    itemsEl.appendChild(div);
    itemNodes.push(div);
  });


  // â˜… è¿½åŠ ï¼š#23 ã®æ®‹ã‚Šå±±æœ­ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¢ã‚¤ãƒ†ãƒ æ¬„ã¸ä¸¦ã¹ã‚‹
 if ((v.mission?.id|0) === 23 && v?.meta?.m23_spread === true
     && (v.items?.length ?? 0) === 0
     && Array.isArray(v?.meta?.m23_spreadRest) && v.meta.m23_spreadRest.length > 0) {
   for (const no of rest) {
      const div2 = document.createElement('div');
     div2.className = 'item m23-spread';
      div2.style.backgroundImage = `url("./item${no}.jpg")`;
      // è¡¨ç¤ºã®ã¿ï¼ˆæ‹¡å¤§ã¯å¯ï¼‰ã€‚ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã¯å¤‰æ›´ã—ãªã„
     div2.onclick = () => openItemZoom(no, -1, { canFaceUp: true });
      itemsEl.appendChild(div2);
      itemNodes.push(div2);
   }
  }
  
  const val = clamp(v.di?.value ?? v.tableCount, 0, 6);
  diEl.style.backgroundImage = `url("./di${val}.png")`;
  diEl.onclick=(ev)=>{
    openMenu(ev.clientX, ev.clientY, [
{label:'é€²ã‚ã‚‹', action: async ()=>{
  const nowv = state.watching?.di?.value ?? val;
  const next = clamp(nowv-1,0,6);

  const a = getCountdownAudio();
const now = Date.now();
if (!state._sfxJustPlayedAt || now - state._sfxJustPlayedAt > 500) {
  try {
    a.currentTime = 0;
    const p = a.play();        // â† awaitã—ãªã„ï¼ˆåŒæœŸã®ã†ã¡ã«é–‹å§‹ï¼‰
    state._sfxJustPlayedAt = now;
    p.catch(()=>{});           // å¿…è¦ãªã‚‰ã“ã“ã§ã€ŒéŸ³å£°ã‚’æœ‰åŠ¹åŒ–ã€ãƒãƒƒãƒ—è¡¨ç¤ºã«å·®ã—æ›¿ãˆå¯
  } catch(_e){}
}


  await update(ref(db, `rooms/${state.roomCode}/di`), { value: next });
  await update(ref(db, `rooms/${state.roomCode}/meta`), {
  sfx: { name: 'countdown', at: serverNow(), nonce: Math.random().toString(36).slice(2) }
  });
}},
      {label:'æˆ»ã™', action: async ()=>{ const nowv=state.watching?.di?.value ?? val; const next=clamp(nowv+1,0,6); await update(ref(db, `rooms/${state.roomCode}/di`), {value:next}); }},
    ]);
  };
}

/* ===== Global badge (item16) ===== */
function renderGlobalReveal(v){
  // å¤‰æ›´ï¼šã‚µã‚¤ãƒ‰è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆãŸãŸã‚å¸¸ã«éè¡¨ç¤º
  globalReveal.innerHTML='';
  H(globalReveal,true);
}

/* ===== Host tool (odd-open normal codes) ===== */
function renderHostTool(v){
  if(!v?.tables){ H(hostTool,true); return; }
  const openCountByNum = {};
  (v.tables||[]).forEach(T=>{
    (T.hand||[]).forEach(c=>{
      if(c?.kind==='normal' && c.open===true){
        const n = c.num|0;
        openCountByNum[n] = (openCountByNum[n]||0) + 1;
      }
    });
  });
  const hasOdd = Object.values(openCountByNum).some(cnt => (cnt % 2)===1);
  H(hostTool, !hasOdd);
}
hostTool.onclick = ()=> alert('å…¨ä½“å…¬é–‹ã•ã‚Œã¦ã„ã‚‹é€šå¸¸ã‚³ãƒ¼ãƒ‰ã®æšæ•°ã«å¥‡æ•°ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚');



/* ===== Mission Complete (all normal & yellow open) ===== */
/* â˜… è¿½åŠ ï¼šé»’&é»„ãŒå…¨å…¬é–‹ãªã‚‰â€œãƒŸãƒƒã‚·ãƒ§ãƒ³å®Œäº†!!â€ãƒãƒƒãƒ—ï¼‹comp.mp3 å†ç”Ÿ */
/* ===== Mission Complete (all normal & yellow open) ===== */
/* â˜… é»’(normal)ï¼†é»„(yellow)ãŒã€Œæ‰‹æœ­ã§æœªå…¬é–‹0æšã€ã«ãªã£ãŸã‚‰1åº¦ã ã‘å®Œäº†ãƒãƒƒãƒ— */
function renderMissionComplete(v){
  try{
    if(!v || !Array.isArray(v.tables)) return;
    const mid = (v?.mission?.id|0) || 0;
    if(!mid) return;

    // â˜… M29/M57 ã®å‡¦ç†ä¸­ã¯ä¸­é–“ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’è©•ä¾¡ã—ãªã„
    const busy = !!(v?.meta?.m29_busy) || !!(v?.meta?.m57_busy);
    if (busy) return;

    // é»’(normal)ã¨é»„(yellow)ã®ã¿å¯¾è±¡ï¼ˆæ‰‹æœ­ã®ã¿ï¼‰
    const cards = [];
    (v.tables||[]).forEach(T=>{
      (T.hand||[]).forEach(c=>{
        // â˜… ä¸­é–“å€‹ä½“ã¯é™¤å¤–ï¼šnull/undefined, gone:true, numæœªå®šç¾©
        if(!c || c.gone===true || c.num==null) return;
        if (c.kind === 'normal' || c.kind === 'yellow') cards.push(c);
      });
    });

    // æœªå…¬é–‹ï¼ˆopen!==trueï¼‰ã®æšæ•°ã€‚ãŸã ã—ä¸Šã§ä¸­é–“å€‹ä½“ã¯æ—¢ã«é™¤å¤–æ¸ˆã¿
    const unopened = cards.filter(c => c.open !== true).length;

    // â–¼ ã‚¹ãƒ‘ãƒ¼ãƒˆã‚¿ã‚¤ãƒãƒ¼åˆ¶å¾¡ï¼ˆæ—¢å­˜ä»•æ§˜ã‚’è¸è¥²ï¼‰
    const nearComplete = (unopened === 2 || unopened === 1);
    if (nearComplete && !state._spTimerOn){
      const at = getSpTimerAudio();
      try{ at.loop = true; at.currentTime = 0; at.play().catch(()=>{}); state._spTimerOn = true; }catch(_e){}
    }
    // 2æš/1æš ä»¥å¤–ã«ãªã£ãŸã‚‰åœæ­¢ï¼ˆ>2æš ã‚‚ã—ãã¯ 0æšï¼å…¨å…¬é–‹ï¼‰
    if (!nearComplete && state._spTimerOn){
      const at = getSpTimerAudio();
      try{ at.pause(); at.currentTime = 0; }catch(_e){}
      state._spTimerOn = false;
    }

    // ã“ã“ã‹ã‚‰é€šå¸¸ã®ã€Œå…¨å…¬é–‹ã€åˆ¤å®šã¸
    if (cards.length === 0) return;
    const allOpen = unopened === 0;
    if (!allOpen) return;

    // åŒä¸€ãƒŸãƒƒã‚·ãƒ§ãƒ³å†…ã§ä¸€åº¦ã ã‘è¡¨ç¤º
    if (state._mcShownMissionId === mid) return;
    state._mcShownMissionId = mid;

    // ãƒãƒƒãƒ—ç”Ÿæˆï¼ˆå·¦â†’ä¸­å¤®ã¸ï¼šæ—¢å­˜CSS .mission-complete-pop ã‚’ä½¿ç”¨ï¼‰
    const id = 'missionCompletePop';
    const old = document.getElementById(id);
    if (old) old.remove();

    const div = document.createElement('div');
    div.id = id;
    div.className = 'mission-complete-pop';
    div.textContent = 'ãƒŸãƒƒã‚·ãƒ§ãƒ³å®Œäº†!!';
    document.body.appendChild(div);

    // åŠ¹æœéŸ³ï¼ˆcomp.mp3ï¼‰å†ç”Ÿ
    try{
      const au = new Audio('./comp.mp3');
      au.currentTime = 0;
      au.play().catch(()=>{});
    }catch(_e){}

    // 3ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹ï¼ˆä»»æ„ï¼‰
    setTimeout(()=>{ const x=document.getElementById(id); if(x) x.remove(); }, 3000);
  }catch(e){
    console.error('renderMissionComplete failed', e);
  }
}

/* ===== Tables ===== */
function renderTables(v){
  tablesEl.innerHTML=''; if(!v) return;
    const seatedNow = (v?.tables||[]).some(T => T.playerId === state.userId);
  document.body.setAttribute('data-seated', seatedNow ? 'yes' : 'no');
  
  if (!(v.meta?.m22_infoShown)) {
    const old = document.getElementById('info22');
    if (old) old.remove();
  }
  
  /* â˜… å…¨ä½“å…¬é–‹ä¸­ã®é€šå¸¸ã‚³ãƒ¼ãƒ‰ã®ã€Œæ•°å­—åˆ¥æšæ•°ã€ã‚’é›†è¨ˆ */
  const openCountByNum = {};
  (v.tables||[]).forEach(T=>{
    (T.hand||[]).forEach(c=>{
      if(c?.kind==='normal' && c.open===true){
        const n = c.num|0; // 1..12
        openCountByNum[n] = (openCountByNum[n]||0) + 1;
      }
    });
  });
  
// #39ï¼šX ãŒ 4æšå…¨ä½“å…¬é–‹ â†’ è‡ªå‹•é…å¸ƒï¼ˆãƒ›ã‚¹ãƒˆã®ã¿ãƒ»ä¸€åº¦ã ã‘ï¼‰
if ((v.mission?.id|0) === 39) {
  const X = v?.meta?.m39_x|0;
  const done = v?.meta?.m39_dealt === true;
  if (X && !done && (openCountByNum[X]||0) === 4 && state.isHost) {
    performM39Deal();
  }
}

// #23ï¼šè¡¨ç¤ºä¸­ã®â€œæ•°å€¤ã‚«ãƒ¼ãƒ‰ï¼ˆm23_numberï¼‰â€ã¨åŒã˜æ•°å­—ãŒ4æšå…¨ä½“å…¬é–‹
// â†’ å±±æœ­ã«æ®‹ã£ã¦ã„ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ¼ãƒ‰ã‚’ã‚¢ã‚¤ãƒ†ãƒ æ¬„ã«ä¸¦ã¹ã‚‹ï¼ˆãƒ›ã‚¹ãƒˆã®ã¿ãƒ»ä¸€å›ï¼‰
if ((v.mission?.id|0) === 23) {
  const X = v?.meta?.m23_number|0;
  const done = v?.meta?.m23_spread === true;
  if (X && !done && (openCountByNum[X]||0) === 4 && state.isHost) {
    performM23Spread();
  }
}

  
  /* â˜… ãƒ†ãƒ¼ãƒ–ãƒ«1ã®çœŸä¸Šã«ãƒã‚§ãƒƒã‚¯è¡¨ï¼ˆ1..12ï¼‰ã‚’è¨­ç½® */
  if((v.tables||[]).length>0){
    const cl = document.createElement('div'); cl.className='checklist';
    for(let n=1; n<=12; n++){
      const cell = document.createElement('div'); cell.className='check-item';
      cell.textContent = String(n);
      if((openCountByNum[n]||0) === 4){ // åŒã˜æ•°å­—ãŒ4æœ¬å…¨ä½“å…¬é–‹
        const mk = document.createElement('div'); mk.className='check-mark';
        cell.appendChild(mk);
      }
      /* ã“ã“ã‹ã‚‰è¿½åŠ ï¼š#43ã®ã¨ãã ã‘ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ï¼ˆå…¨å“¡ï¼‰ */
          {
        const mid = (v?.mission?.id|0);
        if (mid === 43 || mid === 53) {
          cell.style.cursor = 'pointer';
          cell.onclick = async ()=>{
            const prev = (mid===43 ? (v?.meta?.m43_pos|0) : (v?.meta?.m53_pos|0));
            const next = n|0;
            if (!state.roomCode) return;
            if (mid === 43){
              await update(ref(db, `rooms/${state.roomCode}/meta`), {
                m43_prevPos: prev||0, m43_pos: next, m43_updatedAt: Date.now()
              });
            }else{
              await update(ref(db, `rooms/${state.roomCode}/meta`), {
                m53_prevPos: prev||0, m53_pos: next, m53_updatedAt: Date.now()
              });
            }
          };
        }
      }
      
      cl.appendChild(cell);
    }
    tablesEl.appendChild(cl); // â† ç›´å¾Œã«ãƒ†ãƒ¼ãƒ–ãƒ«1ãŒæ¥ã‚‹ã®ã§ã€ŒçœŸä¸Šã€ã«ãªã‚‹
  }

  const W = cssNum('--card-w'), G = cssNum('--card-gap'), CW = cssNum('--char-w');
  const seatedAny = (v.tables||[]).some(T => !!T.playerId);
  // â˜… å¤‰æ›´ï¼šä¸Šé™ã®å¯¾å¿œ
  //   ï¼ ã®ä¸Šé™ã¯ã‚¢ã‚¤ãƒ†ãƒ 12ã®ä½¿ç”¨å›æ•°
  //   â‰  ã®ä¸Šé™ã¯ã‚¢ã‚¤ãƒ†ãƒ 1ã®ä½¿ç”¨å›æ•°
  const uses = v.meta?.itemUses || {i1:0,i2:0,i12:0,i14:0};
  const caps = { 
    equal: uses.i12>=2 ? 4 : (uses.i12>=1 ? 2 : 0),
    noteq: uses.i1>=2  ? 4 : (uses.i1>=1  ? 2 : 0),
    x1:    uses.i14>=2 ? 2 : (uses.i14>=1 ? 1 : 0)
  };
  const counts = v.meta?.tokenCounts || {equal:0,noteq:0,x1:0};
  const i2All=v.meta?.i2Flow;
  const i18All=v.meta?.i18Flow;

  (v.tables||[]).forEach((t, idx)=>{
    const box=document.createElement('div'); box.className='table';
    box.addEventListener('mouseenter', ()=> box.classList.add('elevated'));
    box.addEventListener('mouseleave', ()=> {
      const hasTokenLater = (t.hand||[]).some(c=> (c.tokens||[]).length>0);
      if(!hasTokenLater) box.classList.remove('elevated');
    });

    const n = (t.hand||[]).length;
    const handInner = n>0 ? (n*W + (n-1)*G) : 0;
    const totalW = CW + 8 + handInner + 16;
    box.style.width = Math.max(totalW, CW + 16) + 'px';

const header=document.createElement('div'); header.className='t-header';
const title=document.createElement('div');  title.className='title';
title.textContent = t.playerName ? t.playerName : String(t.titleNumber ?? (idx+1));

    
    
    /* â–¼â–¼ ã“ã“ã‹ã‚‰è¿½åŠ ï¼š#29 æ‰€æŒæ•°è¡¨ç¤º â–¼â–¼ */
if ((v.mission?.id|0) === 29) {
  const cnt = Array.isArray(t.m29Hand) ? t.m29Hand.length : 0;
  // â† ã€Œï¼ˆnï¼‰ã€ã®â€œnâ€éƒ¨åˆ†ã‚’ã‚¢ãƒ³ã‚«ãƒ¼åŒ–
  const span = document.createElement('span');
  span.id = `m29cnt-${idx}`;  // â˜…ã“ã“ãŒ anchor
  span.textContent = `ï¼ˆ${cnt}ï¼‰`;
 title.appendChild(span);
}
    
    header.appendChild(title);
    /* â˜… è¿½åŠ ï¼šãƒ›ã‚¹ãƒˆã ã‘â€”ãƒ†ãƒ¼ãƒ–ãƒ«åã‚¯ãƒªãƒƒã‚¯ã§ã€Œã‚­ãƒƒã‚¯ã€ */
    if (state.isHost){
      title.style.cursor = 'pointer';
     title.title = 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ“ä½œ';
      title.onclick = (ev)=>{
        if(!t.playerId) return; // ç©ºå¸­ã¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç„¡ã—
        openMenu(ev.clientX, ev.clientY, [
          { label:'ã‚­ãƒƒã‚¯', action: async ()=>{ await kickSeatAt(idx); } }
        ]);
     };
    }
    
// #13ï¼šåˆæœŸæƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆæ•°å€¤ï¼‰â€”â€” è¡¨ç¤ºã¯ã‚­ãƒ£ãƒ©ä¸‹ã€ã“ã“ã§ã¯å€¤ã¨ auto-hide ã ã‘æ‰±ã†
let m13HeaderNum = null;
if (v.mission?.flags?.m13_headerRandomInfoToken && Array.isArray(v.meta?.m13_header)) {
  const headerNums = v.meta.m13_header;
  const n0 = headerNums[idx];
  if (n0 != null) {
    m13HeaderNum = n0;

// åŒãƒ†ãƒ¼ãƒ–ãƒ«å†…ã§åŒã˜æ•°å­—ã®æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆtype:'num'ï¼‰ãŒä½¿ã‚ã‚ŒãŸã‚‰è‡ªå‹•ã§æ¶ˆã™
// â€» ãƒ¬ãƒ³ãƒ€ãƒ¼ä¸­ã«DBæ›´æ–°ã—ãªã„ï¼šå¯¾è±¡indexã ã‘ã‚­ãƒ¥ãƒ¼ã¸ç©ã‚€
if (v.mission?.flags?.m13_autoHideHeaderToken) {
  let used = false;
  (t.hand || []).forEach(c => {
    (c.tokens || []).forEach(tk => {
      if (tk?.type === 'num') {
        const n = parseInt(tk.value, 10);
        if (Number.isInteger(n) && n === n0) used = true;
      }
    });
  });
  if (used) {
    const current = (state.watching?.meta?.m13_header || [])[idx];
    if (current === n0) {
      if (!m13HeaderClearIndices) m13HeaderClearIndices = new Set();
      m13HeaderClearIndices.add(idx);
    }
  }
}

  }
}
box.appendChild(header);


    const content=document.createElement('div'); content.className='t-content';

// â˜… ã‚­ãƒ£ãƒ©ï¼‹ä¸‹éƒ¨ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆ#13ï¼‰ç”¨ãƒ©ãƒƒãƒ‘ãƒ¼
const charCol = document.createElement('div'); 
charCol.className = 'char-col';

const char=document.createElement('div'); 
char.className='char-card';
// è‡ªåˆ†ãŒæœªç€å¸­  ã¾ãŸã¯  ã“ã®å¸­ãŒç©ºå¸­ â†’ ãƒ–ãƒ©ãƒ³ã‚¯å›ºå®š
const amSeated = seatedNow;           // å…ˆé ­ã§ç®—å‡ºæ¸ˆã¿
const seatEmpty = !t.playerId;        // ç©ºå¸­åˆ¤å®š
if (!amSeated || seatEmpty) {
  char.classList.add('blank');
  char.removeAttribute('style');
  char.onclick = null;
} else {
  const face = t.character?.flipped ? './battery.jpg' : `./${t.character?.face || 'member (1).jpg'}`;
  char.style.backgroundImage = `url("${face}")`;
  // â–¼â–¼ ã“ã“ã‹ã‚‰ï¼šmember(9) ã ã‘ã¯æ‹¡å¤§ã€ãã®ä»–ã¯å¾“æ¥ã©ãŠã‚Šè£è¿”ã— â–¼â–¼
  const isMine = (t.playerId === state.userId);
  const myOrigFace = String(t?.character?.face || '');
  if (isMine && myOrigFace.includes('member (9).jpg')) {
    // è‡ªåˆ†ï¼†member(9) â†’ ã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§ï¼ˆè£è¿”ã—ã—ãªã„ï¼‰
    char.onclick = ()=> openRoleZoomView(myOrigFace);
  } else {
    // å¾“æ¥æŒ™å‹•ï¼šè‡ªåˆ†ã¯ã‚¯ãƒªãƒƒã‚¯ã§è£è¿”ã—
    char.onclick = async ()=> {
      await update(ref(db, `rooms/${state.roomCode}/tables/${idx}/character`), { flipped: !t.character?.flipped });
    };
  }
}
    if ((state.watching?.mission?.id|0) === 34) {
      // #34ï¼šéšŠé•·ãŒå ´ã«å‡ºã™ã€Œå‰ã€ã ã‘ã€ä»–äººã®æ­£ä½“ã‚«ãƒ¼ãƒ‰ã‚’ãƒ–ãƒ©ãƒ³ã‚¯å›ºå®š
      const capIdx = state?.watching?.captainTable;
      const center = Array.isArray(state?.watching?.m34_center) ? state.watching.m34_center : [];
      const capHasPlayed = (typeof capIdx === 'number') && center.some(o => (o?.by|0) === capIdx);

      if (!capHasPlayed && t.playerId !== state.userId) {
        char.removeAttribute('style');
        char.onclick = null;
        char.classList.add('blank');
      }
    }

charCol.appendChild(char);

// â˜… #13ï¼šåˆæœŸæƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚­ãƒ£ãƒ©ã®ã€Œä¸‹ã€ã«å°ã•ãè¡¨ç¤ºï¼ˆmeta.m13_header ã‚’ãã®ã¾ã¾ä½¿ã†ï¼‰
if (m13HeaderNum != null) {
  const tok = document.createElement('div');
  tok.className = 'token black';
  tok.textContent = String(m13HeaderNum);
  charCol.appendChild(tok);
}
if (Array.isArray(t.m22Tokens) && t.m22Tokens.length > 0) {
  const row = document.createElement('div');
  row.className = 'm22-under';
  t.m22Tokens.slice(0,3).forEach(nn=>{

    const d = document.createElement('div');
    d.className = 'token black';
    d.textContent = String(nn);
     d.style.cursor = 'default'; // èª¤èª˜å°ã‚’é˜²ãï¼ˆæ‰‹ã‚«ãƒ¼ã‚½ãƒ«ã«ã—ãªã„ï¼‰
    row.appendChild(d);
  });
  charCol.appendChild(row);
}
  // â˜… #50ï¼šæƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆç›´ä¸‹ã§ã¯ãªãã€Œã‚­ãƒ£ãƒ©ã‚«ãƒ¼ãƒ‰ã®ä¸‹ã€ã«é›†ç´„è¡¨ç¤ºï¼ˆ4åˆ—ã§æŠ˜è¿”ã—ï¼‰
  // â˜… #50ï¼šæƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆç›´ä¸‹ã§ã¯ãªãã€Œã‚­ãƒ£ãƒ©ã‚«ãƒ¼ãƒ‰ã®ä¸‹ã€ã«é›†ç´„è¡¨ç¤ºï¼ˆ4åˆ—ã§æŠ˜è¿”ã—ï¼‰
if ((v.mission?.id|0) === 50) {
  const nums = [];
  (t.hand||[]).forEach(c=>{
    if (c.open === true) return; // #50 å…¬é–‹åˆ†ã¯ã‚«ãƒ¼ãƒ‰ä¸‹ã¸ç§»å‹•ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯é›†è¨ˆã—ãªã„
    (c.tokens||[]).forEach(tk=>{
      if (tk?.type === 'num') nums.push( (parseInt(tk.value,10) || tk.value) );
    });
  });
  if (nums.length > 0) {
    const row = document.createElement('div');
    row.className = 'm50-under';
    nums.forEach(nn=>{
      const d = document.createElement('div');
      d.className = 'token black';
      d.textContent = String(nn);
      d.style.cursor = 'default';
      row.appendChild(d);
    });
    charCol.appendChild(row);

    // é«˜ã•èª¿æ•´ï¼š4åˆ—æŠ˜è¿”ã—ã«åˆã‚ã›ã¦å¿…è¦åˆ†ã ã‘ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ‹¡å¼µ
    const BASE=96, PERROW=3;
    const rows = Math.ceil(nums.length / PERROW);
    const extra = rows>0 ? (4 + rows*20 + Math.max(0, rows-1)*2) : 0; // 20px(ãƒˆãƒ¼ã‚¯ãƒ³) + è¡Œé–“
    applyTableHeight(box, Math.max(BASE, BASE + extra));  // â† æ—¢å­˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  }
}


    
content.appendChild(charCol);


    const hand=document.createElement('div'); hand.className='hand';
    (t.hand||[]).forEach((c,ci)=>{
            /* ç„¡åŠ¹ã‚«ãƒ¼ãƒ‰ã¯æç”»ã—ãªã„ï¼ˆ"undefined"è¡¨ç¤ºã®æ ¹çµ¶ï¼‰ */
      if (!c || (c.num == null && c?.kind!=='red' && c?.kind!=='yellow')) {
        console.warn('[hand] invalid card skipped', { table: idx, ci, card: c });
        return; // ä»¥é™ã®æç”»å‡¦ç†ã«å…¥ã‚‰ãªã„
      }
      const wrap=document.createElement('div'); wrap.className='card-wrap';
      const card=document.createElement('div'); card.className='card';
wrap.dataset.table = String(idx);
wrap.dataset.cardId = String(c.id||'');
      
      if (c.gone === true){
  wrap.classList.add('m42-gone');     // â˜… æ•°å­—ãƒ»ãƒˆãƒ¼ã‚¯ãƒ³ãªã©åˆ¥ãƒ¬ã‚¤ãƒ¤ã‚‚ã¾ã¨ã‚ã¦ä¸å¯è¦–
}
   
 const isMine = ((c.ownerId ?? t.playerId) === state.userId);

   const seated = (v?.tables||[]).some(T => T.playerId === state.userId);
      if (!seated) {
        if (!c.open) card.classList.add('back'); // æ•°å­—ã¯ .back CSS ã§éš ã‚Œã‚‹
      } else {
        /* â–¼â–¼ ç€å¸­å¾Œã®ã¿ #38/#56 ç‰¹åˆ¥è¡¨ç¤ºã‚’é©ç”¨ â–¼â–¼ */
        const mid = (state.watching?.mission?.id|0);
        const isM38 = (mid === 38);
        const isM56 = (mid === 56);
        const isM64 = (mid === 64);
        const isCaptainTable = (idx === (state.watching?.captainTable|0));
        const isRightmost = (ci === (t.hand||[]).length - 1);
        const hasX = Array.isArray(c.tokens) && c.tokens.some(tk => String(tk.type) === 'xmark');
        const m38Special = isM38 && isCaptainTable && isRightmost && hasX;
        const m56Special = isM56 && isRightmost && hasX; // å…¨ãƒ†ãƒ¼ãƒ–ãƒ«å¯¾è±¡
        const m64Special = isM64 && hasX;                // â˜… ä½ç½®ä¸å•ï¼šxmarkä»˜ãã¯ã€Œè‡ªåˆ†ã ã‘è£ã€
const ownerBlindSpecial = (m38Special || m56Special || m64Special);

        if (!c.open) {
          if (ownerBlindSpecial) {
            if (t.playerId === state.userId) {
              // éšŠé•·æœ¬äººï¼šè£ï¼ˆé»’èƒŒæ™¯ï¼‰
              card.classList.add('back');
            } else {
              // ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼šç°ï¼‹æ•°å­—ï¼ˆï¼è‡ªåˆ†ã®éå…¬é–‹æ‰‹æœ­ã®è¦‹ãˆæ–¹ï¼‰
              const numEl = document.createElement('div');
              numEl.className = 'num';
              numEl.textContent = String(c.num ?? '');
              card.appendChild(numEl);
              // èƒŒæ™¯ã¯ .card ã® #bbb ã‚’ãã®ã¾ã¾åˆ©ç”¨ï¼ˆback ã¯ä»˜ã‘ãªã„ï¼‰
            }
          } else if (!isMine) {
            // é€šå¸¸ã®ä»–äººã‚«ãƒ¼ãƒ‰ã¯è£
            card.classList.add('back');
          }
        }
      }

      if (c.open) card.classList.add('open');

      if (i2All?.selA && i2All.selA.cardId===c.id && i2All.selA.table===idx){ const m = document.createElement('div'); m.className='marker'; m.textContent='â–¼'; wrap.appendChild(m); }
      if (i2All?.selB && i2All.selB.cardId===c.id && i2All.selB.table===idx){ const m = document.createElement('div'); m.className='marker'; m.textContent='â–¼'; wrap.appendChild(m); }
   const m42s = state.watching?.meta?.m42Swap;
const showM42Swap = !!(m42s && m42s.usingBy === state.userId);
if (showM42Swap && m42s.selA && m42s.selA.cardId===c.id && m42s.selA.table===idx){ const m=document.createElement('div'); m.className='marker'; m.textContent='â–¼'; wrap.appendChild(m); }
if (showM42Swap && m42s.selB && m42s.selB.cardId===c.id && m42s.selB.table===idx){ const m=document.createElement('div'); m.className='marker'; m.textContent='â–¼'; wrap.appendChild(m); }

const m42m2 = state.watching?.meta?.m42M2;
const showM42M2 = !!(m42m2 && m42m2.usingBy === state.userId);
if (showM42M2 && m42m2.selA && m42m2.selA.cardId===c.id && m42m2.selA.table===idx){ const m=document.createElement('div'); m.className='marker'; m.textContent='â–¼'; wrap.appendChild(m); }
if (showM42M2 && m42m2.selB && m42m2.selB.cardId===c.id && m42m2.selB.table===idx){ const m=document.createElement('div'); m.className='marker'; m.textContent='â–¼'; wrap.appendChild(m); }
      if (i18All?.sel && i18All.sel.cardId===c.id && i18All.sel.table===idx){ const m=document.createElement('div'); m.className='marker'; m.textContent='â–¼'; wrap.appendChild(m); }
if (c.markUntil && now() < c.markUntil) {
  const isI2orI18 = (c.markSrc === 'i2' || c.markSrc === 'i18');  // â† 1)ã¨2)ã§ä»˜ã‘ãŸã‚¿ã‚°
  const canSee = isI2orI18 ? true : (c.markBy === state.userId);  // i2/18ã¯å…¨å“¡ã€ãã‚Œä»¥å¤–ã¯æœ¬äººã®ã¿
  if (canSee) {
    const m = document.createElement('div'); m.className = 'marker'; m.textContent = 'â–¼'; wrap.appendChild(m);
  }
}


      const isI2Actor = i2All && i2All.usingBy===state.userId;
      const canPickSelf  = isI2Actor && i2All?.phase==='pickSelf'  && t.playerId===state.userId;
      const canPickOther = isI2Actor && i2All?.phase==='pickOther' && t.playerId!==state.userId;

      const isI18Actor = i18All && i18All.usingBy===state.userId;
      const canI18Pick = isI18Actor && i18All?.phase==='pickOther' && t.playerId!==state.userId;

      if(isI2Actor && (canPickSelf || canPickOther)){
        card.classList.add('i2-selectable');
        card.onclick = async (ev)=>{
          ev.stopPropagation();
          if(canPickSelf){
            await update(ref(db, `rooms/${state.roomCode}/meta/i2Flow`), { selA:{table:idx, cardId:c.id}, phase:'pickOther' });
          }else if(canPickOther){
            await update(ref(db, `rooms/${state.roomCode}/meta/i2Flow`), { selB:{table:idx, cardId:c.id} });
openMenuAtClick([
  {label:'äº¤æ›ã™ã‚‹', action: async ()=>{
    const i2 = (await get(ref(db, `rooms/${state.roomCode}/meta/i2Flow`))).val();
    if(i2?.selA && i2?.selB) await doItem2Swap(i2.selA, i2.selB);
  }},
  {label:'ã‚„ã‚Šç›´ã™', action: async ()=>{
    await update(ref(db, `rooms/${state.roomCode}/meta`), { i2Flow:{usingBy:state.userId, phase:'pickSelf', selA:null, selB:null} });
  }}
]);

          }
        };
      }else if(canI18Pick){
        card.classList.add('i2-selectable');
        card.onclick = async (ev)=>{
          ev.stopPropagation();
          await update(ref(db, `rooms/${state.roomCode}/meta/i18Flow`), { sel:{table:idx, cardId:c.id} });
      openMenuAtClick([
  {label:'ã¨ã‚‹', action: async ()=>{ const i18=(await get(ref(db, `rooms/${state.roomCode}/meta/i18Flow`))).val(); if(i18?.sel) await doItem18Take(i18.sel); }},
  {label:'ã‚„ã‚Šç›´ã™', action: async ()=>{ await update(ref(db, `rooms/${state.roomCode}/meta/i18Flow`), { sel:null, phase:'pickOther' }); }}
]);

        };
      }else{
         card.onclick = async ()=>{
   if (state.watching?.meta?.m42_on || state.watching?.meta?.m42Swap?.on || state.watching?.meta?.m42M2?.on) return;
          if(isMine){
            const blockingI2 = i2All && i2All.usingBy===state.userId && (i2All.phase==='pickSelf' || i2All.phase==='pickOther');
            const blockingI18= i18All && i18All.usingBy===state.userId && (i18All.phase==='pickOther');
            if(blockingI2 || blockingI18) return;
            await update(ref(db, `rooms/${state.roomCode}/tables/${idx}/hand/${ci}`), {open: !c.open});
          }
        };
      }

      const num=document.createElement('div'); num.className='num';
            /*æœªå®šç¾©ã‚’æ–‡å­—åˆ— "undefined" ã§å‡ºã•ãªã„ */
      const hasNum = (c.num != null && !Number.isNaN(Number(c.num)));
      if (hasNum) {
        num.textContent = String(c.num);
        num.style.visibility = (c.open || isMine) ? 'visible' : 'hidden';
      } else {
        num.textContent = '';
        num.style.visibility = 'hidden';
        console.warn('[hand] card without visible num', { table: idx, ci, card: c });
      }
      card.appendChild(num);

      const bot=document.createElement('div'); bot.className='img-bottom';
      let img='codenumber.jpg'; if(c.kind==='red') img='redcode.png'; if(c.kind==='yellow') img='yellowcode.png';
      bot.style.backgroundImage=`url("./${img}")`; if(card.classList.contains('back')) bot.style.display='none';
      card.appendChild(bot);

const badge=document.createElement('div'); badge.className='badge-fixed';
const a=document.createElement('div'); a.className='alpha'; a.textContent=c.alpha||'';

const col=document.createElement('div'); col.className='tok-col';
const isM50 = ((state.watching?.mission?.id|0) === 50);
/* #50ï¼šå…¬é–‹ã‚«ãƒ¼ãƒ‰ã ã‘æ•°å­—ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚«ãƒ¼ãƒ‰ä¸‹ã¸ã€‚ãã‚Œä»¥å¤–ã¯å¾“æ¥ã©ãŠã‚Š */
if (!isM50 || (isM50 && c.open === true)) {
  (c.tokens||[]).forEach(tk=>{
    if (isM50 && tk?.type !== 'num') return; // #50 ã¯ num ã®ã¿
    const el = document.createElement('div');
    el.className = 'token ' + (tk.style || '');
    col.appendChild(el);

    const tokenText = (t)=>{
      switch(t.type){
        case 'equal':  return 'ï¼';
        case 'noteq':  return 'â‰ ';
        case 'x1':     return 'x1';
        case 'x2':     return 'x2';
        case 'x3':     return 'x3';
        case 'yellow': return 'â–§';
        case 'even':   return '2/4';
        case 'odd':    return '1/3';
        case 'xmark':  return 'âœ•';
        case 'num':    return String(t.value);
        default:       return String(t.value ?? '');
      }
    };
    el.textContent = tokenText(tk);
  });
}



      if(!(i2All && i2All.usingBy===state.userId) && !(i18All && i18All.usingBy===state.userId) && isMine){
        a.onclick=(ev)=>{
          ev.stopPropagation();
 const mid = (state.watching?.mission?.id|0);
    if (mid === 58) {
      // è¦–è¦šçš„ã«ç„¡åŠ¹ã£ã½ãã—ãŸã„å ´åˆï¼ˆä»»æ„ï¼‰
      // a.style.opacity = '0.6'; a.style.cursor = 'default';
      return; // â† ä½•ã‚‚ã—ãªã„ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‡ºã•ãªã„ï¼‰
    }

          const cardPath  = `rooms/${state.roomCode}/tables/${idx}/hand/${ci}`;
          const tokens = c.tokens || [];
          const has = (type)=> tokens.some(tk=>tk.type===type);
 const INCOMP_GROUP = new Set(['odd','even','x1','x2','x3','yellow']);
  const hasGroup = tokens.some(tk => INCOMP_GROUP.has(tk.type));
          const canEqual = !has('equal') && (counts.equal < caps.equal);
          const canNoteq = !has('noteq') && (counts.noteq < caps.noteq);
          const canNum   = !has('num');
          const canX1    = !has('x1') && (counts.x1 < caps.x1);

         const entries = [];

// â–¼ ãƒŸãƒƒã‚·ãƒ§ãƒ³å°‚ç”¨ï¼šãƒ•ãƒ©ã‚°å–å¾—
const flags = state.watching?.mission?.flags || {};
const myHand = (t.hand||[]).filter(cc => cc.ownerId===state.userId);
const countSame = myHand.filter(cc => cc.num===c.num).length;
 // ã“ã“ã‹ã‚‰è¿½åŠ ï¼š#40 ç•ªæ‰‹åˆ¥ã®ä½¿ç”¨è¨±å¯ï¼ˆxç³» or å¶å¥‡ï¼‰
 // ç•ªæ‰‹ï¼éšŠé•·ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’1ç•ªæ‰‹ã¨ã—ã¦æ™‚è¨ˆå›ã‚Šã« 1,2,3,â€¦
 const _m40 = ((state.watching?.mission?.id|0) === 40);
 const cap   = state.watching?.captainTable ?? 0;
 const total = (state.watching?.tables?.length||0);
 const order = ((idx - cap + total) % total) + 1; // 1å§‹ã¾ã‚Š
 // xç³»è¨±å¯ï¼š1,3,5ç•ªæ‰‹ï¼ å¶å¥‡è¨±å¯ï¼š2,4ç•ªæ‰‹ï¼ ãã‚Œä»¥å¤–ï¼ˆ6ç•ªæ‰‹ãªã©ï¼‰ã¯ã©ã¡ã‚‰ã‚‚ä¸å¯
 const USE_X      = (!!flags.useXTokens)   || (_m40 && [1,3,5].includes(order));
 const USE_PARITY = (!!flags.useParityToken)|| (_m40 && [2,4].includes(order));
const isColorCode = (c.kind === 'red' || c.kind === 'yellow');

 // é»„ã‚³ãƒ¼ãƒ‰ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆâ–§ï¼‰
if(!hasGroup && (flags.useYellowToken || c.kind === 'yellow')){
   entries.push({label:'â–§', action: async ()=>{
    // æ—¢ã«ã‚°ãƒ«ãƒ¼ãƒ—ãŒä»˜ã„ã¦ã„ãŸã‚‰ä½•ã‚‚ã—ãªã„ï¼ˆå¤šé‡é˜²æ­¢ã®æœ€çµ‚ã‚¬ãƒ¼ãƒ‰ï¼‰
    if (hasGroup || has('yellow')) return;
    const updated = [...tokens, {type:'yellow', value:'â–§', style:'yellow'}];
     await update(ref(db, cardPath), { tokens: updated });
     box.classList.add('elevated');
   }});
 }

 // x1/x2/x3ï¼ˆæ•°å­—ãƒãƒƒãƒ—ã‚’å‡ºã•ãªã„ãƒŸãƒƒã‚·ãƒ§ãƒ³ç”¨ï¼‰
if (!hasGroup && USE_X && !isColorCode){
   if(countSame===1) entries.push({label:'x1', action: async ()=>{
    if (hasGroup || has('x1')) return;
    const updated=[...tokens, {type:'x1', value:'x1', style:'x1'}];
     await update(ref(db, cardPath), { tokens: updated });
     box.classList.add('elevated');
   }});
   if(countSame===2) entries.push({label:'x2', action: async ()=>{
    if (hasGroup || has('x2')) return;
    const updated=[...tokens, {type:'x2', value:'x2', style:'x2'}];
     await update(ref(db, cardPath), { tokens: updated });
     box.classList.add('elevated');
   }});
   if(countSame===3) entries.push({label:'x3', action: async ()=>{
    if (hasGroup || has('x3')) return;
    const updated=[...tokens, {type:'x3', value:'x3', style:'x3'}];
     await update(ref(db, cardPath), { tokens: updated });
     box.classList.add('elevated');
   }});
 }

 // å¶æ•°/å¥‡æ•°ï¼ˆæ•°å­—ãƒãƒƒãƒ—ã‚’å‡ºã•ãªã„ãƒŸãƒƒã‚·ãƒ§ãƒ³ç”¨ï¼‰
if (!hasGroup && USE_PARITY && !isColorCode){
   const isEven = (c.num % 2)===0;
   if(isEven){
     entries.push({label:'2/4', action: async ()=>{
     if (hasGroup || has('even')) return;
      const updated=[...tokens, {type:'even', value:'2/4', style:'even'}];
       await update(ref(db, cardPath), { tokens: updated });
       box.classList.add('elevated');
     }});
   }else{
     entries.push({label:'1/3', action: async ()=>{
      if (hasGroup || has('odd')) return;
      const updated=[...tokens, {type:'odd', value:'1/3', style:'odd'}];
       await update(ref(db, cardPath), { tokens: updated });
       box.classList.add('elevated');
     }});
   }
 }


/* ã“ã“ã‹ã‚‰è¿½åŠ ï¼š#52 æ•°å­—ãƒˆãƒ¼ã‚¯ãƒ³ãƒãƒƒãƒ—ï¼ˆé€šå¸¸=è‡ªæ•°ã ã‘é™¤å¤–ï¼èµ¤=å…¨ã¦å¯ï¼‰ */
const _m52 = ((state.watching?.mission?.id|0) === 52);
if (_m52 && canNum && (c.kind==='normal' || c.kind==='red')) {
  for (let nn = 1; nn <= 12; nn++) {
    if (c.kind === 'normal' && nn === (c.num|0)) continue; // é€šå¸¸ã¯ä¸Šã®æ•°ã ã‘é™¤å¤–
    entries.push({
      label: String(nn),
      action: async ()=>{
        const updated = [ ...(tokens), { type:'num', value: nn, style:'black' } ];
        await update(ref(db, cardPath), { tokens: updated });
        box.classList.add('elevated');
      }
    });
  }
}
          
const suppressNumberPop = (c.kind !== 'normal') || !!flags.useYellowToken || !!flags.useXTokens || !!flags.useParityToken;
 const m40 = ((state.watching?.mission?.id|0) === 40);
 const suppressNumberPop_m40 = suppressNumberPop || m40;
// â–¼ æ•°å­—ãƒãƒƒãƒ—ã®å‡ºã—æ–¹ï¼ˆé€šå¸¸ or #17 éšŠé•·ç”¨ï¼‰
const isCaptain = (state.watching?.captainTable|0) === idx;
if(!_m52 && !suppressNumberPop_m40 && canNum){  if(v.mission?.flags?.m17_captainInverseNumberPop && isCaptain){
    // éšŠé•·ã¯ã€Œè‡ªåˆ†ã®ã‚«ãƒ¼ãƒ‰æ•°å€¤ ä»¥å¤–ã€ã® 1..12 ã‚’å€™è£œã«ã™ã‚‹
    for(let nn=1; nn<=12; nn++){
      if(nn===c.num) continue;
      entries.push({label:String(nn), action: async ()=>{
        const updated=[...(tokens), {type:'num', value:nn, style:'black'}];
        await update(ref(db, cardPath), { tokens: updated });
        box.classList.add('elevated');
      }});
    }
  }else{
    // é€šå¸¸ï¼šãã®ã‚«ãƒ¼ãƒ‰ã®æ•°å­—
    entries.push({label:String(c.num), action: async ()=>{
      const updated=[...(tokens), {type:'num', value:c.num, style:'black'}];
      await update(ref(db, cardPath), { tokens: updated });
      await consumeM22IfMatches(idx, c.num);   // â† è¿½åŠ 
      box.classList.add('elevated');
    }});
  }
}

          // ï¼ï¼ˆã‚¢ã‚¤ãƒ†ãƒ 12ç®¡ç†ï¼‰
          if (has('equal')) {
            entries.push({
              label:'ï¼',
              action: async ()=>{
                openMenu(ev.clientX, ev.clientY, [
                  { label:'æ¶ˆã™', action: async ()=>{
                      const next = tokens.filter(tk=>tk.type!=='equal');
                      await update(ref(db, cardPath), { tokens: next });
                      await incToken('equal', -1);
                      const afterHas = (t.hand||[]).some(cc => (cc.tokens||[]).length>0);
                      box.classList.toggle('elevated', afterHas);
                    }},
                  { label:String(c.num), action: async ()=>{
                      if(!has('num')){
                        const next=[...(tokens), {type:'num', value:c.num, style:'black'}];
                        await update(ref(db, cardPath), { tokens: next });
                        box.classList.add('elevated');
                      }
                    }}
                ]);
              }
            });
          } else if (canEqual){
            entries.push({label:'ï¼', action: async ()=>{
              const updated=[...(tokens), {type:'equal', value:c.num, style:'equal'}];
              await update(ref(db, cardPath), { tokens: updated });
              await incToken('equal', +1);
              box.classList.add('elevated');
            }});
          }

          // â‰ ï¼ˆã‚¢ã‚¤ãƒ†ãƒ 1ç®¡ç†ï¼‰
          if (has('noteq')) {
            entries.push({
              label:'â‰ ',
              action: async ()=>{
                openMenu(ev.clientX, ev.clientY, [
                  { label:'æ¶ˆã™', action: async ()=>{
                      const next = tokens.filter(tk=> tk.type!=='noteq');
                      await update(ref(db, cardPath), { tokens: next });
                      await incToken('noteq', -1);
                      const afterHas = (t.hand||[]).some(cc => (cc.tokens||[]).length>0);
                      box.classList.toggle('elevated', afterHas);
                    }},
                  { label:String(c.num), action: async ()=>{
                      if(!has('num')){
                        const next=[...(tokens), {type:'num', value:c.num, style:'black'}];
                        await update(ref(db, cardPath), { tokens: next });
                        box.classList.add('elevated');
                      }
                    }}
                ]);
              }
            });
          } else if (canNoteq){
            entries.push({
              label:'â‰ ',
              action: async ()=>{
                const updated=[...(tokens), {type:'noteq', value:c.num, style:'noteq'}];
                await update(ref(db, cardPath), { tokens: updated });
                await incToken('noteq', +1);
                box.classList.add('elevated');
              }
            });
          }

if (canX1 && c.kind === 'normal'){
            entries.push({label:'x1', action: async ()=>{
              const updated=[...(tokens), {type:'x1', value:c.num, style:'x1'}];
              await update(ref(db, cardPath), { tokens: updated });
              await incToken('x1', +1);
              box.classList.add('elevated');
            }});
          }
          // x1 ã‚’æ—¢ã«æŒã£ã¦ã„ã‚‹å ´åˆï¼š
          // 1) x1ãƒãƒƒãƒ—ã¯è¡¨ç¤ºã—ãªã„
          // 2) æ•°å­—ï¼ˆnumï¼‰ã‚’æ¶ˆã™ã®ã¿è¡¨ç¤ºï¼ˆnum ãŒã‚ã‚‹æ™‚ã ã‘ï¼‰

          if(tokens.length>0){
tokens.forEach((tk,ti)=>{
  const tokenText =
    tk.type === 'equal'  ? 'ï¼' :
    tk.type === 'noteq'  ? 'â‰ ' :
    tk.type === 'x1'     ? 'x1' :
    (tk.value != null)   ? String(tk.value) :
    (c?.num != null)     ? String(c.num) : '';

  const label = `${tokenText} ã‚’æ¶ˆã™`;
            
              entries.push({label, action: async ()=>{
                const next = tokens.slice(); const removed = next.splice(ti,1)[0];
                await update(ref(db, cardPath), { tokens: next });
                if(removed?.type==='equal') await incToken('equal', -1);
                if(removed?.type==='noteq') await incToken('noteq', -1);
                if(removed?.type==='x1')    await incToken('x1', -1);
                const afterHas = (t.hand||[]).some(cc => (cc.tokens||[]).length>0);
                box.classList.toggle('elevated', afterHas);
              }});
            });
          }

          openMenu(ev.clientX, ev.clientY, entries);
        };
      }

      badge.appendChild(a);
      badge.appendChild(col);

      wrap.appendChild(card);
      wrap.appendChild(badge);
      hand.appendChild(wrap);
    });
    content.appendChild(hand);
    box.appendChild(content);

    const hasToken = (t.hand||[]).some(c=> (c.tokens||[]).length>0);
    box.classList.toggle('elevated', hasToken);

    tablesEl.appendChild(box);
      growForCardTokens(box);

  });

  /* â˜… #22ï¼šé»„ã‚«ãƒ¼ãƒ‰ãŒã€Œå…¬é–‹ã€ã•ã‚ŒãŸæšæ•°ãŒ2æšä»¥ä¸Šã«ãªã£ãŸç¬é–“ã«è¡¨ã‚’å‡ºã™ï¼ˆç¨®é¡ã§ã¯ãªãæšæ•°ï¼‰ */
  if (v.mission?.flags?.m22_showTableAfter2Yellows) {
    let openYellowCount = 0;
    (v.tables||[]).forEach(T=>{
      (T.hand||[]).forEach(c=>{
        if(c?.kind==='yellow' && c.open===true){
          openYellowCount += 1;
        }
      });
    });

    const alreadyShown = !!v.meta?.m22_infoShown;
    if (openYellowCount >= 2 && !alreadyShown) {
      // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥é˜²æ­¢ï¼šæç”»ã¯æ¬¡ã® onValue ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ä»»ã›ã‚‹
      update(ref(db, `rooms/${state.roomCode}/meta`), { m22_infoShown: true });
        showInfo22Panel(state.watching || v); // â† ä¸€åº¦ã ã‘æ˜ç¤ºçš„ã«å‡ºã™
    }
  }
  renderM22PickPanel(v);

    // â˜… #27ï¼šé»„ã‚³ãƒ¼ãƒ‰ãŒ2æœ¬å…¬é–‹ã•ã‚ŒãŸã‚‰ã€ã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ç›´ä¸‹ã«æç¤ºç”¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‡ºã™
  if (v.mission?.flags?.m27_poolAfter2Yellows) {
    // é»„å…¬é–‹æšæ•°ã‚’å†åˆ©ç”¨ã—ã¦åˆ¤å®š
    let yOpen = 0;
    (v.tables||[]).forEach(T=>{
      (T.hand||[]).forEach(c=>{
        if (c?.kind==='yellow' && c.open===true) yOpen += 1;
      });
    });
    // åˆå›ã ã‘ãƒ—ãƒ¼ãƒ«ã‚’ä½œã£ã¦DBã¸ä¿å­˜
    const shown = !!v.meta?.m27_shown;
    if (yOpen >= 2 && !shown) {
      ensureM27Candidates(v).then(()=> renderM27Row(state.watching || v));
    } else {
      // æ—¢ã«ç”¨æ„æ¸ˆã¿ãªã‚‰æ¯æç”»ã§åŒæœŸ
      renderM27Row(v);
    }
  }

  // â–¼ #13 ãƒ˜ãƒƒãƒ€ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³ã®é…å»¶ä¸€æ‹¬æ›´æ–°ï¼ˆæ¬¡tickã§å®Ÿè¡Œ...ï¼‰
// â–¼ #13 ãƒ˜ãƒƒãƒ€ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³ã®é…å»¶ä¸€æ‹¬æ›´æ–°ï¼ˆæ¬¡tickã§å®Ÿè¡Œï¼‰
if (!m13HeaderUpdateScheduled && m13HeaderClearIndices && m13HeaderClearIndices.size > 0) {
  m13HeaderUpdateScheduled = true;
  setTimeout(async () => {
    try {
      const indices = Array.from(m13HeaderClearIndices);
      m13HeaderClearIndices = null;
      m13HeaderUpdateScheduled = false;

      // ç¾åœ¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼é…åˆ—ã‚’å–å¾—ã—ã¦ã€å¯¾è±¡ index ã‚’ null ã«ã™ã‚‹
      const snap = await get(ref(db, `rooms/${state.roomCode}/meta/m13_header`));
      const currentHeader = (snap.val() || []).slice();
      indices.forEach(i => {
        if (i >= 0 && i < currentHeader.length) currentHeader[i] = null;
      });

      await update(ref(db, `rooms/${state.roomCode}/meta`), { m13_header: currentHeader });
    } catch (e) {
      console.error('m13 header clear failed', e);
    }
  }, 0);
}

async function incToken(kind, delta){
  try {
    const path = `rooms/${state.roomCode}/meta/tokenCounts`;
    const snap = await get(ref(db, path));
    const prev = snap.val() || { equal:0, noteq:0, x1:0 };
    const next = { ...prev, [kind]: Math.max(0, (prev[kind] || 0) + delta) };
    await set(ref(db, path), next);
  } catch (e) {
    console.error('incToken failed', e);
  }
}

}
function renderM22PickPanel(v){
  // ãƒŸãƒƒã‚·ãƒ§ãƒ³22ä»¥å¤–ã¯æ¶ˆã™
  if (!v?.mission?.id || v.mission.id !== 22) {
    if (m22PickPanel) m22PickPanel.classList.add('hidden');
    return;
  }
  // è‡ªåˆ†ãŒæœªç€å¸­ãªã‚‰æ¶ˆã™
  const myIdx = (v.tables||[]).findIndex(T => T.playerId === state.userId);
  if (myIdx < 0) { if (m22PickPanel) m22PickPanel.classList.add('hidden'); return; }

  const myTable = v.tables[myIdx] || {};
  // ã™ã§ã«å®Œäº†ã—ã¦ã„ã‚‹ãªã‚‰è¡¨ç¤ºã—ãªã„
  if (myTable.m22Done) { m22PickPanel.classList.add('hidden'); return; }

  // æ‰‹æœ­ã«ã‚ã‚‹æ•´æ•°ã®é›†åˆ
  const myHandInts = new Set((myTable.hand||[])
    .filter(c => Number.isInteger(c.num))
    .map(c => c.num|0));

  // å€™è£œ = 1..12 ã‹ã‚‰æ‰‹æœ­ã«ç„¡ã„æ•°å­—
  const candidates = [];
  for (let n=1; n<=12; n++) if (!myHandInts.has(n)) candidates.push(n);

  // æ—¢ã«è‡ªåˆ†ãŒé¸ã‚“ã ãƒˆãƒ¼ã‚¯ãƒ³
  const picked = Array.isArray(myTable.m22Tokens) ? myTable.m22Tokens.slice(0,2) : [];
  const pickedSet = new Set(picked);

  // ä¸Šé™ï¼šå€™è£œãŒ1ã¤ãªã‚‰1ã€2ã¤ä»¥ä¸Šãªã‚‰2
  const maxPick = Math.min(2, candidates.length);

  // ã‚‚ã†å¿…è¦æ•°é¸ã³çµ‚ã‚ã£ã¦ãŸã‚‰é–‰ã˜ã‚‹ï¼ˆä»–ç«¯æœ«ã§åŒæœŸã—ã¦ã„ã¦ã‚‚OKï¼‰
  if (picked.length >= maxPick) {
    // DBã«ã‚‚å®Œäº†ãƒ•ãƒ©ã‚°ã‚’æ®‹ã™ï¼ˆå†è¡¨ç¤ºé˜²æ­¢ï¼‰
    update(ref(db, `rooms/${state.roomCode}/tables/${myIdx}`), { m22Done: true });
    m22PickPanel.classList.add('hidden');
    return;
  }

  // æç”»
  m22PickPanel.innerHTML = '<span class="cap">æœªæ‰€æŒã®æ•°å­—ã‹ã‚‰æœ€å¤§2ã¤é¸æŠï¼š</span>';
  candidates.forEach(nn=>{
    const d = document.createElement('div');
    d.className = 'token black' + (pickedSet.has(nn) ? ' disabled' : '');
    d.textContent = String(nn);
    d.onclick = async ()=>{
      if (pickedSet.has(nn)) return;           // æ—¢ã«é¸æŠæ¸ˆã¿
      if (picked.length >= maxPick) return;    // ä¸Šé™

      const next = picked.concat(nn);

      // é¸ã³åˆ‡ã£ãŸã‚‰ï¼šm22Tokens + m22Done ã‚’åŒæ™‚ã«ä¿å­˜ â†’ ãƒ‘ãƒãƒ«ã‚’å³éè¡¨ç¤º
      if (next.length >= maxPick) {
        await update(ref(db, `rooms/${state.roomCode}/tables/${myIdx}`), {
          m22Tokens: next,
          m22Done: true
        });
        m22PickPanel.classList.add('hidden');
      } else {
        // ã¾ã ä¸Šé™ã«é”ã—ã¦ã„ãªã„ï¼šé¸æŠã ã‘ä¿å­˜ã—ã¦ç¶šè¡Œ
        await update(ref(db, `rooms/${state.roomCode}/tables/${myIdx}`), { m22Tokens: next });
      }
    };
    m22PickPanel.appendChild(d);
  });

  m22PickPanel.classList.remove('hidden');
}


  
/* ï¼š#29 æç”»ãƒ»æ“ä½œãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼ */
function renderM29(v){
  const isM29 = (v?.mission?.id|0) === 29;
  // æ—¢å­˜è¡Œã®æƒé™¤
  const oldHand = document.getElementById('m29HandRow');
  const oldCenter = document.getElementById('m29CenterRow');
  if (!isM29) { if (oldHand) oldHand.remove(); if (oldCenter) oldCenter.remove(); return; }


  
  // è‡ªåˆ†ã®å¸­
  const myIdx = (v.tables||[]).findIndex(T => T.playerId === state.userId);
  const myHand = (myIdx>=0) ? (v.tables[myIdx]?.m29Hand||[]) : [];

  // ---- è‡ªåˆ†ã®æ‰‹æœ­ï¼ˆç”»é¢ä¸‹éƒ¨ï¼šãƒŸãƒƒã‚·ãƒ§ãƒ³è©³ç´°ã®ä¸Šï¼‰ ----
  const footer = document.getElementById('missionFooter');
  if (footer) {
    // ã„ã£ãŸã‚“æ—¢å­˜ã‚’æ¶ˆã™
    const ex = document.getElementById('m29HandRow'); if (ex) ex.remove();
    if (myIdx>=0 && myHand.length>0) {
      const row = document.createElement('div');
      row.id = 'm29HandRow';
      row.className = 'numlane';
      row.style.marginTop = '4px';
      // å„ã‚«ãƒ¼ãƒ‰
      myHand.forEach(n=>{
        const c = document.createElement('div');
        c.className = 'numcard';
         /* ã“ã“ã‹ã‚‰è¿½åŠ ï¼šæ•°å€¤ã‚«ãƒ¼ãƒ‰ã®è¡¨é¢ã¯ç”»åƒã‚’ä½¿ç”¨ */
       c.style.backgroundImage = `url('${imgNumber(n)}')`;
       c.style.backgroundSize = 'cover';
       c.style.backgroundPosition = 'center';
        c.title = 'å ´ã«å‡ºã™';
c.onclick = (ev)=>{
  // ã‚¯ãƒªãƒƒã‚¯å³å®Ÿè¡Œã§ã¯ãªãã€ã¾ãšç¢ºèªãƒãƒƒãƒ—ã‚’è¡¨ç¤º
  openMenu(ev.clientX, ev.clientY, [
    {
      label: `å ´ã«å‡ºã™`,
      action: async ()=>{
        try{
          // DBã‹ã‚‰å†å–å¾—ã—ã¦å®‰å…¨ã«æ›´æ–°
          const tRef = ref(db,
 `rooms/${state.roomCode}/tables/${myIdx}`);
          const mRef = ref(db, `rooms/${state.roomCode}`);
          const [tSnap, rSnap] = await Promise.all([get(tRef), get(mRef)]);
          const T = tSnap.val()||{};
          const R = rSnap.val()||{};
          const hand0 = Array.isArray(T.m29Hand) ? T.m29Hand.slice() : [];
          const pos   = hand0.indexOf(n);
          if (pos<0) return;

          // 1) å‡ºã™ï¼šæ‰‹æœ­ã‹ã‚‰æŠœã„ã¦ã‚»ãƒ³ã‚¿ãƒ¼ã¸
          hand0.splice(pos,1);
          const center = Array.isArray(R.m29_center) ? R.m29_center.slice() : [];
          center.push({ n, by: myIdx, faceUp:false });

          // 2) è‡ªå‹•ãƒ‰ãƒ­ãƒ¼ï¼šæ‰‹æœ­ãŒ1æšä»¥ä¸‹ãªã‚‰æ®‹ã‚Šå±±ã‹ã‚‰1æš
          let drew = false;
          let nextHand = hand0.slice();
          if (nextHand.length <= 1) {
            let deck = Array.isArray(R.m29_deck) ? R.m29_deck.slice() : [];
            if (deck.length > 0) {
              const d = deck.shift();
              nextHand.push(d);
              drew = true;
              // m29_deck ã‚’æ›¸ãæˆ»ã™
              await update(ref(db, `rooms/${state.roomCode}`), { m29_deck: deck });
            }
          }

          // 3) DB æ›´æ–°ï¼ˆæ‰‹æœ­ãƒ»ã‚»ãƒ³ã‚¿ãƒ¼ï¼‰
          await Promise.all([
            update(tRef, { m29Hand: nextHand }),
            update(ref(db, `rooms/${state.roomCode}`), { m29_center: center })
          ]);

          // 4) UIï¼šåå‰å³ã®æšæ•°è¡¨ç¤ºã®å³ã«ã€Œ+1ã€ã‚’3ç§’å‡ºã™
          if (drew) {
            const id = `m29cnt-${myIdx}`;
            const anchor = document.getElementById(id);
            if (anchor && anchor.parentNode) {
              const badge = document.createElement('span');
              badge.textContent = '+1';
              badge.style.marginLeft = '2px';
              badge.style.color = '#22c55e';
              badge.style.transition = 'opacity .3s linear';
              anchor.after(badge);
              setTimeout(()=>{ badge.style.opacity='0'; setTimeout(()=>badge.remove(), 300); }, 2700);
            }
          }
        }catch(e){ console.error(e); }
      }
    }
  ]);
};

        row.appendChild(c);
      });
      // ãƒŸãƒƒã‚·ãƒ§ãƒ³è©³ç´°ã‚¿ã‚¤ãƒˆãƒ«ã®ç›´å‰ã«å·®ã—è¾¼ã‚€
      const title = document.getElementById('missionDetailTitle');
      if (title && title.parentNode === footer) {
        footer.insertBefore(row, title);
      } else {
        footer.appendChild(row);
      }
    }
  }

  // ---- ã‚»ãƒ³ã‚¿ãƒ¼ï¼ˆã‚¢ã‚¤ãƒ†ãƒ ä¸‹ãƒ»ä¸­å¤®å¯„ã›ï¼‰ ----
  const bar = document.getElementById('itemsBar');
  if (!bar) return;
  { const ex = document.getElementById('m29CenterRow'); if (ex) ex.remove(); }

  const center = Array.isArray(v.m29_center) ? v.m29_center : [];
  // â˜…è¿½åŠ ï¼šå…¬é–‹ä¸­â€œã‚³ãƒ¼ãƒ‰â€ã®æ•°å­—åˆ¥å…¬é–‹æšæ•°ã‚’é›†è¨ˆï¼ˆkind:'normal' ã‹ã¤ open:trueï¼‰
const openCountByNum = {};
(v.tables||[]).forEach(T=>{
  (T.hand||[]).forEach(c=>{
    if (c?.kind === 'normal' && c.open === true){
      const num = c.num|0;
      openCountByNum[num] = (openCountByNum[num]||0) + 1;
    }
  });
});

if (state.isHost) ensureM29AutoDrop(v);
if (center.length > 0) {
  const row = document.createElement('div');
  row.id = 'm29CenterRow';
  row.className = 'numlane';
row.style.justifyContent = 'flex-start'; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‰æã§å·¦å¯„ã›
row.style.scrollBehavior = 'smooth';
  // ã€Œé‡ã­å¯¾è±¡ã€ã¨ã€Œé€šå¸¸è¡¨ç¤ºã€ã«æŒ¯ã‚Šåˆ†ã‘
  const stackTargets = [];
  const others = [];
  center.forEach((obj, idx) => {
    const isStack = (obj?.faceUp === true) && ((openCountByNum[obj.n] | 0) >= 4);
    (isStack ? stackTargets : others).push({ obj, idx });
  });

  // â–¼ é‡ã­å¯¾è±¡ãŒã‚ã‚Œã°ã€1ç®‡æ‰€ã«â€œå±±â€ã¨ã—ã¦é‡ã­ã¦è¡¨ç¤º
// â–¼ é‡ã­å¯¾è±¡ãŒã‚ã‚Œã°ã€1ç®‡æ‰€ã«â€œå±±â€ã¨ã—ã¦é‡ã­ã¦è¡¨ç¤º
if (stackTargets.length > 0) {
  const holder = document.createElement('div');
  holder.className = 'numcard-holder';

  // 1æšç›®ã¯åŸºæº–ã€ä»¥é™ã¯ã€Œå·¦ã« +2px ãšã‚‰ã™ã€ï¼æ¨ªæ–¹å‘ã®ã¿ã§é‡ã­ã‚‹
  const baseW = 32;  // .numcard ã®å¹…ã«åˆã‚ã›ã‚‹
  const step  = 2;   // 1æšé‡ãªã‚‹ã”ã¨ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ(px)

  // â˜…è¿½åŠ ï¼šå†…å®¹å¹…ã«åˆã‚ã›ã¦ãƒ›ãƒ«ãƒ€ãƒ¼è‡ªä½“ã®å¹…ã‚’æ‹¡ã’ã‚‹ï¼ˆ= ã¯ã¿å‡ºã—â†’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ï¼‰
  const totalW = baseW + step * Math.max(0, stackTargets.length - 1);
  holder.style.width = `${totalW}px`;

  stackTargets.forEach(({ obj, idx }, k) => {
    const cell = document.createElement('div');
    cell.className = (k === 0) ? 'numcard' : 'numcard overlay';
    cell.style.display = 'grid';
    cell.style.placeItems = 'center';
    cell.style.fontWeight = 'bold';

    // æ•°å€¤ç”»åƒï¼ˆfaceUpå‰æï¼‰
    cell.style.backgroundImage = `url('${imgNumber(obj.n)}')`;
    cell.style.backgroundSize = 'cover';
    cell.style.backgroundPosition = 'center';

    // â–¼ æ®µå·®ï¼ˆk=0ã¯åŸºæº–ã€ä»¥é™ã¯ 2px åˆ»ã¿ã§ã€Œæ¨ªã¸ã€ãšã‚‰ã™ï¼‰
    if (k > 0) {
      const off = step * k;
      cell.style.position = 'absolute';
      cell.style.left     = `${off}px`;
cell.style.top      = `${off}px`; 
      cell.style.opacity  = `${Math.max(0.6, 1 - 0.05 * k)}`;
      cell.style.zIndex   = String(100 + k);
    }

    // â–¼ ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ã¯å…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãã®ã¾ã¾é©ç”¨
    const willDiscardOnly = false; // ï¼ˆM29ã¯æ¨ã¦ç„¡åŠ¹ï¼‰
    cell.title = obj.faceUp ? 'å‡ºã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ¬¡ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ç§»ã™' : 'ã‚ãã‚‹';    cell.onclick = async (ev) => { try {
      const rRef  = ref(db, `rooms/${state.roomCode}`);
      const rSnap = await get(rRef);
      const R     = rSnap.val() || {};
      const cur   = Array.isArray(R.m29_center) ? R.m29_center.slice() : [];

      if (idx < 0 || idx >= cur.length) return;
      const curObj = cur[idx];
      if (!curObj) return;

      if (!curObj.faceUp) {
        // è¡¨ã«ã™ã‚‹
        cur[idx] = { ...curObj, faceUp: true };
        await update(rRef, { m29_center: cur });
        if (state.isHost) {
          const rSnap2 = await get(rRef);
          ensureM29AutoDrop(rSnap2.val() || {});
        }
      } else {
        // 4æšå…¬é–‹æ¸ˆãªã‚‰æ¸¡ã›ãªã„
        const already4 = ((openCountByNum[curObj.n] | 0) >= 4);
        if (((state?.watching?.mission?.id | 0) === 29) && already4) {
          openOneMini(ev.clientX, ev.clientY, 'æ¸¡ã›ã¾ã›ã‚“ï¼ˆã“ã®æ•°å­—ã¯4æšå…¬é–‹æ¸ˆï¼‰');
          return;
        }
        // æ¬¡ãƒ†ãƒ¼ãƒ–ãƒ«ã¸
        const toIdx = ((curObj.by | 0) + 1) % (v.tableCount | 0);
        const tRef  = ref(db, `rooms/${state.roomCode}/tables/${toIdx}`);
        const tSnap = await get(tRef);
        const T2    = tSnap.val() || {};
        const hand  = Array.isArray(T2.m29Hand) ? T2.m29Hand.slice() : [];
        hand.push(curObj.n);
        cur.splice(idx, 1);
        await Promise.all([
          update(tRef, { m29Hand: hand }),
          update(rRef, { m29_center: cur }),
        ]);
      }
    } catch(e){ console.error(e); } };

    holder.appendChild(cell);
  });

 // â–¼ holderã®â€œè¦‹ã‹ã‘ã®å¹…/é«˜ã•â€ã‚’ã€é‡ã­æšæ•°ã«å¿œã˜ã¦æ‹¡å¼µï¼ˆM18æº–æ‹ ï¼‰
const extra = step * Math.max(0, stackTargets.length - 1);
holder.style.width  = `${baseW + extra}px`;
holder.style.height = `${48 + extra}px`;   // M18åŒæ§˜ï¼šç¸¦æ–¹å‘ã®é‡ãªã‚Šåˆ†ã ã‘å™¨ã‚’ä¼¸ã°ã™
row.style.marginBottom = `${extra}px`;     // æ¬¡ã®è¡Œã¨å¹²æ¸‰ã—ãªã„ã‚ˆã†ä½™ç™½ã‚’è¿½åŠ 


  // é‡ã­å±±ã¯è¡Œã®å·¦å´ã«é…ç½®
row.insertBefore(holder, row.firstChild);

// è¿½åŠ ï¼šé‡ãªã‚ŠãŒå¢—ãˆãŸã‚‰å³ç«¯ã¾ã§è‡ªå‹•ã‚¹ãƒ©ã‚¤ãƒ‰
requestAnimationFrame(() => {
  row.scrollLeft = row.scrollWidth;
});

  // â–¼ è¿½åŠ ï¼šé‡ãªã‚ŠãŒå¢—ãˆãŸã‚‰ã€è¡Œã®å³ç«¯ã¾ã§è‡ªå‹•ã‚¹ãƒ©ã‚¤ãƒ‰ï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰
  requestAnimationFrame(() => {
    row.scrollLeft = row.scrollWidth;
  });
}
  // â–¼ é‡ã­å¯¾è±¡ä»¥å¤–ã¯å¾“æ¥ã©ãŠã‚Šâ€œæ¨ªä¸¦ã³â€ã§è¡¨ç¤º
  others.forEach(({ obj, idx }) => {
    const cell = document.createElement('div');
    cell.className = 'numcard';
    cell.style.display = 'grid';
    cell.style.placeItems = 'center';
    cell.style.fontWeight = 'bold';

    if (obj.faceUp) {
      cell.style.backgroundImage = `url('${imgNumber(obj.n)}')`;
      cell.style.backgroundSize = 'cover';
      cell.style.backgroundPosition = 'center';
    } else {
      cell.style.backgroundImage = "url('./numbercardback.jpg')";
      cell.style.backgroundSize = 'cover';
      cell.style.backgroundPosition = 'center';
    }

    const willDiscardOnly = false; // ï¼ˆM29ã¯æ¨ã¦ç„¡åŠ¹ï¼‰
    cell.title = obj.faceUp ? 'å‡ºã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ¬¡ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ç§»ã™' : 'ã‚ãã‚‹';
    cell.onclick = async (ev) => { try {
      const rRef  = ref(db, `rooms/${state.roomCode}`);
      const rSnap = await get(rRef);
      const R     = rSnap.val() || {};
      const cur   = Array.isArray(R.m29_center) ? R.m29_center.slice() : [];

      if (idx < 0 || idx >= cur.length) return;
      const curObj = cur[idx];
      if (!curObj) return;

      if (!curObj.faceUp) {
        cur[idx] = { ...curObj, faceUp: true };
        await update(rRef, { m29_center: cur });
        if (state.isHost) {
          const rSnap2 = await get(rRef);
          ensureM29AutoDrop(rSnap2.val() || {});
        }
      } else {
        const already4 = ((openCountByNum[curObj.n] | 0) >= 4);
        if (((state?.watching?.mission?.id | 0) === 29) && already4) {
          openOneMini(ev.clientX, ev.clientY, '');
          return;
        }
        const toIdx = ((curObj.by | 0) + 1) % (v.tableCount | 0);
        const tRef  = ref(db, `rooms/${state.roomCode}/tables/${toIdx}`);
        const tSnap = await get(tRef);
        const T2    = tSnap.val() || {};
        const hand  = Array.isArray(T2.m29Hand) ? T2.m29Hand.slice() : [];
        hand.push(curObj.n);
        cur.splice(idx, 1);
        await Promise.all([
          update(tRef, { m29Hand: hand }),
          update(rRef, { m29_center: cur }),
        ]);
      }
    } catch(e){ console.error(e); } };

    row.appendChild(cell);
  });

bar.insertAdjacentElement('afterend', row);
// â˜…è¿½åŠ ï¼šé‡ãªã‚Šæšæ•°ã«å¿œã˜ã¦è‡ªå‹•ã‚¹ãƒ©ã‚¤ãƒ‰ï¼ˆå³ç«¯ã¸ï¼‰
requestAnimationFrame(()=>{
  try{
    row.scrollTo({ left: row.scrollWidth, behavior: 'smooth' });
  }catch(_){}
});
}
}

function renderM26(v){
  const mid = (v?.mission?.id|0);
  const isTarget = (mid === 26 || mid === 47);   // â† ã“ã“ã ã‘è¿½åŠ ãƒ»å¤‰æ›´
  const old   = document.getElementById('m26Grid');

  // 26/47 ä»¥å¤–ãªã‚‰æ¶ˆã™ã ã‘
  if (!isTarget){ if (old) old.remove(); return; }

  // ã‚¢ã‚¤ãƒ†ãƒ å¸¯ãŒã¾ã æç”»ã•ã‚Œã¦ã„ãªã„ç¬é–“ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ¬¡ã® onValue ã§æç”»ï¼‰
  const bar = document.getElementById('itemsBar');
  if (!bar) return;

  // ã¾ã æœªè¨­ç½®ãªã‚‰è¨­ç½®
  if (!old) {
    mountM26GridUnderItems();     // â† é–¢æ•°åã‚‚ id ã‚‚ãã®ã¾ã¾æµç”¨ã§OK
    return; // æ¬¡ã® onValue ã§ _sync ãŒèµ°ã‚‹
  }

  // æ—¢ã«ã‚ã‚‹å ´åˆã¯æœ€æ–° state ã«åˆã‚ã›ã¦å†åŒæœŸ
  old._sync && old._sync();
}

/* ===== #55ï¼šãƒãƒ£ãƒ¬ãƒ³ã‚¸10æšã‹ã‚‰äººæ•°åˆ†ã‚’ç¢ºå®šã€‚c8ãŒå«ã¾ã‚ŒãŸã‚‰å·¦å³ã®æ•°å€¤2æšã‚‚ç¢ºå®š ===== */
async function ensureM55MetaInit(vNow){
  const v = vNow || state.watching; if(!v) return;
  const mid = (v?.mission?.id|0);
  if (!(mid === 55 || mid === 60)) return;
  const M = v.meta || {};

  // ã¾ã ç¢ºå®šã—ã¦ã„ãªã‘ã‚Œã°ã€ãƒ›ã‚¹ãƒˆãŒå±±æœ­ã¨å…¬é–‹æœ­ã‚’ç¢ºå®š
  if (!Array.isArray(M.m55_shown)) {
    if (!state.isHost) return;
    // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆæ‹¡å¼µå­æ··åœ¨ã®ã¾ã¾æ‰±ã†ï¼‰
    const deck = [
      'c1.png','c2.png','c3.png','c4.png','c5.png',
      'c6.png','c7.png','c8.png','c9.png','c10.png'
    ].slice();
    shuffle(deck);
    const n = v.tableCount|0;
    const shown = deck.slice(0, Math.max(1,n)); // äººæ•°åˆ†

    // c8ãŒå«ã¾ã‚Œã¦ã„ã‚‹ãªã‚‰å·¦å³ã®æ•°å€¤ã‚’1æšãšã¤ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºã‚ã‚‹ï¼ˆ1..12ï¼‰
    let c8Sides = null;
    if (shown.some(s => /c8\.(png|jpg)$/i.test(s))) {
  const [L, R] = pickK(MATERIALS.numbers, 2); // â† ãƒ¦ãƒ‹ãƒ¼ã‚¯æŠ½é¸
  c8Sides = [L, R];
    }
    await update(ref(db, `rooms/${state.roomCode}/meta`), {
      m55_deck: deck,
      m55_shown: shown,
      m55_c8Sides: c8Sides
    });
  }
}


// ã‚¿ãƒƒãƒ—æ‹¡å¤§ï¼ˆconZoomOverlayã‚’æµç”¨ï¼‰
function openChallengeZoom(id){
  try{
    const old = document.getElementById('conZoomOverlay');
    if (old) old.remove();
    const ov = document.createElement('div');
    ov.id = 'conZoomOverlay';
    ov.addEventListener('click', (e)=>{ if(e.target===ov) closeConstraintZoom(); });
    const wrap = document.createElement('div'); wrap.className = 'conzoom-wrap';
    const big  = document.createElement('div'); big.className  = 'conzoom-card';
    big.style.backgroundImage = `url('${imgChallenge(id)}')`;
    wrap.appendChild(big);
    ov.appendChild(wrap);
    document.body.appendChild(ov);
  }catch(e){ console.error(e); }
}


  
/* ===== #55ï¼šãƒãƒ£ãƒ¬ãƒ³ã‚¸æœ­ï¼ˆäººæ•°åˆ†ï¼‰ã€‚c8 ã®ã¨ãã ã‘å·¦å³ã«æ•°å€¤1æšãšã¤è¡¨ç¤º ===== */
function renderM55(v){
  const isM55 = ((v?.mission?.id|0) === 55 || (v?.mission?.id|0) === 60);
  const rowId = 'm55Row';
  const old   = document.getElementById(rowId);
  if (!isM55){ if (old) old.remove(); return; }

  // åˆå›ã¯ãƒ¡ã‚¿ã‚’ç”¨æ„ã•ã›ã‚‹
  if (!Array.isArray(v?.meta?.m55_shown)) { ensureM55MetaInit(v); if (old) old.remove(); return; }

  if (old) old.remove();
  const lane = document.createElement('div');
  lane.id = rowId;
  lane.className = 'conlane'; // concard ã¨ä¸¦ã¹ã‚‹æ—¢å­˜ãƒ¬ãƒ¼ãƒ³

  const shown = v.meta.m55_shown || [];
  const sides = v.meta.m55_c8Sides || null;

  // ç”»åƒURLãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  const imgChallenge = (fname)=> `./${fname}`;

  shown.forEach(fname=>{
    const isC8 = /c8\.(png|jpg)$/i.test(fname);

    // c8 ã®ã¨ãã¯ LEFTæ•°å€¤ â†’ concard â†’ RIGHTæ•°å€¤ ã®é †ã§æ¨ªä¸¦ã³
    if (isC8 && Array.isArray(sides) && sides.length===2){
      const leftNum  = document.createElement('div');
      leftNum.className = 'numcard';
      leftNum.style.backgroundImage = `url('${imgNumber(sides[0])}')`;
      lane.appendChild(leftNum);
    }

    const cc = document.createElement('div');
    cc.className = 'concard';
    cc.style.backgroundImage = `url('${imgChallenge(fname)}')`;
cc.onclick = (ev)=>{
  ev.stopPropagation();
openChallengeZoom(fname.replace(/\.(png|jpg)$/,''));
};
    lane.appendChild(cc);

    if (isC8 && Array.isArray(sides) && sides.length===2){
      const rightNum = document.createElement('div');
      rightNum.className = 'numcard';
      rightNum.style.backgroundImage = `url('${imgNumber(sides[1])}')`;
      lane.appendChild(rightNum);
    }
  });

  // æ—¢å­˜ã®ã€Œã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ç›´ä¸‹ã«æŒ¿å…¥ã€ãƒ˜ãƒ«ãƒ‘ã‚’ä½¿ç”¨ï¼ˆ#15ç­‰ã¨åŒã˜ï¼‰
  mountLaneUnderItemsBar(lane);  // #15 ã®æœ«å°¾ã¨åŒã˜å‘¼ã³æ–¹ã§OK :contentReference[oaicite:0]{index=0}
}

/* ==== #31ï¼šã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ä¸‹ã« A~Eã€ã‚­ãƒ£ãƒ©åˆ—ã¯ãƒ–ãƒ©ãƒ³ã‚¯ï¼‹ç›´ä¸‹ã«ãƒŸãƒ‹ ==== */
function renderM31(v){
  const isM31 = ((v?.mission?.id|0) === 31);
  const rowId = 'm31ConRow';

  // #31 ä»¥å¤–ã«ãªã£ãŸã‚‰ç‰‡ä»˜ã‘ã ã‘ã—ã¦çµ‚äº†
  if (!isM31){
    const lane = document.getElementById(rowId);
    if (lane) lane.remove();
    document.querySelectorAll('.m31-mini').forEach(n=>n.remove());
    return;
  }

  // --- â‘  åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ A~E ã‚’ itemsBar ç›´ä¸‹ã«ï¼ˆæ—¢å­˜CSS: .conlane/.concard ã‚’ä½¿ç”¨ï¼‰
  let lane = document.getElementById(rowId);
  if (!lane){
    lane = document.createElement('div');
    lane.id = rowId;
    lane.className = 'conlane';
  }else{
    // æ—¢å­˜ãƒ¬ãƒ¼ãƒ³ã¯æ¶ˆã•ãšã«ä¸­èº«ã ã‘æ›´æ–°ï¼ˆ"æ¶ˆã•ãªã„ã§"å¯¾å¿œï¼‰
    lane.replaceChildren();
  }

const taken = new Set(
  (v?.tables || []).map(t => t?.m31Con).filter(Boolean)
);
const pool = ['A','B','C','D','E'].filter(ch => !taken.has(ch));

// ãƒ—ãƒ¼ãƒ«ï¼ˆæœªå–å¾—ã®ã¿ï¼‰ã‚’æç”»
pool.forEach(ch=>{
  const cc = document.createElement('div');
  cc.className = 'concard';
  cc.style.backgroundImage = `url('${imgConstraint(ch)}')`;
  cc.title = 'æ‹¡å¤§';
  cc.onclick = (ev)=>{ 
    ev.stopPropagation(); 
    const myIdx = (()=>{
      const sNum = (state?.seatedTable==null)? null : Number(state.seatedTable);
      if (Number.isInteger(sNum) && sNum>=0 && sNum < (state?.watching?.tables||[]).length) return sNum;
      const alt = (state?.watching?.tables||[]).findIndex(t=> t?.playerId===state.userId);
      return (alt>=0? alt : null);
    })();
    openConstraintZoom31(ch, myIdx);
  };
  lane.appendChild(cc);
});

  // æ—¢å­˜ãƒ˜ãƒ«ãƒ‘ã§ itemsBar ã®ç›´ä¸‹ã¸ï¼ˆæ—¢ã«åœ¨ã‚Œã°é †åºã‚’æ•´ãˆã‚‹ã ã‘ï¼‰
  mountLaneUnderItemsBar(lane);

  // --- â‘¡ å„ãƒ†ãƒ¼ãƒ–ãƒ«ï¼šå¤§ã‚­ãƒ£ãƒ©ã¯ãƒ–ãƒ©ãƒ³ã‚¯åŒ–ã—ã€ç›´ä¸‹ã«ãƒŸãƒ‹ã‚’è¿½åŠ ï¼ˆ#61ã¨åŒã˜è¦‹ãŸç›®æ“ä½œï¼‰
  const tableEls = Array.from(document.querySelectorAll('#tables .table'));
  tableEls.forEach((tbEl, ti)=>{
    const charCol = tbEl.querySelector('.char-col');
    if (!charCol) return;

    // å¤ã„ãƒŸãƒ‹ï¼ˆ#31ç”¨ï¼‰ã‚’é™¤å»ã—ã¦é‡è¤‡é˜²æ­¢
    charCol.querySelectorAll('.m31-mini').forEach(n=>n.remove());

    // å¤§ã‚­ãƒ£ãƒ©ã‚’å¸¸ã«ãƒ–ãƒ©ãƒ³ã‚¯è¡¨ç¤ºã«å›ºå®š
const big = charCol.querySelector('.char-card');
if (big){
  big.classList.add('blank');
  big.removeAttribute('style');
  big.onclick = null;

  const picked = v?.tables?.[ti]?.m31Con;
  const face   = v?.tables?.[ti]?.m31Face || 'front';  // 'front' | 'back'
  if (picked){
    big.classList.remove('blank');
    // è¡¨/è£ã§ç”»åƒã‚’åˆ‡æ›¿
    if (face === 'back'){
      big.style.backgroundImage = `url('${imgConstraintBack()}')`;
    }else{
      big.style.backgroundImage = `url('${imgConstraint(picked)}')`;
    }
    big.style.backgroundSize = 'cover';
    big.style.backgroundPosition = 'center';

    // ã‚¯ãƒªãƒƒã‚¯æŒ™å‹•ï¼šè‡ªåˆ†ã¯è£è¿”ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ä»–äººã¯é–²è¦§ã ã‘
    const myIdx = (()=>{
      const sNum = (state?.seatedTable==null)? null : Number(state.seatedTable);
      if (Number.isInteger(sNum) && sNum>=0 && sNum < (state?.watching?.tables||[]).length) return sNum;
      const alt = (state?.watching?.tables||[]).findIndex(t=> t?.playerId===state.userId);
      return (alt>=0? alt : null);
    })();
    const isMine = (typeof myIdx === 'number' && myIdx === ti);

    big.onclick = (ev)=>{
      ev.stopPropagation();
      if (isMine){
        // è‡ªåˆ†ï¼šè£è¿”ã—å¯èƒ½ãªã‚ºãƒ¼ãƒ 
        openConstraintZoom31Owned(picked, ti);
      }else{
        // ä»–äººï¼šé–²è¦§å°‚ç”¨ã‚ºãƒ¼ãƒ 
        openConstraintZoomView(picked);
      }
    };
  }
}



    // ãƒŸãƒ‹ã‚­ãƒ£ãƒ©ï¼ˆ#61ã¨åŒå¯¸ã® .m61-mini ã‚’æµç”¨ï¼‰ï¼‹ #31è­˜åˆ¥ç”¨ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸
    const mini = document.createElement('div');
    mini.className = 'm61-mini m31-mini';

    const t = (v.tables||[])[ti] || {};
    const seatEmpty = !t.playerId;
    const amMe = !!t.playerId && t.playerId === state.userId;

    if (seatEmpty){
      // ç©ºå¸­ï¼šæ ã ã‘
      mini.classList.add('blank');
    }else{
      const face = t.character?.flipped ? './battery.jpg' : `./${t.character?.face || 'member (1).jpg'}`;
      mini.style.backgroundImage = `url("${face}")`;
      // æœ¬äººã®ã¿è£è¡¨ãƒˆã‚°ãƒ«
      // æœ¬äººã®ã¿ï¼šmember(9)ãªã‚‰æ‹¡å¤§â†’ã€Œä½¿ã†ã€ãƒãƒƒãƒ—ã€ãã®ä»–ã¯è£è¡¨ãƒˆã‚°ãƒ«
      if (amMe){
        const orig = String(t?.character?.face || '');
        if (orig.includes('member (9).jpg')){
          mini.style.cursor = 'pointer';
          mini.onclick = ()=> openRoleZoomView(orig);
        }else{
          mini.onclick = async ()=>{
            await update(ref(db, `rooms/${state.roomCode}/tables/${ti}/character`), { flipped: !t.character?.flipped });
          };
        }
      }else{
        mini.onclick = null;
      }
      if (!amMe) mini.style.cursor = 'default';
    }

    // ã€Œå¤§ã‚­ãƒ£ãƒ©ã®ç›´ä¸‹ã€ã«ãƒŸãƒ‹ã‚’è¿½åŠ 
    charCol.appendChild(mini);
    {
      const rBox  = tbEl.getBoundingClientRect();
      const rMini = mini.getBoundingClientRect();
      // æ—¢å®š 96px ä»¥ä¸Šã§ã€ä¸‹ç«¯ + ä½™ç™½6px ã¾ã§ç¢ºä¿
      const needPx = Math.max(96, Math.ceil(rMini.bottom - rBox.top + 6));
      applyTableHeight(tbEl, needPx);
    }
  });
}


// #31å°‚ç”¨ï¼ˆæ‰€æœ‰ã‚«ãƒ¼ãƒ‰ç”¨ï¼‰ï¼šæ‹¡å¤§ â†’ ã€Œè£è¿”ã™ã€ãƒãƒƒãƒ— â†’ m31Face ã‚’ front/back ãƒˆã‚°ãƒ«
function openConstraintZoom31Owned(letter, tableIdx){
  try{
    // æ—¢å­˜ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æƒé™¤
    const old = document.getElementById('conZoomOverlay');
    if (old) old.remove();

    const ov = document.createElement('div');
    ov.id = 'conZoomOverlay';
    ov.addEventListener('click', (e)=>{ if(e.target===ov) closeConstraintZoom(); });

    const wrap = document.createElement('div');
    wrap.className = 'conzoom-wrap';

    const big = document.createElement('div');
    big.className = 'conzoom-card';

    // ç¾åœ¨ã® face ã‚’å–å¾—ã—ã¦è¦‹ãŸç›®ã‚’åˆã‚ã›ã‚‹
    const face = state?.watching?.tables?.[tableIdx]?.m31Face || 'front';
    big.style.backgroundImage = (face==='back')
      ? `url('${imgConstraintBack()}')`
      : `url('${imgConstraint(letter)}')`;

    const renderMenu = ()=>{
      // æ—¢å­˜ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ¶ˆã—ã¦ã‹ã‚‰å†ç”Ÿæˆï¼ˆãƒ©ãƒ™ãƒ«ã‚’æœ€æ–°çŠ¶æ…‹ã«ï¼‰
      wrap.querySelector('.conzoom-menu')?.remove();
      const menu = document.createElement('div');
      menu.className = 'conzoom-menu';
      const cur = state?.watching?.tables?.[tableIdx]?.m31Face || 'front';
      const btnFlip = document.createElement('button');
      btnFlip.textContent = (cur === 'back') ? 'è¡¨ã«æˆ»ã™' : 'è£è¿”ã™';
      btnFlip.onclick = async (ev)=>{
        ev.stopPropagation();
        try{
          const next = (cur === 'back') ? 'front' : 'back';
          await update(ref(db, `rooms/${state.roomCode}/tables/${tableIdx}`), { m31Face: next });
        }catch(e){ console.error('[M31 flip]', e); }
        closeConstraintZoom();
      };
      menu.appendChild(btnFlip);
      wrap.appendChild(menu);
    };

    // ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’ãƒˆã‚°ãƒ«ï¼ˆä»»æ„æ“ä½œï¼‰
    big.addEventListener('click', (e)=>{
      e.stopPropagation();
      const m = wrap.querySelector('.conzoom-menu');
      if (m) m.remove(); else renderMenu();
    });

    wrap.appendChild(big);
    ov.appendChild(wrap);
    document.body.appendChild(ov);
  }catch(e){ console.error(e); }
}


// #31å°‚ç”¨ï¼šæ‹¡å¤§ â†’ ã€Œé¸æŠã™ã‚‹ã€ãƒãƒƒãƒ— â†’ è‡ªåˆ†ã® m31Con ã«ä¿å­˜
function openConstraintZoom31(letter, myIdx){
  try{
    // æ—¢å­˜ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’é–‰ã˜ã¦ã‹ã‚‰æ–°è¦
    const old = document.getElementById('conZoomOverlay');
    if (old) old.remove();

    const ov = document.createElement('div');
    ov.id = 'conZoomOverlay';
    ov.addEventListener('click', (e)=>{ if(e.target===ov) closeConstraintZoom(); });

    const wrap = document.createElement('div');
    wrap.className = 'conzoom-wrap';

    const big = document.createElement('div');
    big.className = 'conzoom-card';
    big.style.backgroundImage = `url('${imgConstraint(letter)}')`;

    // æ‹¡å¤§ã‚«ãƒ¼ãƒ‰è‡ªä½“ã®ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãƒˆã‚°ãƒ«
    big.addEventListener('click', (e)=>{
      e.stopPropagation();
      if (typeof myIdx !== 'number' || myIdx<0) return;

      let menu = wrap.querySelector('.conzoom-menu');
      if (menu){ menu.remove(); return; } // 2å›ç›®ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹

      menu = document.createElement('div');
      menu.className = 'conzoom-menu';

      const btnPick = document.createElement('button');
      btnPick.textContent = 'é¸æŠã™ã‚‹';
      btnPick.onclick = async (ev)=>{
        ev.stopPropagation();
        try{
          // è‡ªåˆ†ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã« m31Con ã‚’ä¿å­˜ï¼ˆä¸Šæ›¸ãOKä»•æ§˜ï¼‰
          await update(ref(db, `rooms/${state.roomCode}/tables/${myIdx}`), { m31Con: letter });
        }catch(err){ console.error(err); }
        closeConstraintZoom();
      };

      menu.appendChild(btnPick);
      wrap.appendChild(menu);
    });

    wrap.appendChild(big);
    ov.appendChild(wrap);
    document.body.appendChild(ov);
  }catch(e){ console.error(e); }
}


  
/* ã“ã“ã‹ã‚‰è¿½åŠ ï¼š#34 æç”»ãƒ»æ“ä½œãƒ­ã‚¸ãƒƒã‚¯ */
function renderM34(v){
  const isM34 = ((v?.mission?.id|0) === 34) || ((v?.mission?.id|0) === 34);

  // æ—¢å­˜é™¤å»
  const oldH = document.getElementById('m34HandRow'); if (oldH) oldH.remove();
  const oldC = document.getElementById('m34CenterRow'); if (oldC) oldC.remove();
  if (!isM34) return;

  const myIdx = (v.tables||[]).findIndex(T => T.playerId === state.userId);
  const myLetter = (myIdx>=0) ? v.tables[myIdx]?.m34Con : null;
  const center = Array.isArray(v.m34_center) ? v.m34_center : [];

  // â”€â”€ è‡ªåˆ†ã®ä¸‹éƒ¨ï¼ˆå ´ã«å‡ºã—ã¦ãªã„ã¨ãã ã‘è¡¨ç¤ºï¼‰
  const myOut = center.some(o => o?.by === myIdx);
  const footer = document.getElementById('missionFooter');
  if (footer && myIdx>=0 && myLetter && !myOut) {
    const row = document.createElement('div');
    row.id = 'm34HandRow';
    row.className = 'conlane';
    const c = document.createElement('div');
    c.className = 'concard';
    c.style.backgroundImage = `url('${imgConstraint(myLetter)}')`;
    /* ã“ã“ã‹ã‚‰å¤‰æ›´ */
    c.title = 'æ‹¡å¤§';
    c.onclick = (ev)=>{ ev.stopPropagation(); openConstraintZoom(myLetter, myIdx); };
    /* ã“ã“ã¾ã§å¤‰æ›´ */
    row.appendChild(c);

    // ã‚¿ã‚¤ãƒˆãƒ«ã®ç›´å‰ã«å·®ã—è¾¼ã‚€ï¼ˆ#29ã¨åŒæ§˜ï¼‰
    const title = document.getElementById('missionDetailTitle');
    if (title && title.parentNode === footer) footer.insertBefore(row, title);
    else footer.appendChild(row);
  }

  // â”€â”€ ã‚»ãƒ³ã‚¿ãƒ¼ï¼ˆã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ç›´ä¸‹ï¼‰
  const bar = document.getElementById('itemsBar');
  if (bar && center.length>0){
    const row = document.createElement('div');
    row.id = 'm34CenterRow';
    row.className = 'conlane';
    center.forEach((obj, idx)=>{
      const cell = document.createElement('div');
      cell.className = 'concard';
      cell.style.backgroundImage = `url('${imgConstraint(obj.ch)}')`;
      cell.title = 'æˆ»ã™';
      cell.onclick = async ()=>{
        try{
          const rRef = ref(db, `rooms/${state.roomCode}`);
          const rSnap = await get(rRef);
          const R = rSnap.val()||{};
          const cur = Array.isArray(R.m34_center) ? R.m34_center.slice() : [];
          if (idx>=0 && idx<cur.length){
            cur.splice(idx,1);
            await update(rRef, { m34_center: cur });
          }
        }catch(e){ console.error(e); }
      };
      row.appendChild(cell);
    });
    bar.insertAdjacentElement('afterend', row);
  }
}

/* ã“ã“ã‹ã‚‰è¿½åŠ ï¼š#32/#37 åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ã®å±±æœ­ï¼ˆåŒæœŸè¡¨ç¤ºï¼‰ */
// å…±æœ‰ï¼šmeta åˆæœŸåŒ–ï¼ˆãƒŸãƒƒã‚·ãƒ§ãƒ³IDã”ã¨ï¼‰
async function ensureConDeckMetaInit(vNow, mid){
  const v = vNow || state.watching; if (!v) return;
  if ((v?.mission?.id|0) !== mid) return;
  const keyDeck = `m${mid}_deck`;
  const keyDisc = `m${mid}_discards`;
  if (Array.isArray(v?.meta?.[keyDeck])) return;   // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿
  if (!state.isHost) return;                        // åˆæœŸåŒ–ã¯ãƒ›ã‚¹ãƒˆã®ã¿

  // åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ Aã€œL ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦å±±æœ­ã«
  const deck = 'ABCDEFGHIJKL'.split(''); shuffle(deck);
  await update(ref(db, `rooms/${state.roomCode}/meta`), {
    [keyDeck]: deck,
    [keyDisc]: []
  });
}

// å…±æœ‰ï¼šæç”»ï¼ˆmid=32/37 ã‚’åˆ‡æ›¿ï¼‰
function renderConDeckSync(v, mid){
  const isTarget = ((v?.mission?.id|0) === mid);
  const rowId = `m${mid}ConRow`;
  const old = document.getElementById(rowId);
  if (!isTarget){ if (old) old.remove(); return; }

  const keyDeck = `m${mid}_deck`;
  const keyDisc = `m${mid}_discards`;

  // åˆå›ï¼šãƒ›ã‚¹ãƒˆãŒ meta ã‚’ç”¨æ„ï¼ˆæœªç”¨æ„ãªã‚‰ä¸€æ—¦æŠœã‘ã¦æ¬¡ã® onValue ã§æç”»ï¼‰
  if (!Array.isArray(v?.meta?.[keyDeck])){ ensureConDeckMetaInit(v, mid); if (old) old.remove(); return; }

  if (old) old.remove();
  const lane = document.createElement('div');
  lane.id = rowId;
  lane.className = 'conlane';  // åˆ¶ç´„ã‚«ãƒ¼ãƒ‰å¸¯ï¼ˆæ—¢å­˜CSSï¼‰

  // å±±æœ­ãƒœã‚¿ãƒ³ï¼ˆåˆ¶ç´„ã‚«ãƒ¼ãƒ‰è£é¢ï¼‰ï¼‹æ®‹è¡¨ç¤º
  const deckBtn = document.createElement('div');
  deckBtn.className = 'numdeck';                        // ä½¿ã„å›ã—
  deckBtn.title = 'ã‚ãã‚‹';
  deckBtn.style.background = "#fff url('./conback.jpg') center/70% no-repeat";

  const restLbl = document.createElement('span');
  restLbl.className = 'numrest';

  // å³å´ï¼šå…¬é–‹æœ­ï¼ˆç©ã¿é‡ã­ï¼‰
  const pile = document.createElement('div');
  pile.className = 'numcard-holder';
  pile.style.position = 'relative';

  lane.appendChild(deckBtn);
  lane.appendChild(restLbl);
  lane.appendChild(pile);

  // å†æç”»
  const refresh = ()=>{
    const d = (v?.meta?.[keyDeck]||[]);
    const x = (v?.meta?.[keyDisc]||[]);
    const remain = d.filter(ch => !x.includes(ch)).length;
    restLbl.textContent = `æ®‹:${remain}`;
    pile.innerHTML = '';

    // discards ã‚’ç©ã¿é‡ã­è¡¨ç¤ºï¼ˆ2px ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼‰
    x.forEach((ch, i)=>{
      const node = document.createElement('div');
      node.className = 'concard';
      node.style.backgroundImage = `url('${imgConstraint(ch)}')`;
      node.title = 'æ‹¡å¤§';
      node.onclick = (ev)=>{ ev.stopPropagation(); openConstraintZoom(ch); };
      if (i>0){
        const off = i*2;
        node.style.position = 'absolute';
        node.style.left = off + 'px';
        node.style.top  = off + 'px';
      }
      pile.appendChild(node);
      const extra = i*2;
      // åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ã®ã‚µã‚¤ã‚ºã¯ CSS å¤‰æ•°ã«è¿½å¾“ï¼ˆæ—¢å­˜CSSï¼š--con-h / --item-hï¼‰
      const baseH = cssNum('--con-h') || cssNum('--item-h') || 75;
      pile.style.height = (baseH + extra) + 'px';
      lane.style.marginBottom = extra + 'px';
    });
  };
  refresh();

  // 1æšã‚ãã‚‹ï¼šå±±æœ­é †ã§æœªä½¿ç”¨ã®1æšã‚’ discards ã«ç©ã‚€ï¼ˆå…¨å“¡ã¸åŒæœŸï¼‰
  deckBtn.onclick = async ()=>{
    try{
      const mRef = ref(db, `rooms/${state.roomCode}/meta`);
      const mSnap = await get(mRef);
      const meta = mSnap.val() || {};
      const D  = Array.isArray(meta[keyDeck]) ? meta[keyDeck].slice() : [];
      const Xs = Array.isArray(meta[keyDisc]) ? meta[keyDisc].slice() : [];
      const next = D.find(ch => !Xs.includes(ch));
      if (next == null){
        // ã™ã¹ã¦ä½¿ã„åˆ‡ã£ãŸã‚‰å†ç”Ÿæˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆ#30 ãªã©ã¨åŒæ§˜ã®é‹ç”¨ã«ã™ã‚‹ãªã‚‰ã“ã“ã§å†æ§‹ç¯‰ã—ã¦ã‚‚å¯ï¼‰
        return;
      }
      Xs.push(next);
      await update(mRef, { [keyDisc]: Xs });
    }catch(e){ console.error(e); }
  };

  // DOMï¼šã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ç›´ä¸‹
  mountLaneUnderItemsBar(lane);
}

// ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼ˆãƒŸãƒƒã‚·ãƒ§ãƒ³ã”ã¨ï¼‰
function renderM32(v){ renderConDeckSync(v, 32); }
function renderM37(v){ renderConDeckSync(v, 37); }
/* ã“ã“ã¾ã§è¿½åŠ  */

  
  
/* ã“ã“ã‹ã‚‰è¿½åŠ ï¼š#42 æç”»ãƒ»æ“ä½œãƒ­ã‚¸ãƒƒã‚¯ï¼ˆâ‡…å…¥ã‚Œæ›¿ãˆãƒ¢ãƒ¼ãƒ‰ã‚’ã²ã¨ã‹ãŸã¾ã‚Šã§å®Ÿè£…ï¼‰ */
async function renderM42(v){
  const isM42   = ((v?.mission?.id|0) === 42);
  const nowLock = (isM42 && !!v?.meta?.m42_on);

  // ===== ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ­ãƒƒã‚¯ï¼ˆæ—¢å­˜ç¶­æŒï¼‰ =====
  if (typeof state._m42ScrollLocked === 'undefined') state._m42ScrollLocked = false;
  const releaseScrollLock = ()=>{
    document.body.classList.remove('m42-noscroll');
    if (state._m42LockHandler){
      window.removeEventListener('touchmove', state._m42LockHandler, { passive:false });
      window.removeEventListener('wheel',     state._m42LockHandler, { passive:false });
      window.removeEventListener('keydown',   state._m42KeyHandler,  { passive:false });
      state._m42LockHandler = null;
      state._m42KeyHandler  = null;
    }
    state._m42ScrollLocked = false;
  };
  if (nowLock && !state._m42ScrollLocked){
    window.scrollTo({ top: 0, behavior: 'auto' });
    document.body.classList.add('m42-noscroll');
    state._m42LockHandler = (e)=>{ e.preventDefault(); };
    state._m42KeyHandler  = (e)=>{
      const k = e.code || e.key;
      if (['ArrowUp','ArrowDown','PageUp','PageDown','Home','End','Space'].includes(k)) { e.preventDefault(); }
    };
    window.addEventListener('touchmove', state._m42LockHandler, { passive:false });
    window.addEventListener('wheel',     state._m42LockHandler, { passive:false });
    window.addEventListener('keydown',   state._m42KeyHandler,  { passive:false });
    state._m42ScrollLocked = true;
  }
  if (!nowLock && state._m42ScrollLocked){ releaseScrollLock(); }
  if (!isM42 && state._m42ScrollLocked){  releaseScrollLock(); }

  // ===== è£œåŠ©CSSï¼ˆä¸€åº¦ã ã‘ï¼‰ =====
  if (!document.getElementById('m42ExtraStyle')) {
    const st = document.createElement('style');
    st.id = 'm42ExtraStyle';
    st.textContent = `
      .m42-hide-origin{ visibility: hidden !important; } /* â‘¤ å…ƒä½ç½®ã‚’å®Œå…¨ç©ºæ¬„ã« */
      /* ã‚´ãƒ¼ã‚¹ãƒˆï¼ˆæ•°å­—ï¼‹é»’åœ°ï¼‹codenumber.jpgå¸¯ï¼‰ */
      .m42-ghost{
        position:fixed; left:0; top:0;
        width:var(--card-w); height:var(--card-h);
        border-radius:6px; border:1px solid #ddd;
        background:#000; pointer-events:none; z-index:2147483601;
        transform:translate(-50%, -50%);
      }
      .m42-ghost .num{
        position:absolute; top:2px; left:0; right:0;
        text-align:center; font-size:var(--font-card); font-weight:var(--font-weight);
        color:#fff; line-height:1; text-shadow:0 1px 0 rgba(0,0,0,.15);
      }
      .m42-ghost .img-bottom{
        position:absolute; left:1px; right:1px; bottom:1px; height:18px;
        border-radius:0 0 6px 6px;
        background:url('./codenumber.jpg') center/cover no-repeat;
      }
      /* å…¬é–‹ã‚«ãƒ¼ãƒ‰ã®é’æ ï¼ˆâ˜/â‡…/-2/box ä¸­ï¼‰ */
      body[data-m42swap="on"] .card.open,
      body[data-m42m2="on"]   .card.open,
      body[data-m42box="on"]  .card.open { outline:2px dashed #38bdf8; outline-offset:-3px; }
      /* exæ¼”å‡ºã®å›ºå®šï¼ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æŠ‘æ­¢ */
      #m42Ex{ position:fixed!important; left:50%!important; top:50%!important; transform:translate(-50%,-50%)!important; }
      body.m42-noscroll{ overflow:hidden!important; overscroll-behavior:none!important; }
      .m42-gray{ background:#827e7e !important; color:#111 !important; border-color:#ddd !important; }

    `;
    document.head.appendChild(st);
  }

  // ===== æ—¢å­˜UIã®æƒé™¤ =====
  const oldBar = document.getElementById('m42HostBar'); if (oldBar) oldBar.remove();
  const oldBox = document.getElementById('m42Box');     if (oldBox && !v?.meta?.m42_on) oldBox.remove();

  if (!isM42){
    document.body.removeAttribute('data-m42swap');
    document.body.removeAttribute('data-m42m2');
    if (state._m42swapClick){ document.removeEventListener('click', state._m42swapClick, true); state._m42swapClick=null; }
    if (state._m42m2Click)  { document.removeEventListener('click', state._m42m2Click,   true); state._m42m2Click=null; }
    if (state._m42DragUnsub){ state._m42DragUnsub(); state._m42DragUnsub=null; }
    const g=document.getElementById('m42Ghost'); if(g) g.remove();
    return;
  }

  // ===== ãƒ›ã‚¹ãƒˆãƒãƒ¼ï¼ˆâ˜/â‡…/-2/â†» ã‚’é…ç½®ï¼‰ =====
  if (state.isHost){
    const bar = document.createElement('div');
    bar.id = 'm42HostBar';
    Object.assign(bar.style, {
      position:'fixed', left:'50%', bottom:'10px', transform:'translateX(-50%)',
      display:'flex', gap:'6px', zIndex:2147483600, background:'#fff',
      border:'1px solid #eee', borderRadius:'12px', padding:'6px 8px',
      boxShadow:'0 10px 24px rgba(0,0,0,.08)'
    });
    const btn = (txt, on)=>{ const b=document.createElement('button'); b.className='btn small'; b.textContent=txt; b.onclick=on; return b; };

    const toggleBox    = async ()=>{ const on = !!v?.meta?.m42_on;        await update(ref(db, `rooms/${state.roomCode}/meta`), { m42_on: !on }); };
const toggleSwap = async ()=>{
  const on = !!v?.meta?.m42Swap?.on;
  if (on){
    await update(ref(db, `rooms/${state.roomCode}/meta`), {
      m42Swap: null,
      m42SwapPop: null
    });
  }else{
    await update(ref(db, `rooms/${state.roomCode}/meta`), {
      m42Swap: { on:true, usingBy:null, selA:null, selB:null },
      m42SwapPop: { on:true, at: Date.now() }
    });
  }
};

const toggleMinus2 = async ()=>{
  const on = !!v?.meta?.m42M2?.on;
  if (on){
    await update(ref(db, `rooms/${state.roomCode}/meta`), {
      m42M2: null,
      m42M2Pop: null
    });
  }else{
    await update(ref(db, `rooms/${state.roomCode}/meta`), {
      m42M2: { on:true, usingBy:null, selA:null, selB:null },
      m42M2Pop: { on:true, at: Date.now() }
    });
  }
};


    // â†»æ¼”å‡ºï¼ˆç”»åƒã‚’æœ€å‰ãƒãƒƒãƒ—å±¤ã«ä¸€æ™‚è¡¨ç¤ºï¼‰
    const flashEx = (img)=>{
      let ex = document.getElementById('m42Ex');
      if (ex) ex.remove();
      ex = document.createElement('div');
      ex.id = 'm42Ex';
      Object.assign(ex.style, {
        position:'fixed', left:'50%', top:'50%', transform:'translate(-50%,-50%)',
        width:'140px', height:'90px',
        background:`url('./${img}') center/contain no-repeat`,
        zIndex:2147483647, pointerEvents:'none'
      });
      // ç”»é¢ã®æœ€å‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å±¤ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…±é€šã® popLayer ã‚’æƒ³å®šï¼‰
      (window.popLayer || document.body).appendChild(ex);
      setTimeout(()=>{ if(ex && ex.isConnected) ex.remove(); }, 3000);
      return ex;
    };

    const findMySeat = (vv)=>{
      if (state.seatedTable != null) return Number(state.seatedTable);
      const i = (vv?.tables||[]).findIndex(t=> t?.playerId===state.userId);
      return (i>=0? i : null);
    };
    const seatTo = async (newIdx)=>{
      await leaveSeatNow();
      await update(ref(db, `rooms/${state.roomCode}/tables/${newIdx}`), {
        playerId: state.userId, playerName: state.userName
      });
      const hRef  = ref(db, `rooms/${state.roomCode}/tables/${newIdx}/hand`);
      const hSnap = await get(hRef);
      const hand  = hSnap.val() || [];
      await Promise.all(hand.map((_,idx)=>
        update(ref(db, `rooms/${state.roomCode}/tables/${newIdx}/hand/${idx}`), { ownerId: state.userId })
      ));
      state.seatedTable = newIdx;
      updateMenuButtons();
    };
    const moveSeatCyclic = async (dir)=>{
      const vv = state.watching || v;
      const n  = (vv?.tableCount|0) || (vv?.tables?.length|0);
      if (!n) return;
      const cur = findMySeat(vv);
      if (cur==null){ alert('å¸­ã«åº§ã£ã¦ã„ã¾ã›ã‚“'); return; }
      const next = ( (cur + (dir>0? +1 : -1)) % n + n ) % n;
      await seatTo(next);
    };
    // å…¨å“¡åº§å¸­ã‚’å¾ªç’°ï¼ˆdir=+1 å·¦å›ã‚Š, -1 å³å›ã‚Šï¼‰
    const rotateAllSeats = async (dir)=>{
      const vv   = state.watching || v;
      const snap = await get(ref(db, `rooms/${state.roomCode}/tables`));
      const tbls = snap.val() || [];
      const n    = tbls.length|0; if(!n) return;

      const nextPlayers = Array.from({length:n}, ()=>({id:null, name:null}));
      for(let i=0;i<n;i++){
        const pid  = tbls[i]?.playerId || null;
        const name = tbls[i]?.playerName || null;
        if(pid){
          const j = ((i + (dir>0? +1 : -1)) % n + n) % n;
          nextPlayers[j] = {id:pid, name};
        }
      }
      const out = tbls.map((T,i)=>{
        const np = nextPlayers[i];
        const hand = Array.isArray(T?.hand) ? T.hand.map(c => ({...c, ownerId: np.id||null})) : [];
        return {...T, playerId: np.id||null, playerName: np.name||null, hand};
      });
      await set(ref(db, `rooms/${state.roomCode}/tables`), out);

      // è‡ªå¸­UIã®ã‚ºãƒ¬é˜²æ­¢
      const cur = (vv?.tables||[]).findIndex(t=> t?.playerId===state.userId);
      if (cur>=0){
        const next = ((cur + (dir>0? +1 : -1)) % n + n) % n;
        state.seatedTable = next;
        updateMenuButtons();
      }
    };

    // â†»ãƒœã‚¿ãƒ³ï¼šå·¦/å³ã‚’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§é¸æŠ â†’ ç”»åƒåŒæœŸï¼‹å¾ªç’°å¸­ç§»å‹•
// â†»ãƒœã‚¿ãƒ³ï¼šå·¦/å³ã‚’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§é¸æŠ â†’ ç”»åƒåŒæœŸï¼‹å¾ªç’°å¸­ç§»å‹•
const onRotate = ()=>{
  openBottomMenu([
    { label:'å·¦', className:'m42-gray', action: async ()=>{
        await update(ref(db, `rooms/${state.roomCode}/meta`), { m42_ex:{ img:'exleft.jpg',  at: Date.now() } });
        flashEx('exleft.jpg');
        await rotateAllSeats(+1);
        setTimeout(async ()=>{
          await update(ref(db, `rooms/${state.roomCode}/meta`), { m42_ex: null });
        }, 3000);
    }},
    { label:'å³', className:'m42-gray', action: async ()=>{
        await update(ref(db, `rooms/${state.roomCode}/meta`), { m42_ex:{ img:'exright.jpg', at: Date.now() } });
        flashEx('exright.jpg');
        await rotateAllSeats(-1);
        setTimeout(async ()=>{
          await update(ref(db, `rooms/${state.roomCode}/meta`), { m42_ex: null });
        }, 3000);
    }},
  ]);
};


    // ãƒœã‚¿ãƒ³é…ç½®
    bar.appendChild(btn('-2', toggleMinus2));
    bar.appendChild(btn('â‡…',  toggleSwap));
    bar.appendChild(btn('â˜',  toggleBox));
    bar.appendChild(btn('â†»',  onRotate));
    document.body.appendChild(bar);
  }

  // ===== exç”»åƒï¼ˆm42_exï¼‰è³¼èª­è¡¨ç¤ºï¼ˆå…¨å“¡å´ï¼‰ =====
  {
    const ex = v?.meta?.m42_ex;
    const exist = document.getElementById('m42Ex');
    if (ex && !exist){
      const div = document.createElement('div');
      div.id = 'm42Ex';
      Object.assign(div.style, {
        position:'fixed', left:'50%', top:'50%', transform:'translate(-50%, -50%)',
        width:'140px', height:'90px',
        background:`url('./${ex.img}') center/contain no-repeat`,
        zIndex:2147483647, pointerEvents:'none'
      });
      (window.popLayer || document.body).appendChild(div);
      setTimeout(()=>{ if(div.isConnected) div.remove(); }, 3000);
    }
    if (!ex && exist){ exist.remove(); }
  }

  // ===== â˜ON â†’ #m42Box è¡¨ç¤ºï¼†é’æ ãƒ•ãƒ©ã‚° =====
  if (v?.meta?.m42_on){
    const bar = document.getElementById('itemsBar');
    if (bar && !document.getElementById('m42Box')){
      const box = document.createElement('div');
      box.id = 'm42Box';
      Object.assign(box.style, {
        width:'140px', height:'90px', marginTop:'6px', marginLeft:'4px',
        background:`url('./box.jpg') center/cover no-repeat`,
        border:'2px dashed #38bdf8', borderRadius:'10px'
      });
      bar.insertAdjacentElement('afterend', box);
    }
    document.body.setAttribute('data-m42box','on');
  } else {
    document.body.removeAttribute('data-m42box');
  }

  // ===== ã“ã“ã‹ã‚‰ï¼šâ‘ ã€œâ‘¤ ãƒ‰ãƒ©ãƒƒã‚°åŒæœŸ =====
  const ensureGhost = ()=>{
    let g = document.getElementById('m42Ghost');
    if (!g){
      g = document.createElement('div');
      g.id = 'm42Ghost';
      g.className = 'm42-ghost';
      const num = document.createElement('div'); num.className='num';
      const img = document.createElement('div'); img.className='img-bottom';
      g.appendChild(num); g.appendChild(img);
      document.body.appendChild(g);
    }
    return g;
  };
  const removeGhost = ()=>{ const g=document.getElementById('m42Ghost'); if(g) g.remove(); };

  const canDrag = ()=> !!document.body.getAttribute('data-m42box'); // â˜ONä¸­ã®ã¿
  const blankOrigin = (table, cardId, blank)=>{
    const wrap = document.querySelector(`.card-wrap[data-table="${table}"][data-card-id="${cardId}"]`);
    if (wrap) wrap.classList.toggle('m42-hide-origin', !!blank);
  };

  // è³¼èª­ã‚¹ãƒŠãƒƒãƒ—ã® m42_drag ã‚’åæ˜ ï¼ˆå…¨å“¡ã«åŒã˜è¦‹ãˆæ–¹ï¼‰
  const dragMeta = v?.meta?.m42_drag || null;
  if (dragMeta){
    const g = ensureGhost();
    g.querySelector('.num').textContent = String(dragMeta.num ?? '');
    g.style.left = `${dragMeta.x}px`;
    g.style.top  = `${dragMeta.y}px`;
    blankOrigin(dragMeta.table, dragMeta.cardId, true);
  }else{
    removeGhost();
    document.querySelectorAll('.card-wrap.m42-hide-origin').forEach(w=> w.classList.remove('m42-hide-origin'));
  }

  // ãƒ­ãƒ¼ã‚«ãƒ«ã§ä¸€åº¦ã ã‘ãƒã‚¤ãƒ³ã‚¿ãƒãƒ³ãƒ‰ãƒ©ã‚’ä»•è¾¼ã‚€
  if (!state._m42DragBound){
    state._m42DragBound = true;

    const onDown = (ev)=>{
      if (!isM42 || !canDrag()) return;
      const wrap = ev.target.closest?.('.card-wrap'); if(!wrap) return;
      const cardEl = wrap.querySelector('.card');     if(!cardEl || !cardEl.classList.contains('open')) return; // å…¬é–‹ã®ã¿

      const table  = parseInt(wrap.dataset.table,10);
      const cardId = wrap.dataset.cardId;
      if (!Number.isInteger(table) || !cardId) return;

      const numEl = cardEl.querySelector('.num');
      const num   = numEl ? (numEl.textContent||'') : '';

      // å…ƒä½ç½®ã‚’ç©ºæ¬„åŒ–ï¼ˆâ‘¤ï¼‰
      blankOrigin(table, cardId, true);

      let moved = false;
      const startX = ev.clientX, startY = ev.clientY;

      const move = (e)=>{
        const x = e.clientX, y = e.clientY;
        const dx = Math.abs(x - startX), dy = Math.abs(y - startY);
        if (!moved && (dx>2 || dy>2)) moved = true;

        const g = ensureGhost();
        g.querySelector('.num').textContent = String(num);
        g.style.left = `${x}px`;
        g.style.top  = `${y}px`;
        update(ref(db, `rooms/${state.roomCode}/meta`), {
          m42_drag: { table, cardId, num, x, y, by: state.userId, at: Date.now() }
        });
      };

      const up = async (e)=>{
        window.removeEventListener('pointermove', move);
        window.removeEventListener('pointerup',   up, true);

        // #m42Box å†…ã«è½ã¨ã—ãŸã‹ï¼ˆâ‘£ï¼‰
        const box = document.getElementById('m42Box');
        let droppedInBox = false;
        if (box){
          const r = box.getBoundingClientRect();
          const x = e.clientX, y = e.clientY;
          droppedInBox = (x>=r.left && x<=r.right && y>=r.top && y<=r.bottom);
        }

        if (droppedInBox && moved){
          try{
            const tsSnap = await get(ref(db, `rooms/${state.roomCode}/tables/${table}/hand`));
            const hand   = tsSnap.val() || [];
            const idx    = hand.findIndex(c => c?.id===cardId);
            if (idx>=0){
              hand.splice(idx,1);                 // è©°ã‚ã¦å‰Šé™¤
              await set(ref(db, `rooms/${state.roomCode}/tables/${table}/hand`), hand);
            }
          }finally{
            await update(ref(db, `rooms/${state.roomCode}/meta`), { m42_drag: null });
          }
        }else{
          // â‘¡ å¾©å¸°ï¼ˆboxå¤– or ã‚¯ãƒªãƒƒã‚¯é›¢ã—ï¼‰
          await update(ref(db, `rooms/${state.roomCode}/meta`), { m42_drag: null });
        }

        removeGhost();
        blankOrigin(table, cardId, false);
      };

      window.addEventListener('pointermove', move);
      window.addEventListener('pointerup',   up, true);
    };

    document.addEventListener('pointerdown', onDown, true);
    state._m42DragUnsub = ()=>{
      document.removeEventListener('pointerdown', onDown, true);
    };
  }

  // ===== â‡… å…¥ã‚Œæ›¿ãˆ =====
  const swapOn = !!v?.meta?.m42Swap?.on;
  if (swapOn){
    document.body.setAttribute('data-m42swap','on');
    if (!state._m42swapClick){
      state._m42swapClick = async (ev)=>{
        const wrap = ev.target.closest?.('.card-wrap'); if (!wrap) return;
        const cardEl = wrap.querySelector('.card'); if (!cardEl || !cardEl.classList.contains('open')) return;
        ev.stopPropagation();

        const table = parseInt(wrap.dataset.table,10);
        const cardId = wrap.dataset.cardId;
        if (!Number.isInteger(table) || !cardId) return;

        const me = state.userId;
        const mRef = ref(db, `rooms/${state.roomCode}/meta`);
        const mSnap = await get(mRef);
        const meta  = mSnap.val() || {};
        const flow  = meta.m42Swap && meta.m42Swap.on ? meta.m42Swap : {on:true, usingBy:null, selA:null, selB:null};

        if (flow.usingBy && flow.usingBy !== me){
          await update(mRef, { m42Swap:{on:true, usingBy:me, selA:{table, cardId}, selB:null} });
          return;
        }
        if (!flow.selA){
          await update(mRef, { m42Swap:{on:true, usingBy:me, selA:{table, cardId}, selB:null} });
          return;
        }
        if (flow.selA && !flow.selB){
          const selA = flow.selA, selB = {table, cardId};
          const tSnap = await get(ref(db, `rooms/${state.roomCode}/tables`));
          const tables = tSnap.val() || [];
          const findNum = ({table, cardId})=>{
            const hand = (tables[table]?.hand)||[];
            const c = hand.find(x=> x?.id===cardId);
            return c ? (c.num|0) : null;
          };
          const na = findNum(selA), nb = findNum(selB);
          if (na!=null && nb!=null && na===nb){
            alert('åŒã˜æ•°å­—ã§ã™');
            await update(mRef, { m42Swap:{on:true, usingBy:me, selA:null, selB:null} });
            return;
          }

          await update(mRef, { m42Swap:{on:true, usingBy:me, selA, selB} });
          openMenuAtClick([
            {label:'äº¤æ›ã™ã‚‹', action: async ()=>{
              const ts = (await get(ref(db, `rooms/${state.roomCode}/tables`))).val() || [];
              const pick = (ti, id)=>{ const hand=(ts[ti]?.hand)||[]; const idx=hand.findIndex(c=> c?.id===id); return {hand, idx, card: idx>=0?hand[idx]:null}; };
              const A = pick(selA.table, selA.cardId);
              const B = pick(selB.table, selB.cardId);
              if (!A.card || !B.card) { await update(mRef, { m42Swap:{on:true, usingBy:me, selA:null, selB:null} }); return; }
const toA = { ...B.card, ownerId: (ts[selA.table]?.playerId)||null, markUntil: (now()+6000), markBy: me };
const toB = { ...A.card, ownerId: (ts[selB.table]?.playerId)||null, markUntil: (now()+6000), markBy: me };
A.hand[A.idx] = toA;
B.hand[B.idx] = toB;


              const realpha = (hand)=>{ const alpha='abcdefghijklmnopqrstuvwxyz'; hand.forEach((c,i)=> c.alpha = alpha[i%alpha.length]); };
              realpha(A.hand); realpha(B.hand);

              await Promise.all([
                set(ref(db, `rooms/${state.roomCode}/tables/${selA.table}/hand`), A.hand),
                set(ref(db, `rooms/${state.roomCode}/tables/${selB.table}/hand`), B.hand),
                update(mRef, { m42Swap: null })
              ]);
            }},
            {label:'ã‚„ã‚Šç›´ã™', action: async ()=>{
              await update(mRef, { m42Swap:{on:true, usingBy:me, selA:null, selB:null} });
            }}
          ]);
        }
      };
      document.addEventListener('click', state._m42swapClick, true);
    }
  }else{
    document.body.removeAttribute('data-m42swap');
    if (state._m42swapClick) { document.removeEventListener('click', state._m42swapClick, true); state._m42swapClick=null; }
  }

  // ===== -2 ãƒ¢ãƒ¼ãƒ‰ =====
  const m2On = !!v?.meta?.m42M2?.on;
  if (m2On){
    document.body.setAttribute('data-m42m2','on');
    if (!state._m42m2Click){
      state._m42m2Click = async (ev)=>{
        const wrap = ev.target.closest?.('.card-wrap'); if (!wrap) return;
        const cardEl = wrap.querySelector('.card');      if (!cardEl || !cardEl.classList.contains('open')) return;
        ev.stopPropagation();
        const table = parseInt(wrap.dataset.table,10);
        const cardId = wrap.dataset.cardId;
        if (!Number.isInteger(table) || !cardId) return;

        const me = state.userId;
        const mRef = ref(db, `rooms/${state.roomCode}/meta`);
        const mSnap = await get(mRef);
        const meta  = mSnap.val() || {};
        const flow  = meta.m42M2 && meta.m42M2.on ? meta.m42M2 : {on:true, usingBy:null, selA:null, selB:null};

        if (flow.usingBy && flow.usingBy !== me){
          await update(mRef, { m42M2:{on:true, usingBy:me, selA:{table, cardId}, selB:null} });
          return;
        }
        if (!flow.selA){
          await update(mRef, { m42M2:{on:true, usingBy:me, selA:{table, cardId}, selB:null} });
          return;
        }
        if (flow.selA && !flow.selB){
  if (flow.selA.table === table && flow.selA.cardId === cardId) {
    await update(mRef, { m42M2:{on:true, usingBy:me, selA:{table, cardId}, selB:null} });
    return;
  }
          const selA = flow.selA, selB = {table, cardId};
          const ts = (await get(ref(db, `rooms/${state.roomCode}/tables`))).val() || [];
          const pickNum = ({table, cardId})=>{
            const hand=(ts[table]?.hand)||[]; const c=hand.find(x=> x?.id===cardId);
            return (c && typeof c.num==='number') ? (c.num|0) : null;
          };
          const na = pickNum(selA), nb = pickNum(selB);
          if (na==null || nb==null || na!==nb){
            alert('é•ã†æ•°å­—ã§ã™');
            await update(mRef, { m42M2:{on:true, usingBy:me, selA:null, selB:null} });
            return;
          }
          await update(mRef, { m42M2:{on:true, usingBy:me, selA, selB} });
          openMenuAtClick([
            {label:'å…ƒã«æˆ»ã™', action: async ()=>{
              const ts2 = (await get(ref(db, `rooms/${state.roomCode}/tables`))).val() || [];
              const locate = ({table, cardId})=>{
                const hand=(ts2[table]?.hand)||[]; const idx=hand.findIndex(c=> c?.id===cardId);
                return {hand, idx};
              };
              const A = locate(selA), B = locate(selB);
              if (A.idx<0 || B.idx<0){ await update(mRef, { m42M2:{on:true, usingBy:me, selA:null, selB:null} }); return; }
              if (A.hand[A.idx]) A.hand[A.idx] = {...A.hand[A.idx], open:false};
              if (B.hand[B.idx]) B.hand[B.idx] = {...B.hand[B.idx], open:false};
              await Promise.all([
                set(ref(db, `rooms/${state.roomCode}/tables/${selA.table}/hand`), A.hand),
                set(ref(db, `rooms/${state.roomCode}/tables/${selB.table}/hand`), B.hand),
                update(mRef, { m42M2: null })
              ]);
            }},
            {label:'ã‚„ã‚Šç›´ã™', action: async ()=>{
              await update(mRef, { m42M2:{on:true, usingBy:me, selA:null, selB:null} });
            }}
          ]);
        }
      };
      document.addEventListener('click', state._m42m2Click, true);
    }
  }else{
    document.body.removeAttribute('data-m42m2');
    if (state._m42m2Click){
      document.removeEventListener('click', state._m42m2Click, true);
      state._m42m2Click=null;
    }
  }

// ===== é»’ãƒãƒƒãƒ—ã®åŒæœŸè¡¨ç¤º =====
{
  const sp = !!v?.meta?.m42SwapPop?.on;
  const mp = !!v?.meta?.m42M2Pop?.on;

  // â‡… ãƒãƒƒãƒ—
  const spEl = document.getElementById('m42SwapPop');
  if (sp) {
    if (spEl && spEl.classList.contains('hidden')) openM42SwapPop();
  } else {
    if (spEl && !spEl.classList.contains('hidden')) spEl.classList.add('hidden');
  }

  // -2 ãƒãƒƒãƒ—
  const mpEl = document.getElementById('m42Minus2Pop');
  if (mp) {
    if (mpEl && mpEl.classList.contains('hidden')) openM42Minus2Pop();
  } else {
    if (mpEl && !mpEl.classList.contains('hidden')) mpEl.classList.add('hidden');
  }
}


}




/* ã“ã“ã¾ã§è¿½åŠ ï¼š#42 */

/* ã“ã“ã‹ã‚‰è¿½åŠ ï¼šãƒŸãƒƒã‚·ãƒ§ãƒ³43 */
function renderM43(v){
  const isM43 = ((v?.mission?.id|0) === 43);
  const old = document.getElementById('m43Nano');

  // ãƒŸãƒƒã‚·ãƒ§ãƒ³43ä»¥å¤– â†’ å¾Œç‰‡ä»˜ã‘
  if (!isM43){
    if (old) old.remove();
    document.getElementById('nanoRow')?.remove(); // æ—§ãƒ»æ–°UIã®æƒé™¤
    return;
  }

  // åˆæœŸåŒ–ï¼šãƒ›ã‚¹ãƒˆãŒ m43_nano ã‚’ç”¨æ„
  if ((v?.meta?.m43_nano|0) === 0){
    if (state.isHost){
      const P = (v?.tableCount|0) || (v?.tables?.length|0) || 0;
      const initNano = (P>=5) ? 3 : 4;
      update(ref(db, `rooms/${state.roomCode}/meta`), { m43_nano: initNano, m43_pos: 0, m43_prevPos: 0 });
    }
    if (old) old.remove();
    document.getElementById('nanoRow')?.remove();
    return;
  }

  const pos     = v?.meta?.m43_pos|0;
  const prevPos = v?.meta?.m43_prevPos|0;
  const nanoLv  = clamp(v?.meta?.m43_nano|0, 0, 4);

  if (!pos){
    if (old) old.remove();
    document.getElementById('nanoRow')?.remove();
    return;
  }

  const goingLeft = (prevPos>0 && pos < prevPos);
  const img = goingLeft ? `./nano${nanoLv}left.png` : `./nano${nanoLv}.png`;

  // è¡Œã‚³ãƒ³ãƒ†ãƒŠï¼ˆitemsBar ã®ç›´ä¸‹ï¼‰ã‚’ç”¨æ„
  const itemsBar = document.getElementById('itemsBar');
  if (!itemsBar) return;
  let row = document.getElementById('nanoRow');
  if (!row){
    row = document.createElement('div');
    row.id = 'nanoRow';
    row.className = 'nano-row';
    itemsBar.insertAdjacentElement('afterend', row);
  }

  const node = old || document.createElement('div');
  node.id = 'm43Nano';
  node.className = 'm43-nano';
  node.style.backgroundImage = `url("${img}")`;

  node.onclick = (ev)=>{
    openMenu(ev.clientX, ev.clientY, [
      { label:'å›å', action: async ()=>{
      /* ã“ã“ã‹ã‚‰è¿½åŠ ï¼š#43 å›åã‚¿ãƒƒãƒ— â†’ Aç¾¤ã‹ã‚‰1æšã‚’è‡ªåˆ†ã®æ‰‹æœ­ã¸ */
      const code = state.roomCode;
      const myTable = state.seatedTable;
      if (myTable == null) { alert('å¸­ã«åº§ã£ã¦ã„ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿æ“ä½œã§ãã¾ã™'); return; }

      // ãƒ¡ã‚¿ã¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å–å¾—
      const mRef = ref(db, `rooms/${code}/meta`);
      const tRef = ref(db, `rooms/${code}/tables`);
      const [mSnap, tSnap] = await Promise.all([ get(mRef), get(tRef) ]);
      const meta = mSnap.val() || {};
      const tbls = tSnap.val() || [];
      const A = Array.isArray(meta.m43_A) ? meta.m43_A.slice() : [];

      // Aç¾¤ã‹ã‚‰1æšå–ã‚Šå‡ºã—ï¼ˆå…ˆé ­ï¼ä¸€ç•ªä¸Šï¼‰
      if (A.length > 0 && tbls[myTable]) {
        const n = A.shift(); // number
        const T = tbls[myTable];
        const hand = Array.isArray(T.hand) ? T.hand : [];
        hand.push({
          id: crypto.randomUUID(),
          num: n,
          kind: 'normal',
          open: false,
          ownerId: T.playerId || null,
          tokens: [],
          markUntil: Date.now() + 5000   // â† 5ç§’é–“ã€Œâ–¼ã€è¡¨ç¤º
        });
        hand.sort((a,b)=> a.num - b.num);
        const alpha = 'abcdefghijklmnopqrstuvwxyz';
        hand.forEach((c,i)=> c.alpha = alpha[i % alpha.length]);
        T.hand = hand;

        // DB ã¸åæ˜ ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ï¼‹Aç¾¤ã‚’æ›´æ–°ï¼‰
        await Promise.all([
          set(ref(db, `rooms/${code}/tables`), tbls),
          update(mRef, { m43_A: A })
        ]);
      }

      // æ—¢å­˜ã®ã€Œæ®µéšã‚’ä¸‹ã’ã‚‹ã€ã‚‚ãã®ã¾ã¾å®Ÿè¡Œ
      const cur = (state.watching?.meta?.m43_nano|0);
      const next = Math.max(0, cur - 1);
      await update(mRef, { m43_nano: next, m43_updatedAt: Date.now() });
      }
      }
    ]);
  };

  // ä½ç½®ã¯ checklist ã®ã‚»ãƒ«ä¸­å¤®ã«åˆã‚ã›ã¦ã€ŒnanoRowã€å†…ã§ left ã‚’æ±ºã‚ã‚‹
  const cells = tablesEl.querySelectorAll('.checklist .check-item');
  const target = cells[pos-1];
  if (!target){ if (node.isConnected) node.remove(); row.remove(); return; }
  const rb = target.getBoundingClientRect();
  const rrow = row.getBoundingClientRect();
const x = rb.left - rrow.left + (rb.width/2) - 28; // 56px ã®åŠåˆ†
node.style.left = `${Math.max(0, x)}px`;
node.style.top  = `0px`;
  if (!node.isConnected) row.appendChild(node);
}

/* ==== ãƒŸãƒƒã‚·ãƒ§ãƒ³59ï¼šå„ checklistbox ã®ç›´ä¸Šã«12æ•°å€¤ã‚«ãƒ¼ãƒ‰ï¼ˆå›ºå®šãƒ©ãƒ³ãƒ€ãƒ ï¼‰
   ï¼‹ nanoï¼ˆã‚«ãƒ¼ãƒ‰ä¸ŠåŠåˆ†ã«é‡ã­ã‚‹ï¼šã‚»ãƒ«å†…ç›¸å¯¾é…ç½®ç‰ˆï¼‰ ==== */
async function renderM59(v){
  const isM59 = ((v?.mission?.id|0) === 59);
  if (!isM59){
    document.querySelectorAll('.m59-row').forEach(n => n.remove());
    document.getElementById('m59Nano')?.remove();
    return;
  }

  // å¯¾è±¡è¡Œï¼ˆchecklistbox ãŒç„¡ã‘ã‚Œã° .checklist ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  const boxes   = Array.from(tablesEl.querySelectorAll('.checklistbox'));
  const targets = boxes.length ? boxes : Array.from(tablesEl.querySelectorAll('.checklist'));
  if (!targets.length) return;

  // ã‚²ãƒ¼ãƒ ã”ã¨å›ºå®šã®12æšï¼ˆåˆå›ã¯ãƒ›ã‚¹ãƒˆãŒä¿å­˜ï¼‰
  let nums = v?.meta?.m59Nums;
  if (!Array.isArray(nums) || nums.length !== 12){
    nums = MATERIALS.numbers.slice();
    shuffle(nums);
    if (state.isHost){
      await update(ref(db, `rooms/${state.roomCode}/meta`), { m59Nums: nums });
    }
  }

  // æ—¢å­˜ãƒ¬ãƒ¼ãƒ³ã‚’æƒé™¤
  document.querySelectorAll('.m59-row').forEach(n => n.remove());

  // å„ checklistbox ã®ç›´å‰ã«12æšãƒ¬ãƒ¼ãƒ³ã‚’æ–°è¨­
  targets.forEach((boxEl, rowIdx) => {
    const lane = document.createElement('div');
    lane.className = 'm59-row';
    lane.style.display = 'grid';
    lane.style.gridTemplateColumns = 'repeat(12, 1fr)';
    lane.style.columnGap = '2px';
    lane.style.width = '100%';
    // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®å·¦ãƒãƒ¼ã‚¸ãƒ³ã«åˆã‚ã›ã¦ãšã‚‰ã™ï¼ˆæ¨ªå¹…è¦‹ãŸç›®ä¸€è‡´ï¼‰
    lane.style.margin = '0 0 6px 10px';
    lane.style.overflow = 'visible';

    nums.forEach((n, idx) => {
      const cell = document.createElement('div');
      cell.className = 'm59-cell';
      cell.style.position = 'relative';
      cell.style.display  = 'grid';
      cell.style.placeItems = 'center';

      const card = document.createElement('div');
      card.className = 'numcard m59num';
      card.style.width  = '30px'; // #59 ã¯å°‘ã—å°ã•ã
      card.style.height = '46px';
      card.style.backgroundImage = `url('${imgNumber(n)}')`;
      card.title = String(n);

      card.onclick = async () => {
        await update(ref(db, `rooms/${state.roomCode}/meta`), {
          m59_row: rowIdx,        // 0-based
          m59_pos: (idx + 1),     // 1..12
          m59_updatedAt: Date.now()
        });
      };

      cell.appendChild(card);
      lane.appendChild(cell);
    });

    boxEl.parentNode.insertBefore(lane, boxEl); // çœŸä¸Šã«å·®ã—è¾¼ã‚€
  });

  // === nano ã‚’æç”»ï¼ˆã‚»ãƒ«å†…ç›¸å¯¾é…ç½®ï¼‰ ===
  const rowIndex = (v?.meta?.m59_row ?? 0) | 0;
  const posIndex = (v?.meta?.m59_pos | 0);  // 1..12
  const goLeft   = !!(v?.meta?.m59_left);

  const lanes = Array.from(tablesEl.querySelectorAll('.m59-row'));
  if (!posIndex || !lanes[rowIndex]){ document.getElementById('m59Nano')?.remove(); return; }

  const targetCell = lanes[rowIndex].children[posIndex - 1];
  if (!targetCell){ document.getElementById('m59Nano')?.remove(); return; }

  // æ—¢å­˜ã‚’ç¢ºå®Ÿã«ä¸€æƒï¼ˆå¸¸ã«1ã¤ã ã‘ï¼‰
  document.getElementById('m59Nano')?.remove();

  const node = document.createElement('div');
  node.id = 'm59Nano';
  node.className = 'm43-nano'; // 56x56 æ—¢å­˜CSSã‚’æµç”¨
  node.style.backgroundImage = `url("${goLeft ? './nano0left.png' : './nano0.png'}")`;

  // â˜…ã“ã“ãŒã€Œä¸ŠåŠåˆ†é‡ã­ã€ï¼šã‚»ãƒ«å†…åŸºæº–ã§ä¸Šè¾ºã«ä¸­å¿ƒã‚’åˆã‚ã›ã‚‹
  node.style.left   = '50%';
  node.style.top    = '-10px';
  node.style.transform = 'translate(-50%, -50%)';
  node.style.pointerEvents = 'auto';

  // ã‚¯ãƒªãƒƒã‚¯ã§å‘ããƒˆã‚°ãƒ«
  node.onclick = (ev)=>{
    openMenu(ev.clientX, ev.clientY, [
      { label: (goLeft ? 'å³å‘ãã«ã™ã‚‹' : 'å·¦å‘ãã«ã™ã‚‹'),
        action: async ()=>{
          await update(ref(db, `rooms/${state.roomCode}/meta`), {
            m59_left: !goLeft,
            m59_updatedAt: Date.now()
          });
        }
      }
    ]);
  };

  targetCell.appendChild(node);
}

  
// ãƒŸãƒƒã‚·ãƒ§ãƒ³57ï¼šåŒæ•°4æšå…¬é–‹ â†’ åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ã‚’ã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®å³ã«è¡¨ç¤ºï¼ˆå®Œå…¨é‡ã­ï¼‰ã€‚
// é‡ã­ä½ç½®ã«ã¯æ•°å€¤ã‚«ãƒ¼ãƒ‰ã¯å‡ºã•ãªã„ã€‚ãƒšã‚¢æ¬„ã«ã¯æ•°å€¤ï¼‹åˆ¶ç´„ãƒšã‚¢ã‚’è¡¨ç¤ºã€‚
async function renderM57(v){
  const isM57 = ((v?.mission?.id|0) === 57);
  if (!isM57){
    // #57ã‹ã‚‰é›¢ã‚ŒãŸç¬é–“ã«ç‰‡ä»˜ã‘
    document.getElementById('m57Grid')?.remove();
    document.querySelectorAll('.m57-grid').forEach(n=>n.remove());
    document.getElementById('m57Sel')?.remove();
    document.getElementById('m57Done')?.remove();
    document.getElementById('m57Stack')?.remove();
    document.getElementById('m57StackRight')?.remove();
    document.getElementById('conZoomOverlay')?.remove();
    return;
  }

  if (state._m57Rendering) return;
  state._m57Rendering = true;

  try {
    // å†æç”»å‰ã®æƒé™¤
    document.getElementById('m57Grid')?.remove();
    document.querySelectorAll('.m57-grid').forEach(n=>n.remove());
    document.getElementById('m57Sel')?.remove();
    document.getElementById('m57Done')?.remove();
    document.getElementById('m57Stack')?.remove();
    document.getElementById('m57StackRight')?.remove();

    const itemsBar = document.getElementById('itemsBar');
    if (!itemsBar) return;

    // æ•°å­—â†’åˆ¶ç´„ A..L ã®å¯¾å¿œï¼ˆãƒ›ã‚¹ãƒˆãŒåˆå›ä¿å­˜ï¼‰
    let letters = v?.meta?.m57Letters;
    if (!letters) {
      letters = Array.from({length:12}, (_,i)=>String.fromCharCode(97+i)); // a..l
      if (state.isHost) {
        await update(ref(db, `rooms/${state.roomCode}/meta`), { m57Letters: letters });
      }
    }

    // 4æšå…¬é–‹ãŒæˆç«‹ã—ãŸæ•°å­—ã®æŠ½å‡º
    const openCountByNum = {};
    (v.tables || []).forEach(T => {
      (T.hand || []).forEach(c => {
        if (c?.kind === 'normal' && c.open === true) {
          const n = c.num | 0;
          openCountByNum[n] = (openCountByNum[n] || 0) + 1;
        }
      });
    });
    const achievedSet = new Set(
      Object.entries(openCountByNum)
        .filter(([, cnt]) => (cnt|0) >= 4)
        .map(([n]) => Number(n))
    );

    // ã¾ã æˆç«‹ã—ã¦ã„ãªã„ã€Œæ•°å€¤ï¼‹åˆ¶ç´„ã€ãƒšã‚¢ã®ç¢ºèªã‚°ãƒªãƒƒãƒ‰ï¼ˆã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ç›´ä¸‹ï¼‰
    {
      const grid = document.createElement('div');
      grid.id = 'm57Grid';
      grid.className = 'm57-grid';
      grid.style.display = 'grid';
      grid.style.gridTemplateColumns = 'repeat(4, auto)';
      grid.style.gap = '6px';
      grid.style.marginTop = '6px';

      for (let i = 1; i <= 12; i++) {
        if (achievedSet.has(i)) continue;

        const wrap = document.createElement('div');
        wrap.style.display = 'flex';
        wrap.style.alignItems = 'center';
        wrap.style.marginRight = '-6px';

        // æ•°å€¤ã‚«ãƒ¼ãƒ‰ï¼ˆâ† ãƒšã‚¢æ¬„ã«ã¯è¡¨ç¤ºã™ã‚‹ï¼‰
        const num = document.createElement('div');
        num.className = 'numcard';
        num.style.backgroundImage = `url('${imgNumber(i)}')`;

        // åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ï¼ˆæ‹¡å¤§ã®ã¿ï¼‰
        const con = document.createElement('div');
        con.className = 'concard';
        con.style.marginLeft = '-6px';
        con.style.backgroundImage = `url('${imgConstraint(letters[i-1])}')`;
        con.onclick = () => {
          document.getElementById('conZoomOverlay')?.remove();
          const overlay = document.createElement('div');
          overlay.id = 'conZoomOverlay';
          overlay.innerHTML = `
            <div class="conzoom-wrap">
              <div class="conzoom-card" style="background-image:url('${imgConstraint(letters[i-1])}')"></div>
            </div>`;
          overlay.onclick = (e)=>{ if(e.target===overlay) overlay.remove(); };
          document.body.appendChild(overlay);
        };

        wrap.appendChild(num);
        wrap.appendChild(con);
        grid.appendChild(wrap);
      }

      itemsBar.insertAdjacentElement('afterend', grid);
    }

    // ï¼ˆä»»æ„ï¼‰é¸ã°ã‚ŒãŸåˆ¶ç´„ã‚’ã‚¢ã‚¤ãƒ†ãƒ å³ã«å˜ä½“è¡¨ç¤ºã—ãŸã„å ´åˆã®ãƒŸãƒ©ãƒ¼
    {
      const di = document.getElementById('di');
      const sel = v?.meta?.m57Chosen;
      if (di && sel) {
        const img = document.createElement('div');
        img.id = 'm57Sel';
        img.className = 'concard';
        img.style.marginRight = '6px';
        img.style.backgroundImage = `url('${imgConstraint(sel)}')`;
        img.onclick = () => {
          document.getElementById('conZoomOverlay')?.remove();
          const overlay = document.createElement('div');
          overlay.id = 'conZoomOverlay';
          overlay.innerHTML = `
            <div class="conzoom-wrap">
              <div class="conzoom-card" style="background-image:url('${imgConstraint(sel)}')"></div>
            </div>`;
          overlay.onclick = (e)=>{ if(e.target===overlay) overlay.remove(); };
          document.body.appendChild(overlay);
        };
        di.insertAdjacentElement('beforebegin', img); // ã‚¢ã‚¤ãƒ†ãƒ ã®å³ã«è¡¨ç¤º
      }
    }

    // å³å´ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆæ•°å€¤ã‚«ãƒ¼ãƒ‰ã¯å‡ºã•ãªã„ï¼åˆ¶ç´„ã®ã¿å®Œå…¨é‡ã­ï¼‰
    {
      const achieved = Array.from(achievedSet);
      if (!achieved.length) return;

      // ä¸¦ã³é †ï¼šæ—¢å­˜é †ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€æ–°è¦ã¯æœ«å°¾ï¼ˆï¼æœ€ä¸Šé¢ï¼‰ã«è¿½åŠ 
      let order = Array.isArray(v?.meta?.m57Order) ? v.meta.m57Order.slice() : [];
      const before = new Set(order);
      order = order.filter(n => achievedSet.has(n));
      achieved.forEach(n => { if (!before.has(n)) order.push(n); });

      // ãƒ›ã‚¹ãƒˆãŒåŒæœŸ
      if (state.isHost) {
        const changed =
          (v?.meta?.m57Order?.length||0) !== order.length ||
          (v?.meta?.m57Order||[]).some((x,i)=> x !== order[i]);
        if (changed) {
          await update(ref(db, `rooms/${state.roomCode}/meta`), {
            m57Order: order,
            m57UpdatedAt: Date.now()
          });
        }
      }

      const di = document.getElementById('di');
      const done = document.createElement('div');
      done.id = 'm57Done';
      done.style.display = 'flex';
      done.style.alignItems = 'center';

      // åˆ¶ç´„ã®å®Œå…¨é‡ã­ç”¨ãƒœãƒƒã‚¯ã‚¹ï¼ˆåŒä¸€åº§æ¨™ãƒ»åŒã‚µã‚¤ã‚ºã«é…ç½®ï¼‰
      const stackBox = document.createElement('div');
      stackBox.id = 'm57Stack';
      stackBox.style.position = 'relative';
      stackBox.style.width  = `var(--con-w, var(--item-w, 50px))`;
      stackBox.style.height = `var(--con-h, var(--item-h, 75px))`;

      order.forEach((n, i) => {
        const con = document.createElement('div');
        con.className = 'concard';
        con.style.position = 'absolute';
        // å®Œå…¨ã«åŒã˜ä½ç½®ï¼ˆä¸‹ã‚’å®Œå…¨ã«éš ã™ï¼‰
        con.style.left = '0';
        con.style.top  = '0';
        con.style.width  = '100%';
        con.style.height = '100%';
        con.style.backgroundImage = `url('${imgConstraint(letters[n-1])}')`;
        con.style.zIndex = String(100 + i); // å¾Œã®ã‚‚ã®ã»ã©ä¸Š
        con.onclick = () => {
          document.getElementById('conZoomOverlay')?.remove();
          const overlay = document.createElement('div');
          overlay.id = 'conZoomOverlay';
          overlay.innerHTML = `
            <div class="conzoom-wrap">
              <div class="conzoom-card" style="background-image:url('${imgConstraint(letters[n-1])}')"></div>
            </div>`;
          overlay.onclick = (e)=>{ if(e.target===overlay) overlay.remove(); };
          document.body.appendChild(overlay);
        };
        stackBox.appendChild(con);
      });

      done.appendChild(stackBox);
      if (di) di.insertAdjacentElement('beforebegin', done);
      else itemsBar.appendChild(done);
    }

  } finally {
    state._m57Rendering = false;
  }
}


/* ã“ã“ã‹ã‚‰è¿½åŠ ï¼šãƒŸãƒƒã‚·ãƒ§ãƒ³61ï¼ˆåˆ¶ç´„A~Eé…å¸ƒï¼†äº¤æ›/B=F~Gã€éšŠé•·ã®â†‘â†“å›ã—ï¼‰ */
async function ensureM61MetaInit(vNow){
  const v = vNow || state.watching; if(!v) return;
  if ((v?.mission?.id|0) !== 61) return;
  const n = (v?.tables?.length|0); if (n<=0) return;
  // æ—¢ã«é…ã‚Šæ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„
  if (Array.isArray(v?.meta?.m61_byTable) && v.meta.m61_byTable.length === n) return;
  if (!state.isHost) return;
// ãƒ‡ãƒƒã‚­A = A..E ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦äººæ•°åˆ†ã«é…ã‚‹ï¼ˆäººæ•°ãŒ5è¶…ãªã‚‰å¾ªç’°ï¼‰
const A = ['A','B','C','D','E']; shuffle(A);
const by = Array.from({length:n}, (_,i)=> A[i % A.length]);

// â˜…è¿½åŠ ï¼šBãƒ‡ãƒƒã‚­ï¼ˆF..Lï¼‰ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ meta ã¸ä¿å­˜ã€‚ä½¿ç”¨æ¸ˆã¿ã¯ç©ºã§é–‹å§‹
const bDeck = ['F','G','H','I','J','K','L']; shuffle(bDeck);

await update(ref(db, `rooms/${state.roomCode}/meta`), {
  m61_byTable: by,
  m61_bDeck: bDeck,     // â† è¿½åŠ 
  m61_bUsed: [],        // â† è¿½åŠ 
  m61_rotAt: Date.now()
});
}

/* ã“ã“ã‹ã‚‰è¿½åŠ ï¼šãƒŸãƒƒã‚·ãƒ§ãƒ³63ï¼ˆéšŠé•·ã®ã¿åˆæœŸé…å¸ƒï¼ãƒªã‚¶ãƒ¼ãƒ–ã¯ã‚¢ã‚¤ãƒ†ãƒ ä¸‹ï¼è­²æ¸¡ï¼†å›åï¼‰ */

// åˆæœŸãƒ¡ã‚¿ã®ç”¨æ„ï¼ˆãƒ›ã‚¹ãƒˆã®ã¿ï¼‰
async function ensureM63MetaInit(vNow){
  const v = vNow || state.watching; if (!v) return;
  if ((v?.mission?.id|0) !== 63) return;
  const n = (v?.tables?.length|0); if (n <= 0) return;
  if (v?.meta?.m63_init === true) return;
  if (!state.isHost) return;

  // äººæ•° â†’ åˆæœŸé…å¸ƒæ•°ï¼ˆéšŠé•·ã®ã¿ï¼‰
  const per = (m)=>{
    if (m===2) return 14;
    if (m===3) return 18;
    if (m===4) return 24;
    return 30; // 5 or 6
  };

  const cap = Math.max(0, v?.captainTable|0);
  const by = {};
  for (let i=0;i<n;i++) by[i] = (i===cap ? per(n) : 0);

  await update(ref(db, `rooms/${state.roomCode}/meta`), {
    oxItem: 0,
    oxByTable: by,
    m63_init: true
  });
}

// æç”»ãƒ»æ“ä½œ
function renderM63(v){
  const isM63 = ((v?.mission?.id|0) === 63);
  // ç‰‡ä»˜ã‘
  if (!isM63){
    document.getElementById('m63Reserve')?.remove();
    document.querySelectorAll('.table').forEach(tb=> tb.style.removeProperty('--table-h'));
    return;
  }

  // åˆå›ãƒ¡ã‚¿
  if (v?.meta?.m63_init !== true){ ensureM63MetaInit(v); return; }

  // ===== ãƒªã‚¶ãƒ¼ãƒ–ï¼ˆã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ç›´ä¸‹ï¼‰ =====
  const itemsBar = document.getElementById('itemsBar');
  if (!itemsBar) return;

  let poolRow = document.getElementById('m63Reserve');
  if (!poolRow){
    poolRow = document.createElement('div');
    poolRow.id = 'm63Reserve';
    poolRow.className = 'ox-row';               // ox-pool ã¯ä»˜ã‘ãªã„ï¼ˆox2ç”»åƒã¯ä½¿ã‚ãªã„ï¼‰
    // ä¸­èº«ï¼ˆæŠ˜è¿”ã—10åˆ—ï¼‰
    const wrap = document.createElement('div');
    wrap.className = 'ox-wrap';
    poolRow.appendChild(wrap);
    itemsBar.insertAdjacentElement('afterend', poolRow);
  }

  const wrap = poolRow.querySelector('.ox-wrap');
  wrap.innerHTML = '';
  const poolCnt = Math.max(0, v?.meta?.oxItem|0);
  for (let i=0;i<poolCnt;i++){
    const t = document.createElement('div');
    t.className = 'token ox';
    wrap.appendChild(t);
  }

  // å°ã•ãª "+N" ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆ2ç§’ï¼‰
  const flashPlus = (n)=>{
    if (!poolRow) return;
    const old = document.getElementById('m63Plus');
    if (old) old.remove();
    const plus = document.createElement('div');
    plus.id = 'm63Plus';
    plus.textContent = `+${n}`;
    plus.style.marginLeft = '6px';
    plus.style.fontWeight = '700';
    plus.style.opacity = '0.85';
    poolRow.appendChild(plus);
    setTimeout(()=> plus.remove(), 2000);
  };

  // ãƒªã‚¶ãƒ¼ãƒ–ï¼šéšŠé•·ã®ã¿ã€Œå›åã€ãƒãƒƒãƒ—
  const myIdx = (v?.tables||[]).findIndex(T => T.playerId === state.userId);
  const capIdx = (v?.captainTable|0);
  if (myIdx === capIdx && poolCnt > 0){
    poolRow.onclick = (ev)=>{
      openOneMini(ev.clientX, ev.clientY, 'å›å', async ()=>{
        const mRef = ref(db, `rooms/${state.roomCode}/meta`);
        const snap = await get(mRef);
        const meta = snap.val()||{};
        const pool = Math.max(0, meta?.oxItem|0);
        if (pool <= 0) return;
        const curCap = Math.max(0, meta?.oxByTable?.[capIdx]||0);
        const upd = {};
        upd['oxItem'] = 0;
        upd[`oxByTable/${capIdx}`] = curCap + pool;
        await update(mRef, upd);
      });
    };
  }else{
    poolRow.onclick = null;
  }

  // ===== å„ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ‰€æŒé…¸ç´ ã‚’è¡¨ç¤ºï¼ˆ#44ã¨åŒã˜ä½ç½®ã«å‡ºã™ï¼‰ =====
  const tableNodes = document.querySelectorAll('.table'); // renderTables ã¨åŒé †
  const n = (v?.tables?.length|0);

  (v.tables||[]).forEach((T, ti)=>{
    const box = tableNodes[ti]; if (!box) return;

    // æ—¢å­˜ã®è¡Œã‚’å†åˆ©ç”¨ or ç”Ÿæˆï¼ˆ#44æµç”¨ï¼‰
    let row = box.querySelector('.ox-row[data-owner="1"][data-m63="1"]');
    if (!row){
      row = document.createElement('div');
      row.className = 'ox-row';
      row.dataset.owner = '1';
      row.dataset.m63 = '1';
      // #44 ã¨åŒã˜ã‚¢ãƒ³ã‚«ãƒ¼ï¼ˆã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆç›´ä¸‹ï¼‰ :contentReference[oaicite:4]{index=4}
      const anchor = box.querySelector('.badge-fixed');
      if (anchor){
        anchor.insertAdjacentElement('afterend', row);
        const ah = anchor.querySelector('.alpha')?.getBoundingClientRect().height || 18;
        row.style.marginTop = `${Math.round(ah * 5)}px`;
      }else{
        (box.querySelector('.hand') || box).appendChild(row);
      }
    }

 // å†æç”»ï¼ˆå¿…ãš .ox-wrap ã‚’æŒŸã‚€ï¼‰
 row.innerHTML = '';
 let w = document.createElement('div');
 w.className = 'ox-wrap';
 row.appendChild(w);
 const cnt = Math.max(0, v?.meta?.oxByTable?.[ti]||0);
 for (let i=0;i<cnt;i++){
   const t = document.createElement('div');
   t.className = 'token ox';
   w.appendChild(t);                // â† .ox-wrap å†…ã«è¿½åŠ 
 }

    // ãƒ†ãƒ¼ãƒ–ãƒ«é«˜ã•ã‚’æ‰€æŒæ•°ã«å¿œã˜ã¦æ‹¡å¼µï¼ˆ15å€‹ã”ã¨ã«1è¡Œè¿½åŠ ï¼‰
    const baseH = 96;       // æ¨™æº–ã®é«˜ã•
    const perRow = 15;      // 1è¡Œã‚ãŸã‚Šã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°
    const rowH = 24;        // 1è¡Œã®é«˜ã•ï¼ˆ20px + gapä½™ç™½ã‚’è€ƒæ…®ï¼‰
    const rows = Math.ceil(cnt / perRow);
    const extra = rows > 0 ? (4 + rowH * rows) : 0;
    box.style.setProperty('--table-h', `${baseH + extra}px`);
    // è‡ªåˆ†ã®æ‰€æŒé…¸ç´ ã‚¯ãƒªãƒƒã‚¯ â†’ 1..12 ã‚’ãƒªã‚¶ãƒ¼ãƒ–ã¸è¿”å´ï¼ˆ+Nãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼‰
    if (Number.isInteger(myIdx) && myIdx === ti){
      row.onclick = (ev)=>{
        const mine = Math.max(0, v?.meta?.oxByTable?.[ti]||0);
        if (mine <= 0) return;
        const maxK = Math.min(12, mine);
        const entries = Array.from({length:maxK}, (_,i)=> i+1).map(k=>({
          label:String(k),
          action: async ()=>{
            const mRef = ref(db, `rooms/${state.roomCode}/meta`);
            const snap = await get(mRef);
            const meta = snap.val()||{};
            const curMine = Math.max(0, meta?.oxByTable?.[ti]||0);
            const curPool = Math.max(0, meta?.oxItem|0);
            if (k > curMine) return;
            const upd = {};
            upd[`oxByTable/${ti}`] = curMine - k;
            upd['oxItem'] = curPool + k;
            await update(mRef, upd);
            flashPlus(k);
          }
        }));
ã€€ã€€    entries.push({ label: `/ ${mine}` });
        openMenu(ev.clientX, ev.clientY, entries);
      };
    }else{
      row.onclick = null;
    }

    // ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã€Œãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã€ã«æ¸¡ã™åˆ¤å®šã‚’ä»˜ä¸ï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆå´ã®boxã§å‡ºã™ï¼‰
    if (Number.isInteger(myIdx) && myIdx !== ti && !box.dataset.m63Bind){
      box.dataset.m63Bind = '1';
      box.addEventListener('click', (ev)=>{
        const mineNow = Math.max(0, v?.meta?.oxByTable?.[myIdx]||0);
        if (mineNow <= 0) return;
        openOneMini(ev.clientX, ev.clientY, 'æ¸¡ã™', async ()=>{
          const mRef = ref(db, `rooms/${state.roomCode}/meta`);
          const snap = await get(mRef);
          const meta = snap.val()||{};
          const curMine   = Math.max(0, meta?.oxByTable?.[myIdx]||0);
          if (curMine <= 0) return;
          const curTarget = Math.max(0, meta?.oxByTable?.[ti]||0);
          const upd = {};
          upd[`oxByTable/${myIdx}`] = 0;
          upd[`oxByTable/${ti}`]    = curTarget + curMine;
          await update(mRef, upd);
        });
      });
    }
  });
}
/* ã“ã“ã¾ã§è¿½åŠ ï¼šãƒŸãƒƒã‚·ãƒ§ãƒ³63 */

  
/* ã“ã“ã‹ã‚‰è¿½åŠ ï¼š#62 äººæ•°åˆ†ã®æ•°å€¤ã‚«ãƒ¼ãƒ‰ï¼ˆåŒæœŸï¼‰ */
async function ensureM62MetaInit(vNow){
  const v = vNow || state.watching; if (!v) return;
  if ((v?.mission?.id|0) !== 62) return;
  const need = (v?.tables?.length|0); if (need <= 0) return;

  // æ—¢ã«äººæ•°åˆ†ãã‚ã£ã¦ã„ã‚Œã°ä½•ã‚‚ã—ãªã„ï¼ˆä¸è¶³/éå¤šãªã‚‰ä½œã‚Šç›´ã—ï¼‰
  const cur = Array.isArray(v?.meta?.m62_nums) ? v.meta.m62_nums : null;
  if (Array.isArray(cur) && cur.length === need) return;
  if (!state.isHost) return;

  // å ´ã«æœªä½¿ç”¨ã®æ•°å­—ã‹ã‚‰äººæ•°åˆ†ã‚’æŠ½é¸ï¼ˆé‡è¤‡å›é¿ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼‰
  const picks = (typeof pickUnusedNumbers === 'function')
    ? pickUnusedNumbers(need)
    : MATERIALS.numbers.slice().sort(()=>Math.random()-0.5).slice(0, need);

  await update(ref(db, `rooms/${state.roomCode}/meta`), { m62_nums: picks });
}

function renderM62(v){
  const isM62 = ((v?.mission?.id|0) === 62);
  const rowId = 'm62Row';
  const old   = document.getElementById(rowId);
  if (!isM62){ if (old) old.remove(); return; }

  const need = (v?.tables?.length|0);
  const nums = Array.isArray(v?.meta?.m62_nums) ? v.meta.m62_nums : null;
  if (!nums || nums.length !== need){ ensureM62MetaInit(v); if (old) old.remove(); return; }

  if (old) old.remove();
  const lane = document.createElement('div');
  lane.id = rowId;
  lane.className = 'numlane';

  // placeNumberCard ã¯æ—¢å­˜ã®åŒã˜æ•°å­—ã®è¡¨ç¤ºã‚’ä¸€ãƒµæ‰€ã«é›†ç´„ï¼ˆé‡è¤‡é˜²æ­¢ï¼†ç§»å‹•ï¼‰ã—ã¦ãã‚Œã¾ã™
  nums.forEach(n => {
    if (typeof placeNumberCard === 'function'){
      placeNumberCard(n, lane);
    }else{
      const nc = document.createElement('div');
      nc.className = 'numcard';
      nc.style.backgroundImage = `url('${imgNumber(n)}')`;
      lane.appendChild(nc);
    }
  });

  // ã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ç›´ä¸‹ã«è¨­ç½®ï¼ˆæ—¢å­˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼‰
  mountLaneUnderItemsBar(lane);
}


  /* ===== ã“ã“ã‹ã‚‰è¿½åŠ ï¼š#66 ã‚¹ãƒ†ãƒ¼ã‚¸ï¼†åˆ¶ç´„ï¼ˆåå­—ï¼‰ ===== */

/** åˆå›ãƒ¡ã‚¿ç”Ÿæˆï¼ˆãƒ›ã‚¹ãƒˆã®ã¿ï¼‰ */
async function ensureM66MetaInit(vNow){
  const v = vNow || state.watching; if (!v) return;
  if ((v?.mission?.id|0) !== 66) return;
  if (Array.isArray(v?.meta?.m66_slots)) return;   // æ—¢ã«ç”¨æ„æ¸ˆã¿
  if (!state.isHost) return;

  // A~E ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ« â†’ å›ºå®š5ã‚¹ãƒ­ãƒƒãƒˆã«é…ç½®
  const deck = ['A','B','C','D','E'];
  shuffle(deck);
  const slots = [deck[0], deck[1], deck[2], deck[3], deck[4]]; // [byDi, top(x), bottom, left, right]

  await update(ref(db, `rooms/${state.roomCode}/meta`), {
    m66_slots: slots,
    m66_face : 1,     // 1éšï¼ˆ1stage.jpgï¼‰
    m66_rabit: null   // ã¾ã è¡¨ç¤ºãªã—
  });
}

/** æç”»ãƒ»æ“ä½œ */
function renderM66(v){
  const isM66 = ((v?.mission?.id|0) === 66);
  const oldLayer = document.getElementById('m66Layer');
  const oldByDi  = document.getElementById('m66ConByDi');

  if (!isM66){
    if (oldLayer) oldLayer.remove();
    if (oldByDi)  oldByDi.remove();
    if (document.getElementById('conZoomOverlay')) closeConstraintZoom();
    return;
  }

  // åˆæœŸãƒ¡ã‚¿æœªç”¨æ„ãªã‚‰ãƒ›ã‚¹ãƒˆãŒç”¨æ„ï¼ˆæ¬¡tickã§æç”»ï¼‰
  if (!Array.isArray(v?.meta?.m66_slots)){ ensureM66MetaInit(v); if (oldLayer) oldLayer.remove(); if (oldByDi) oldByDi.remove(); return; }

  const slots = v.meta.m66_slots.slice(); // [byDi, top, bottom, left, right]

  // â”€â”€ diç”»åƒã®å·¦ï¼šåˆ¶ç´„1æšï¼ˆbyDiï¼‰
  const di = document.getElementById('di');
  if (di){
    let byDi = document.getElementById('m66ConByDi');
    if (!byDi){
      byDi = document.createElement('div');
      byDi.id = 'm66ConByDi';
      byDi.className = 'concard';
      // diã®å·¦ã«å·®ã—è¾¼ã¿ï¼ˆitemsBarå†…ï¼‰
      di.insertAdjacentElement('beforebegin', byDi);
      // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å…¥æ›¿
      bindM66Drag(byDi, 'bydi');
      byDi.title = 'æ‹¡å¤§';
      byDi.addEventListener('click', (ev)=>{ 
        ev.stopPropagation();
        const cur = Array.isArray(state?.watching?.meta?.m66_slots) ? state.watching.meta.m66_slots : slots;
        openConstraintZoomView(cur[0]);
      });
    }
    // è¡¨ç¤ºã¯ä»Šå›ã®æç”»ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã§OK
    byDi.style.backgroundImage = `url('${imgConstraint(slots[0])}')`;
  }


  // â”€â”€ ã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ç›´ä¸‹ï¼šåå­—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆtop / left stage right / bottomï¼‰
  let layer = document.getElementById('m66Layer');
  if (!layer){
    layer = document.createElement('div');
    layer.id = 'm66Layer';
    layer.className = 'm66-layer';

    // ä¸Šï¼ˆxï¼‰
    const lineTop = document.createElement('div'); lineTop.className = 'm66-line';
    lineTop.appendChild(mkSlot('top'));
    layer.appendChild(lineTop);

    // ä¸­ï¼ˆå·¦ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ»å³ï¼‰
    const lineMid = document.createElement('div'); lineMid.className = 'm66-line';
    lineMid.appendChild(mkSlot('left'));
    lineMid.appendChild(mkStageBox());
    lineMid.appendChild(mkSlot('right'));
    layer.appendChild(lineMid);

    // ä¸‹
    const lineBot = document.createElement('div'); lineBot.className = 'm66-line';
    lineBot.appendChild(mkSlot('bottom'));
    layer.appendChild(lineBot);

    // æ—¢å­˜ãƒ˜ãƒ«ãƒ‘ã§ itemsBar ã®ç›´ä¸‹ã«è¨­ç½®
    mountLaneUnderItemsBar(layer);
  }

  // å†æç”»
  refreshM66(layer, slots, v);

  /* ===== å†…éƒ¨ãƒ˜ãƒ«ãƒ‘ ===== */

  function mkSlot(name){
    const slot = document.createElement('div'); slot.className = 'm66-slot';
    const cc = document.createElement('div'); cc.className = 'concard'; cc.draggable = true;

    // æ‹¡å¤§ï¼ˆå¸¸ã«æœ€æ–°metaã‹ã‚‰å‚ç…§ï¼‰
    cc.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      const map = { bydi:0, top:1, bottom:2, left:3, right:4 };
      const idx = map[name];
      const cur = Array.isArray(state?.watching?.meta?.m66_slots) ? state.watching.meta.m66_slots : slots;
      const letter = cur?.[idx];
      if (letter) openConstraintZoomView(letter);
    });

    bindM66Drag(cc, name);
    slot.appendChild(cc);
    return slot;
  }

  // ï¼ˆgetLetterBy ã¯ä¸è¦ã«ãªã£ãŸã‚‰å‰Šé™¤OKï¼‰


  function mkStageBox(){
    const box = document.createElement('div');
    box.className = 'm66-stagebox';
    const stage = document.createElement('div');
    stage.className = 'm66-stage';
    box.appendChild(stage);

    // å³ä¸Šãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆï¼ˆéšåˆ‡æ›¿ï¼‰
    const hot = document.createElement('div');
    hot.className = 'm66-hot';
    hot.title = 'éšã‚’åˆ‡æ›¿';
    hot.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      const cur = (v?.meta?.m66_face|0)===2 ? 2 : 1;
      const to2 = (cur===1);
      openOneMini(ev.clientX, ev.clientY, to2 ? '2éšã¸' : '1éšã¸', async ()=>{
        await update(ref(db, `rooms/${state.roomCode}/meta`), { m66_face: to2 ? 2 : 1 });
      });
    });
    box.appendChild(hot);

    // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªãƒƒã‚¯ï¼šãƒ©ãƒ“ãƒƒãƒˆã‚’ãã®åº§æ¨™ã«ç§»å‹•ï¼ˆ1åŒ¹ã ã‘ï¼‰
    box.addEventListener('click', async (ev)=>{
      const r = box.getBoundingClientRect();
      const nx = (ev.clientX - r.left) / r.width;
      const ny = (ev.clientY - r.top) / r.height;
      await update(ref(db, `rooms/${state.roomCode}/meta`), { m66_rabit: { x:nx, y:ny } });
    });

    return box;
  }



 function refreshM66(layer, slots, v){
    const ccTop = layer.querySelector('.m66-line:nth-child(1) .concard');
    const mid   = layer.querySelector('.m66-line:nth-child(2)');
    const ccLeft  = mid?.querySelector('.m66-slot:nth-child(1) .concard');
    const ccRight = mid?.querySelector('.m66-slot:nth-child(3) .concard');
    const ccBot = layer.querySelector('.m66-line:nth-child(3) .concard');

    if (ccTop){   ccTop.style.backgroundImage   = `url('${imgConstraint(slots[1])}')`; ccTop.dataset.letter = slots[1]; }
    if (ccLeft){  ccLeft.style.backgroundImage  = `url('${imgConstraint(slots[3])}')`; ccLeft.dataset.letter = slots[3]; }
    if (ccRight){ ccRight.style.backgroundImage = `url('${imgConstraint(slots[4])}')`; ccRight.dataset.letter = slots[4]; }
    if (ccBot){   ccBot.style.backgroundImage   = `url('${imgConstraint(slots[2])}')`; ccBot.dataset.letter = slots[2]; }
    // ã‚¹ãƒ†ãƒ¼ã‚¸é¢ï¼ˆ1=è¡¨ 2=è£ï¼‰
    const stage = layer.querySelector('.m66-stage');
    const face  = (v?.meta?.m66_face|0)===2 ? './2stage.jpg' : './1stage.jpg';
    if (stage) stage.style.backgroundImage = `url('${face}')`;

    // ãƒ©ãƒ“ãƒƒãƒˆã®åº§æ¨™åæ˜ 
    const box = layer.querySelector('.m66-stagebox');
    if (box){
      let rab = box.querySelector('.m66-rabit');
      const pos = v?.meta?.m66_rabit;
      if (pos && Number.isFinite(pos.x) && Number.isFinite(pos.y)){
        if (!rab){ rab = document.createElement('div'); rab.className='m66-rabit'; box.appendChild(rab); }
        rab.style.left = (pos.x * 100) + '%';
        rab.style.top  = (pos.y * 100) + '%';
      }else{
        if (rab) rab.remove();
      }
    }
  }

  // D&D äº¤æ›ï¼ˆåŒä¸€å›ºå®šã‚¹ãƒ­ãƒƒãƒˆé–“ã§ä¸­èº«ã‚’å…¥æ›¿ï¼‰
  function bindM66Drag(node, name){
    const map = { bydi:0, top:1, bottom:2, left:3, right:4 };
    node.setAttribute('draggable','true');

    node.addEventListener('dragstart',(e)=>{
      e.dataTransfer.setData('text/plain', name);
    });
    node.addEventListener('dragover',(e)=>{ e.preventDefault(); });
    node.addEventListener('drop', async (e)=>{
      e.preventDefault();
      const src = e.dataTransfer.getData('text/plain');
      const dst = name;
      if (!src || !dst || src===dst) return;
      try{
        const mRef = ref(db, `rooms/${state.roomCode}/meta`);
        const snap = await get(mRef);
        const meta = snap.val()||{};
        const cur  = Array.isArray(meta?.m66_slots) ? meta.m66_slots.slice() : slots.slice();
        const si = map[src], di = map[dst];
        if (si==null || di==null) return;
        const tmp = cur[si]; cur[si]=cur[di]; cur[di]=tmp;
        await update(mRef, { m66_slots: cur });
      }catch(err){ console.error(err); }
    });
  }
}
/* ===== ã“ã“ã¾ã§è¿½åŠ ï¼š#66 ===== */

  
  
/* ã“ã“ã¾ã§è¿½åŠ ï¼š#62 */
// ===== M65 åˆæœŸé…å¸ƒï¼šéšŠé•·ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³é…å¸ƒ =====
async function ensureM65MetaInit(vNow){
  const v = vNow || state.watching; if (!v) return;
  if ((v?.mission?.id|0) !== 65) return;
  const N = (v?.tables?.length|0); if (N <= 0) return;
  if (Array.isArray(v?.meta?.m65_byTable)) return;   // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿
  if (!state.isHost) return;                         // åˆæœŸåŒ–ã¯ãƒ›ã‚¹ãƒˆã®ã¿

  const cap = Math.max(0, v?.captainTable|0);

  // é…å¸ƒé †ï¼šéšŠé•·ãƒ†ãƒ¼ãƒ–ãƒ« â†’ å³å›ã‚Šã§ã€Œå…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã€ï¼ˆæœªç€å¸­ã‚‚å«ã‚€ï¼‰
  const order = [];
  for (let off=0; off<N; off++){
    order.push((cap + off) % N);
  }

  // 1..12 ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ã€order ã«ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³é…å¸ƒ
  const deck = MATERIALS.numbers.slice(); // æƒ³å®š: [1..12]
  shuffle(deck);

  const by = Array.from({length:N}, ()=> []);
  for (let k=0; k<deck.length; k++){
    const owner = order[k % order.length];
    by[owner].push(deck[k]);
  }

  await update(ref(db, `rooms/${state.roomCode}/meta`), { m65_byTable: by });
}
// ===== /M65 =====

function renderM65(v){
  const isM65 = ((v?.mission?.id|0) === 65);
  const rowId = 'm65Row';
  const old   = document.getElementById(rowId);
  if (!isM65){ if (old) old.remove(); return; }

  // åˆæœŸé…å¸ƒï¼ˆæœªç”Ÿæˆãªã‚‰ãƒ›ã‚¹ãƒˆãŒä¸€åº¦ã ã‘ï¼‰
  if (!Array.isArray(v?.meta?.m65_byTable)){ ensureM65MetaInit(v); if (old) old.remove(); return; }

  // è‡ªåˆ†ãŒæœªç€å¸­ãªã‚‰è¡¨ç¤ºã—ãªã„
  const tables = v.tables || [];
  const myIdx  = tables.findIndex(T => T?.playerId === state.userId);
  if (myIdx < 0){ if (old) old.remove(); return; }

  // è‡ªåˆ†ã®æŒã¡æœ­ï¼ˆæ•°å€¤ã‚«ãƒ¼ãƒ‰ï¼‰ã‚’å–å¾—ãƒ»æ˜‡é †è¡¨ç¤º
  const mine = Array.isArray(v.meta.m65_byTable?.[myIdx]) ? v.meta.m65_byTable[myIdx].slice() : [];
  mine.sort((a,b)=>a-b);

  // å…¨ä½“å…¬é–‹ã®é€šå¸¸ã‚³ãƒ¼ãƒ‰æšæ•°ã‚’é›†è¨ˆï¼ˆå„ãƒ†ãƒ¼ãƒ–ãƒ« hand ã® open==true, kind:'normal'ï¼‰â†’ 4æšä»¥ä¸Šã§è£é¢
  const openCountByNum = {};
  (tables||[]).forEach(T=>{
    (T.hand||[]).forEach(c=>{
      if (c?.kind==='normal' && c.open===true){
        const n = c.num|0;
        openCountByNum[n] = (openCountByNum[n]||0) + 1;
      }
    });
  });

  const footer = document.getElementById('missionFooter');
 if (!footer){ if (old) old.remove(); return; }
 let row = old;
 if (!row){
   row = document.createElement('div');
   row.id = rowId;
   row.className = 'numlane';
   // footer ã®å‰ã«å·®ã—è¾¼ã‚€ï¼ˆï¼missionFooterã®ä¸Šã«è¡¨ç¤ºï¼‰
   footer.insertAdjacentElement('beforebegin', row);
 }
 row.innerHTML = '';
  // æ¬¡ã®ç€å¸­è€…ã‚’æ±‚ã‚ã‚‹
  const findNextSeated = (fromIdx)=>{
    if (tables.length===0) return -1;
    for (let off=1; off<=tables.length; off++){
      const i = (fromIdx + off) % tables.length;
      if (tables[i]?.playerId) return i;
    }
    const any = tables.findIndex(T => T?.playerId);
    return any >= 0 ? any : 0;
  };
  const nextIdx = findNextSeated(myIdx);
  const nextName = tables[nextIdx]?.playerName || `#${(nextIdx|0)+1}`;

  // ã‚«ãƒ¼ãƒ‰DOMç”Ÿæˆï¼ˆè£é¢æ¡ä»¶: ãã®æ•°ãŒ4æšä»¥ä¸Š å…¨ä½“å…¬é–‹ï¼‰
  mine.forEach(n=>{
    const holder = document.createElement('div');
    holder.className = 'numcard-holder';
    const nc = document.createElement('div');
    nc.className = 'numcard';
    const needBack = (openCountByNum[n]|0) >= 4;
    if (needBack){
      nc.classList.add('back'); // è£é¢è¡¨ç¤ºï¼ˆã‚¯ãƒªãƒƒã‚¯å¯ï¼‰
      nc.style.backgroundImage = `url('${imgBack}')`; // â˜… æ•°å€¤ã‚«ãƒ¼ãƒ‰å°‚ç”¨ã®è£é¢
    }else{
      nc.style.backgroundImage = `url('${imgNumber(n)}')`;
    }
    nc.title = `#${n}`;

nc.onclick = async (ev)=>{

  /*** è¿½åŠ ï¼š#29 ã§ 4æšå…¬é–‹æ¸ˆã¿ã®æ•°å€¤ã¯ã€Œæ¸¡ã›ãªã„ã€ ***/
  const isM29Now = ((state?.watching?.mission?.id|0) === 29);
  if (isM29Now && (openCountByNum[n]|0) >= 4){
    openOneMini(ev.clientX, ev.clientY, '');
    return;
  }

      openMenu(ev.clientX, ev.clientY, [
        { label:`${nextName} ã« ${n} ã‚’æ¸¡ã™`, action: async ()=>{
          try{
            // æœ€æ–°ãƒ¡ã‚¿ã‚’å–å¾—ã—ã¦è‡ªåˆ†â†’æ¬¡å¸­ã¸1æšç§»å‹•
            const mRef = ref(db, `rooms/${state.roomCode}/meta`);
            const snap = await get(mRef);
            const meta = snap.val() || {};
            const by   = Array.isArray(meta.m65_byTable) ? meta.m65_byTable.slice() : [];
            const myArr   = Array.isArray(by[myIdx]) ? by[myIdx].slice() : [];
            const nextArr = Array.isArray(by[nextIdx]) ? by[nextIdx].slice() : [];
            const pos = myArr.indexOf(n);
            if (pos >= 0){
              myArr.splice(pos,1);
              nextArr.push(n);
              by[myIdx]  = myArr;
              by[nextIdx]= nextArr;
              await update(mRef, { m65_byTable: by });
            }
          }catch(e){ console.error(e); }
        }}]);
    };
    holder.appendChild(nc);
    row.appendChild(holder);
  });
}
/* ===== /#65 ===== */

  
function renderM61(v){
  const isM61 = ((v?.mission?.id|0) === 61);
  // ç‰‡ä»˜ã‘ï¼ˆ#61ä»¥å¤–ã«ãªã£ãŸã‚‰ç—•è·¡ã‚’æ¶ˆã™ï¼‰
  if (!isM61){
    document.querySelectorAll('.m61-con, .m61-stack').forEach(n=>n.remove());
    if (document.getElementById('conZoomOverlay')) closeConstraintZoom();
    return;
  }
  // åˆæœŸé…å¸ƒ
  if (!Array.isArray(v?.meta?.m61_byTable)) { ensureM61MetaInit(v); return; }

  const by = v.meta.m61_byTable.slice();
  const myIdx = (v.tables||[]).findIndex(T => T.playerId === state.userId);

  // å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚­ãƒ£ãƒ©ã‚«ãƒ¼ãƒ‰ã€Œå·¦ã€ã«ã€ã‚­ãƒ£ãƒ©ã‚«ãƒ¼ãƒ‰ã¨åŒã‚µã‚¤ã‚ºã§è¡¨ç¤º
  const tableEls = Array.from(document.querySelectorAll('#tables .table'));
  tableEls.forEach((tbEl, ti)=>{
    // æ—¢å­˜ãƒãƒ¼ãƒ‰ã‚’æƒé™¤ã—ã¦1å€‹åŒ–
    tbEl.querySelectorAll('.m61-con, .m61-stack').forEach(n=>n.remove());
    const content = tbEl.querySelector('.t-content');
    const charCol = tbEl.querySelector('.char-col');
    if (!content || !charCol) return;
    const ch = by[ti];
    if (!ch) return;

    // â–¼ M61 å°‚ç”¨ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆåˆ¶ç´„ã®ä¸‹ã«æ¥µå°ã‚­ãƒ£ãƒ©ï¼‰
    const stack = document.createElement('div');
    stack.className = 'm61-stack';
    // åˆ¶ç´„ã‚«ãƒ¼ãƒ‰
    const con = document.createElement('div');
    con.className = 'concard m61-con';
    con.style.width  = 'var(--char-w)';
   con.style.height = 'var(--char-h)';
    con.style.backgroundImage = `url('${imgConstraint(ch)}')`;
    // ãƒŸãƒ‹ã‚­ãƒ£ãƒ©
    const mini = document.createElement('div');
   mini.className = 'm61-mini';
    const t = (v.tables||[])[ti] || {};
    const seatEmpty = !t.playerId;
    const amSeatedHere = (t.playerId && t.playerId === state.userId);
    if (seatEmpty){
      mini.classList.add('blank');
      mini.onclick = null;
    }else{
      const face = t.character?.flipped ? './battery.jpg' : `./${t.character?.face || 'member (1).jpg'}`;
      mini.style.backgroundImage = `url("${face}")`;
     // æ—¢å­˜ã®å¤§ã‚­ãƒ£ãƒ©åŒæ§˜ã€æœ¬äººã®ã¿è£è¡¨ãƒˆã‚°ãƒ«

      if (amSeatedHere){
        const orig = String(t?.character?.face || '');
        if (orig.includes('member (9).jpg')){
          mini.style.cursor = 'pointer';
          mini.onclick = ()=> openRoleZoomView(orig);
        }else{
          mini.onclick = async ()=>{
            await update(ref(db, `rooms/${state.roomCode}/tables/${ti}/character`), { flipped: !t.character?.flipped });
          };
        }
      }else{
        mini.onclick = null;
      }

      if (!amSeatedHere) mini.style.cursor = 'default';
   }
    stack.appendChild(con);
    stack.appendChild(mini);
    // æ—§ .char-col ã‚’ç‰©ç†å‰Šé™¤ã—ã¦è©°ã‚ã‚‹
    content.insertBefore(stack, charCol);
    charCol.remove();


  {
      const rBox   = tbEl.getBoundingClientRect();
      const rStack = stack.getBoundingClientRect();
      // æ—¢å®š 96px ä»¥ä¸Šã§ã€ä¸‹ç«¯ + ä½™ç™½6px ã¾ã§ç¢ºä¿
      const needPx = Math.max(96, Math.ceil(rStack.bottom - rBox.top + 6));
      applyTableHeight(tbEl, needPx);
    }

    // è‡ªåˆ†ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã ã‘ã€Œæ‹¡å¤§â†’äº¤æ›ã€å¯èƒ½
    if (ti === myIdx){
      con.style.cursor = 'pointer';
      con.onclick = ()=> openConstraintZoom61(ch, ti);
   }else{
      // è‡ªåˆ†ä»¥å¤–ï¼šæ‹¡å¤§ã®ã¿ï¼ˆäº¤æ›ãªã©ã®ãƒãƒƒãƒ—ãªã—ï¼‰
      con.style.cursor = 'pointer';
      con.onclick = ()=> openConstraintZoomView(ch);
    }
  });

const capIdx = v?.captainTable ?? null;
  const zoneId = 'm61TapZone';
  document.getElementById(zoneId)?.remove();
  if (capIdx >= 0 && capIdx === myIdx){
    const zone = document.createElement('div');
    zone.id = zoneId;
    Object.assign(zone.style, {
      position:'fixed', left:'0', right:'0', bottom:'0', height:'56px',
      zIndex:'200', background:'transparent', pointerEvents:'auto'
    });
    const mRef = ref(db, `rooms/${state.roomCode}/meta`);
    const rotate = async (dir)=>{
      try{
        const snap = await get(mRef);
        const meta = snap.val()||{};
        const arr = Array.isArray(meta.m61_byTable) ? meta.m61_byTable.slice() : [];
        if (arr.length===0) return;
        const n = arr.length;
        const next = Array.from({length:n}, (_,i)=> arr[(i - dir + n)%n]);
        await update(mRef, { m61_byTable: next, m61_rotAt: Date.now() });
      }catch(e){ console.error('[M61 rotate]', e); }
    };
    zone.onclick = (ev)=>{
      ev.stopPropagation();
      openBottomMenu([
        { label:'åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ã‚’â†‘', action: ()=> rotate(-1) },
        { label:'åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ã‚’â†“', action: ()=> rotate(1) }
      ]);
    };
    document.body.appendChild(zone);
  }

}

function applyCaptainBorder(v) {
  const mid = v?.mission?.id | 0;

  // ã„ã£ãŸã‚“å…¨ãƒªã‚»ãƒƒãƒˆï¼ˆå†æç”»æ™‚ã®æ®‹ç•™é˜²æ­¢ï¼‰
  tablesEl.querySelectorAll('.char-card.captain-card')
    .forEach(el => el.classList.remove('captain-card'));

  // å¯¾è±¡ãƒŸãƒƒã‚·ãƒ§ãƒ³ä»¥å¤–ã¯ä½•ã‚‚ã—ãªã„
  if (mid < 31 || mid > 66) return;

  // è¦³æˆ¦è€…ï¼ˆæœªç€å¸­ï¼‰ã¯è¦‹ãˆãªã„
  if (state.seatedTable == null) return;

  // éšŠé•·å¸­ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
  const capIdx = v?.captainTable;
  if (capIdx == null) return;

  // éšŠé•·å¸­ã«å®Ÿéš›ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒåº§ã£ã¦ã„ã‚‹ã“ã¨
  const hasCaptain = !!(v?.tables?.[capIdx]?.playerId);
  if (!hasCaptain) return;

  // éšŠé•·ãŒ member (6)ã€œ(9) ã‚’é¸æŠå®Œäº†ã—ã¦ã„ã‚‹ã“ã¨ï¼ˆface ã«ä¿å­˜ï¼‰
  const capFace = (v?.tables?.[capIdx]?.character?.face || '').toLowerCase();
  const pickedAlt = /member\s*\((6|7|8|9)\)\.(jpe?g|png)$/.test(capFace);
  if (!pickedAlt) return;   // æœªé¸æŠã‚„ member (5) ãªã‚‰é»’æ ãªã—

  // â–¼â–¼ #34 å°‚ç”¨ï¼šéšŠé•·ãŒè‡ªåˆ†ã®åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ã‚’ã€Œå ´ï¼ˆã‚»ãƒ³ã‚¿ãƒ¼ï¼‰ã€ã«å‡ºã™ã¾ã§é»’æ ã‚’å‡ºã•ãªã„ â–¼â–¼
  if (mid === 34) {
    const center = Array.isArray(v?.m34_center) ? v.m34_center : [];
    const capHasPlayed = center.some(o => (o?.by|0) === capIdx);
    if (!capHasPlayed) return; // ã¾ã å ´ã«å‡ºã—ã¦ã„ãªã„ â†’ é»’æ ã‚’æŠ‘æ­¢
  }
  

  // DOMã«åæ˜ ï¼ˆæ­£ä½“ã‚«ãƒ¼ãƒ‰ã¯ .char-cardï¼‰
  const tb = tablesEl.querySelectorAll('.table')[capIdx];
  if (!tb) return;

  tb.querySelectorAll('.char-card').forEach(c => {
    c.classList.add('captain-card');
  });
}

function enforceM31to66(v){
  try{
    const mid = (v?.mission?.id|0);
    const inRange = (mid >= 31 && mid <= 66);
    const body = document.body;

    // ç«¶åˆã—ã†ã‚‹å¤ã„ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æƒé™¤
    ['m3166Style','m3166MaskStyle','m3166PrivacyStyle','m3166TableMaskStyle','m3166CaptainBlankStyle','m3166HardMaskStyle','m3166MiniBorderStyle']
      .forEach(id=>{ const el=document.getElementById(id); if(el) el.remove(); });

    // CSSï¼ˆæœ€çµ‚è£å®šï¼‰ï¼šæœªé¸æŠãƒ†ãƒ¼ãƒ–ãƒ«ï¼éšŠé•·æœªç€å¸­ã¯å¸¸æ™‚ãƒ–ãƒ©ãƒ³ã‚¯ + å°æ ç”¨ã®é»’æ 
    const css = `
/* === M31-66: æ­£ä½“ã‚«ãƒ¼ãƒ‰ã®æœ€çµ‚è£å®šï¼ˆæœªé¸æŠ&éšŠé•·æœªç€å¸­ã¯å¸¸æ™‚ãƒ–ãƒ©ãƒ³ã‚¯ï¼‰ === */
body[data-privacy="m31-66"] #tables .table .char-card{ position:relative; }

/* æœªé¸æŠãƒ†ãƒ¼ãƒ–ãƒ«ã¯å¸¸æ™‚ãƒ–ãƒ©ãƒ³ã‚¯ï¼ˆåˆæœŸé…å¸ƒã‚‚ä¸å¯è¦–ï¼‰ */
body[data-privacy="m31-66"] #tables .table[data-picked="0"] .char-card::after{
  content:""; position:absolute; inset:0;
  background:#f3f4f6; border:1px dashed #d1d5db; border-radius:6px;
  z-index:2147483647; pointer-events:none;
}
/* éšŠé•·ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæœªç€å¸­ãªã‚‰å¸¸æ™‚ãƒ–ãƒ©ãƒ³ã‚¯ */
body[data-privacy="m31-66"] #tables .table[data-cap="1"][data-seated="0"] .char-card::after{
  content:""; position:absolute; inset:0;
  background:#f3f4f6; border:1px dashed #d1d5db; border-radius:6px;
  z-index:2147483647; pointer-events:none;
}

/* â˜… å°ã•ã„æ ï¼ˆm61-miniï¼‰ç”¨ã®é»’æ  â€” ãƒ•ã‚¡ã‚¤ãƒ«CSSã«ã¯å®šç¾©ãŒãªã„ãŸã‚ã“ã“ã§ä»˜ä¸ */
.m61-mini.captain-card{ border:2px solid #000 !important; border-radius:4px; }
/* === /M31-66 === */
`;
    let st = document.createElement('style');
    st.id = 'm3166MiniBorderStyle';
    st.textContent = css;
    document.head.appendChild(st);

    // ç¯„å›²å¤–ã¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    if(!inRange){
      delete body.dataset.privacy;
      document.querySelectorAll('#tables .table').forEach(tb=>{
        tb.removeAttribute('data-picked');
        tb.removeAttribute('data-seated');
        tb.removeAttribute('data-cap');
      });
      document.querySelectorAll('#tables .char-card.captain-card, #tables .m61-mini.captain-card')
        .forEach(el=>el.classList.remove('captain-card'));
      return;
    }
    body.dataset.privacy = 'm31-66';

    // DBã®çŠ¶æ…‹
    const tables = Array.isArray(v?.tables) ? v.tables : [];
    const face1to9   = /member\s*\(([1-9])\)\.(?:jpe?g|png|webp)$/i;
    const faceNot5   = /member\s*\((1|2|3|4|6|7|8|9)\)\.(?:jpe?g|png|webp)$/i; // é»’æ ã¯ã€Œ5ã€é™¤å¤–

    const tEls = document.querySelectorAll('#tables .table');
    const capIdx = (v?.captainTable ?? null);

    // å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®å±æ€§ã‚’åˆ»ã‚€ & åˆæœŸã‚«ãƒ¼ãƒ‰ã®éœ²å‡ºã‚’æŠ‘æ­¢/å¾©å¸°
    tEls.forEach((tb, idx)=>{
      const t = tables[idx] || {};
      const seatedThere = !!t.playerId;
      const face = String(t?.character?.face || '');   // DBå®Ÿå€¤
      const picked = seatedThere && face1to9.test(face);

      tb.dataset.seated = seatedThere ? '1' : '0';
      tb.dataset.picked = picked ? '1' : '0';
      if (capIdx === idx) tb.dataset.cap = '1'; else tb.removeAttribute('data-cap');

      const charEl = tb.querySelector('.char-card');
      const miniEl = tb.querySelector('.m61-mini'); // å°ã•ã„è¡¨ç¤ºï¼ˆç‰¹ã«M61ã§ä½¿ç”¨ï¼‰

      // æœªé¸æŠ orï¼ˆéšŠé•·ãƒ†ãƒ¼ãƒ–ãƒ«ã§æœªç€å¸­ï¼‰â†’ åˆæœŸç”»åƒã‚’ç¢ºå®Ÿã«æ¶ˆã™ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¨äºŒé‡åŒ–ã§ä¿é™ºï¼‰
      const mustHide = (!picked) || (capIdx === idx && !seatedThere);
      if (charEl){
        if (mustHide) charEl.style.backgroundImage = 'none';
        else if (charEl.style.backgroundImage === 'none') charEl.style.removeProperty('background-image');
        charEl.classList.remove('blank','captain-card'); // æ®‹éª¸ã‚’æƒé™¤
      }
      if (miniEl){
        if (mustHide) miniEl.style.backgroundImage = 'none';
        else if (miniEl.style.backgroundImage === 'none') miniEl.style.removeProperty('background-image');
        miniEl.classList.remove('blank','captain-card');
      }
    });

    // éšŠé•·ã®é»’æ ï¼šé–²è¦§è€…ãŒ1ã€œ9ã®é¸æŠè€… & éšŠé•·å¸­ãŒç€å¸­ã‹ã¤ã€Œ5ä»¥å¤–ã€ã‚’é¸æŠæ¸ˆã¿
    // ã•ã‚‰ã«ã€ŒãƒŸãƒƒã‚·ãƒ§ãƒ³31/61ã§ã¯å°ã•ã„æ ã«ã®ã¿ã€æ ã‚’ä»˜ä¸ã€‚ãã‚Œä»¥å¤–ã§ã¯é€šå¸¸ã®.char-cardã«ä»˜ä¸ã€‚
    const viewerIdx = (state?.seatedTable ?? null);
    const viewerPicked = (viewerIdx !== null) && face1to9.test(String(tables?.[viewerIdx]?.character?.face || ''));

    // ã„ã£ãŸã‚“å…¨ã¦ã®æ ã‚’å¤–ã™ï¼ˆç«¶åˆæ’é™¤ï¼‰
    document.querySelectorAll('#tables .char-card.captain-card, #tables .m61-mini.captain-card')
      .forEach(el=>el.classList.remove('captain-card'));

    if (capIdx != null && viewerPicked){
      const capT = tables[capIdx] || {};
      const capSeated = !!capT.playerId;
      const capFace = String(capT?.character?.face || '');
      const capPickedNot5 = capSeated && faceNot5.test(capFace); // 5ã¯é™¤å¤–

        if (capPickedNot5){
          const capTableEl = tEls[capIdx];
          if (capTableEl){
            const miniEl = capTableEl.querySelector('.m61-mini');
            const bigEl  = capTableEl.querySelector('.char-card');
  
            // #34 ä¾‹å¤–ï¼šéšŠé•·æœ¬äººã«ã¯å¸¸ã«é»’æ ã‚’è¡¨ç¤ºã€‚æœªå ´å‡ºã—ã®é–“ã¯ä»–è€…ã«ã¯éè¡¨ç¤ºã€‚
            if (mid === 34){
              const center = Array.isArray(v?.m34_center) ? v.m34_center : [];
              const capHasPlayed = center.some(o => (o?.by|0) === capIdx);
              const viewingSelfCaptain = (state?.seatedTable ?? null) === capIdx;
              if (!capHasPlayed && !viewingSelfCaptain){
                // æŠ‘æ­¢ï¼šä½•ã‚‚ä»˜ã‘ãªã„ï¼ˆç›´å‰ã§ä¸€åº¦ remove æ¸ˆã¿ï¼‰
              }else{
              if (bigEl)  bigEl.classList.add('captain-card');
              if (miniEl) miniEl.classList.remove('captain-card');
             }
         }else if (mid === 31 || mid === 61){
             // å°ã•ã„æ ã®æ–¹ã ã‘ã«é»’æ 
            if (miniEl) miniEl.classList.add('captain-card');
             if (bigEl)  bigEl.classList.remove('captain-card'); // å¿µã®ãŸã‚å¤–ã™
          }else{
           // é€šå¸¸ã¯å¤§ãã„æ­£ä½“ã‚«ãƒ¼ãƒ‰ã«é»’æ 
           if (bigEl)  bigEl.classList.add('captain-card');
            if (miniEl) miniEl.classList.remove('captain-card');
         }
       }
      }

    }
  }catch(e){
    console.warn('enforceM31to66 error:', e);
  }
}



  
/* ã“ã“ã‹ã‚‰è¿½åŠ ï¼šãƒŸãƒƒã‚·ãƒ§ãƒ³54ï¼ˆé…¸ç´ ãƒªã‚¶ãƒ¼ãƒ–ï¼‹èµ¤ãƒ‡ãƒƒã‚­ï¼‰ */
async function renderM54(v){
  const isM54 = ((v?.mission?.id|0) === 54);
  // ç”»é¢è¦ç´ ã®ç‰‡ä»˜ã‘
  if (!isM54){
    const x = document.getElementById('m54OxPool'); if (x) x.remove();
    const y = document.getElementById('m54RedBox'); if (y) y.remove();
    return;
  }

  // --- 0) åˆæœŸåŒ–ï¼ˆãƒ›ã‚¹ãƒˆã®ã¿ãƒ»1å›ï¼‰ ---
  // â‘¡é…å¸ƒï¼šäººæ•°åˆ¥ {2:9,3:6,4:3,5:2,6:2} ã‚’å„ãƒ†ãƒ¼ãƒ–ãƒ«ã«é…å¸ƒ
  // â‘¢ãƒªã‚¶ãƒ¼ãƒ–ï¼š 30 - (äººæ•°Ã—é…å¸ƒæ•°)
  // â‘¥èµ¤ãƒ‡ãƒƒã‚­ï¼š1..11 ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ m54_redDeck ã«ã€ä½¿ç”¨æ¸ˆã¿ã¯ m54_redUsed
  if (state.isHost && v?.meta?.m54_init !== true){
    const n = (v?.tables?.length|0);
    const per = (n<=2)?9 : (n===3)?6 : (n===4)?3 : 2;
    const by  = {}; for (let i=0;i<n;i++) by[i]=per;
    const pool = Math.max(0, 30 - n*per);

const deck = Array.from({length:11}, (_,i)=> (i+1) + 0.5);
    shuffle(deck);

update(ref(db, `rooms/${state.roomCode}/meta`), {
  m54_init: true,
  m54_byTable: by,
  m54_pool: pool,
  m54_redDeck: deck,
  m54_redUsed: []
}).catch(console.error);

    return; // æ¬¡ã® onValue ã§æç”»
  }

  // --- 1) ã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ç›´ä¸‹ã«ã€Œãƒªã‚¶ãƒ¼ãƒ–ã€ã‚’å‡ºã™ï¼ˆå·¦ã« ox2 ç”»åƒï¼‰ ---
  const itemsBar = document.getElementById('itemsBar');
  if (!itemsBar) return;

  let poolRow = document.getElementById('m54OxPool');
  if (!poolRow){
    poolRow = document.createElement('div');
    poolRow.id = 'm54OxPool';
    poolRow.className = 'ox-row ox-pool';   // #44 ã¨åŒã˜ã‚¯ãƒ©ã‚¹
    itemsBar.insertAdjacentElement('afterend', poolRow);
  }
  // å·¦å´ã® ox2 ã¨å³å´ã®ãƒ©ãƒƒãƒ—
  let wrap = poolRow.querySelector('.ox-wrap');
  if (!wrap){
    poolRow.innerHTML = '';
    const side = document.createElement('div');
    side.className = 'ox-side';             // èƒŒæ™¯ã¯ ox2.jpgï¼ˆ#44 ã¨åŒã˜ï¼‰
    poolRow.appendChild(side);
    wrap = document.createElement('div');
    wrap.className = 'ox-wrap';
    poolRow.appendChild(wrap);
  }else{
    wrap.innerHTML = '';
  }
  const poolCnt = Math.max(0, v?.meta?.m54_pool|0);
  for (let i=0;i<poolCnt;i++){
    const t = document.createElement('div');
    t.className = 'token ox';
    wrap.appendChild(t);
  }

  // â‘£ ãƒªã‚¶ãƒ¼ãƒ–ã‚¯ãƒªãƒƒã‚¯ â†’ ã€Œè£œçµ¦ã€ãƒãƒƒãƒ—ï¼ˆ1æšç²å¾—ï¼‰
// â‘£ ãƒªã‚¶ãƒ¼ãƒ–ã‚¯ãƒªãƒƒã‚¯ â†’ OXè¡¨ç¤ºã® 1/2/3 ãƒœã‚¿ãƒ³ï¼ˆå®Ÿè¡Œå€¤ã¯ 1/2/3ï¼‰
poolRow.onclick = (ev)=>{
  const poolCnt = Math.max(0, v?.meta?.m54_pool|0);
  if (poolCnt <= 0) return;

  const idx = (state?.seatedTable==null)? null : Number(state.seatedTable);
  if (idx==null){ alert('å¸­ã«åº§ã£ã¦ã‹ã‚‰å–å¾—ã—ã¦ãã ã•ã„'); return; }

  const x = ev.clientX, y = ev.clientY;
  const oxHtml = (n)=> `<span style="display:flex;gap:2px">${'<div class="token ox"></div>'.repeat(n)}</span>`;

const rangeLabel = {1:"1~4", 2:"5~8", 3:"9~12"};

const entries = [1,2,3]
  .filter(k => poolCnt >= k)
  .map(k => ({
    label: '',
    // â˜…ç¯„å›²ãƒ©ãƒ™ãƒ«ã‚’ä¸Šã€OXã‚’ä¸‹ã«ä¸¦ã¹ã‚‹
    html: `<div style="display:flex;flex-direction:column;align-items:center;gap:2px">
             <div class="range-label">${rangeLabel[k]}</div>
             <div style="display:flex;gap:2px">
               ${'<div class="token ox"></div>'.repeat(k)}
             </div>
           </div>`,
    ariaLabel: rangeLabel[k],      action: async ()=>{
        const mine = (v?.meta?.m54_byTable?.[idx]|0) + k;
        const left = (v?.meta?.m54_pool|0) - k;
        if (left < 0) return;
        await update(ref(db, `rooms/${state.roomCode}/meta`), {
          m54_pool: left,
          [`m54_byTable/${idx}`]: mine
        });
      }
    }));

  openMenu(x, y, entries);
};


  // --- 2) å„ãƒ†ãƒ¼ãƒ–ãƒ«ä¸‹ã«è‡ªåˆ†ã®é…¸ç´ ãƒˆãƒ¼ã‚¯ãƒ³è¡¨ç¤ºï¼ˆ#44ã¨åŒã˜å ´æ‰€ï¼‰ ---
  const tableNodes = document.querySelectorAll('.table'); // renderTables ã¨åŒé †
  const n = (v?.tables?.length|0);
  (v.tables||[]).forEach((T, ti)=>{
    const box = tableNodes[ti]; if (!box) return;

    let row = box.querySelector('.ox-row[data-owner="1"][data-m54="1"]');
    if (!row){
      row = document.createElement('div');
      row.className = 'ox-row';
      row.dataset.owner = '1';
      row.dataset.m54 = '1';
      const anchor = box.querySelector('.badge-fixed');
      if (anchor){
        anchor.insertAdjacentElement('afterend', row);
        const ah = anchor.querySelector('.alpha')?.getBoundingClientRect().height || 18;
        row.style.marginTop = `${Math.round(ah * 5)}px`;
    }else{
     (box.querySelector('.hand') || box).appendChild(row);
     }
   }
     // å†æç”»ï¼ˆ.ox-wrap ã‚’ä»‹ã— 15 å€‹/è¡Œã§æŠ˜è¿”ã—ï¼šM49/M63ã¨ä¸€è‡´ï¼‰
   row.innerHTML = '';
   const cnt = Math.max(0, v?.meta?.m54_byTable?.[ti]||0);
    const wrap = document.createElement('div');
    wrap.className = 'ox-wrap';
     row.appendChild(wrap);
     for (let i=0; i<cnt; i++){
      const t = document.createElement('div');
      t.className = 'token ox';
     wrap.appendChild(t);
    }
    // ãƒ†ãƒ¼ãƒ–ãƒ«é«˜ã•ï¼šæ‰€æŒé…¸ç´ ã®è¡Œæ•°ã«åˆã‚ã›ã¦æ‹¡å¼µ
     const baseH = 96, perRow = 15, rowH = 24;
    const rows  = (cnt>0) ? Math.ceil(cnt / perRow) : 0;
    const extra = rows>0 ? (4 + rowH * rows) : 0;
  const needH = Math.max(baseH, baseH + extra);
   box.style.setProperty('--table-h', `${needH}px`);
    box.style.height = `${needH}px`;  // â† å®Ÿé«˜ã•ã‚‚ç›´æŒ‡å®š
    // â‘¤ è‡ªåˆ†ã®è¡Œã‚¯ãƒªãƒƒã‚¯ â†’ 1/2/3 ã‚’è¿”å´ï¼ˆãƒªã‚¶ãƒ¼ãƒ–ã«æˆ»ã™ï¼‰
    //    ï¼ˆ#44ã®è¿”å´ UI ã¨åŒæ§˜ã®æŒ™å‹•ï¼‰
    const myIdx = (()=>{
      const sNum = (state?.seatedTable==null)? null : Number(state.seatedTable);
      if (Number.isInteger(sNum) && sNum>=0 && sNum<n) return sNum;
      const alt = (v.tables||[]).findIndex(t=> t?.playerId===state.userId);
      return (alt>=0? alt : null);
    })();

    if (myIdx !== null && myIdx === ti){
      row.onclick = (ev)=>{
        const maxCan = Math.max(0, v?.meta?.m54_byTable?.[ti]||0);
        const choices = [1,2,3].filter(k=> k<=maxCan).map(k=>({
          label:String(k),
          action: async ()=>{
            const mine = (v?.meta?.m54_byTable?.[ti]||0) - k;
            const pool = (v?.meta?.m54_pool||0) + k;
            if (mine<0) return;
            await update(ref(db, `rooms/${state.roomCode}/meta`), {
              m54_pool: pool,
              [`m54_byTable/${ti}`]: mine
            });
          }
        }));
        if (choices.length>0) openMenu(ev.clientX, ev.clientY, choices);
      };
    }else{
      row.onclick = null;
    }
  });

  // --- 3) èµ¤ãƒ‡ãƒƒã‚­ï¼ˆdiã®å·¦å´ã« redcode.png ï¼‹ æ®‹æšæ•°ï¼‰ ---
  const di = document.getElementById('di');
  if (di && !document.getElementById('m54RedBox')){
    const box = document.createElement('div');
    box.id = 'm54RedBox';
    box.style.display = 'flex';
    box.style.flexDirection = 'column';
    box.style.alignItems = 'center';
    // ãƒ‡ãƒƒã‚­ç”»åƒï¼ˆnumdeckè¦‹ãŸç›®ã‚’æµç”¨ã—ã¤ã¤èƒŒæ™¯ã ã‘å·®ã—æ›¿ãˆï¼‰
    const deckBtn = document.createElement('div');
    deckBtn.className = 'numdeck';
    deckBtn.style.backgroundImage = "url('./redcode.png')";
    deckBtn.title = 'èµ¤ã‚³ãƒ¼ãƒ‰ï¼ˆè¿½åŠ ï¼‰';
    // æ®‹æšæ•°
    const restLbl = document.createElement('span');
    restLbl.className = 'numrest';
    restLbl.style.marginTop = '2px';

    box.appendChild(deckBtn);
    box.appendChild(restLbl);
    di.insertAdjacentElement('beforebegin', box);

    // æ®‹è¡¨ç¤ºã®æ›´æ–°
    const refreshRed = ()=>{
      const D = Array.isArray(v?.meta?.m54_redDeck)? v.meta.m54_redDeck : [];
      const U = Array.isArray(v?.meta?.m54_redUsed)? v.meta.m54_redUsed : [];
      const remain = D.filter(x=> !U.includes(x)).length;
      restLbl.textContent = `æ®‹:${remain}`;
    };
    refreshRed();

    // â‘¥ ã‚¯ãƒªãƒƒã‚¯ â†’ ã€Œè¿½åŠ ã€ã‚¿ãƒ– â†’ å±±æœ­ã®ä¸Šã‹ã‚‰1æšã‚’è‡ªåˆ†ã®æ‰‹æœ­ã«æ˜‡é †æŒ¿å…¥
    deckBtn.onclick = (ev)=>{
      openOneMini(ev.clientX, ev.clientY, 'è¿½åŠ ', async ()=>{
        try{
          const mRef = ref(db, `rooms/${state.roomCode}/meta`);
          const rRef = ref(db, `rooms/${state.roomCode}`);
          const [mSnap, rSnap] = await Promise.all([get(mRef), get(rRef)]);
          const meta = mSnap.val()||{};
          const room = rSnap.val()||{};
          const D = Array.isArray(meta.m54_redDeck)? meta.m54_redDeck.slice() : [];
          const U = Array.isArray(meta.m54_redUsed)? meta.m54_redUsed.slice() : [];

          // æ¬¡ã®1æš
          const top = D.find(n=> !U.includes(n));
          if (top==null) return;

          // è‡ªåˆ†ã®ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·
          const myTable = (()=>{
            const sNum = (state?.seatedTable==null)? null : Number(state.seatedTable);
            if (Number.isInteger(sNum)) return sNum;
            const idx = (room.tables||[]).findIndex(t=> t?.playerId===state.userId);
            return idx>=0? idx : null;
          })();
          if (myTable==null || !Array.isArray(room.tables)) return;

          // æ‰‹æœ­ã¸ï¼ˆæ˜‡é †ãƒ»alphaå†ä»˜ç•ªï¼‰ â€” #43 ã®è¿½åŠ å‡¦ç†ã¨åŒã˜æµå„€
          const tbls = room.tables.slice();
          const T = tbls[myTable];
          const hand = Array.isArray(T.hand)? T.hand.slice() : [];
          hand.push({
            id: crypto.randomUUID(),
            num: top,
            kind: 'red',     // â† ç¨®åˆ¥ã¯ red ã¨ã—ã¦ãŠãï¼ˆå¿…è¦ãªã‚‰ 'normal' ã«å¤‰æ›´ï¼‰
            open: false,
            ownerId: T.playerId || null,
            tokens: [],
            markUntil: Date.now() + 5000
          });
          hand.sort((a,b)=> a.num - b.num);
          const alpha = 'abcdefghijklmnopqrstuvwxyz';
          hand.forEach((c,i)=> c.alpha = alpha[i % alpha.length]);
          T.hand = hand;

          // ä½¿ç”¨æ¸ˆã¿ã¸è¨˜éŒ²
          U.push(top);

          await Promise.all([
            set(ref(db, `rooms/${state.roomCode}/tables`), tbls),
            update(mRef, { m54_redUsed: U })
          ]);
        }catch(e){ console.error(e); }
      });
    };
  }else{
    // æ—¢ã«ã‚ã‚Œã°æ®‹è¡¨ç¤ºã ã‘æ›´æ–°
    const restLbl = document.querySelector('#m54RedBox .numrest');
    if (restLbl){
      const D = Array.isArray(v?.meta?.m54_redDeck)? v.meta.m54_redDeck : [];
      const U = Array.isArray(v?.meta?.m54_redUsed)? v.meta.m54_redUsed : [];
      restLbl.textContent = `æ®‹:${D.filter(x=>!U.includes(x)).length}`;
    }
  }
}
/* ã“ã“ã¾ã§è¿½åŠ ï¼šãƒŸãƒƒã‚·ãƒ§ãƒ³54 */

  
/* ã“ã“ã‹ã‚‰è¿½åŠ ï¼šãƒŸãƒƒã‚·ãƒ§ãƒ³53ï¼ˆnano0 å›ºå®šï¼‰ */
function renderM53(v){
  const isM53 = ((v?.mission?.id|0) === 53);
  const old = document.getElementById('m53Nano');

  // #53 ä»¥å¤–ãªã‚‰å¾Œç‰‡ä»˜ã‘
  if (!isM53){
    if (old) old.remove();
    tablesEl.classList.remove('m43-shift'); // #43 ã¨åŒã˜ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ã‚’æµç”¨
    return;
  }

  const pos = v?.meta?.m53_pos|0;
  if (!pos){
    if (old) old.remove();
    tablesEl.classList.remove('m43-shift');
    return;
  }

  // ç”»åƒã¯å¸¸ã« nano0.pngï¼ˆãƒ¬ãƒ™ãƒ«ã‚„å‘ãã¯ä¸ä½¿ç”¨ï¼‰
  const node = old || document.createElement('div');
  node.id = 'm53Nano';
  node.className = 'm43-nano'; // CSSã¯#43ã®nanoã‚’å…±ç”¨
  node.style.backgroundImage = `url("./nano0.png")`;

  // ä½ç½®ã¯ #43 ã¨åŒã˜ï¼šãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®ã‚»ãƒ«ä¸­å¤®ä¸Š
  const itemsBar = document.getElementById('itemsBar');
  if (!itemsBar) return;
  let row = document.getElementById('nanoRow');
  if (!row){
    row = document.createElement('div');
    row.id = 'nanoRow';
    row.className = 'nano-row';
    itemsBar.insertAdjacentElement('afterend', row);
  }
  const cells = tablesEl.querySelectorAll('.checklist .check-item');
  const target = cells[pos-1];
  if (!target){ if (node.isConnected) node.remove(); row.remove(); return; }
  const rb = target.getBoundingClientRect();
  const rrow = row.getBoundingClientRect();
  const x = rb.left - rrow.left + (rb.width/2) - 28;
  node.style.left = `${Math.max(0, x)}px`;
  node.style.top  = `0px`;
  if (!node.isConnected) row.appendChild(node);
}
/* ã“ã“ã¾ã§è¿½åŠ ï¼šãƒŸãƒƒã‚·ãƒ§ãƒ³53 */

  
/* â–¼â–¼ ï¼šãƒŸãƒƒã‚·ãƒ§ãƒ³44ï¼ˆé…¸ç´ ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰ â–¼â–¼ */
function renderM44(v){
 if ((v?.mission?.id|0) !== 44) { const x=document.getElementById('m44OxPool'); if(x) x.remove(); return; }

  // â–¼ ç€å¸­ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å®‰å…¨ã«ä¸€åº¦ã ã‘å–å¾—ï¼ˆstate.seatedTable ãŒæ¬ è½ã—ã¦ã„ã¦ã‚‚æ‹¾ã†ï¼‰
  const idx = (()=>{
    const n = (v?.tables?.length|0);
    const s = (state?.seatedTable==null) ? null : Number(state.seatedTable);
    if (Number.isInteger(s) && s>=0 && s<n) return s;
    const alt = (v.tables||[]).findIndex(t => t?.playerId === state.userId);
    return (alt>=0 ? alt : null);
  })();

  
  // --- 1) åˆæœŸã‚»ãƒƒãƒˆï¼ˆãƒ›ã‚¹ãƒˆã®ã¿ï¼‰ï¼šäººæ•°Ã—2 ã‚’å…¨ä½“ãƒ—ãƒ¼ãƒ«ã«ç”¨æ„ ---
  if (state.isHost && (!v.meta || typeof v.meta.oxItem !== 'number')) {
    const init = (v.tables?.length || 0) * 2;
    update(ref(db, `rooms/${state.roomCode}/meta`), { oxItem:init, oxByTable:{} });
    return; // æ¬¡å› onValue ã§æç”»
  }

  // --- 2) ã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ä¸‹ã«å…¨ä½“ãƒ—ãƒ¼ãƒ«ã‚’è¡¨ç¤ºï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ 1/2/3 ã®å–å¾—ï¼‰ ---
  const itemsBar = document.getElementById('itemsBar');
  if (!itemsBar) return;

  let poolRow = document.getElementById('m44OxPool');
  if (!poolRow){
    poolRow = document.createElement('div');
    poolRow.id = 'm44OxPool';
    poolRow.className = 'ox-row ox-pool';   // å·¦ç”»åƒã‚’ç½®ããƒ—ãƒ¼ãƒ«è¡Œ
    // ã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®â€œç›´ä¸‹â€ã«ç½®ãï¼ˆãƒŸãƒƒã‚·ãƒ§ãƒ³12ã® num-under ã¨åŒæ§˜ã®ä½ç½®æ„Ÿï¼‰
    itemsBar.insertAdjacentElement('afterend', poolRow);
  }
  let wrap = poolRow.querySelector('.ox-wrap');
  if (!wrap){
    poolRow.innerHTML = '';
    const side = document.createElement('div');
    side.className = 'ox-side';       // â† å·¦å´ã® ox2.jpgï¼ˆã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ¼ãƒ‰ã¨åŒã‚µã‚¤ã‚ºï¼‰
    poolRow.appendChild(side);
    wrap = document.createElement('div');
    wrap.className = 'ox-wrap';       // â† ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è©°ã‚ã‚‹æ ï¼ˆ10å€‹ã§æ”¹è¡Œï¼‰
    poolRow.appendChild(wrap);
  }else{
    wrap.innerHTML = '';
  }  const poolCnt = Math.max(0, v.meta?.oxItem|0);
  for (let i=0; i<poolCnt; i++){
    const t = document.createElement('div');
    t.className = 'token ox';
    wrap.appendChild(t);  // â† ãƒˆãƒ¼ã‚¯ãƒ³ã¯ .ox-wrap ã®ä¸­ã¸
  }

  // ã‚¯ãƒªãƒƒã‚¯ã§ 1/2/3 å–å¾—ï¼ˆéšŠé•·ã¯ã€Œé›†ã‚ã‚‹ã€ã‚‚è¡¨ç¤ºï¼‰
// ã‚¯ãƒªãƒƒã‚¯ã§ 1/2/3 å–å¾—ï¼ˆéšŠé•·ã¯ã€Œé›†ã‚ã‚‹ã€ã‚‚è¡¨ç¤ºï¼‰
poolRow.onclick = (ev)=>{
  const poolCnt = Math.max(0, v.meta?.oxItem|0);  // â† ãƒ—ãƒ¼ãƒ«æ®‹é‡

  // â˜… OXãƒˆãƒ¼ã‚¯ãƒ³HTMLï¼ˆnå€‹åˆ†ï¼‰ã‚’ç”Ÿæˆ
  const oxHtml = (n)=> `<span style="display:flex;gap:2px">${'<div class="token ox"></div>'.repeat(n)}</span>`;

const rangeLabel = {1:"1~4", 2:"5~8", 3:"9~12"};

const entries = [1,2,3]
  .filter(k => poolCnt >= k)
  .map(k => ({
    label: '',
    // â˜…ç¯„å›²ãƒ©ãƒ™ãƒ«ã‚’ä¸Šã€OXã‚’ä¸‹ã«ä¸¦ã¹ã‚‹
    html: `<div style="display:flex;flex-direction:column;align-items:center;gap:2px">
             <div class="range-label">${rangeLabel[k]}</div>
             <div style="display:flex;gap:2px">
               ${'<div class="token ox"></div>'.repeat(k)}
             </div>
           </div>`,
    ariaLabel: rangeLabel[k],      action: async ()=>{
        const left = (v.meta?.oxItem|0) - k;
        if (idx==null){ alert('å¸­ã«åº§ã£ã¦ã‹ã‚‰å–å¾—ã—ã¦ãã ã•ã„'); return; }
        const mine = (v.meta?.oxByTable?.[idx]||0) + k;
        if (left < 0) return;
        await update(ref(db, `rooms/${state.roomCode}/meta`), {
          oxItem: left,
          [`oxByTable/${idx}`]: mine
        });
      }
    }));

  // ï¼ˆã“ã®å¾Œã® éšŠé•·ã ã‘ã€Œé›†ã‚ã‚‹ã€entries.push ã¯ãã®ã¾ã¾æ®‹ã™ï¼‰

    // â˜…éšŠé•·ã ã‘ï¼šå…¨å“¡ã®é…¸ç´ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é›†ã‚ã¦ãƒªã‚¶ãƒ¼ãƒ–ï¼ˆoxItemï¼‰ã¸æˆ»ã™
    if ((v.captainTable|0) === (state.seatedTable|0)) {
      entries.push({
        label:'é›†ã‚ã‚‹',
        action: async ()=>{
          const by = v.meta?.oxByTable || {};
          // å…¨ãƒ†ãƒ¼ãƒ–ãƒ«æ‰€æŒé…¸ç´ ã®åˆè¨ˆ
          const total = Object.values(by).reduce((a,b)=> a + ((b|0) || 0), 0);

          // å¤‰æ›´ãŒç„¡ã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
          if (total <= 0) return;

          // meta ç›´ä¸‹ã‚’ update ã§ã¾ã¨ã‚ã¦æ›´æ–°ï¼ˆoxByTable[*] ã‚’ 0 ã«ã€oxItem ã‚’åˆç®—åŠ ç®—ï¼‰
          const upd = {
            oxItem: (v.meta?.oxItem || 0) + total
          };
          // ã„ã¾æŒã£ã¦ã„ã‚‹ã‚­ãƒ¼ã ã‘ 0 ã«ã™ã‚‹ï¼ˆå­˜åœ¨ã—ãªã„ã‚­ãƒ¼ã¯è§¦ã‚‰ãªã„ï¼‰
          Object.keys(by).forEach(k=>{
            upd[`oxByTable/${k}`] = 0;
          });

          await update(ref(db, `rooms/${state.roomCode}/meta`), upd);
        }
      });
    }
    if (entries.length === 0) return; openMenu(ev.clientX, ev.clientY, entries);  };

  // --- 3) å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã®â€œä¸‹éƒ¨â€ï¼ˆæƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ç¾¤ã‚ˆã‚Šä¸‹ï¼‰ã«æ‰€æŒé…¸ç´ ã‚’è¡¨ç¤º ---
  const tableNodes = document.querySelectorAll('.table'); // renderTables ã®ä¸¦ã³ã¨åŒé †
  (v.tables||[]).forEach((T, ti)=>{
    const box = tableNodes[ti];
    if (!box) return;

    // æ—¢å­˜ã®è¡Œã‚’å†åˆ©ç”¨ or ç”Ÿæˆ
    let ownRow = box.querySelector('.ox-row[data-owner="1"]');
    if (!ownRow){
      ownRow = document.createElement('div');
      ownRow.className = 'ox-row';
      ownRow.dataset.owner = '1';
      // â˜…å¤‰æ›´ï¼šæƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³æœ‰ç„¡ã«ä¾ã‚‰ãšã€å¸¸ã«ã€Œã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆç›´ä¸‹ã€ã«ç½®ã
     const anchor = box.querySelector('.badge-fixed'); // â† 1æšç›®ã® .alpha ã‚’å«ã‚€
     if (anchor && anchor.parentElement) {
       (anchor.parentElement).appendChild(ownRow);
      // ã€Œã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆäºŒå€‹åˆ†ã€ã ã‘ä¸‹ã’ã‚‹ï¼ˆæ–‡å­—é«˜ã‚’å‹•çš„å–å¾—ï¼‰
      const ah = anchor.parentElement.querySelector('.alpha')?.getBoundingClientRect().height || 18;
    ownRow.style.marginTop = `${Math.round(ah * 5)}px`;
      } else {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæ‰‹æœ­ã®ç›´å¾Œã«ç½®ã
        const hand = box.querySelector('.hand');
        (hand || box).appendChild(ownRow);
      }
    }
    // å†æç”»ï¼ˆ10å€‹ã§æ”¹è¡Œã™ã‚‹ãŸã‚å¸¸ã« .ox-wrap ã‚’æŒ¿å…¥ï¼‰
    ownRow.innerHTML = '';
    const cnt = Math.max(0, v.meta?.oxByTable?.[ti]||0);
    const wrapSelf = document.createElement('div');
    wrapSelf.className = 'ox-wrap';      // â† ãƒ—ãƒ¼ãƒ«ã¨åŒã˜æŠ˜è¿”ã—ãƒ«ãƒ¼ãƒ«ï¼ˆ10ã§æ”¹è¡Œï¼‰
    ownRow.appendChild(wrapSelf);
    for (let i=0; i<cnt; i++){
      const t = document.createElement('div');
     t.className = 'token ox';
      wrapSelf.appendChild(t);           // â† ãƒˆãƒ¼ã‚¯ãƒ³ã¯ wrap å†…ã«å…¥ã‚Œã‚‹
    }

  // â–¼â–¼ ãƒ†ãƒ¼ãƒ–ãƒ«é«˜ã•ã‚’æ‰€æŒé…¸ç´ ã®ã€è¡Œæ•°ã€‘ã«åˆã‚ã›ã¦ã‚¹ãƒ©ã‚¤ãƒ‰ï¼ˆM49/M63ã¨åŒä¸€ï¼‰
    const BASE   = 96;     // åŸºæº–é«˜ã•ï¼ˆåº§å¸­ã®ã¿ï¼‰
     const PERROW = 15;     // 1è¡Œã‚ãŸã‚Šã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°ï¼ˆ.ox-wrap ã¨ä¸€è‡´ï¼‰
    const ROWH   = 24;     // 1è¡Œã®å®Ÿè³ªé«˜ã•ï¼ˆ20px+ä½™ç™½ï¼‰
    const rows   = (cnt>0) ? Math.ceil(cnt / PERROW) : 0;
    const extra  = rows>0 ? (4 + ROWH * rows) : 0;
   const needH  = Math.max(BASE, BASE + extra);
    box.style.setProperty('--table-h', `${needH}px`);
    box.style.height = `${needH}px`;      // â† å®Ÿé«˜ã•ã‚‚ç›´æŒ‡å®šã§ç¢ºå®Ÿã«åæ˜ 
  

    // è‡ªåˆ†ã®æ‰€æŒé…¸ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ 1/2/3 ã‚’è¿”å´ï¼ˆãƒ—ãƒ¼ãƒ«ã¸ï¼‰
if (Number.isInteger(idx) && idx === ti){
      ownRow.onclick = (ev)=>{
        openMenu(ev.clientX, ev.clientY, [1,2,3].map(k=>({
          label:String(k),
          action: async ()=>{
            const mine = (v.meta?.oxByTable?.[ti]||0) - k;
            const pool = (v.meta?.oxItem||0) + k;
            if (mine < 0) return;
            await update(ref(db, `rooms/${state.roomCode}/meta`), {
              oxItem: pool,
              [`oxByTable/${ti}`]: mine
            });
          }
        })));
      };
    }else{
      ownRow.onclick = null;
    }
  });
}
/* â–²â–² ã“ã“ã¾ã§è¿½åŠ ï¼šãƒŸãƒƒã‚·ãƒ§ãƒ³44ï¼ˆé…¸ç´ ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰ â–²â–² */


  
/* â–¼â–¼ ã“ã“ã‹ã‚‰è¿½åŠ ï¼šãƒŸãƒƒã‚·ãƒ§ãƒ³49ï¼ˆé…å¸ƒï¼†è­²æ¸¡ï¼šãƒ—ãƒ¼ãƒ«ãªã—ï¼‰ â–¼â–¼ */
 async function renderM49(v){
  try{
      const isM49 = ((v?.mission?.id|0) === 49);
      // ãƒŸãƒƒã‚·ãƒ§ãƒ³49ã§ãªã‘ã‚Œã°ã€å‰å›ã®é«˜ã•ä¸Šæ›¸ãã‚’å…ƒã«æˆ»ã—ã¦çµ‚äº†
      if (!isM49) {
        document.querySelectorAll('.table').forEach(tb=>{
          tb.style.removeProperty('--table-h');
       });
        return;
      }

    // --- 0) å®‰å…¨ã‚¬ãƒ¼ãƒ‰ï¼štables ãŒç„¡ã„/ç©ºãªã‚‰ä½•ã‚‚ã—ãªã„ ---
    const n = (v?.tables?.length|0);
    if (!Array.isArray(v?.tables) || n <= 0) return;

    // --- 1) åˆæœŸé…å¸ƒï¼ˆãƒ›ã‚¹ãƒˆã®ã¿ãƒ»ä¸€åº¦ã ã‘ï¼‰ ---
    // äººæ•°â†’åˆæœŸæšæ•°ï¼š2äºº=7, 3äºº=6, 4äºº=5, 5äºº=4, 6äºº=4
    if (state.isHost && v?.meta?.m49_init !== true){
      const map = (m)=>{
        if (m<=2) return 7;
        if (m===3) return 6;
        if (m===4) return 5;
        return 4; // 5 or 6
      };
      const per = map(n);
      const by  = {};
      for (let i=0;i<n;i++) by[i] = per;

      // ãƒŸãƒƒã‚·ãƒ§ãƒ³44ã§ä½¿ã£ã¦ã„ãŸ oxItemï¼ˆãƒ—ãƒ¼ãƒ«ï¼‰ã¯ä½¿ã‚ãªã„ã®ã§ 0 ã«
  update(ref(db, `rooms/${state.roomCode}/meta`), {
        oxByTable: by,
        oxItem: 0,
        m49_init: true
  }).catch(console.error);
      return; // æ¬¡å› onValue ã§æç”»
    }

    // --- 2) å„ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ‰€æŒé…¸ç´ ã‚’è¡¨ç¤ºï¼ˆä½ç½®ã¯ #44 ã¨åŒã˜ã‚¢ãƒ³ã‚«ãƒ¼ç›´ä¸‹ï¼‰ ---
    // #44 ã¨åŒã˜ã‚¯ãƒ©ã‚¹/è¦‹ãŸç›®ã‚’å†åˆ©ç”¨ï¼ˆ.token.ox / .ox-rowï¼‰
    const tableNodes = document.querySelectorAll('.table'); // renderTables ã¨åŒé †
    (v.tables||[]).forEach((T, ti)=>{
      const box = tableNodes[ti];
      if (!box) return;

      // æ—¢å­˜è¡Œã‚’å†åˆ©ç”¨ or ç”Ÿæˆ
      let row = box.querySelector('.ox-row[data-owner="1"]');
      if (!row){
        row = document.createElement('div');
        row.className = 'ox-row';
        row.dataset.owner = '1';

        // #44 åŒæ§˜ã€ã€Œã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆç›´ä¸‹ã€ã«å›ºå®šé…ç½®
        const anchor = box.querySelector('.badge-fixed');
        if (anchor && anchor.parentElement){
          const ah = anchor.parentElement.querySelector('.alpha')?.getBoundingClientRect().height || 18;
          (anchor.parentElement).appendChild(row);
          row.style.marginTop = `${Math.round(ah * 5)}px`;
        }else{
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæ‰‹æœ­ã®ç›´å¾Œ
          const hand = box.querySelector('.hand');
          (hand || box).appendChild(row);
        }
      }

  // å†æç”»ï¼ˆM63ã¨åŒã˜ã .ox-wrap ã‚’ä»‹ã—ã¦ 15 å€‹ã§æ”¹è¡Œï¼‰
  row.innerHTML = '';
  const wrap = document.createElement('div');
  wrap.className = 'ox-wrap';     // CSS ã§ 1 è¡Œã‚ãŸã‚Š 15 å€‹ã«æŠ˜è¿”ã—
  row.appendChild(wrap);
  const cnt = Math.max(0, v?.meta?.oxByTable?.[ti]||0);
  for (let i=0; i<cnt; i++){
    const t = document.createElement('div');
    t.className = 'token ox';
    wrap.appendChild(t);
  }
     // â–¼â–¼ ãƒ†ãƒ¼ãƒ–ãƒ«é«˜ã•ï¼šæ‰€æŒé…¸ç´ ã®è¡Œæ•°ã«åˆã‚ã›ã¦è‡ªå‹•èª¿æ•´ï¼ˆ#63ç›¸å½“ã®è¨ˆç®—ï¼‰
  {
    const baseH = 96;           // CSS :root ã® --table-h æ—¢å®š
    const perRow = 15;          // 1 è¡Œã‚ãŸã‚Šã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°ï¼ˆ.ox-wrap ã¨ä¸€è‡´ï¼‰
    const rows = Math.ceil(cnt / perRow);
    // 4pxï¼ˆå‰ç¸ï¼‰ + 20pxï¼ˆãƒˆãƒ¼ã‚¯ãƒ³é«˜ï¼‰Ã—è¡Œæ•° + 2pxï¼ˆè¡Œé–“ï¼‰Ã—(è¡Œæ•°-1)
    const extra = rows > 0 ? (4 + rows * 20 + Math.max(0, rows - 1) * 2) : 0;
    const needH = Math.max(baseH, baseH + extra);
    box.style.setProperty('--table-h', `${needH}px`);
ã€€  box.style.height = `${needH}px`;          // â† å®Ÿé«˜ã•ã‚‚ç›´æŒ‡å®šã—ã¦ç¢ºå®Ÿã«åºƒã’ã‚‹

  }
      // --- 3) è­²æ¸¡ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼šè‡ªåˆ†â€œä»¥å¤–â€ã®è¡Œã ã‘ã‚¯ãƒªãƒƒã‚¯å¯ ---
      // è‡ªåˆ†ã®ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã‚’å®‰å…¨ã«ç‰¹å®šã™ã‚‹
      const myIdx = (() => {
  const sNum = (state?.seatedTable == null) ? null : Number(state.seatedTable);
  if (Number.isInteger(sNum) && sNum >= 0 && sNum < n) return sNum;

  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šplayerId ã¨è‡ªåˆ†ã® userId ã‚’ç…§åˆ
  const alt = (v.tables || []).findIndex(t => t?.playerId === state.userId);
  return (alt >= 0 ? alt : null);      })();

  if (myIdx !== null && myIdx !== ti){

  // å…±é€šãƒãƒ³ãƒ‰ãƒ©ï¼šrow/box ã‹ã‚‰å‘¼ã¶ã€‚äºŒé‡ç™ºç«é˜²æ­¢ã®ãŸã‚ stopPropagation
  const openGiveMenu = async (ev)=>{
    ev.stopPropagation();
    const mine = Math.max(0, v?.meta?.oxByTable?.[myIdx]||0);
    if (mine <= 0) return;

    const entries = Array.from({length: mine}, (_,i)=> i+1).map(k=>({
      label: String(k),
      action: async ()=>{
        const snap = await get(ref(db, `rooms/${state.roomCode}/meta`));
        const meta = snap.val()||{};
        const curMine   = Math.max(0, meta?.oxByTable?.[myIdx]||0);
        const curTarget = Math.max(0, meta?.oxByTable?.[ti]||0);
        if (k > curMine) return;
        const upd = {};
        upd[`oxByTable/${myIdx}`] = curMine - k;
        upd[`oxByTable/${ti}`]    = curTarget + k;
        await update(ref(db, `rooms/${state.roomCode}/meta`), upd);
      }
    }));
    if (entries.length > 0) openMenu(ev.clientX, ev.clientY, entries);
  };

  // å¾“æ¥ã©ãŠã‚Šé…¸ç´ è¡Œï¼ˆç´°å¸¯ï¼‰ã‚‚ã‚¯ãƒªãƒƒã‚¯å¯
  row.onclick = openGiveMenu;

  // â˜…è¿½åŠ ï¼šãƒ†ãƒ¼ãƒ–ãƒ«æ ï¼ˆboxï¼‰å…¨ä½“ã«ã‚‚åŒã˜ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šã‚’ä»˜ä¸ï¼ˆ1å›ã ã‘ï¼‰
  if (!box.dataset.m49Bind) {
    box.dataset.m49Bind = '1';
    box.addEventListener('click', openGiveMenu);
  }

}else{
  // è‡ªåˆ†ã®è¡Œã¯ã‚¯ãƒªãƒƒã‚¯ä¸å¯ï¼ˆrow / box ã¨ã‚‚ä»˜ã‘ãªã„ï¼‰
  row.onclick = null;
}

    });
  }catch(err){
    // å…¥å®¤ä¸èƒ½äº‹æ•…ã‚’é˜²ããŸã‚ã€ä¾‹å¤–ã¯æ¡ã‚Šæ½°ã—ã¦ãƒ­ã‚°ã ã‘
    console.error('[M49]', err);
  }
}
/* â–²â–² ã“ã“ã¾ã§è¿½åŠ ï¼šãƒŸãƒƒã‚·ãƒ§ãƒ³49 â–²â–² */


  
  // #34ï¼šåˆ¶ç´„ã‚«ãƒ¼ãƒ‰æ‹¡å¤§ãƒãƒƒãƒ—ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºï¼‰
function openConstraintZoom(letter, myIdx){
  try{
    const old = document.getElementById('conZoomOverlay');
    if (old) old.remove();

    const ov = document.createElement('div');
    ov.id = 'conZoomOverlay';
    ov.addEventListener('click', (e)=>{ if(e.target===ov) closeConstraintZoom(); });

    const wrap = document.createElement('div');
    wrap.className = 'conzoom-wrap';

    const big = document.createElement('div');
    big.className = 'conzoom-card';
    big.style.backgroundImage = `url('${imgConstraint(letter)}')`;
    big.addEventListener('click', (e)=>{
      e.stopPropagation();
      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒç„¡ã‘ã‚Œã°ç”Ÿæˆï¼ã‚ã‚Œã°ãƒˆã‚°ãƒ«
        if (typeof myIdx !== 'number') return;
        // â˜…è¿½åŠ ï¼šéšŠé•·ä»¥å¤–ã¯ã€Œå ´ã«å‡ºã™ã€ãƒãƒƒãƒ—ã‚’å‡ºã•ãªã„ï¼ˆé–²è¦§ã®ã¿ï¼‰
        const cap = (state?.watching?.captainTable | 0);
        const isCaptain = (typeof cap === 'number' && cap === myIdx);
        if (!isCaptain) {
          // ééšŠé•·ã¯ãƒˆã‚°ãƒ«å‹•ä½œã‚’ã—ãªã„ï¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‡ºã•ãšã€ãã®ã¾ã¾æ‹¡å¤§ã®ã¿
          return;
        }      let m = wrap.querySelector('.conzoom-menu');
      if (m){ m.remove(); return; }
      m = document.createElement('div');
      m.className = 'conzoom-menu';

      const btnOut = document.createElement('button');
      btnOut.textContent = 'å ´ã«å‡ºã™';
      btnOut.onclick = async (ev)=>{
        ev.stopPropagation();
        try{
          const rRef = ref(db, `rooms/${state.roomCode}`);
          const rSnap = await get(rRef);
          const R = rSnap.val()||{};
          const cur = Array.isArray(R.m34_center) ? R.m34_center.slice() : [];
          if (!cur.some(o => o?.by === myIdx)){
            cur.push({ ch: letter, by: myIdx });
            await update(rRef, { m34_center: cur });
          }
        }catch(err){ console.error(err); }
        closeConstraintZoom();
      };

   
      m.appendChild(btnOut);
      wrap.appendChild(m);
    });

    wrap.appendChild(big);
    ov.appendChild(wrap);
    document.body.appendChild(ov);
  }catch(e){ console.error(e); }
}
function closeConstraintZoom(){
  const ov = document.getElementById('conZoomOverlay');
  if (ov) ov.remove();
}


/* â–¼â–¼ M31ã€œ66ï¼šæ­£ä½“ã‚«ãƒ¼ãƒ‰ãƒ”ãƒƒã‚«ãƒ¼ï¼ˆå°‚ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ»å³åŒæœŸãƒ»laneä¿è­·ï¼‰ â–¼â–¼ */
async function maybeOpenRolePickerAfterSeat(){
  try{
    const v = state?.watching;
    const mid = (v?.mission?.id|0);
    const inPickerRange = (mid >= 31 && mid <= 66 && mid !== 58);
    if (!inPickerRange) return;
    const myIdx = (typeof state.seatedTable === 'number')
      ? state.seatedTable
      : (v?.tables||[]).findIndex(t=> t?.playerId===state.userId);
    if (myIdx < 0) return;

    const t = (v?.tables||[])[myIdx] || {};
    const cur = (t?.character?.face) || 'member (1).jpg';

    openRolePickOverlay(cur, myIdx);
  }catch(e){ console.error('[role-pick]', e); }
}

function openRolePickOverlay(curFaceName, myIdx){
  // æ—¢ã«é–‹ã„ã¦ã„ã‚Œã°ä½•ã‚‚ã—ãªã„ï¼ˆå¤šé‡é˜²æ­¢ï¼‰
  if (document.getElementById('rolePickOverlay')) return;
  cleanupRolePickerListener();

  const room = state?.roomCode || state?.code;

  // ãƒ•ã‚¡ã‚¤ãƒ«åã®æ­£è¦åŒ–ï¼ˆç›¸å¯¾/çµ¶å¯¾/ã‚¯ã‚¨ãƒª/ãƒãƒƒã‚·ãƒ¥/ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰/å¤§å°æ‹¡å¼µå­ï¼‰
  const normalizeFace = (s)=>{
    let x = decodeURIComponent(String(s||'')).replace(/^\.\/+/, '');
    x = x.split(/[?#]/)[0];   // ?ã‚„#ä»¥é™ã‚’é™¤å»
    x = x.split('/').pop();   // ãƒ•ã‚¡ã‚¤ãƒ«åã®ã¿
    return x.toLowerCase();
  };

  // å€™è£œï¼šè‡ªåˆ†ã«é…ã‚‰ã‚ŒãŸæ­£ä½“ + member(6)~(9)
  const baseNames = Array.from(new Set([
    curFaceName, 'member (6).jpg','member (7).jpg','member (8).jpg','member (9).jpg'
  ]));
  const baseMap     = new Map(baseNames.map(n => [normalizeFace(n), n])); // norm â†’ è¡¨ç¤ºå
  const baseNormSet = new Set([...baseMap.keys()]);

  // ï¼ï¼å°‚ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆä»–UIã«é–‰ã˜ã‚‰ã‚Œãªã„ï¼‰ï¼ï¼
  const ov = document.createElement('div');
  ov.id = 'rolePickOverlay';
  Object.assign(ov.style, {
    position:'fixed', inset:'0', display:'grid', placeItems:'center',
    zIndex:'2147483646', background:'rgba(0,0,0,0.35)'
  });

  // å¤–å´ã‚¯ãƒªãƒƒã‚¯/ESCã¯ã€Œæ‹¡å¤§è§£é™¤ã€ã ã‘ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¯é–‰ã˜ãªã„ï¼‰
  ov.addEventListener('click', (e)=>{
    if (e.target !== ov) return;
    const preview = ov.querySelector('.rp-preview');
    if (preview){ preview.style.display='none'; preview.innerHTML=''; }
  });
  ov.tabIndex = -1;
  ov.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){
      e.preventDefault(); e.stopPropagation();
      const preview = ov.querySelector('.rp-preview');
      if (preview){ preview.style.display='none'; preview.innerHTML=''; }
    }
  });

  // â–¼ wrapï¼ˆæ—¢å­˜ã® conzoom-wrap ã¨ã¯åˆ†é›¢ï¼‰
  const wrap = document.createElement('div');
  wrap.className = 'rp-wrap';
  Object.assign(wrap.style, { position:'relative', maxWidth:'min(96vw, 1200px)' });
  wrap.addEventListener('click', e=>e.stopPropagation());

  // â–¼ ä¸Šéƒ¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰å‡ºã™ï¼‰
  const preview = document.createElement('div');
  preview.className = 'rp-preview';
  Object.assign(preview.style,{ display:'none', placeItems:'center', marginBottom:'12px' });

  // â–¼ ä¸‹éƒ¨ï¼šæ¨ªä¸¦ã³ï¼ˆå¸¸æ™‚è¡¨ç¤ºãƒ»å³åŒæœŸã§æ›´æ–°ï¼‰â€» â† æƒé™¤å¯¾è±¡ã® .conlane ã¯ä½¿ã‚ãªã„ï¼
  const lane = document.createElement('div');
  lane.className = 'rp-lane';
  Object.assign(lane.style, {
    display:'flex', gap:'8px', flexWrap:'nowrap',
    justifyContent:'center', alignItems:'center', marginTop:'0'
  });

  // ãƒ¬ãƒ¼ãƒ³å†æç”»ï¼ˆusedNorm ã¯æ­£è¦åŒ–å Setï¼‰
  const renderLane = (usedNorm=new Set())=>{
    lane.innerHTML = '';
    for (const [normName, originalName] of baseMap.entries()){
      if (usedNorm.has(normName)) continue; // ä»–å¸­ãŒä½¿ç”¨ä¸­ãªã‚‰é™¤å¤–
      const c = document.createElement('div');
      c.className = 'concard'; // ã‚¢ã‚¤ãƒ†ãƒ ã¨åŒã‚µã‚¤ã‚ºã®è¦‹ãŸç›®ã‚’æµç”¨
      c.style.backgroundImage = `url('./${originalName}')`;
      c.title = 'ã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§';
      c.addEventListener('click', ev=>{
        ev.stopPropagation();
        openRolePickZoomToPreview(preview, originalName, myIdx);
      });
      lane.appendChild(c);
    }
    if (!lane.children.length){
      const p = document.createElement('div');
      p.textContent = 'é¸æŠå¯èƒ½ãªã‚«ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“';
      p.style.padding = '6px 10px';
      lane.appendChild(p);
    }
  };

  // DBè³¼èª­ï¼štables ã® face ã‚’ç›£è¦–ã—ã¦ã€ä»–å¸­ãŒé¸ã‚“ã ã‚‚ã®ã‚’å³é™¤å¤–
  const tblRef = ref(db, `rooms/${room}/tables`);
  state._rolePickOff = onValue(tblRef, snap=>{
    const val = snap.val() || {};
    const usedNorm = new Set();
    for (const [k, t] of Object.entries(val)){          // {"0":{â€¦}} å½¢å¼ã«å¯¾å¿œ
      const idx = Number(k);
      if (!isFinite(idx)) continue;
      if (idx === myIdx) continue;                      // è‡ªåˆ†ã®é¸æŠã¯é™¤å¤–å¯¾è±¡ã«ã—ãªã„
      const nf = normalizeFace(t?.character?.face);
      if (nf && baseNormSet.has(nf)) usedNorm.add(nf);  // å€™è£œã«å«ã¾ã‚Œã‚‹å ´åˆã®ã¿ä½¿ç”¨ä¸­æ‰±ã„
    }
    renderLane(usedNorm);
  });

  // åˆæœŸæç”»ï¼ˆè³¼èª­åˆ°é”å‰ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  try{
    const tables0 = (state?.watching?.tables) || [];
    const used0 = new Set();
    tables0.forEach((t, idx)=>{
      if (idx === myIdx) return;
      const nf = normalizeFace(t?.character?.face);
      if (nf && baseNormSet.has(nf)) used0.add(nf);
    });
    renderLane(used0);
  }catch(_){ renderLane(new Set()); }

  wrap.appendChild(preview);
  wrap.appendChild(lane);
  ov.appendChild(wrap);
  document.body.appendChild(ov);
}

// æ‹¡å¤§ã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«è¡¨ç¤ºï¼ˆæ¨ªä¸¦ã³ã¯å¸¸ã«æ®‹ã™ï¼‰
function openRolePickZoomToPreview(previewEl, faceName, myIdx){
  previewEl.style.display = 'grid';
  previewEl.innerHTML = '';

  const big = document.createElement('div');
  big.className = 'conzoom-card'; // æ‹¡å¤§è¦‹ãŸç›®ã¯æµç”¨ã§OKï¼ˆæƒé™¤å¯¾è±¡ã§ã¯ãªã„ï¼‰
  big.style.backgroundImage = `url('./${faceName}')`;
  previewEl.appendChild(big);

  // æ‹¡å¤§ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã§ã€Œé¸æŠã™ã‚‹ã€è¡¨ç¤ºï¼ˆãƒˆã‚°ãƒ«ï¼‰
  big.addEventListener('click', e=>{
    e.stopPropagation();
    let m = previewEl.querySelector('.conzoom-menu');
    if (m){ m.remove(); return; }
    m = document.createElement('div');
    m.className = 'conzoom-menu';

    const btnPick = document.createElement('button');
    btnPick.textContent = 'é¸æŠã™ã‚‹';
    btnPick.onclick = async ev=>{
      ev.stopPropagation();
      try{
        const room = state?.roomCode || state?.code;
        await update(ref(db, `rooms/${room}/tables/${myIdx}/character`), {
          face: faceName, flipped: false
        });
      }catch(err){ console.error('[role-pick select]', err); }
      closeRolePickOverlay(); // æ±ºå®šæ™‚ã®ã¿é–‰ã˜ã‚‹ï¼ˆå°‚ç”¨ï¼‰
    };

    m.appendChild(btnPick);
    previewEl.appendChild(m);
  }, { once:false });
}

// å°‚ç”¨ã‚¯ãƒ­ãƒ¼ã‚º & è³¼èª­è§£é™¤
function closeRolePickOverlay(){
  cleanupRolePickerListener();
  const ov = document.getElementById('rolePickOverlay');
  if (ov) ov.remove();
}

// ç›£è¦–è§£é™¤ï¼ˆãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ï¼‰
function cleanupRolePickerListener(){
  try{ if (state._rolePickOff){ state._rolePickOff(); } }catch(e){ console.warn('[role-pick cleanup]', e); }
  state._rolePickOff = null;
}
/* â–²â–² M31ã€œ66ï¼šæ­£ä½“ã‚«ãƒ¼ãƒ‰ãƒ”ãƒƒã‚«ãƒ¼ â–²â–² */


// #61ï¼šé–²è¦§å°‚ç”¨ã®æ‹¡å¤§ï¼ˆãƒœã‚¿ãƒ³ãƒ»ãƒãƒƒãƒ—ãªã—ï¼‰
function openConstraintZoomView(letter){
  try{
    const old = document.getElementById('conZoomOverlay');
    if (old) old.remove();
   const ov = document.createElement('div');
    ov.id = 'conZoomOverlay';
    ov.addEventListener('click', (e)=>{ if(e.target===ov) closeConstraintZoom(); });
   const wrap = document.createElement('div');
    wrap.className = 'conzoom-wrap';
    const big = document.createElement('div');
    big.className = 'conzoom-card';
    big.style.backgroundImage = `url('${imgConstraint(letter)}')`;
    wrap.appendChild(big);
    ov.appendChild(wrap);
    document.body.appendChild(ov);
  }catch(e){ console.error(e); }
}
 

function openRoleZoomView(faceFileName){
  try{
    const old = document.getElementById('conZoomOverlay');
    if (old) old.remove();
    const ov = document.createElement('div');
    ov.id = 'conZoomOverlay';
    ov.addEventListener('click', (e)=>{ if(e.target===ov) closeConstraintZoom(); });
    const wrap = document.createElement('div');
    wrap.className = 'conzoom-wrap';
    const big = document.createElement('div');
    big.className = 'conzoom-card';
    // memberç”»åƒã‚’ãã®ã¾ã¾æ‹¡å¤§
    big.style.backgroundImage = `url('./${faceFileName}')`;
    // â–¼ è¿½åŠ ï¼šæ‹¡å¤§ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ã€Œä½¿ã†ã€ãƒãƒƒãƒ—ï¼ˆãƒˆã‚°ãƒ«ï¼‰
    big.addEventListener('click', (e)=>{
      e.stopPropagation();
      let menu = wrap.querySelector('.conzoom-menu');
      if (menu){ menu.remove(); return; }   // 2å›ç›®ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      menu = document.createElement('div');
      menu.className = 'conzoom-menu';
      const btnUse = document.createElement('button');
      btnUse.textContent = 'ä½¿ã†';
btnUse.onclick = async (ev)=>{
  ev.stopPropagation();
  const isNine = String(faceFileName||'').includes('member (9).jpg');
  if (isNine){
    // item2 ã®ã€Œä½¿ã†ã€ã¨åŒã˜ï¼ši2Flow ã‚’ pickSelf ã§é–‹å§‹
    await update(ref(db, `rooms/${state.roomCode}/meta`), {
      i2Flow: { usingBy: state.userId, phase: 'pickSelf', selA: null, selB: null }
    });
  }
  closeConstraintZoom();
};

      menu.appendChild(btnUse);
      wrap.appendChild(menu);
    });
    wrap.appendChild(big);
    ov.appendChild(wrap);
    document.body.appendChild(ov);
  }catch(e){ console.error('[role-zoom]', e); }
} 
// â˜… #61å°‚ç”¨ï¼šæ‹¡å¤§â†’ã€Œäº¤æ›ã€â†’ã€Œæœ¬å½“ã«ï¼Ÿã€â†’B(F/G)ã‹ã‚‰å·®ã—æ›¿ãˆ
function openConstraintZoom61(letter, myIdx){
  try{
    const old = document.getElementById('conZoomOverlay');
    if (old) old.remove();
    const ov = document.createElement('div');
    ov.id = 'conZoomOverlay';
    ov.addEventListener('click', (e)=>{ if(e.target===ov) closeConstraintZoom(); });
    const wrap = document.createElement('div');
    wrap.className = 'conzoom-wrap';
    const big = document.createElement('div');
    big.className = 'conzoom-card';
    big.style.backgroundImage = `url('${imgConstraint(letter)}')`;
    wrap.appendChild(big);
    ov.appendChild(wrap);
    document.body.appendChild(ov);
    // æœ€åˆã¯ã€Œäº¤æ›ã€ãƒœã‚¿ãƒ³ã ã‘
    const menu = document.createElement('div');
    menu.className = 'conzoom-menu';
    const btnSwap = document.createElement('button');
   btnSwap.textContent = 'äº¤æ›';
    btnSwap.onclick = (ev)=>{
      ev.stopPropagation();
      // ç¢ºèªæ®µéšã¸ç½®ãæ›ãˆ
      menu.innerHTML = '';
      const btnOk = document.createElement('button');
      btnOk.textContent = 'æœ¬å½“ã«ï¼Ÿ';
      btnOk.onclick = async (ev2)=>{
        ev2.stopPropagation();
        try{
          const mRef = ref(db, `rooms/${state.roomCode}/meta`);
          const snap = await get(mRef);
          const meta = snap.val()||{};
          const arr  = Array.isArray(meta.m61_byTable) ? meta.m61_byTable.slice() : [];
          if (myIdx<0 || myIdx>=arr.length) { closeConstraintZoom(); return; }
          // ãƒ‡ãƒƒã‚­B = F or G ã‚’ãƒ©ãƒ³ãƒ€ãƒ 
// â˜…å¤‰æ›´ï¼šmeta ã® Bãƒ‡ãƒƒã‚­ã‹ã‚‰ã€Œæœªä½¿ç”¨ã®å…ˆé ­1æšã€ã‚’å¼•ã
const deck = Array.isArray(meta.m61_bDeck) ? meta.m61_bDeck.slice() : ['F','G','H','I','J','K','L'];
const used = Array.isArray(meta.m61_bUsed) ? meta.m61_bUsed.slice() : [];

// ã¾ã ä½¿ã£ã¦ã„ãªã„æœ€ä¸Šæ®µã‚’å–å¾—
const nextB = deck.find(ch => !used.includes(ch));
if (!nextB) { closeConstraintZoom(); return; } // åœ¨åº«åˆ‡ã‚Œãªã‚‰ä½•ã‚‚ã—ãªã„

arr[myIdx] = nextB;
used.push(nextB);

// m61_byTable ã¨ m61_bUsed ã‚’åŒæ™‚æ›´æ–°ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
await update(mRef, {
  m61_byTable: arr,
  m61_bUsed: used,
  m61_swapAt: Date.now()
});
        }catch(e){ console.error('[M61 swap]', e); }
        closeConstraintZoom();
      };
      const btnCancel = document.createElement('button');
      btnCancel.textContent = 'ã‚„ã‚ã‚‹';
      btnCancel.onclick = (e3)=>{ e3.stopPropagation(); closeConstraintZoom(); };
      menu.appendChild(btnOk);
      menu.appendChild(btnCancel);
    };
    menu.appendChild(btnSwap);
   wrap.appendChild(menu);
  }catch(e){ console.error(e); }
}

  
/* ï¼šã‚¢ã‚¤ãƒ†ãƒ æ‹¡å¤§ãƒãƒƒãƒ— */
function openItemZoom(itemNo, itemIdx, opt={}){
  try{
    const old = document.getElementById('conZoomOverlay');
    if (old) old.remove();

    const ov = document.createElement('div');
    ov.id = 'conZoomOverlay';
    ov.addEventListener('click', (e)=>{ if(e.target===ov) closeConstraintZoom(); });

    const wrap = document.createElement('div');
    wrap.className = 'conzoom-wrap';

    const big = document.createElement('div');
    big.className = 'conzoom-card';
    big.style.backgroundImage = `url('./item${itemNo}.jpg')`;

    big.addEventListener('click', async (e)=>{
      e.stopPropagation();
      let m = wrap.querySelector('.conzoom-menu');
      if (m){ m.remove(); return; }
      m = document.createElement('div');
      m.className = 'conzoom-menu';

      // â‘ ï¼ˆä»»æ„ï¼‰è£ãªã‚‰ã€Œè¡¨ã«ã™ã‚‹ã€
      if (opt?.canFaceUp) {
        const btnFace = document.createElement('button');
        btnFace.textContent = 'è¡¨ã«ã™ã‚‹';
        btnFace.onclick = async (ev)=>{
          ev.stopPropagation();
          await update(ref(db, `rooms/${state.roomCode}/items/${itemIdx}`), { faceUp:true });
          closeConstraintZoom();
        };
        m.appendChild(btnFace);
      }

      // â‘¡ã€Œä½¿ã†ã€ï¼šå¾“æ¥ã® 'ä½¿ç”¨ã™ã‚‹' ã¨åŒç­‰ã®å‡¦ç†
      const btnUse = document.createElement('button');
      btnUse.textContent = 'ä½¿ã†';
      btnUse.onclick = async (ev)=>{
        ev.stopPropagation();
        await update(ref(db, `rooms/${state.roomCode}/items/${itemIdx}`), { used:true });
        const path=`rooms/${state.roomCode}/meta/itemUses`;
        const uses = state.watching?.meta?.itemUses || {i1:0,i2:0,i12:0,i14:0};
        if(itemNo===1)  await update(ref(db, path), {i1:(uses.i1||0)+1});
        if(itemNo===2)  await update(ref(db, path), {i2:(uses.i2||0)+1});
        if(itemNo===12) await update(ref(db, path), {i12:(uses.i12||0)+1});
        if(itemNo===14) await update(ref(db, path), {i14:(uses.i14||0)+1});

        if(itemNo===2){
          await update(ref(db, `rooms/${state.roomCode}/meta`), { i2Flow:{usingBy:state.userId, phase:'pickSelf', selA:null, selB:null} });
        }
        if(itemNo===13){ await addTwoItemsFromDeck(); }
        if(itemNo===16){ await handleItem16(itemIdx); }
        if(itemNo===18){ await update(ref(db, `rooms/${state.roomCode}/meta`), { i18Flow:{usingBy:state.userId, phase:'pickOther', sel:null} }); }

        closeConstraintZoom();
      };
      m.appendChild(btnUse);

      wrap.appendChild(m);
    });

    wrap.appendChild(big);
    ov.appendChild(wrap);
    document.body.appendChild(ov);
  }catch(e){ console.error(e); }
}


  
/* === #22 ç”¨ï¼šæ•°å­—ãƒˆãƒ¼ã‚¯ãƒ³ã®ä½¿ç”¨æ•°ã‚’é›†è¨ˆ === */
function countNumTokenUsage(n, v){
  const vv = v || state.watching;
  let used = 0;
  (vv?.tables || []).forEach(T=>{
    // ã‚«ãƒ¼ãƒ‰ã«ç½®ã‹ã‚ŒãŸã€Œæ•°å­—ã€ãƒˆãƒ¼ã‚¯ãƒ³
    (T.hand || []).forEach(c=>{
      (c.tokens || []).forEach(tk=>{
        if (tk?.type === 'num' && parseInt(tk.value, 10) === n) used += 1;
      });
    });
   // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼ãƒ‰ä¸‹ã®ä¿æŒãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆm22Tokensï¼‰
    (T.m22Tokens || []).forEach(nn=>{
      if (parseInt(nn, 10) === n) used += 1;
    });
  });
  return used;
}

 // â˜… #27ï¼šå€™è£œãƒ—ãƒ¼ãƒ«ã‚’ç”Ÿæˆã—ã¦ DB(meta) ã«ä¿å­˜ï¼ˆåˆå›ã®ã¿ï¼‰
 async function ensureM27Candidates(vNow){
   const v = vNow || state.watching;
   if (!v) return;
   // æ—¢ã«ç”¨æ„æ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„
   if (Array.isArray(v?.meta?.m27_row) && v.meta.m27_row.length > 0) {
     await update(ref(db, `rooms/${state.roomCode}/meta`), { m27_shown: true });
     return;
   }
   // Z = 1..12 å„2å€‹ã€ä½¿ç”¨åˆ†ï¼ˆä¸Šé™2ã¾ã§ï¼‰ã‚’å·®ã—å¼•ã
   const pool = [];
   for (let n=1; n<=12; n++){
     const left = 2 - Math.min(2, countNumTokenUsage(n, v));
     for (let i=0; i<left; i++) pool.push(n);
   }
   // äººæ•°ã¶ã‚“ãƒ©ãƒ³ãƒ€ãƒ æç¤ºï¼ˆé‡è¤‡ã¯è¨±å¯ï¼šä»•æ§˜ã¯ã€Œå„2å€‹ã€ãªã®ã§é‡è¤‡OKï¼‰
   shuffle(pool);
   const need = Math.max(0, v.tableCount|0);
   const picks = pool.slice(0, need);
   await update(ref(db, `rooms/${state.roomCode}/meta`), {
     m27_row: picks,
     m27_shown: true
   });
 }

 // â˜… #27ï¼šã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ç›´ä¸‹ã«æç¤ºãƒˆãƒ¼ã‚¯ãƒ³è¡Œã‚’æç”»
 function renderM27Row(vNow){
   const v = vNow || state.watching;
   const bar = document.getElementById('itemsBar');
   if (!bar || !v?.mission || v.mission.id !== 27) {
     const old = document.getElementById('m27Row');
     if (old) old.remove();
     return;
   }
   const list = Array.isArray(v?.meta?.m27_row) ? v.meta.m27_row.slice() : [];
   // è¡ŒãŒä¸è¦ãªã‚‰æ¶ˆã™
   if (list.length === 0){
     const old = document.getElementById('m27Row');
     if (old) old.remove();
     return;
   }

   // æ—¢å­˜è¡Œã‚’å†åˆ©ç”¨ or æ–°è¦ä½œæˆ
   let row = document.getElementById('m27Row');
   if (!row){
     row = document.createElement('div');
     row.id = 'm27Row';
     row.className = 'm27-row';
     // ã€Œæç¤ºãƒˆãƒ¼ã‚¯ãƒ³ã€ãƒ©ãƒ™ãƒ«
     const cap = document.createElement('span');
     cap.className = 'cap';
     cap.textContent = 'æç¤ºãƒˆãƒ¼ã‚¯ãƒ³ï¼š';
     row.appendChild(cap);
     bar.insertAdjacentElement('afterend', row);
   }
   // ãƒ©ãƒ™ãƒ«ä»¥å¤–ã‚’æ¶ˆã—ã¦å†æç”»
   [...row.children].forEach((ch,i)=>{ if(i>0) ch.remove(); });

   list.forEach((n, idx)=>{
     const tok = document.createElement('div');
     tok.className = 'token black';
     tok.textContent = String(n);
     tok.title = 'ã‚¯ãƒªãƒƒã‚¯ã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚­ãƒ£ãƒ©ä¸‹ã«ç½®ã';
     tok.onclick = async (ev)=>{
       try{
         // è‡ªåˆ†ã®å¸­ã¸
         const myIdx = (v.tables||[]).findIndex(T => T.playerId === state.userId);
         if (myIdx < 0){ alert('å¸­ã«åº§ã£ã¦ã‹ã‚‰é¸ã‚“ã§ãã ã•ã„'); return; }

        const metaSnap0 = await get(ref(db, `rooms/${state.roomCode}/meta`));
        const meta0 = metaSnap0.val() || {};
        const takenMap = meta0.m27_taken || {};
        if (takenMap[state.userId]) {
          // æ—¢ã«1å€‹å–å¾—æ¸ˆã¿
          return;
        }
         
         // m22Tokens ã‚’æ±ç”¨ã®â€œä¿æŒãƒˆãƒ¼ã‚¯ãƒ³ç½®ãå ´â€ã¨ã—ã¦æµç”¨ï¼ˆ#22 ã¨åŒã˜è‡ªå‹•æ¶ˆè²»ãƒ«ãƒ¼ãƒãƒ³ãŒä½¿ãˆã‚‹ï¼‰
         const tRef = ref(db, `rooms/${state.roomCode}/tables/${myIdx}`);
         const snap = await get(tRef);
         const cur  = snap.val() || {};
         const arr  = Array.isArray(cur.m22Tokens) ? cur.m22Tokens.slice() : [];
         arr.push(n);

         // è¡Œå´ã‹ã‚‰ã‚‚1ã¤å–ã‚Šé™¤ã
         const metaSnap = await get(ref(db, `rooms/${state.roomCode}/meta`));
         const meta  = metaSnap.val() || {};
         const rowNow = Array.isArray(meta.m27_row) ? meta.m27_row.slice() : [];
         // idx ã®ä½ç½®ã® 1 å€‹ã‚’å‰Šé™¤ï¼ˆåŒå€¤ãŒè¤‡æ•°ã‚ã‚‹ãŸã‚ index æŒ‡å®šï¼‰
         if (rowNow[idx] === n) rowNow.splice(idx,1);
         else {
           const pos = rowNow.indexOf(n);
           if (pos >= 0) rowNow.splice(pos,1);
         }

         await Promise.all([
          update(tRef, { m22Tokens: arr }),
          update(ref(db, `rooms/${state.roomCode}/meta`), { 
            m27_row: rowNow,
            m27_taken: { ...(meta.m27_taken||{}), [state.userId]: true }
          })         ]);

         // å–ã‚Šçµ‚ãˆãŸã‚‰å³æ™‚å†æç”»ï¼ˆæ¬¡ã® onValue ã‚’å¾…ãŸãšã«è»½ãï¼‰
         renderM27Row(state.watching || v);
       }catch(e){
         console.error(e);
       }
     };
     row.appendChild(tok);
   });
 }
  
  /* â–¼ #22ï¼šè‡ªåˆ†ã®ã‚­ãƒ£ãƒ©ä¸‹ã®ä¿æŒãƒˆãƒ¼ã‚¯ãƒ³ã‚’1ã¤æ¶ˆè²»ã™ã‚‹ */
async function consumeM22IfMatches(tableIdx, n){
  try{
    const tRef = ref(db, `rooms/${state.roomCode}/tables/${tableIdx}`);
    const snap = await get(tRef);
    const cur  = snap.val() || {};
    const arr  = Array.isArray(cur.m22Tokens) ? cur.m22Tokens.slice() : [];
    const i    = arr.indexOf(n);
    if(i >= 0){
      arr.splice(i,1);
      await update(tRef, { m22Tokens: arr });
    }
  }catch(e){ console.error('consumeM22IfMatches', e); }
}


/* === #22 ç”¨ï¼šæƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³è¡¨ï¼ˆ3Ã—4ï¼‰ï¼šé»’ãƒˆãƒ¼ã‚¯ãƒ³ + x0/x1/x2 ã‚’æ¨ªä¸¦ã³è¡¨ç¤º === */
function showInfo22Panel(vNow){
  if (window.m22_alreadyShown) return;  // â˜…ã“ã“ã‹ã‚‰è¿½åŠ ï¼šä¸€åº¦ã ã‘è¡¨ç¤º
  window.m22_alreadyShown = true;   

  const v = vNow || state.watching;
  if (!v) return;

  // â˜… é»„2ç¨®å…¬é–‹ï¼ˆï¼ã‚µãƒ¼ãƒå´ã§ m22_infoShown ã‚’ç«‹ã¦ãŸï¼‰ã¾ã§ã¯è¡¨ã‚’ç”Ÿæˆã—ãªã„
  if (v?.meta?.m22_infoShown !== true) return;
 ã€€const givenMap = v.meta?.m22_given || {};
ã€€ const iGave    = !!givenMap[state.userId];
  const div = document.createElement('div');
  div.id = 'info22';
  div.className = 'info22';

  for (let n=1; n<=12; n++){
    // ä½¿ç”¨æ•°ï¼ˆ2ä»¥ä¸Šã¯ 2 ã§æ‰“ã¡æ­¢ã‚ï¼‰
    const used = countNumTokenUsage(n, v);
const shown = 2 - Math.min(2, used);

      const cell = document.createElement('div');
    cell.className = 'cell';

    // é»’ãƒˆãƒ¼ã‚¯ãƒ³æœ¬ä½“ï¼ˆæ—¢å­˜ã® .token.black ã‚’å†åˆ©ç”¨ï¼‰
    const tok = document.createElement('div');
    tok.className = 'token black';
    tok.textContent = String(n);

// â˜… shown ãŒ 0 ã®å ´åˆã¯ç„¡åŠ¹ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä»˜ä¸
if (shown === 0) cell.classList.add('disabled');
    
    // å³å´ã® xãƒ©ãƒ™ãƒ«
    const xl = document.createElement('span');
    xl.className = 'xlabel';
    xl.textContent = `x${shown}`;

    cell.appendChild(tok);
    cell.appendChild(xl);

    // â–¼ ã‚»ãƒ«å…¨åŸŸï¼ãƒˆãƒ¼ã‚¯ãƒ³ã©ã¡ã‚‰ã‚’æŠ¼ã—ã¦ã‚‚åŒã˜æŒ™å‹•ï¼šè‡ªåˆ†ã¯1å›ã ã‘ã€Œæ¸¡ã™ã€å¯èƒ½ã€‚ä»¥é™ã¯ã€Œéš ã™ã€ã®ã¿
    const handleGiveOrHide = async (ev)=>{
      ev.stopPropagation();

  // â˜… x0 ã¯ãƒãƒƒãƒ—ã‚’å‡ºã•ãªã„ï¼ˆä½•ã‚‚ã—ãªã„ï¼‰
  if (shown === 0) return;
      
      const latest = state.watching || v;
      const givenMap = latest?.meta?.m22_given || {};
      const iGaveNow = !!givenMap[state.userId];

      if (state.m22GaveOnce || iGaveNow) {
        openMenu(ev.clientX, ev.clientY, [
          { label:'éš ã™', action: ()=>{ const x=document.getElementById('info22'); if(x) x.remove(); } }
        ]);
        return;
      }

      // æ¬¡æ‰‹ç•ªï¼šè‡ªåˆ†ã®æ¬¡ã®ç€å¸­è€…
      const tables = (latest.tables||[]);
      const myIdx  = tables.findIndex(T => T.playerId === state.userId);
      let nextIdx  = -1;
      if (myIdx >= 0 && tables.length > 0){
        for (let off=1; off<=tables.length; off++){
          const i = (myIdx + off) % tables.length;
          if (tables[i]?.playerId){ nextIdx = i; break; }
        }
      }
      if (nextIdx < 0){
        nextIdx = (tables.findIndex(T => T.playerId) + tables.length) % Math.max(1, tables.length);
      }
      const nextName = tables[nextIdx]?.playerName || `#${(nextIdx|0)+1}`;

      openMenu(ev.clientX, ev.clientY, [
        { label: `${nextName} ã« ${n} ã‚’æ¸¡ã™`, action: async ()=>{
            try{
              state.m22GaveOnce = true;

              const gPath = `rooms/${state.roomCode}/meta/m22_given`;
              const gSnap = await get(ref(db, gPath));
              const gMap  = gSnap.val() || {};
              if (gMap[state.userId]) return;

              // å—ã‘å–ã‚Šå…ˆã« push
              const tRef = ref(db, `rooms/${state.roomCode}/tables/${nextIdx}`);
              const snap = await get(tRef);
              const cur  = snap.val() || {};
              const arr  = Array.isArray(cur.m22Tokens) ? cur.m22Tokens.slice() : [];
              arr.push(n);
              await update(tRef, { m22Tokens: arr });

              // è‡ªåˆ†ã¯æ¸¡ã—æ¸ˆã¿ã«ã™ã‚‹ï¼ˆDBä¿æŒï¼‰
              await update(ref(db, gPath), { [state.userId]: true });
    // â˜… æ¸¡ã—ãŸã‚‰è¡¨ã‚’è‡ªå‹•ã§éš ã™
    const panel = document.getElementById('info22');
    if (panel) panel.remove();
  }catch(e){
    state.m22GaveOnce = false;
    console.error(e);
            }
          } }
      ]);
    };

    cell.onclick = handleGiveOrHide;
    tok.onclick  = handleGiveOrHide;

    div.appendChild(cell);
  }
  
  document.body.appendChild(div);
}




// â˜…â˜…â˜… ã“ã“ã‹ã‚‰è¿½åŠ ï¼š#29 è‡ªå‹•å‡ºã—ãƒ˜ãƒ«ãƒ‘ãƒ¼ â˜…â˜…â˜…
async function ensureM29AutoDrop(roomVal){
  try{
    if ((roomVal?.mission?.id|0) !== 29) return;
    // ã™ã§ã«å‡¦ç†æ¸ˆã¿ã®æ•°å­—ã‚’ãƒ¡ã‚¿ã«è¨˜éŒ²ã—ã¦äºŒé‡å®Ÿè¡Œã‚’é˜²æ­¢
    const doneMap = (roomVal.meta && roomVal.meta.m29_autoDone) ? { ...roomVal.meta.m29_autoDone } : {};

    // ç¾åœ¨å…¬é–‹ä¸­ã‚³ãƒ¼ãƒ‰ã®ã€Œæ•°å­—åˆ¥ open:true æšæ•°ã€ã‚’é›†è¨ˆ
    const openMap = {};
    (roomVal.tables||[]).forEach(T=>{
      (T.hand||[]).forEach(c=>{
        if (c?.kind==='normal' && c.open===true){
          const n = c.num|0;
          openMap[n] = (openMap[n]||0) + 1;
        }
      });
    });

    // ã‚»ãƒ³ã‚¿ãƒ¼/ãƒ‡ãƒƒã‚­ã®ç¾çŠ¶
    let center = Array.isArray(roomVal.m29_center) ? roomVal.m29_center.slice() : [];
    let deck   = Array.isArray(roomVal.m29_deck)   ? roomVal.m29_deck.slice()   : [];

    // 1..12 ã‚’èµ°æŸ»ã—ã€ã€Œå…¬é–‹4æšã€ã‹ã¤ã€Œæœªå‡¦ç†ã€ã®æ•°å­—ã‚’è‡ªå‹•ã§å ´ã«å‡ºã™
    for (let n=1; n<=12; n++){
      if ((openMap[n]||0) !== 4) continue;
      if (doneMap[n]) continue;

      // ã¾ãšå„ãƒ†ãƒ¼ãƒ–ãƒ«ã® m29Hand ã‹ã‚‰è©²å½“ n ã‚’æ¢ã™
      let placed = false;
      let ownerIdx = -1;

      for (let i=0; i<(roomVal.tables||[]).length; i++){
        const tPath = `rooms/${state.roomCode}/tables/${i}`;
        const tSnap = await get(ref(db, tPath));
        const T = tSnap.val() || {};
        const curHand = Array.isArray(T.m29Hand) ? T.m29Hand.slice() : [];
        const pos = curHand.indexOf(n);
        if (pos >= 0){
          curHand.splice(pos, 1);

          // â‘¡ æ‰‹æœ­ãŒ1æšä»¥ä¸‹ãªã‚‰ã€å±±æœ­ã‹ã‚‰1æš è‡ªå‹•ãƒ‰ãƒ­ãƒ¼ï¼ˆã‚ã‚Œã°ï¼‰
          //    â€» deck ã¯ ensureM29AutoDrop å†…ã§ä¿æŒ â†’ æœ€å¾Œã«ã¾ã¨ã‚ã¦ DB åæ˜ 
         if (curHand.length <= 1 && deck.length > 0) {
            const d = deck.shift();    // å…ˆé ­ã‹ã‚‰1æš
            curHand.push(d);
          }

          // â‘¢ æ‰‹æœ­ã ã‘å…ˆã«æ›¸ãæˆ»ã™ï¼ˆã‚»ãƒ³ã‚¿ãƒ¼/ãƒ‡ãƒƒã‚­ã¯é–¢æ•°æœ«å°¾ã§ä¸€æ‹¬åæ˜ ï¼‰
          await update(ref(db, tPath), { m29Hand: curHand });
          ownerIdx = i;
          placed = true;
          break;
        }
      }

      // æ‰‹æœ­ã«ç„¡ã‘ã‚Œã° m29_deckï¼ˆæ®‹ã‚Šå±±ï¼‰ã‹ã‚‰æ‹¾ã†
      if (!placed){
        const p = deck.indexOf(n);
        if (p >= 0){
          deck.splice(p,1);
          placed = true;
          ownerIdx = -1; // ãƒ‡ãƒƒã‚­ç”±æ¥
        }
      }

      // è¦‹ã¤ã‹ã£ãŸã‚‰ã‚»ãƒ³ã‚¿ãƒ¼ã¸ã€Œè¡¨ã§ã€å‡ºã™
      if (placed){
        center.push({ n, by: ownerIdx, faceUp: true });
        doneMap[n] = true;
      }
    }

    // ã¾ã¨ã‚ã¦DBã¸åæ˜ 
    const updates = { };
    updates['rooms/'+state.roomCode+'/m29_center'] = center;
    updates['rooms/'+state.roomCode+'/meta'] = {
      ...(roomVal.meta||{}),
      m29_autoDone: doneMap
    };
    updates['rooms/'+state.roomCode+'/m29_deck'] = deck;
    await update(ref(db), updates);
  }catch(e){
    console.error('ensureM29AutoDrop failed', e);
  }
}
// â˜…â˜…â˜… ã“ã“ã¾ã§è¿½åŠ  â˜…â˜…â˜…



function refreshInfo22(vNow){
  const panel = document.getElementById('info22');
  if (!panel) return;
  const v = vNow || state.watching;
  // ãƒ•ãƒ©ã‚°ãŒä¸‹ãŒã£ã¦ã„ãŸã‚‰é–‰ã˜ã‚‹
  if (v?.meta?.m22_infoShown !== true) { panel.remove(); return; }

  // 1..12 ã®å„ã‚»ãƒ«ã® xè¡¨ç¤ºã¨ disabled ã‚’æ›´æ–°
  const cells = panel.querySelectorAll('.cell');
  for (let n=1; n<=12; n++){
    const cell = cells[n-1];
    if (!cell) continue;
    const used  = countNumTokenUsage(n, v);          // æ—¢å­˜é–¢æ•°ã‚’å†åˆ©ç”¨
    const shown = 2 - Math.min(2, used);             // 0/1/2
    const xl = cell.querySelector('.xlabel');
    if (xl) xl.textContent = `x${shown}`;
    cell.classList.toggle('disabled', shown===0);    // x0 ã¯ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹
  }
}




/* ===== Item 2 swap ===== */
async function doItem2Swap(A, B){
  if(!A || !B) return;
  const snap = await get(ref(db, `rooms/${state.roomCode}/tables`));
  const tables = snap.val() || [];

  const pickCard = (tableIdx, cardId)=>{
    const hand = (tables[tableIdx]?.hand)||[];
    const i = hand.findIndex(c=> c.id===cardId);
    return {hand, index:i, card: i>=0 ? hand[i] : null};
  };

  const a = pickCard(A.table, A.cardId);
  const b = pickCard(B.table, B.cardId);
  if(!a.card || !b.card){ await update(ref(db, `rooms/${state.roomCode}/meta`), { i2Flow:null }); return; }

  a.hand.splice(a.index,1); b.hand.splice(b.index,1);

  const insertSortedLeft = (hand, card)=>{ const n = card.num; let pos = 0; while(pos<hand.length && hand[pos].num < n) pos++; while(pos>0 && hand[pos-1].num===n) pos--; hand.splice(pos,0,card); };

  const mark = now()+10000; // 10ç§’
 const toB = {...a.card, ownerId: tables[B.table].playerId || null, markUntil: mark, markSrc:'i2'};
   const toA = {...b.card, ownerId: tables[A.table].playerId || null, markUntil: mark, markSrc:'i2'};
  insertSortedLeft(b.hand, toB);
  insertSortedLeft(a.hand, toA);

  const realpha = (hand)=>{ const alpha='abcdefghijklmnopqrstuvwxyz'; hand.forEach((c,i)=> c.alpha = alpha[i%alpha.length]); };
  realpha(a.hand); realpha(b.hand);

  await Promise.all([
    set(ref(db, `rooms/${state.roomCode}/tables/${A.table}/hand`), a.hand),
    set(ref(db, `rooms/${state.roomCode}/tables/${B.table}/hand`), b.hand),
    update(ref(db, `rooms/${state.roomCode}/meta`), { i2Flow:null })
  ]);
  // äº¤æ›å¾Œï¼šmember(9) ã‚’è‡ªåˆ†ãŒæŒã£ã¦ã„ã‚‹ãªã‚‰æ ã®9ã‚’è£è¿”ã™
  try{
    const myIdx = (tables||[]).findIndex(t => t?.playerId === state.userId);
    if (myIdx >= 0){
      const meChar = tables[myIdx]?.character || {};
      const isNine = String(meChar.face||'').includes('member (9).jpg');
      if (isNine && !meChar.flipped){
        await update(ref(db, `rooms/${state.roomCode}/tables/${myIdx}/character`), { flipped: true });
      }
    }
  } catch(e){ console.warn('[i2] auto-flip 9 failed', e); }
}

/* ===== Item 18 take ===== */
async function doItem18Take(sel){
  const myTable = state.watching?.tables?.findIndex(t=> t.playerId===state.userId);
  if(myTable==null || myTable<0){ alert('å¸­ã«åº§ã£ã¦ã‹ã‚‰ä½¿ç”¨ã—ã¦ãã ã•ã„'); await update(ref(db, `rooms/${state.roomCode}/meta/i18Flow`), {sel:null, phase:'pickOther'}); return; }
  const snap = await get(ref(db, `rooms/${state.roomCode}/tables`));
  const tables = snap.val() || [];

  const srcHand = (tables[sel.table]?.hand)||[];
  const si = srcHand.findIndex(c=> c.id===sel.cardId);
  if(si<0){ await update(ref(db, `rooms/${state.roomCode}/meta/i18Flow`), {sel:null, phase:'pickOther'}); return; }
  const card = srcHand.splice(si,1)[0];

  const dstHand = (tables[myTable]?.hand)||[];
  const n = card.num;
  let pos = 0; while(pos<dstHand.length && dstHand[pos].num < n) pos++; while(pos>0 && dstHand[pos-1].num===n) pos--; 
  const mark = now()+10000;
dstHand.splice(pos,0,{...card, ownerId: state.userId, markUntil: mark, markSrc:'i18'});
  const realpha = (hand)=>{ const alpha='abcdefghijklmnopqrstuvwxyz'; hand.forEach((c,i)=> c.alpha = alpha[i%alpha.length]); };
  realpha(dstHand); realpha(srcHand);

  await Promise.all([
    set(ref(db, `rooms/${state.roomCode}/tables/${sel.table}/hand`), srcHand),
    set(ref(db, `rooms/${state.roomCode}/tables/${myTable}/hand`), dstHand),
    update(ref(db, `rooms/${state.roomCode}/meta`), { i18Flow:null })
  ]);
}

/* ==== ã‚¢ã‚¤ãƒ†ãƒ ãƒ‡ãƒƒã‚­åˆ¶å¾¡ï¼ˆãƒŸãƒƒã‚·ãƒ§ãƒ³åˆ¥ï¼‰ ==== */

/* ã“ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã§é»„ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã†ã‹ï¼Ÿ */
function missionUsesYellow(missionId){
  const plan = buildMixPlan(missionId) || [];
  // yellowPick / yellowChoose ã‚’å«ã‚€ã‹ã€#2ï¼ˆé»„ã‚³ãƒ¼ãƒ‰ï¼‰ãªã‚‰ true
  return missionId===2 || plan.some(p => p.type==='yellowPick' || p.type==='yellowChoose');
}

/* ãƒŸãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã®ã‚¢ã‚¤ãƒ†ãƒ é™¤å¤–ãƒªã‚¹ãƒˆï¼ˆå¿…è¦ã«å¿œã˜ã¦è¿½è¨˜ï¼‰ */
 const ITEM_EXCLUSIONS = {
   10: [11],
   20: [2],
   26: [10],
   27: [7],
   35: [2],
   39: [1,2,3,4,5,6,7,8,9,10,11,12,13],
   45: [7,10,11],
   47: [10],
   49: [10],
   51: [10],
   52: [1,12],
  53: [6,9],
  54: [10],
   56: [2],
   58: [4,7],
   59: [10],
   63: [10],
  65: [10],
 };

    
/* ===== Item helpers ===== */
/* missionId ã¨ â€œé»„ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã†ã‹â€ã§å±±æœ­ã‚’æ±ºå®šã—ã€é™¤å¤–ã‚‚é©ç”¨ */
function itemDeckNumbers(missionId){
  // 43ä»¥é™ã¯ 1..18 ã‚’ä½¿ç”¨
  if(missionId >= 43){
    return Array.from({length:18}, (_,i)=> i+1);
  }

  // ã€œ42ã¯ 1..13ï¼ˆé»„ã‚³ãƒ¼ãƒ‰ã‚ã‚Šï¼‰ / 1..12ï¼ˆé»„ã‚³ãƒ¼ãƒ‰ãªã—ï¼‰
  const useYellow = missionUsesYellow(missionId);
  const maxNo = useYellow ? 13 : 12;
  let pool = Array.from({length:maxNo}, (_,i)=> i+1);

  // é™¤å¤–é©ç”¨
  const ex = ITEM_EXCLUSIONS[missionId] || [];
  if(ex.length){
    const exSet = new Set(ex);
    pool = pool.filter(n => !exSet.has(n));
  }
  return pool;
}


/* item13: è¿½åŠ ã§2æš */
async function addTwoItemsFromDeck(){
  const v = state.watching; if(!v) return;
  const missionId = v?.mission?.id || 0;

  // ãƒŸãƒƒã‚·ãƒ§ãƒ³è¦å‰‡ã«å¾“ã£ãŸãƒ—ãƒ¼ãƒ«
  const pool = itemDeckNumbers(missionId);

  // æ—¢å­˜ã¨é‡è¤‡ã—ãªã„ã‚‚ã®ã‹ã‚‰è¿½åŠ 
  const existingNos = new Set((v.items||[]).map(i=>i.no));
  const candidates = pool.filter(n=> !existingNos.has(n));
  shuffle(candidates);

  const pick = candidates.slice(0,2).map(no=>({id:crypto.randomUUID(), no, used:false}));
  if(pick.length===0) return;

  const next = (v.items||[]).concat(pick);
  await set(ref(db, `rooms/${state.roomCode}/items`), next);
}


/* item16: æ•°å­—(1..12)ã®ä½¿ç”¨æ•°ã‚’é›†è¨ˆã—ã€<2ã®æ•°å­—ã‹ã‚‰1ã¤é¸ã³ãƒ¡ã‚¿ã«ä¿å­˜ï¼ˆè¡¨ç¤ºã¯ã‚¢ã‚¤ãƒ†ãƒ 16å³å´ã§è¡Œã†ï¼‰ */
async function handleItem16(itemIdx){
  const v = state.watching; if(!v) return;

  const counts = Array.from({length:13}, ()=>0); // 1..12
  (v.tables||[]).forEach(T=>{
    (T.hand||[]).forEach(c=>{
      (c.tokens||[]).forEach(tk=>{
        if(tk?.type==='num'){
          const n = parseInt(tk.value, 10);
          if(n>=1 && n<=12) counts[n] += 1;
        }
      });
    });
  });

  const candidates = [];
  for(let n=1; n<=12; n++){
    if((counts[n]||0) < 2) candidates.push(n);
  }

  if(candidates.length===0){
    await update(ref(db, `rooms/${state.roomCode}/meta`), { i16Badge: null });
    return;
  }

  const pick = candidates[Math.floor(Math.random()*candidates.length)];
  await update(ref(db, `rooms/${state.roomCode}/meta`), { i16Badge: { num: pick, at: Date.now() } });
}

/* gear etc */
function updateMenuButtons(){
  const seated = state.seatedTable!=null;
  H(btnSit, seated);
  H(btnLeave, !seated);
  H(btnPickMission, !state.isHost);

  // â˜… #22ï¼šé»„ã‚³ãƒ¼ãƒ‰2ç¨®å…¬é–‹ã¾ã§ã¯ã€Œè¡¨ã€ã‚’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«å‡ºã•ãªã„
  const v = state.watching;
  const id  = 'btnShowInfo22';
  const old = document.getElementById(id);

  // æ¡ä»¶ = ãƒŸãƒƒã‚·ãƒ§ãƒ³22ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨±å¯ãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ã¦ã€ã‹ã¤ v.meta.m22_infoShown === trueï¼ˆé»„2ç¨®å…¬é–‹æ¸ˆã¿ï¼‰
  const canReferInfoTable = !!(v?.mission?.flags?.m22_allowInfoTableFromMenu && v?.meta?.m22_infoShown === true);

  if (!canReferInfoTable && old){ old.remove(); }
  if (canReferInfoTable && !old){
    const b = document.createElement('button');
    b.className = 'btn'; b.id = id; b.textContent = 'æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆ#22ï¼‰';
b.onclick = ()=>{ window.m22_alreadyShown = false; showInfo22Panel(state.watching); };
    menuPop.insertBefore(b, menuPop.firstChild || null);
  }
}


const outsideClose=(e,t)=>{ if(!t.contains(e.target)) H(t,true); };
function closeAllMini(e){
  const b = document.body;
  const inM42 =
    b.getAttribute('data-m42m2') === 'on' ||
    b.getAttribute('data-m42swap') === 'on';

  // â–¼ è¿½åŠ ï¼šitem2 / item18 ã®é¸æŠãƒ•ãƒ­ãƒ¼ä¸­ã‚‚å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ãªã„
  const meta = state.watching?.meta || {};
  const i2   = meta.i2Flow  || null;
  const i18  = meta.i18Flow || null;
  const inI2  = !!(i2  && i2.usingBy === state.userId && (i2.phase === 'pickSelf' || i2.phase === 'pickOther'));
  const inI18 = !!(i18 && i18.usingBy === state.userId && (i18.phase === 'pickOther'));

  if (inM42 || inI2 || inI18) return;

  document.querySelectorAll('.mini-pop').forEach(pop=>{
    if(!pop.contains(e.target)) pop.remove();
  });
}
 document.addEventListener('click',(e)=>{ closeAllMini(e); outsideClose(e, menuPop); }, true);
gear.onclick=()=> { menuPop.classList.toggle('hidden'); if(!menuPop.classList.contains('hidden')) updateMenuButtons(); };

/* â˜… å…±é€šã®é›¢å¸­å‡¦ç† */
async function leaveSeatNow(){
  if(state.seatedTable==null || !state.watching?.tables) return;
  const idx=state.seatedTable; const hand=(state.watching.tables[idx].hand||[]);
  try{
    await onDisconnect(ref(db, `rooms/${state.roomCode}/tables/${idx}`)).cancel();
    await Promise.all(hand.map((_,i)=>
      onDisconnect(ref(db, `rooms/${state.roomCode}/tables/${idx}/hand/${i}`)).cancel()
    ));
  }catch(_e){}

  await update(ref(db, `rooms/${state.roomCode}/tables/${idx}`), {playerId:null, playerName:null});
  await Promise.all(hand.map((_,i)=> update(ref(db, `rooms/${state.roomCode}/tables/${idx}/hand/${i}`), {ownerId:null})));
  state.seatedTable=null; updateMenuButtons();
}

/* â˜… è‡ªå‹•é€€å¸­ï¼šåˆ‡æ–­æ™‚ã«å¸­ã¨æ‰‹æœ­ã®æ‰€æœ‰ã‚’å¤–ã™äºˆç´„ã‚’å¼µã‚‹ */
async function setupAutoLeaveOnDisconnect(tableIdx){
  if (tableIdx == null) return;
  const room = state.roomCode;

  try{
    if (state.seatedTable != null && state.seatedTable !== tableIdx){
      const prev = state.seatedTable;
      await onDisconnect(ref(db, `rooms/${room}/tables/${prev}`)).cancel();
      const prevHand = state.watching?.tables?.[prev]?.hand || [];
      await Promise.all(prevHand.map((_,i)=>
        onDisconnect(ref(db, `rooms/${room}/tables/${prev}/hand/${i}`)).cancel()
      ));
    }
  }catch(_e){}

  await onDisconnect(ref(db, `rooms/${room}/tables/${tableIdx}`))
    .update({ leaveRequested: serverNow(), leaveUid: state.userId });
}




  /* â˜… è¿½åŠ ï¼šãƒ›ã‚¹ãƒˆç”¨â€”ä»»æ„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚­ãƒƒã‚¯ï¼ˆé›¢å¸­åŒ–ï¼‰ */
  async function kickSeatAt(tableIdx){
    const v = state.watching;
    if(!state.isHost || !v?.tables || tableIdx==null) return;
    const T = v.tables[tableIdx] || {};
    if(!T.playerId) return; // ç©ºå¸­ã¯ä½•ã‚‚ã—ãªã„
    const hand = Array.isArray(T.hand) ? T.hand : [];
    await update(ref(db, `rooms/${state.roomCode}/tables/${tableIdx}`), { playerId:null, playerName:null });
    await Promise.all(hand.map((_,i)=>
      update(ref(db, `rooms/${state.roomCode}/tables/${tableIdx}/hand/${i}`), { ownerId:null })
    ));
  }

  
 // â–¼ å¸­é¸æŠã‚¿ãƒ–ã®æç”»ã‚’é–¢æ•°åŒ–ï¼šé–‹ã„ã¦ã„ã‚‹é–“ã‚‚å†æç”»ã§åŒæœŸ
function renderSeatTabs(v){
  if(!v?.started) return;
  seatTabs.innerHTML='';
  (v.tables||[]).forEach((t,i)=>{
    const tab=document.createElement('div'); 
    tab.className='tab';
tab.textContent = String(i + 1);
    if(t.playerId) tab.classList.add('disabled');
    tab.onclick=async ()=>{
      if(tab.classList.contains('disabled')) return;
      await update(ref(db, `rooms/${state.roomCode}/tables/${i}`), {
        playerId:state.userId, playerName:state.userName
      });
      const hRef = ref(db, `rooms/${state.roomCode}/tables/${i}/hand`);
      const hSnap = await get(hRef);
      const hand = hSnap.val() || [];
      await Promise.all(hand.map((_,idx)=> 
        update(ref(db, `rooms/${state.roomCode}/tables/${i}/hand/${idx}`), { ownerId: state.userId })
      ));
// await setupAutoLeaveOnDisconnect(i);   // â˜…è‡ªå‹•é€€å¸­ã‚’ç„¡åŠ¹åŒ–
      state.seatedTable=i; H(seatPop,true); updateMenuButtons();
maybeOpenRolePickerAfterSeat();

    };
    seatTabs.appendChild(tab);
  });
}

btnSit.onclick = async ()=>{
  if(state.mode!=='player'){ alert('è¦³æˆ¦å…¥å®¤ã§ã¯å¸­ã«åº§ã‚Œã¾ã›ã‚“ã€‚å‚åŠ ã§å…¥ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚'); return; }
  const v = state.watching;
  if(!v?.started){ return; }

  // â˜… è‡ªå‹•ç€å¸­ï¼šåŒã˜åå‰ã®å¸­ã‚’æ¢ã™
  const sameNameIdx = (v.tables || []).findIndex(t => t.playerName === state.userName);
  if (sameNameIdx >= 0) {
    // åå‰ãŒä¸€è‡´ã™ã‚‹å¸­ãŒã‚ã‚Œã°è‡ªå‹•ç€å¸­
    await update(ref(db, `rooms/${state.roomCode}/tables/${sameNameIdx}`), {
      playerId: state.userId,
      playerName: state.userName
    });
    const hRef = ref(db, `rooms/${state.roomCode}/tables/${sameNameIdx}/hand`);
    const hSnap = await get(hRef);
    const hand = hSnap.val() || [];
    await Promise.all(hand.map((_, idx) => 
      update(ref(db, `rooms/${state.roomCode}/tables/${sameNameIdx}/hand/${idx}`), { ownerId: state.userId })
    ));
    state.seatedTable = sameNameIdx;
    H(seatPop, true); 
    updateMenuButtons();
    maybeOpenRolePickerAfterSeat();
    return;
  }

  // åå‰ä¸€è‡´ãªã—ã®å ´åˆã¯å¾“æ¥ã®å¸­ãƒãƒƒãƒ—
  renderSeatTabs(v);
  H(seatPop, false);
};


btnSeatCancel.onclick=()=> H(seatPop,true);

btnLeave.onclick = async ()=>{ await leaveSeatNow();btnSit.onclick(); };

/* start / mission-pick */
btnPickMission.onclick = ()=>{
  if(!state.isHost){ alert('ãƒ›ã‚¹ãƒˆã®ã¿æ“ä½œå¯'); return; }
  openMissionPicker();   // â–¼ æ–°ã—ã„ãƒ”ãƒƒã‚«ãƒ¼è¡¨ç¤º
};

// æ—¢å­˜ã®restartPopã¯ä½¿ã‚ãªã„
btnRestartOk.onclick = ()=>{};
btnRestartCancel.onclick = ()=>{ H(restartPop,true); };

// â–¼ å¤‰æ›´ï¼šçˆ†å¼¾ã‚’è§£é™¤ï¼ ã§ä¸‹éƒ¨ãƒ”ãƒƒã‚«ãƒ¼ã‚’é–‹ã

btnStartCancel.onclick = ()=> H(startPop,true);
btnStartOk.onclick = async ()=>{ const count=clamp(parseInt(selCount.value,10),1,6); const missionId=parseInt(selMission.value,10); H(startPop,true); await startGame(count, missionId); };


/* â–¼â–¼ ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ”ãƒƒã‚«ãƒ¼å®Ÿè£… â–¼â–¼ */
let mpSelectedCount = 4;

function openMissionPicker(){
  // åˆæœŸäººæ•°ã¯ç¾åœ¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«æ•° or 4
  const v = state.watching;
  mpSelectedCount = clamp(parseInt(v?.tableCount||4,10), 1, 6);

  // äººæ•°ã‚¿ãƒ–ç”Ÿæˆ
  mpCounts.innerHTML = '';
  [2,3,4,5,6].forEach(n=>{
    const tab = document.createElement('div');
    tab.className = 'tab' + (n===mpSelectedCount?' active':'');
    tab.textContent = String(n);
    tab.onclick = ()=>{
      mpSelectedCount = n;
      [...mpCounts.children].forEach(c=>c.classList.remove('active'));
      tab.classList.add('active');
    };
    mpCounts.appendChild(tab);
  });

// ãƒŸãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ç”Ÿæˆï¼ˆ#ä»˜ãæ•°å­—ï¼‰
mpMissions.innerHTML = '';
// 1ã€œ66 å…¨éƒ¨
const missionIds = Array.from({length:66}, (_,i) => i+1);
missionIds.forEach(id=>{
  const b = document.createElement('button');
  b.className = 'btn small';
  b.textContent = `#${id}`; // â˜… #ä»˜ã
  b.onclick = async ()=>{
    await leaveSeatNow();
    closeMissionPicker();
    await startGame(mpSelectedCount, id);
  };
  mpMissions.appendChild(b);
});



  btnMpBack.onclick = ()=> closeMissionPicker();
  H(mp, false);
  // ä»–ã®ãƒãƒƒãƒ—ã¯é–‰ã˜ã‚‹
  H(menuPop, true);
}

function closeMissionPicker(){ H(mp, true); }
/* â–²â–² ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ”ãƒƒã‚«ãƒ¼å®Ÿè£… â–²â–² */

async function startGame(playerCount, missionId){
  if(!state.isHost) return;

  // â˜… å‰ã®ã‚²ãƒ¼ãƒ ç”±æ¥ã®DOMï¼†ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’å®Œå…¨ã‚¯ãƒªã‚¢
  clearMissionOverlays();
  window.m22_alreadyShown = false;

  // å¿µã®ãŸã‚ã€ç”»é¢ä¸‹éƒ¨ãƒãƒƒã‚¸ã‚‚æ¶ˆã™
  if(globalReveal){ globalReveal.innerHTML=''; H(globalReveal,true); }
 // â˜… #22ï¼šæ¸¡ã—æ¸ˆã¿ã‚¬ãƒ¼ãƒ‰ã®ãƒªã‚»ãƒƒãƒˆ
  state.m22GaveOnce = false;
  // â˜… #22ï¼šã‚µãƒ¼ãƒå´ãƒ¡ã‚¿ã‚‚åˆæœŸåŒ–ï¼ˆå¯è¦–ãƒ•ãƒ©ã‚°ï¼æ¸¡ã—æ¸ˆã¿è¡¨ï¼‰
  try{
    await update(ref(db, `rooms/${state.roomCode}/meta`), {
      m22_infoShown:false, m22_given:null,
      m27_row: [], m27_shown:false, m27_taken:null,
      // â˜… M44 ã®åˆæœŸåŒ–ï¼ˆãƒŸãƒƒã‚·ãƒ§ãƒ³åˆ‡æ›¿æ™‚ã«å¿…ãšãƒªã‚»ãƒƒãƒˆï¼‰
      oxItem: 0,
      oxByTable: {}
    });
   }catch(_){}
  const code = state.roomCode;


  const captainIndex = Math.floor(Math.random()*playerCount);
  const faces=[1,2,3,4]; shuffle(faces);
  const tables=[]; for(let i=0;i<playerCount;i++){ const face=(i===captainIndex)?'member (5).jpg':`member (${faces[i%4]}).jpg`; tables.push({ titleNumber:i+1, playerId:null, playerName:null, character:{face, flipped:false}, hand:[] }); }

  // ===== ãƒ‡ãƒƒã‚­æ§‹ç¯‰ =====
  let deck=[]; let missionMeta;
let m29Rest = null; // â˜…è¿½åŠ ï¼š#29 ã®æ®‹ã‚Šå±±ï¼ˆ12æšã§æ‰“ã¡æ­¢ã‚ç”¨ï¼‰
  // ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒƒã‚­ 1..12 x4 = 48ï¼ˆé€šå¸¸ã‚³ãƒ¼ãƒ‰ï¼‰
  const base=[]; for(let n=1;n<=12;n++){ for(let k=0;k<4;k++) base.push({id:crypto.randomUUID(), num:n, kind:'normal', open:false, ownerId:null}); }
  shuffle(base);

  // â–¼ ãƒŸãƒƒã‚·ãƒ§ãƒ³åˆ¥ï¼šèµ¤/é»„ã®æ··å…¥ãƒ—ãƒ©ãƒ³ã‚’å–å¾—ï¼†å®Ÿè¡Œ
  const planList = buildMixPlan(missionId);
  const { toAdd, mixLines, chooseLines } = executeMixPlan(planList);

  // #1/#2ã®æ—§å®Ÿè£…ã¯ planList ã§åŒ…å«ã§ãã‚‹ãŒã€äº’æ›ã®ãŸã‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  if(missionId===1 && planList.length===0){
    const x = (Math.random()*11|0) + 1;
    toAdd.push({num:x+0.5, kind:'red'});
    mixLines.push(`èµ¤[${x+0.5}]`);
  }
  if(missionId===2 && planList.length===0){
    const x = (Math.random()*11|0) + 1;
    toAdd.push({num:x+0.1, kind:'yellow'});
    mixLines.push(`é»„[${x+0.1}]`);
  }

  // ãƒ‡ãƒƒã‚­åˆæˆ
  deck = base.concat(
    toAdd.map(s => ({ id:crypto.randomUUID(), num:s.num, kind:s.kind, open:false, ownerId:null }))
  );
  shuffle(deck);

  // ãƒŸãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤ºãƒ¡ã‚¿ç”Ÿæˆï¼ˆèµ¤/é»„ã®çµæœè¡Œã‚’å…ˆé ­ã«å·®ã—è¾¼ã‚€ï¼‰
  missionMeta = missionInfo(missionId, { mixLines, chooseLines });
  /* â–¼â–¼ ã“ã“ã‹ã‚‰è¿½åŠ ï¼š#29 æ•°å€¤ã‚«ãƒ¼ãƒ‰ã®é…å¸ƒã¨ã‚»ãƒ³ã‚¿ãƒ¼åˆæœŸåŒ– â–¼â–¼ */
  if (missionId === 29) {
    const nums = MATERIALS.numbers.slice(); shuffle(nums); // 1..12 ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    // å…¨å“¡ã«2æšã€éšŠé•·ã®å‰ï¼ˆcap-1ï¼‰ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã« +1
    const cap = captainIndex|0;
    const x   = (cap - 1 + playerCount) % playerCount;
    let pi = 0;
    tables.forEach((T, i) => {
      const take = (i===x) ? 3 : 2;
      T.m29Hand = [];
      for (let k=0; k<take && pi<nums.length; k++) T.m29Hand.push(nums[pi++]);
    });
m29Rest = nums.slice(pi);
    // ã‚»ãƒ³ã‚¿ãƒ¼ï¼ˆå ´ã«å‡ºã—ãŸæ•°å€¤ã‚«ãƒ¼ãƒ‰ç½®ãå ´ï¼‰
    // å½¢å¼: { n: number, by: tableIndex, faceUp: boolean }
    missionMeta.flags = { ...(missionMeta.flags||{}), m29:true };
  }
  /* â–²â–² ã“ã“ã¾ã§è¿½åŠ ï¼š#29 â–¼â–¼ */

  let m43A = [];
  if (missionId === 43) {
    // 5,6äººâ†’3æš / 3,4äººâ†’4æšï¼ˆ2äººã¯æƒ³å®šå¤–ã ãŒ 4 ã«å¯„ã›ã‚‹ï¼‰
    const need = (playerCount >= 5) ? 3 : 4;
    // ã€Œã“ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã§é…å¸ƒã™ã‚‹äºˆå®šã®ã‚«ãƒ¼ãƒ‰ã€ï¼ç¾åœ¨ã® deck ã‹ã‚‰é€šå¸¸æ•°å€¤ã‚«ãƒ¼ãƒ‰ã ã‘ã‚’å€™è£œã«
    const normalIdx = deck.map((c,i)=> c?.kind==='normal' ? i : -1).filter(i=> i>=0);
    shuffle(normalIdx);
    // ãƒ©ãƒ³ãƒ€ãƒ ã«å¿…è¦æšæ•°ã¶ã‚“ã‚’é¸ã³ã€ãƒ‡ãƒƒã‚­ã‹ã‚‰â€œæŠœãå–ã‚Šâ€â†’ Aç¾¤ï¼ˆæ•°å€¤ã®é…åˆ—ï¼‰ã«
    const takeIdx = normalIdx.slice(0, need).sort((a,b)=> b-a); // å¾Œã‚ã‹ã‚‰ splice ã™ã‚‹ãŸã‚é™é †
    takeIdx.forEach(i=>{
      const c = deck[i];
      if (c && typeof c.num === 'number') {
        m43A.push(c.num|0);
        deck.splice(i,1); // ãƒ‡ãƒƒã‚­ã‹ã‚‰é™¤å¤–
      }
    });
  }

  
  // ===== é…å¸ƒ â†’ æ‰‹æœ­æ˜‡é † â†’ Î±ä»˜ä¸ =====
  const alpha="abcdefghijklmnopqrstuvwxyz";
  let p=0; while(p<deck.length){ for(let t=0; t<playerCount && p<deck.length; t++){ const c=deck[p++]; tables[t].hand.push({...c, alpha:'', tokens:[], markUntil:null}); } }
  tables.forEach(T=>{ T.hand.sort((a,b)=> a.num - b.num); T.hand.forEach((c,i)=>{ c.alpha = alpha[i % alpha.length]; }); });

// ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆäººæ•°ã¶ã‚“ï¼‰ â€” ãƒŸãƒƒã‚·ãƒ§ãƒ³è¦å‰‡ã«åˆã‚ã›ã¦å±±æœ­ã‚’ä½œã‚‹
let pool = itemDeckNumbers(missionId);

// â˜… ãƒŸãƒƒã‚·ãƒ§ãƒ³ã®ãƒ•ãƒ©ã‚°ã‚’å…ˆã«ç¢ºèªã—ã¦ limitItemsTo ãŒã‚ã‚Œã° pool ã‚’çµã‚‹
const flagsForItems = missionMeta?.flags || {};
if (Array.isArray(flagsForItems.limitItemsTo) && flagsForItems.limitItemsTo.length > 0) {
  pool = flagsForItems.limitItemsTo.slice(); // ãƒŸãƒƒã‚·ãƒ§ãƒ³18ã¯ [8] ã«ãªã‚‹
}

shuffle(pool);

// #15: æœ€åˆã¯è£å‘ãï¼ˆfaceUp:falseï¼‰ã€‚ãã‚Œä»¥å¤–ã¯é€šå¸¸ã©ãŠã‚Šè¡¨ï¼ˆfaceUp:trueï¼‰
const faceUpStart = !(missionMeta?.flags?.itemsFaceDownStart);

 // #23 ã¯é–‹å§‹æ™‚ã¯é…ã‚‰ãªã„ï¼ˆåºƒã’æ¡ä»¶ã‚’æº€ãŸã™ã¾ã§éè¡¨ç¤ºï¼‰
 const items = (missionMeta?.id === 23)
   ? []
   : pool
       .slice(0, Math.min(playerCount, pool.length))
       .map(no => ({ id: crypto.randomUUID(), no, used: false, faceUp: faceUpStart }));

  // â˜… é–‹å§‹ã‚¨ãƒƒã‚¸ã‚’ä½œã‚‹ãŸã‚ã«ä¸€ç¬ã ã‘ false ã‚’æ›¸ãï¼ˆãƒŸãƒƒã‚·ãƒ§ãƒ³ã¯æœªé¸æŠçŠ¶æ…‹ã¸ï¼‰
  await update(ref(db, `rooms/${code}`), { started:false, mission:null });

  await set(ref(db, `rooms/${code}`), {
    ...(state.watching||baseRoom(state.userId)),
    hostId: state.watching?.hostId || state.userId,
    started:true, tableCount:playerCount, tables, items,
  di:{ value: ((missionId===51 || missionId===55 || missionId===60 || missionId===62 || missionId===41) ? 1 : playerCount), max:6 },
  captainTable: captainIndex, mission: missionMeta,     /* â–¼â–¼ ã“ã“ã‹ã‚‰è¿½åŠ ï¼š#29 ã‚»ãƒ³ã‚¿ãƒ¼åˆæœŸåŒ– â–¼â–¼ */
    m29_center: (missionMeta?.id===29 ? [] : null),
 m29_deck:   (missionMeta?.id===29 ? (m29Rest||[]) : null),
    /* â–²â–² ã“ã“ã¾ã§è¿½åŠ  â–¼â–¼ */
    meta:{ itemUses:{i1:0,i2:0,i12:0,i14:0}, tokenCounts:{equal:0,noteq:0,x1:0}, i2Flow:null, i18Flow:null, i16Badge:null }
  });
  /* ã“ã“ã‹ã‚‰è¿½åŠ ï¼š#43 Aç¾¤ã¨ nano åˆæœŸå€¤ã‚’ meta ã«ä¿å­˜ */
  if (missionId === 43) {
    const initNano = (playerCount >= 5) ? 3 : 4; // ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã®è¡¨ç¤ºï¼ˆä»•æ§˜ã©ãŠã‚Šï¼‰
    try{
      await update(ref(db, `rooms/${code}/meta`), {
        m43_A: Array.isArray(m43A) ? m43A : [],
        m43_nano: initNano,
        m43_pos: 0,
        m43_prevPos: 0
      });
    }catch(_e){}
  }
  await setupMissionOnStart(code);   // â˜…è¿½åŠ 

  H(gear,false);
}

/* ==== ãƒŸãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ==== */
async function setupMissionOnStart(code){
  const snap = await get(ref(db, `rooms/${code}`));
  const v = snap.val(); if(!v?.mission) return;
  const flags = v.mission.flags || {};
  /* #9ï¼šå³2 + ç•°ãªã‚‹æ•°å€¤2æšã‚’æ±ºå®šã—ã¦ meta ã«ä¿å­˜ï¼ˆãƒ›ã‚¹ãƒˆã®ã¿å®Ÿè¡Œï¼‰ */
  if ((v.mission?.id|0) === 9) {
   const pool = MATERIALS.numbers.slice(); shuffle(pool);
    const picks = pool.slice(0,2);            // ç•°ãªã‚‹2æš
   await update(ref(db, `rooms/${code}/meta`), {
      m9_numbers: picks,
     m9_rule: 'right2'
    });
  }

    /* â˜… #12ï¼šå„ã‚¢ã‚¤ãƒ†ãƒ ã®â€œçœŸä¸‹â€ã«ç½®ãæ•°å­—ã‚’æ±ºå®šâ†’metaã¸ä¿å­˜ï¼ˆãƒ›ã‚¹ãƒˆã®ã¿ãƒ»ä¸€åº¦ã ã‘ï¼‰ */
    if ((v.mission?.id|0) === 12) {
    if (!Array.isArray(v?.meta?.m12_under)) {
        const itemCount = Array.isArray(v.items) ? v.items.length : 0;
       const pool = MATERIALS.numbers.slice(); shuffle(pool);
        const picks = pool.slice(0, itemCount);   // 1ã‚¢ã‚¤ãƒ†ãƒ ã«ã¤ã1æšã€é‡è¤‡ãªã—
        await update(ref(db, `rooms/${code}/meta`), { m12_under: picks });
      }
    }

  
  /* ã“ã“ã‹ã‚‰è¿½åŠ ï¼š#41 é»„ã‚³ãƒ¼ãƒ‰4æšé…å¸ƒï¼ˆ4äººï¼å…¨å“¡ / 5äººï¼éšŠé•·ä»¥å¤–ï¼‰ */
  if ((v.mission?.id|0) === 41) {
    const tcount = v.tableCount|0;
    const cap    = v.captainTable|0;

    // å—ã‘å–ã‚Šå…ˆï¼š4äººâ†’å…¨å“¡ / 5äººâ†’éšŠé•·ä»¥å¤– / ãã®ä»–â†’å…ˆé ­ã‹ã‚‰æœ€å¤§4äºº
    const recipients =
      (tcount === 5)
        ? Array.from({length:tcount}, (_,i)=>i).filter(i => i !== cap)
        : (tcount === 4)
            ? [0,1,2,3]
            : Array.from({length: Math.min(4, tcount)}, (_,i)=>i);

    // é»„ã‚³ãƒ¼ãƒ‰4æšã‚’æŠ½é¸ï¼ˆå—ã‘å–ã‚Šäººæ•°ã¶ã‚“ã ã‘ä½¿ç”¨ï¼‰
    const yList = MATERIALS.yellowCodes.slice(); shuffle(yList);
    const pick  = yList.slice(0, recipients.length);

    // â–¼ ãƒŸãƒƒã‚·ãƒ§ãƒ³è©³ç´°ã«è¡¨ç¤ºï¼ˆå…ˆé ­ã‚¿ã‚¤ãƒˆãƒ«ã®ç›´å¾Œã« â–§è¡Œã‚’å·®ã—è¾¼ã‚€ï¼‰
    try{
      const dispSnap = await get(ref(db, `rooms/${code}/mission/display`));
      const disp = dispSnap.val() || [];
      const yellowLine = '<span style="color:gold;">â–§</span>' + pick.map(n => `[${n}]`).join('');
      await update(ref(db, `rooms/${code}/mission`), { display: [disp[0] || '#41', yellowLine, ...disp.slice(1)] });
    }catch(_){}

    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç›´æ¥é…å¸ƒï¼ˆæ‰‹æœ­ã¸è¿½åŠ â†’æ˜‡é †â†’Î±å†æ¡ç•ªï¼‰
    const tablesSnap = await get(ref(db, `rooms/${code}/tables`));
    const tbls = tablesSnap.val() || [];
    const realpha = (hand)=>{ const alpha='abcdefghijklmnopqrstuvwxyz'; hand.forEach((c,i)=> c.alpha = alpha[i%alpha.length]); };

    recipients.forEach((ti, idx)=>{
      const hand = tbls[ti]?.hand || [];
      hand.push({
        id: crypto.randomUUID(),
        num: pick[idx],
        kind: 'yellow',
        open: false,
        ownerId: tbls[ti]?.playerId || null,
        tokens: []
      });
      hand.sort((a,b)=> a.num - b.num);
      realpha(hand);
      tbls[ti].hand = hand;
    });
    // â–¼â–¼ è¿½åŠ ï¼š#41 é–‹å§‹æ™‚ã«ã€Œå„ã‚­ãƒ£ãƒ©ä¸‹ã¸ æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³(é»’) ã‚’1æšãšã¤ã€é…å¸ƒï¼ˆã‚¯ãƒªãƒƒã‚¯ä¸å¯ãƒ»ä½¿ç”¨ã§è‡ªå‹•æ¶ˆæ»…ï¼‰
    //    è¡¨ç¤ºã¯æ—¢å­˜ã® m22Tokens æç”»ï¼ˆchar ä¸‹ã®é»’ãƒˆãƒ¼ã‚¯ãƒ³åˆ—ï¼‰ã‚’æµç”¨ã—ã¾ã™ã€‚
    //    ä»•æ§˜ï¼šå„å¸­ãƒ©ãƒ³ãƒ€ãƒ  1..12ï¼ˆé‡è¤‡OKï¼‰ã€‚ä½¿ç”¨æ™‚ã¯ consumeM22IfMatches ã§è‡ªå‹•çš„ã«å–ã‚Šé™¤ã‹ã‚Œã¾ã™ã€‚
    try{
      const pool = MATERIALS.numbers.slice();  // [1..12]
      shuffle(pool);
      for (let ti = 0; ti < tbls.length; ti++){
        if (!tbls[ti]) continue;
        const n = pool[ti % pool.length];      // äººæ•°>12 ã®å ´åˆã‚‚å¾ªç’°é…å¸ƒï¼ˆé‡è¤‡å¯ï¼‰
        tbls[ti].m22Tokens = [ n ];            // 1æšã ã‘æŒãŸã›ã‚‹
      }
    }catch(_){}



    
    await set(ref(db, `rooms/${code}/tables`), tbls);
  }

/* ã“ã“ã‹ã‚‰è¿½åŠ ï¼š#48 é»„ã‚³ãƒ¼ãƒ‰3æšã‚’ã€ŒéšŠé•·â†’æ¬¡â†’æ¬¡ã€ã¸ç›´æ¥é…å¸ƒ */
if ((v.mission?.id|0) === 48) {
  const tcount = v.tableCount|0;
  const cap    = v.captainTable|0;
  if (tcount >= 1 && cap >= 0) {                       // â† å®‰å…¨ã‚¬ãƒ¼ãƒ‰ï¼ˆå…¥å®¤ä¸èƒ½ãƒã‚°å¯¾ç­–ï¼‰
    const targets = [cap, (cap+1)%tcount, (cap+2)%tcount];

    // ãƒ©ãƒ³ãƒ€ãƒ ã«é»„ã‚³ãƒ¼ãƒ‰ 3 ã¤
    const yList = MATERIALS.yellowCodes.slice(); shuffle(yList);
    const pick  = yList.slice(0, 3);

    // ãƒŸãƒƒã‚·ãƒ§ãƒ³è©³ç´°ã®å…ˆé ­ã«è¡¨ç¤ºï¼ˆâ–§[n] ã‚’1è¡Œå·®ã—è¾¼ã¿ï¼‰
    try{
      const dispSnap = await get(ref(db, `rooms/${code}/mission/display`));
      const disp = dispSnap.val() || [];
      const yellowLine = '<span style="color:gold;">â–§</span>' + pick.map(n => `[${n}]`).join('');
      await update(ref(db, `rooms/${code}/mission`), { display: [disp[0] || '#48', yellowLine, ...disp.slice(1)] });
    }catch(_){}

    // ç›´æ¥é…å¸ƒï¼ˆæ‰‹æœ­ã¸è¿½åŠ  â†’ æ˜‡é † â†’ Î±å†æ¡ç•ªï¼‰
    const tablesSnap = await get(ref(db, `rooms/${code}/tables`));
    const tbls = tablesSnap.val() || [];
    const realpha = (hand)=>{
      const alpha='abcdefghijklmnopqrstuvwxyz';
      hand.forEach((c,i)=> c.alpha = alpha[i%alpha.length]);
    };

    targets.forEach((ti, idx)=>{
      const hand = (tbls[ti]?.hand || []).slice();
      hand.push({
        id: crypto.randomUUID(),
        num: pick[idx],
        kind: 'yellow',
        open: false,
        ownerId: tbls[ti]?.playerId || null,
        tokens: []
      });
      hand.sort((a,b)=> a.num - b.num);
      realpha(hand);
      if (tbls[ti]) tbls[ti].hand = hand;
    });

    await set(ref(db, `rooms/${code}/tables`), tbls);
  }
}
/* ã“ã“ã¾ã§è¿½åŠ ï¼š#48 */

  
 // ===== #13ï¼šèµ¤ã‚³ãƒ¼ãƒ‰3æšã‚’ã€ŒéšŠé•·â†’æ¬¡â†’æ¬¡ã€ã¸ç›´æ¥é…å¸ƒï¼‹åå‰å³ãƒˆãƒ¼ã‚¯ãƒ³è¨­å®š =====
  if(v.mission?.flags?.m13_distributeRedToCaptain3){
    const tcount = v.tableCount|0;
    const cap = v.captainTable|0;
    const targets = [cap, (cap+1)%tcount, (cap+2)%tcount];
    
    // ãƒ©ãƒ³ãƒ€ãƒ ã«èµ¤ã‚³ãƒ¼ãƒ‰ 3 ã¤
    const redList = MATERIALS.redCodes.slice(); shuffle(redList);
    const pick = redList.slice(0,3);
// â–¼ è¿½åŠ ï¼šé¸ã°ã‚ŒãŸèµ¤ã‚³ãƒ¼ãƒ‰ã‚’ãƒŸãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤ºã«åæ˜ ï¼ˆå…ˆé ­ã«1è¡Œå·®ã—è¾¼ã¿ï¼‰
try{
  const dispSnap = await get(ref(db, `rooms/${code}/mission/display`));
  const disp = dispSnap.val() || [];
  const redLine = '<span style="color:red;">â—</span>' + pick.map(n => `[${n}]`).join('');
  await update(ref(db, `rooms/${code}/mission`), { display: [disp[0] || '#13', redLine, ...disp.slice(1)] });
}catch(_){}
    const tablesSnap = await get(ref(db, `rooms/${code}/tables`));
    const tbls = tablesSnap.val() || [];
    const realpha = (hand)=>{ const alpha='abcdefghijklmnopqrstuvwxyz'; hand.forEach((c,i)=> c.alpha=alpha[i%alpha.length]); };

    targets.forEach((ti, idx)=>{
      const hand = tbls[ti]?.hand || [];
      hand.push({ id:crypto.randomUUID(), num:pick[idx], kind:'red', open:false, ownerId: tbls[ti]?.playerId||null, tokens:[] });
      hand.sort((a,b)=> a.num - b.num);
      realpha(hand);
      tbls[ti].hand = hand;
    });

    // åå‰ã®å³ã®ãƒ©ãƒ³ãƒ€ãƒ æ•°å­—ï¼ˆå„ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
    const header = Array.from({length:tcount}, ()=> MATERIALS.numbers[(Math.random()*12)|0]);

    await Promise.all([
      set(ref(db, `rooms/${code}/tables`), tbls),
      update(ref(db, `rooms/${code}/meta`), { m13_header: header })
    ]);
  }



  // ===== #18ï¼šã‚¢ã‚¤ãƒ†ãƒ ã‚’ 8 ã®ã¿ã€ã‹ã¤ P1 å±±æœ­ =====
  if(Array.isArray(v.mission?.flags?.limitItemsTo)){
    const allow = new Set(v.mission.flags.limitItemsTo);
    const nextItems = (v.items||[]).filter(it => allow.has(it.no));
    await set(ref(db, `rooms/${code}/items`), nextItems);
  }

  // ===== #20ï¼šå„ãƒ†ãƒ¼ãƒ–ãƒ«ã§ 1 æšã‚’å³ç«¯ã¸ç§»å‹•ã—ã€é»„è‰²âœ•ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä»˜ä¸ =====
  if(v.mission?.flags?.m20_rightmostX){
    const tablesSnap = await get(ref(db, `rooms/${code}/tables`));
    const tbls = tablesSnap.val() || [];
    const alphaStr='abcdefghijklmnopqrstuvwxyz';
    tbls.forEach(T=>{
      const hand = (T.hand||[]).slice().sort((a,b)=> a.num - b.num); // æ˜‡é †ãƒ™ãƒ¼ã‚¹
      if(hand.length===0) return;
      const ri = (Math.random()*hand.length)|0;
      const chosen = hand.splice(ri,1)[0];
      hand.push(chosen); // å³ç«¯ã¸
      // âœ•ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆé»„è‰²ï¼‰ã‚’ãã®ã‚«ãƒ¼ãƒ‰ã«ä»˜ä¸
      chosen.tokens = [...(chosen.tokens||[]), {type:'xmark', value:'âœ•', style:'yellowX'}];
      // Î±å†ä»˜ä¸
      hand.forEach((c,i)=> c.alpha = alphaStr[i%alphaStr.length]);
      T.hand = hand;
    });
    await set(ref(db, `rooms/${code}/tables`), tbls);
  }


 /* ã“ã“ã‹ã‚‰è¿½åŠ ï¼š#38 éšŠé•·ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã¿ å³ç«¯âœ• */
  if (v.mission?.flags?.m38_captainRightmostX) {
    const captainIdx = (v.captainTable|0);
    if (captainIdx >= 0) {
      const tablesSnap = await get(ref(db, `rooms/${code}/tables`));
      const tbls = tablesSnap.val() || [];
      const T = tbls[captainIdx];
    if (T && Array.isArray(T.hand) && T.hand.length > 0) {
       const alphaStr='abcdefghijklmnopqrstuvwxyz';
        const hand = T.hand.slice().sort((a,b)=> a.num - b.num); // æ˜‡é †ãƒ™ãƒ¼ã‚¹
        const ri = (Math.random()*hand.length)|0;
        const chosen = hand.splice(ri,1)[0];
        hand.push(chosen); // å³ç«¯ã¸
        chosen.tokens = [ ...(chosen.tokens||[]), {type:'xmark', value:'âœ•', style:'yellowX'} ];
        hand.forEach((c,i)=> c.alpha = alphaStr[i%alphaStr.length]); // Î±å†ä»˜ä¸
      T.hand = hand;
     await set(ref(db, `rooms/${code}/tables`), tbls);
      }
    }
 }

  /* === #64ï¼šå„æ‰‹æœ­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ 2æšâ†’å°ã•ã„æ–¹ã‚’å·¦ç«¯ï¼å¤§ãã„æ–¹ã‚’å³ç«¯ï¼ˆè‡ªåˆ†ã ã‘è£ï¼‰ === */
  if ((v.mission?.id|0) === 64) {
    // äºŒé‡å®Ÿè¡Œé˜²æ­¢
    if (v?.meta?.m64_init === true) { /* æ—¢ã«å®Œäº† */ }
    else if (state.isHost) {
      try{
        const tSnap = await get(ref(db, `rooms/${code}/tables`));
        const tbls = tSnap.val() || [];
        const realpha = (hand)=>{ const alpha='abcdefghijklmnopqrstuvwxyz'; hand.forEach((c,i)=> c.alpha = alpha[i%alpha.length]); };

        for (let ti = 0; ti < tbls.length; ti++){
          const T = tbls[ti] || {};
          const hand = Array.isArray(T.hand) ? T.hand.slice() : [];
          if (hand.length < 2) continue;

          // ãƒ©ãƒ³ãƒ€ãƒ ã«2æšæŠ½å‡ºï¼ˆé‡è¤‡ãªã—ï¼‰
          const idxs = Array.from({length: hand.length}, (_,i)=>i);
          shuffle(idxs);
          const aIdx = idxs[0], bIdx = idxs[1];
          const A = hand[aIdx], B = hand[bIdx];
          if (!A || !B) continue;

          // å°ã•ã„æ–¹â†’å·¦ç«¯ / å¤§ãã„æ–¹â†’å³ç«¯ï¼ˆåŒæ•°ãªã‚‰æŠ½å‡ºé †ï¼‰
          const leftCard  = (A.num|0) < (B.num|0) ? A : (A.num|0) > (B.num|0) ? B : A;
          const rightCard = (leftCard === A) ? B : A;

          // 2æšã‚’å…ƒã®é…åˆ—ã‹ã‚‰é™¤å»
          const leftId = leftCard.id, rightId = rightCard.id;
          const rest = hand.filter(c => c && c.id !== leftId && c.id !== rightId);

          // xmark ä»˜ä¸ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
          const putX = (c)=>{
            const tokens = Array.isArray(c.tokens) ? c.tokens.slice() : [];
            if (!tokens.some(tk => tk?.type === 'xmark')) tokens.push({type:'xmark'});
            return { ...c, tokens };
          };

          const newHand = [ putX(leftCard), ...rest, putX(rightCard) ];
          realpha(newHand);
          tbls[ti].hand = newHand;
        }

        await Promise.all([
          set(ref(db, `rooms/${code}/tables`), tbls),
          update(ref(db, `rooms/${code}/meta`), { m64_init: true })
        ]);
      }catch(e){ console.error('[M64 init]', e); }
    }
  }

  
  /* ã“ã“ã¾ã§è¿½åŠ  */
  // #39ï¼šåˆæœŸåŒ–ï¼ˆtask1ã€œ3ï¼‰
if ((v.mission?.id|0) === 39) {
  // 1) å„ãƒ†ãƒ¼ãƒ–ãƒ«ï¼šæ‰‹æœ­ã«ãªã„æ•°å­—ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ 1ã¤ã‚’ m22Tokens ã«ä»˜ä¸
  const tblRef = ref(db, `rooms/${code}/tables`);
  const tblSnap = await get(tblRef);
  const tbls    = tblSnap.val() || [];
  const allNums = MATERIALS.numbers.slice();

  tbls.forEach(T=>{
    const tok = allNums[(Math.random()*allNums.length)|0]; // â† æ‰‹æœ­ã¯è¦‹ãªã„
    const row = Array.isArray(T.m22Tokens) ? T.m22Tokens.slice() : [];
    if (!row.includes(tok)) row.push(tok);                 // æ—¢å­˜ã¯ä¿æŒã—ã¤ã¤1ã¤è¿½åŠ 
    T.m22Tokens = row;
  });

  // 2) X ã‚’æ±ºå®šã€3) X ã‚’é™¤ã 11 æšã‹ã‚‰ 8 æšã®å±±æœ­
  const X    = allNums[(Math.random()*allNums.length)|0];
  const rest = allNums.filter(n=> n!==X); shuffle(rest);
  const deck8 = rest.slice(0,8);

  await Promise.all([
    set(tblRef, tbls),
    update(ref(db, `rooms/${code}/meta`), {
      m39_x: X,
      m39_deck: deck8,
      m39_discards: [],
      m39_dealt: false
    })
  ]);
}

  // #26ï¼š1ã€œ12ã‚’3Ã—4ã§é…ç½®ï¼ˆè£è¡¨ãƒˆã‚°ãƒ«ï¼‰
  if (flags.m26_grid12) {
    mountM26GridUnderItems();
  }
  
// #34ï¼šAã€œE ã‚’å„ãƒ†ãƒ¼ãƒ–ãƒ«ã«1æšãšã¤ï¼ˆäººæ•°>5ã®ã¨ãã¯å¾ªç’°ï¼‰
if ((v.mission?.id|0) === 34 || (v.mission?.id|0) === 34) {
  const codeSnap = await get(ref(db, `rooms/${code}`));
  const vv = codeSnap.val() || {};
  const tables = (vv.tables||[]).map(T => ({...T}));
  const letters = ['A','B','C','D','E']; shuffle(letters);
  for (let i=0; i<tables.length; i++){
    if (!tables[i].m34Con) tables[i].m34Con = letters[i % letters.length];
  }
  await update(ref(db, `rooms/${code}`), {
    tables,
   m34_center: []
  });
}
  function randNum(){ return MATERIALS.numbers[(Math.random()*12)|0]; }
}

/* ==== æ•°å€¤ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==== */
function buildNumLaneDOM(cells){
  const lane = document.createElement('div'); lane.className='numlane';
  cells.forEach(c=>{
    const div = document.createElement('div');
    if(c.kind==='rule'){ div.className='rulecard'; div.style.backgroundImage=`url('${c.img}')`; }
    if(c.kind==='num'){  div.className='numcard';  div.style.backgroundImage=`url('${c.img}')`; }
    lane.appendChild(div);
  });
  return lane;
}
function mountLaneUnderItemsBar(lane){
  const bar = document.getElementById('itemsBar');
  bar.insertAdjacentElement('afterend', lane);
}

/* ãƒ‘ã‚¿ãƒ¼ãƒ³1ï¼šå±±æœ­â†’ã‚ãã‚‹ */
function buildDeckLaneP1(){
  const lane = document.createElement('div'); 
  lane.className='numlane';

  // 1..12 ã®ã¿ãƒ»é‡è¤‡ãªã—ã®å±±æœ­
  const deck = MATERIALS.numbers.slice(); 
  shuffle(deck);
  let rest = deck.length;

  // å±±æœ­ãƒœã‚¿ãƒ³ã¨æ®‹è¡¨ç¤º
  const deckBtn = document.createElement('div');
  deckBtn.className='numdeck';
  deckBtn.title='ã‚ãã‚‹';

  const restLbl = document.createElement('span');
  restLbl.className='numrest';
  restLbl.textContent=`æ®‹:${rest}`;

  // â˜… å³å´ã«å…¬é–‹æœ­ç©ã¿é‡ã­ç”¨ãƒ›ãƒ«ãƒ€ãƒ¼
  const pile = document.createElement('div');
  pile.className = 'numcard-holder';
  pile.style.position = 'relative';

  lane.appendChild(deckBtn);
  lane.appendChild(restLbl);
  lane.appendChild(pile);

  // ç©ã¿é‡ã­è¿½åŠ 
  function addToPile(n){
    const already = pile.querySelectorAll('.numcard').length;
    const node = document.createElement('div');
    node.className = 'numcard';
    node.style.backgroundImage = `url('${imgNumber(n)}')`;

    if(already>0){
      const off = already * 2; // 2pxåˆ»ã¿
      node.style.position = 'absolute';
      node.style.left = off + 'px';
      node.style.top  = off + 'px';
    }
    pile.appendChild(node);

    // â˜… é«˜ã•èª¿æ•´ï¼ˆè¦‹åˆ‡ã‚Œé˜²æ­¢ï¼‰
    const extraH = already * 2; // ä¸‹æ–¹å‘ã¸ã®ã‚ºãƒ¬åˆ†
    pile.style.height = (48 + extraH) + 'px'; // 48pxã¯ã‚«ãƒ¼ãƒ‰é«˜ã•
    lane.style.marginBottom = extraH + 'px'; // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å°‘ã—ä¸‹ã’ã‚‹
  }

  deckBtn.onclick = (ev)=>{
    if(rest<=0){
      openOneMini(ev.clientX, ev.clientY, 'å±±æœ­ã‚’ä½œã‚‹', async ()=>{
        deck.splice(0, deck.length, ...MATERIALS.numbers.slice()); 
        shuffle(deck);
        rest = deck.length;
        restLbl.textContent = `æ®‹:${rest}`;
        deckBtn.style.backgroundImage = `url('./numberdeck.png')`;
        deckBtn.style.background = '';
        deckBtn.title = 'ã‚ãã‚‹';
        pile.innerHTML = '';
        pile.style.height = '48px';
        lane.style.marginBottom = '0px';
        NUMCARD_REG.clear();
      });
      return;
    }

    const n = deck.pop();
    rest--;
    restLbl.textContent = `æ®‹:${rest}`;
    addToPile(n);


   
    if(rest===0){
      deckBtn.style.background = `#fff url('${imgBack}') center/60% no-repeat`;
      deckBtn.title='å±±æœ­ã‚’ä½œã‚‹';
    }
  };

  return lane;
}
/* åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ç‰ˆï¼šP1ï¼ˆå±±æœ­â†’ã‚ãã‚‹ï¼‰*/
function buildConDeckLaneP1(){
  // ãƒŸãƒƒã‚·ãƒ§ãƒ³34ã¨åŒã˜è¦‹ãŸç›®ã‚µã‚¤ã‚ºã«ã™ã‚‹ãŸã‚ã€å¸¯ã¯ conlaneã€ã‚«ãƒ¼ãƒ‰ã¯ concard ã‚’ä½¿ã†
  const lane = document.createElement('div');
  lane.className = 'conlane';
  lane.id = 'm32ConRow'; // å¿µã®ãŸã‚ä¸€æ„ID

  // åˆ¶ç´„ã‚«ãƒ¼ãƒ‰12æšï¼ˆAã€œLï¼‰
  const deck = 'ABCDEFGHIJKL'.split('');
  shuffle(deck);
  let rest = deck.length;

  // å±±æœ­ãƒœã‚¿ãƒ³ã¨æ®‹è¡¨ç¤ºï¼ˆæ•°å€¤P1ã¨åŒã˜UIéƒ¨å“ã‚’æµç”¨ï¼‰
  const deckBtn = document.createElement('div');
  deckBtn.className = 'numdeck';   // è¦‹ãŸç›®ã¯å…±é€šã®ãƒ‡ãƒƒã‚­ãƒœã‚¿ãƒ³ã§OK
  deckBtn.title = 'ã‚ãã‚‹';
 deckBtn.style.background = "#fff url('./conback.jpg') center/70% no-repeat"; 
  const restLbl = document.createElement('span');
  restLbl.className = 'numrest';
  restLbl.textContent = `æ®‹:${rest}`;

  // å³å´ã«å…¬é–‹æœ­ã®ç©ã¿é‡ã­ç½®ãå ´ï¼ˆåˆ¶ç´„ã‚«ãƒ¼ãƒ‰ã¯ concard ã§ç©ã‚€ï¼‰
  const pile = document.createElement('div');
  pile.className = 'numcard-holder';
  pile.style.position = 'relative';

  lane.appendChild(deckBtn);
  lane.appendChild(restLbl);
  lane.appendChild(pile);

    // 1æšã‚ãã£ã¦å…¬é–‹æœ­ï¼ˆå³å´ï¼‰ã«ç©ã‚€ï¼šæŒ™å‹•ã¯æ•°å€¤P1ã¨åŒã˜
    const addToPile = (ch)=>{
      const node = document.createElement('div');
      node.className = 'concard';
      node.style.backgroundImage = `url('${imgConstraint(ch)}')`;

      const already = pile.querySelectorAll('.concard').length;
      const off = already * 2;

      if (already > 0){
        node.style.position = 'absolute';
        node.style.left = off + 'px';
        node.style.top  = off + 'px';
      }
   node.title = 'æ‹¡å¤§';
ã€€ã€€node.onclick = (ev)=>{ ev.stopPropagation(); openConstraintZoom(ch); };
      pile.appendChild(node);

      // â˜… ã“ã“ã‹ã‚‰å¤‰æ›´ï¼š1æšç›®ã§ã‚‚å¿…ãšé«˜ã•/ä½™ç™½ã‚’æ›´æ–°ã™ã‚‹
      const baseH = cssNum('--con-h') || cssNum('--item-h') || 75;
      pile.style.height = (baseH + off) + 'px';
      lane.style.marginBottom = off + 'px';
      // â˜… ã“ã“ã¾ã§å¤‰æ›´
    };

  deckBtn.onclick = ()=>{
    if (rest <= 0) return;
    const ch = deck.pop(); // æœ«å°¾ã‹ã‚‰1æš
    rest -= 1;
    restLbl.textContent = `æ®‹:${rest}`;
    addToPile(ch);
  };

  return lane;
}
  
/* ãƒ‘ã‚¿ãƒ¼ãƒ³2ï¼šãƒ‡ãƒƒã‚­ã‹ã‚‰næšâ†’ä¸¦ã¹ã‚‹ï¼ˆã‚¢ã‚¤ãƒ†ãƒ ä¸‹ï¼‰ */
function buildDeckLaneP2(n=2){
  const lane = document.createElement('div'); lane.className='numlane';
  const deck = MATERIALS.numbers.slice(); shuffle(deck);
  const picks = deck.slice(0, n);
  picks.forEach(x=>{
    const nc = document.createElement('div'); nc.className='numcard'; nc.style.backgroundImage=`url('${imgNumber(x)}')`;
    lane.appendChild(nc);
  });
  return lane;
}

/* ãƒ‘ã‚¿ãƒ¼ãƒ³3ï¼šæŒ‡å®šã‚«ãƒ¼ãƒ‰ã‚’å›ºå®šä¸¦ã¹ï¼ˆå¿…è¦æ™‚ï¼‰ */
function buildFixedLane(list){
  return buildNumLaneDOM(list.map(n=>({kind:'num',img:imgNumber(n)})));
}

  /* ===== #9ï¼šå³2 + ç•°ãªã‚‹æ•°å€¤2æšï¼ˆåŒæœŸè¡¨ç¤ºï¼‰ ===== */
  function renderM9(v){
    const isM9 = ((v?.mission?.id|0) === 9);
   const old = document.getElementById('m9Row');
    if (!isM9){ if(old) old.remove(); return; }
    // ãƒ¡ã‚¿ï¼ˆãƒ›ã‚¹ãƒˆãŒé–‹å§‹æ™‚ã«ä¿å­˜ï¼‰
    const nums = Array.isArray(v?.meta?.m9_numbers) ? v.meta.m9_numbers : null;
    const rule = v?.meta?.m9_rule || 'right2';
    if (!nums || nums.length < 2) return; // æœªæº–å‚™ãªã‚‰ä½•ã‚‚ã—ãªã„ï¼ˆæ¬¡ã®onValueã§æç”»ï¼‰
   if (old) old.remove();
    // [å³2][æ•°][æ•°] ã‚’ã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ç›´ä¸‹ã«è¡¨ç¤º
    const lane = buildNumLaneDOM([
      {kind:'rule', img: imgRule(rule)},
      {kind:'num',  img: imgNumber(nums[0])},
      {kind:'num',  img: imgNumber(nums[1])},
    ]);
    lane.id = 'm9Row';
    mountLaneUnderItemsBar(lane);
  }
/* ã“ã“ã‹ã‚‰è¿½åŠ ï¼š#11 æ•°å€¤ã‚«ãƒ¼ãƒ‰1æšï¼ˆåŒæœŸè¡¨ç¤ºï¼‰ */
async function ensureM11MetaInit(vNow){
  const v = vNow || state.watching; if (!v) return;
  // æ—¢ã«ç”¨æ„æ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„ï¼åˆæœŸåŒ–ã¯ãƒ›ã‚¹ãƒˆã®ã¿
  if ((v?.meta?.m11_number|0) > 0) return;
  if (!state.isHost) return;

  // ã¾ã å ´ã«ä½¿ã‚ã‚Œã¦ã„ãªã„æ•°å­—ã‹ã‚‰1æšé¸ã¶ï¼ˆé‡è¤‡é˜²æ­¢ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’æ´»ç”¨ï¼‰
  const pick = (typeof pickUnusedNumbers === 'function')
    ? pickUnusedNumbers(1)[0]
    : MATERIALS.numbers[Math.random()*MATERIALS.numbers.length|0];

  await update(ref(db, `rooms/${state.roomCode}/meta`), { m11_number: pick });
}

function renderM11(v){
  const isM11 = ((v?.mission?.id|0) === 11);
  const rowId = 'm11Row';
  const old   = document.getElementById(rowId);
  if (!isM11){ if (old) old.remove(); return; }

  // åˆå›ï¼šãƒ›ã‚¹ãƒˆãŒ m11_number ã‚’ç”¨æ„ï¼ˆæœªç”¨æ„ãªã‚‰ç”¨æ„ã—ã¦æ¬¡ã®onValueã§æç”»ï¼‰
  if ((v?.meta?.m11_number|0) === 0){ ensureM11MetaInit(v); if (old) old.remove(); return; }

  if (old) old.remove();
  const lane = document.createElement('div');
  lane.id = rowId;
  lane.className = 'numlane';

  // æ•°å€¤ã‚«ãƒ¼ãƒ‰1æšã‚’é…ç½®ï¼ˆé‡è¤‡ç¦æ­¢ã®ç™»éŒ²ã¤ãï¼‰
  const N = v?.meta?.m11_number|0;
  if (typeof placeNumberCard === 'function'){
    placeNumberCard(N, lane);     // æ—¢å­˜UIç™»éŒ²ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  }else{
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãŒç„¡ã„å ´åˆï¼‰
    const holder = document.createElement('div');
    holder.className = 'numcard-holder';
    const nc = document.createElement('div');
    nc.className = 'numcard';
    nc.style.backgroundImage = `url('${imgNumber(N)}')`;
    holder.appendChild(nc);
    lane.appendChild(holder);
  }

  // DOMè¨­ç½®ï¼šã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ç›´ä¸‹ï¼ˆ#39ç­‰ã¨åŒã˜ï¼‰
  mountLaneUnderItemsBar(lane);
}

function renderM12(v){
  const isM12 = ((v?.mission?.id|0) === 12);
  const old = document.getElementById('m12UnderRow');
  if (!isM12){ if (old) old.remove(); return; }

  const itemsBar = document.getElementById('itemsBar');
  const items    = document.querySelectorAll('#items .item');
  const arr      = Array.isArray(v?.meta?.m12_under) ? v.meta.m12_under.slice(0, items.length) : null;

  // ã‚¢ã‚¤ãƒ†ãƒ ãŒã¾ã æç”»ã•ã‚Œã¦ã„ãªã„ï¼meta æœªæº–å‚™ã®ç¬é–“ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ¬¡ã® onValue ã§æç”»ï¼‰
  if (!itemsBar || items.length === 0 || !arr || arr.length < items.length) return;

  if (old) old.remove();

  const under = document.createElement('div');
  under.id = 'm12UnderRow';
  under.className = 'num-under';          // æ—¢å­˜CSSã€‚ã‚¢ã‚¤ãƒ†ãƒ å¤–å´ã®çœŸä¸‹ã«æ¨ªä¸¦ã³ã§é…ç½® :contentReference[oaicite:4]{index=4}

  arr.forEach(n=>{
    const slot   = document.createElement('div');
    slot.className = 'slot';

    const holder = document.createElement('div');  // æ—¢å­˜ã®ã‚«ãƒ¼ãƒ‰æ ï¼ˆé‡ã­è¡¨ç¾ã¨æ•´åˆï¼‰
    holder.className = 'numcard-holder';           // :contentReference[oaicite:5]{index=5}

    const card   = document.createElement('div');
    card.className = 'numcard';
    card.style.backgroundImage = `url('${imgNumber(n)}')`;

    holder.appendChild(card);
    slot.appendChild(holder);
    under.appendChild(slot);

    // ä»–ã®ãƒ¬ãƒ¼ãƒ³ã¨åŒã˜ãƒ¦ãƒ‹ãƒ¼ã‚¯ç®¡ç†ã«åˆã‚ã›ã‚‹ï¼ˆåŒæ•°ã®å¤šé‡è¡¨ç¤ºã‚’é¿ã‘ã‚‹ä»•æ§˜ï¼‰
    NUMCARD_REG.set(n, holder);                    // :contentReference[oaicite:6]{index=6}
  });

  itemsBar.insertAdjacentElement('afterend', under); // æ—¢å­˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ç›¸å½“ã®æŒ¿å…¥ä½ç½® :contentReference[oaicite:7]{index=7}
}

/* ===== #23ï¼šæ•°å€¤1æš å›ºå®šè¡¨ç¤º + å³å´ã«ã‚¢ã‚¤ãƒ†ãƒ å±±æœ­ï¼ˆåŒæœŸï¼‰ ===== */
async function ensureM23NumberInit(vNow){
  const v = vNow || state.watching; if(!v) return;
  if (v?.mission?.id !== 23) return;
  const has = (v.meta && (v.meta.m23_number|0) > 0);
  if (has) return;
  if (!state.isHost) return; // åˆæœŸåŒ–ã¯ãƒ›ã‚¹ãƒˆã®ã¿
  const n = MATERIALS.numbers[(Math.random()*MATERIALS.numbers.length)|0] | 0; // 1..12
  await update(ref(db, `rooms/${state.roomCode}/meta`), { m23_number: n });
}

function renderM23(v){
  const isM23 = ((v?.mission?.id|0) === 23);
  const rowId = 'm23Row';
  const old = document.getElementById(rowId);
  if (!isM23){ if (old) old.remove(); return; }

  // æ•°å€¤ï¼†ã‚¢ã‚¤ãƒ†ãƒ å±±ã®ãƒ¡ã‚¿ãŒæœªæº–å‚™ãªã‚‰ãƒ›ã‚¹ãƒˆãŒæº–å‚™ã—ã¦æ¬¡tickã¸
  if (!((v?.meta?.m23_number|0) > 0)) { ensureM23NumberInit(v); if (old) old.remove(); return; }
  if (!Array.isArray(v?.meta?.m23_deck)) { ensureM23MetaInit().then(()=>{}); if (old) old.remove(); return; }

  if (old) old.remove();
  const lane = document.createElement('div');
  lane.id = rowId;
  lane.className = 'numlane';

  // å·¦ï¼šæ•°å€¤1æšã‚’å›ºå®šè¡¨ç¤ºï¼ˆå…¨å“¡ã«åŒæœŸï¼‰
  const N = v?.meta?.m23_number|0;
  if (N){
    const nc = document.createElement('div');
   nc.className = 'numcard';
    nc.style.backgroundImage = `url('${imgNumber(N)}')`;
    lane.appendChild(nc);
  }

  // å³ï¼šã‚¢ã‚¤ãƒ†ãƒ å±±æœ­UIï¼ˆâ€»åºƒã’æ¸ˆã¿ã¯è¡¨ç¤ºã—ãªã„ï¼‰
  if (!(v?.meta?.m23_spread)) {
    attachM23DeckUI(lane);
  }
  // ã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ç›´ä¸‹ã«è¨­ç½®ï¼ˆ#39ç­‰ã¨åŒã˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼‰
 mountLaneUnderItemsBar(lane);
}  
 
/* ===== â˜… #23ï¼šã‚¢ã‚¤ãƒ†ãƒ å±±ï¼ˆ7æšï¼‰ã‚’æ•°å€¤å±±ãƒ¬ãƒ¼ãƒ³ã®å³å´ã«è¡¨ç¤º ===== */
async function ensureM23MetaInit(){
  const v = state.watching; if(!v) return;
  if (Array.isArray(v?.meta?.m23_deck)) return; // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿
  const pool = itemDeckNumbers(v?.mission?.id || 23).slice(); // 1..13 or 1..12
  shuffle(pool);
  const seven = pool.slice(0,7);
  await update(ref(db, `rooms/${state.roomCode}/meta`), {
    m23_deck: seven,        // å±±æœ­ï¼ˆç•ªå·é…åˆ—ï¼‰
   m23_discards: [],       // æ¨ã¦æœ­
    m23_spread: false,      // åºƒã’ãŸã‹ï¼Ÿ
    m23_drawnNumbers: []    // æ•°å€¤å±±ã§è¡¨ã«ãªã£ãŸæ•°å€¤
  });
}

  /* ===== #18ï¼šæ•°å€¤ã‚«ãƒ¼ãƒ‰å±±æœ­ï¼ˆåŒæœŸè¡¨ç¤ºï¼‰ ===== */
  async function ensureM18MetaInit(vNow){
    const v = vNow || state.watching; if (!v) return;
   if (Array.isArray(v?.meta?.m18_deck)) return;        // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿
    if (!state.isHost) return;                            // åˆæœŸåŒ–ã¯ãƒ›ã‚¹ãƒˆã®ã¿
    const deck = MATERIALS.numbers.slice(); shuffle(deck); // 1..12 ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    await update(ref(db, `rooms/${state.roomCode}/meta`), {
      m18_deck: deck,
      m18_discards: []
   });
  }

 function renderM18(v){
   const isM18 = ((v?.mission?.id|0) === 18);
    const rowId = 'm18Row';
   const old = document.getElementById(rowId);
    if (!isM18){ if (old) old.remove(); return; }
    // åˆå›ã®ã¿ãƒ›ã‚¹ãƒˆãŒãƒ¡ã‚¿ã‚’æº–å‚™ï¼ˆæœªç”¨æ„ãªã‚‰ç”¨æ„ã—ã¦æ¬¡ã®onValueã§æç”»ï¼‰
    if (!Array.isArray(v?.meta?.m18_deck)) { ensureM18MetaInit(v); if (old) old.remove(); return; }

    if (old) old.remove();
    const lane = document.createElement('div');
    lane.id = rowId;
    lane.className = 'numlane';

    // å±±æœ­ï¼ˆæ•°å€¤ï¼‰ãƒœã‚¿ãƒ³ã¨æ®‹æšæ•°
   const deckBtn = document.createElement('div');
   deckBtn.className = 'numdeck';
  deckBtn.title = 'ã‚ãã‚‹';

    const restLbl = document.createElement('span');
   restLbl.className = 'numrest';
   // å…¬é–‹æœ­ã®ç©ã¿é‡ã­
    const pile = document.createElement('div');
    pile.className = 'numcard-holder';
   pile.style.position = 'relative';
   lane.appendChild(deckBtn);
    lane.appendChild(restLbl);
    lane.appendChild(pile);

    const refresh = ()=>{
      const d = (v?.meta?.m18_deck||[]);
      const x = (v?.meta?.m18_discards||[]);
      const remain = d.filter(n=>!x.includes(n)).length;
      restLbl.textContent = `æ®‹:${remain}`;
      pile.innerHTML = '';
      x.forEach((n, i)=>{
       const node = document.createElement('div');
        node.className = 'numcard';
        node.style.backgroundImage = `url('${imgNumber(n)}')`;
        if (i>0){
         const off = i*2;
         node.style.position='absolute';
          node.style.left = off+'px';
          node.style.top  = off+'px';
        }
        pile.appendChild(node);
        const extra = i*2;
        pile.style.height = (48+extra)+'px';
      lane.style.marginBottom = extra+'px';
     });
    };
    refresh();

    // 1æšã‚ãã£ã¦å…¬é–‹æœ­ã¸ â†’ DB(meta.m18_discards) ã‚’æ›´æ–°ï¼ˆå…¨å“¡ã«å³åŒæœŸï¼‰
deckBtn.onclick = async (ev)=>{
  try{
    const mRef = ref(db, `rooms/${state.roomCode}/meta`);
    const mSnap = await get(mRef);
    const meta  = mSnap.val()||{};
    const D = Array.isArray(meta.m18_deck) ? meta.m18_deck.slice() : [];
    const Xs = Array.isArray(meta.m18_discards) ? meta.m18_discards.slice() : [];

    const next = D.find(n=> !Xs.includes(n)); // å±±æœ­é †ã§æ¬¡
    if (next==null){
      openOneMini(ev.clientX, ev.clientY, 'å±±æœ­ã‚’ä½œã‚Šç›´ã™', async ()=>{
        const newDeck = MATERIALS.numbers.slice(); shuffle(newDeck);
        await update(mRef, { m18_deck: newDeck, m18_discards: [] });
      });
      return;
    }
    Xs.push(next);
    await update(mRef, { m18_discards: Xs });
  }catch(e){ console.error(e); }
};


    // ã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ç›´ä¸‹ã«è¨­ç½®ï¼ˆæ—¢å­˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ä½¿ç”¨ï¼‰
    mountLaneUnderItemsBar(lane);
  }

   function renderM30Audio(v){
     const isM30 = ((v?.mission?.id|0) === 30);
     const barId = 'm30AudioBar';
     const audioId = 'm30Audio';
     const oldBar = document.getElementById(barId);
     if (!isM30){ if (oldBar) oldBar.remove(); return; }

  let audio = document.getElementById(audioId);
  if (!audio){
    audio = document.createElement('audio');
    audio.id = audioId;
    audio.preload = 'auto';
    audio.src = './mi30.mp3';
    audio.crossOrigin = 'anonymous';
    audio.style.display = 'none';
    audio.setAttribute('playsinline', '');
    audio.setAttribute('webkit-playsinline', '');
    audio.playsInline = true;
    document.body.appendChild(audio);
  }

     if (state.isHost){
       if (oldBar) oldBar.remove();
       const bar = document.createElement('div');
       bar.id = barId;
       bar.className = 'line';
       bar.innerHTML = `
         <button class="btn small" id="m30Back10">âª 10ç§’</button>
         <button class="btn small" id="m30Play">â–¶</button>
         <button class="btn small" id="m30Pause">â¸</button>
         <input id="m30Seek" type="range" min="0" max="0" value="0" step="0.1" style="vertical-align:middle; width:240px; margin:0 8px;">
         <span id="m30Time">0:00</span>
       `;
       const footer = document.getElementById('missionFooter');
       if (footer && !footer.classList.contains('hidden')) {
         footer.appendChild(bar);
       }

       const btnBack = document.getElementById('m30Back10');
       const btnPlay = document.getElementById('m30Play');
       const btnPause= document.getElementById('m30Pause');
       const seek    = document.getElementById('m30Seek');
       const timeLbl = document.getElementById('m30Time');

       const fmt = (t)=> {
         const s = Math.max(0, Math.floor(t|0));
         const m = (s/60)|0; const r = s%60;
         return `${m}:${String(r).padStart(2,'0')}`;
       };
       const writeMeta = async (playing)=>{
         const payload = {
           m30_audio: {
             playing: !!playing,
             t: audio.currentTime||0,
      at: serverNow()             }
         };
         await update(ref(db, `rooms/${state.roomCode}/meta`), payload);
       };
       const refreshDur = ()=>{
         const dur = isFinite(audio.duration) ? Math.max(0, audio.duration) : 0;
         seek.max = String(dur || 0);
       };
       if (isNaN(audio.duration) || !isFinite(audio.duration)){
         audio.addEventListener('loadedmetadata', refreshDur, { once:true });
       } else {
         refreshDur();
       }
       const refreshLocal = ()=>{
         timeLbl.textContent = fmt(audio.currentTime||0);
         if (!document.activeElement || document.activeElement !== seek){
           seek.value = String(audio.currentTime||0);
         }
       };
       refreshLocal();
       audio.addEventListener('timeupdate', refreshLocal);

       btnPlay.onclick = async ()=>{
         try{ await audio.play(); }catch(_e){}
         await writeMeta(true);
       };
       btnPause.onclick = async ()=>{
         try{ audio.pause(); }catch(_e){}
         await writeMeta(false);
       };
       btnBack.onclick = async ()=>{
         audio.currentTime = Math.max(0, (audio.currentTime||0) - 10);
         await writeMeta(!audio.paused);
       };
       seek.oninput = ()=>{ timeLbl.textContent = fmt(Number(seek.value||'0')); };
       seek.onchange = async ()=>{
         audio.currentTime = Number(seek.value||'0');
         await writeMeta(!audio.paused);
       };
     } else {
       if (oldBar) oldBar.remove();
     }

     // â–¼ ãƒ›ã‚¹ãƒˆä»¥å¤–ã‚‚ meta ã‚’è¦‹ã¦è¿½å¾“ï¼ˆ#19 ã¨åŒä»•æ§˜ï¼‰
     const data = v?.meta?.m30_audio || null;
     if (data){
  const elapsed = Math.max(0, (serverNow() - (data.at||0)) / 1000); // â†ç½®æ›
       const target = Math.max(0, (data.t||0) + (data.playing ? elapsed : 0));
       if (Math.abs((audio.currentTime||0) - target) > 0.5){
         audio.currentTime = target;
       }
       if (data.playing && audio.paused){
         audio.play().catch(()=>{
           if (!document.getElementById('m30Unlock')){
             const div = document.createElement('div');
             div.id = 'm30Unlock';
             div.className = 'mini-pop bottom-pop';
             div.innerHTML = `<button class="btn small">éŸ³å£°ã‚’æœ‰åŠ¹åŒ–ï¼ˆãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ï¼‰</button>`;
             div.onclick = async ()=>{
               try{ await audio.play(); }catch(_e){}
               div.remove();
             };
             document.getElementById('popLayer')?.appendChild(div);
           }
         });
       }
       if (!data.playing && !audio.paused){
        audio.pause();
       }
     }
   }







function renderSfx(v){
  const data = v?.meta?.sfx || null;
  if (!data || data.name !== 'countdown') return;

  const audio = getCountdownAudio();

  if (!state._sfxHandled) state._sfxHandled = {};
  const key = String(data.nonce || data.at || '');
  if (state._sfxHandled[key]) return;
  state._sfxHandled = { [key]: true };

  if (state._sfxJustPlayedAt && Date.now() - state._sfxJustPlayedAt <= 500) {
    return;
  }

  try{
    audio.currentTime = 0;
    audio.play().catch(()=>{
      if (!document.getElementById('sfxUnlock')){
        const div = document.createElement('div');
        div.id = 'sfxUnlock';
        div.className = 'mini-pop bottom-pop';
        div.innerHTML = `<button class="btn small">éŸ³å£°ã‚’æœ‰åŠ¹åŒ–ï¼ˆãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ï¼‰</button>`;
        div.onclick = async ()=>{
          try{ await audio.play(); }catch(_e){}
          div.remove();
        };
        document.getElementById('popLayer')?.appendChild(div);
      }
    });
  }catch(_e){}
}

   function renderM19(v){
     const isM19 = ((v?.mission?.id|0) === 19);
     const barId = 'm19AudioBar';
     const audioId = 'm19Audio';
     const oldBar = document.getElementById(barId);
     if (!isM19){ if (oldBar) oldBar.remove(); return; }

     let audio = document.getElementById(audioId);
     if (!audio){
       audio = document.createElement('audio');
       audio.id = audioId;
       audio.preload = 'auto';
       audio.src = './mi19.mp3';
       audio.crossOrigin = 'anonymous';
       audio.style.display = 'none';
       document.body.appendChild(audio);
     }

     if (state.isHost){
       if (oldBar) oldBar.remove();
       const bar = document.createElement('div');
       bar.id = barId;
       bar.className = 'line';
       bar.innerHTML = `
         <button class="btn small" id="m19Back10">âª 10ç§’</button>
         <button class="btn small" id="m19Play">â–¶</button>
         <button class="btn small" id="m19Pause">â¸</button>
         <input id="m19Seek" type="range" min="0" max="0" value="0" step="0.1" style="vertical-align:middle; width:240px; margin:0 8px;">
         <span id="m19Time">0:00</span>
       `;
       const footer = document.getElementById('missionFooter');
       if (footer && !footer.classList.contains('hidden')) {
         footer.appendChild(bar);
       }

       const btnBack = document.getElementById('m19Back10');
       const btnPlay = document.getElementById('m19Play');
       const btnPause= document.getElementById('m19Pause');
       const seek    = document.getElementById('m19Seek');
       const timeLbl = document.getElementById('m19Time');

       const fmt = (t)=> {
         const s = Math.max(0, Math.floor(t|0));
         const m = (s/60)|0; const r = s%60;
         return `${m}:${String(r).padStart(2,'0')}`;
       };
       const writeMeta = async (playing)=>{
         const payload = {
           m19_audio: {
             playing: !!playing,
             t: audio.currentTime||0,
      at: serverNow()  
           }
         };
         await update(ref(db, `rooms/${state.roomCode}/meta`), payload);
       };
       const refreshDur = ()=>{
         const dur = isFinite(audio.duration) ? Math.max(0, audio.duration) : 0;
         seek.max = String(dur || 0);
       };
       if (isNaN(audio.duration) || !isFinite(audio.duration)){
         audio.addEventListener('loadedmetadata', refreshDur, { once:true });
       } else {
         refreshDur();
       }
       const refreshLocal = ()=>{
         timeLbl.textContent = fmt(audio.currentTime||0);
         if (!document.activeElement || document.activeElement !== seek){
           seek.value = String(audio.currentTime||0);
         }
       };
       refreshLocal();
       audio.addEventListener('timeupdate', refreshLocal);

       btnPlay.onclick = async ()=>{
         try{ await audio.play(); }catch(_e){}
         await writeMeta(true);
       };
       btnPause.onclick = async ()=>{
         try{ audio.pause(); }catch(_e){}
         await writeMeta(false);
       };
       btnBack.onclick = async ()=>{
         audio.currentTime = Math.max(0, (audio.currentTime||0) - 10);
         await writeMeta(!audio.paused);
       };
       seek.oninput = ()=>{ timeLbl.textContent = fmt(Number(seek.value||'0')); };
       seek.onchange = async ()=>{
         audio.currentTime = Number(seek.value||'0');
         await writeMeta(!audio.paused);
       };
     } else {
       if (oldBar) oldBar.remove();
     }

     
     const data = v?.meta?.m19_audio || null;
     if (data){
const elapsed = Math.max(0, (serverNow() - (data.at||0)) / 1000); // â†ç½®æ›
       const target = Math.max(0, (data.t||0) + (data.playing ? elapsed : 0));
       if (Math.abs((audio.currentTime||0) - target) > 0.5){
         audio.currentTime = target;
       }
       if (data.playing && audio.paused){
         audio.play().catch(()=>{
           if (!document.getElementById('m19Unlock')){
             const div = document.createElement('div');
             div.id = 'm19Unlock';
             div.className = 'mini-pop bottom-pop';
             div.innerHTML = `<button class="btn small">éŸ³å£°ã‚’æœ‰åŠ¹åŒ–ï¼ˆãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ï¼‰</button>`;
             div.onclick = async ()=>{
               try{ await audio.play(); }catch(_e){}
               div.remove();
             };
             document.getElementById('popLayer')?.appendChild(div);
           }
         });
       }
       if (!data.playing && !audio.paused){
         audio.pause();
       }
     }
   }
  
function renderM42Audio(v){
  const isM42 = ((v?.mission?.id|0) === 42);
  const barId = 'm42AudioBar';
  const audioId = 'm42Audio';
  const oldBar = document.getElementById(barId);
  if (!isM42){ if (oldBar) oldBar.remove(); return; }

  // Audioè¦ç´ ã®ç”¨æ„ï¼ˆmi42.mp3ï¼‰
  let audio = document.getElementById(audioId);
  if (!audio){
    audio = document.createElement('audio');
    audio.id = audioId;
    audio.preload = 'auto';
    audio.src = './mi42.mp3';
    audio.crossOrigin = 'anonymous';
    audio.style.display = 'none';
    audio.setAttribute('playsinline', '');
    audio.setAttribute('webkit-playsinline', '');
    audio.playsInline = true;
    document.body.appendChild(audio);
  }

  if (state.isHost){
    if (oldBar) oldBar.remove();
    const bar = document.createElement('div');
    bar.id = barId;
    bar.className = 'line';
    bar.innerHTML = `
      <button class="btn small" id="m42Back10">âª 10ç§’</button>
      <button class="btn small" id="m42Play">â–¶</button>
      <button class="btn small" id="m42Pause">â¸</button>
      <input id="m42Seek" type="range" min="0" max="0" value="0" step="0.1" style="vertical-align:middle; width:240px; margin:0 8px;">
      <span id="m42Time">0:00</span>
    `;
    const footer = document.getElementById('missionFooter');
    if (footer && !footer.classList.contains('hidden')) {
      footer.appendChild(bar);
    }

    const btnBack = document.getElementById('m42Back10');
    const btnPlay = document.getElementById('m42Play');
    const btnPause= document.getElementById('m42Pause');
    const seek    = document.getElementById('m42Seek');
    const timeLbl = document.getElementById('m42Time');

    const fmt = (t)=> {
      const s = Math.max(0, Math.floor(t|0));
      const m = (s/60)|0; const r = s%60;
      return `${m}:${String(r).padStart(2,'0')}`;
    };

    const writeMeta = async (playing)=>{
      const payload = {
        m42_audio: {
          playing: !!playing,
          t: audio.currentTime||0,
          at: serverNow()
        }
      };
      await update(ref(db, `rooms/${state.roomCode}/meta`), payload);
    };

    const refreshDur = ()=>{
      const dur = isFinite(audio.duration) ? Math.max(0, audio.duration) : 0;
      seek.max = String(dur || 0);
    };
    if (isNaN(audio.duration) || !isFinite(audio.duration)){
      audio.addEventListener('loadedmetadata', refreshDur, { once:true });
    } else {
      refreshDur();
    }

    const refreshLocal = ()=>{
      timeLbl.textContent = fmt(audio.currentTime||0);
      if (!document.activeElement || document.activeElement !== seek){
        seek.value = String(audio.currentTime||0);
      }
    };
    refreshLocal();
    audio.addEventListener('timeupdate', refreshLocal);

    btnPlay.onclick = async ()=>{
      try{ await audio.play(); }catch(_e){}
      await writeMeta(true);
    };
    btnPause.onclick = async ()=>{
      try{ audio.pause(); }catch(_e){}
      await writeMeta(false);
    };
    btnBack.onclick = async ()=>{
      audio.currentTime = Math.max(0, (audio.currentTime||0) - 10);
      await writeMeta(!audio.paused);
    };
    seek.oninput = ()=>{ timeLbl.textContent = fmt(Number(seek.value||'0')); };
    seek.onchange = async ()=>{
      audio.currentTime = Number(seek.value||'0');
      await writeMeta(!audio.paused);
    };
  } else {
    if (oldBar) oldBar.remove();
  }

  // éãƒ›ã‚¹ãƒˆå´ã¯ meta ã‚’è¦‹ã¦è¿½å¾“ï¼ˆ#30/#19 ã¨åŒã˜ä»•çµ„ã¿ï¼‰
  const data = v?.meta?.m42_audio || null;
  if (data){
    const elapsed = Math.max(0, (serverNow() - (data.at||0)) / 1000);
    const target = Math.max(0, (data.t||0) + (data.playing ? elapsed : 0));
    if (Math.abs((audio.currentTime||0) - target) > 0.5){
      audio.currentTime = target;
    }
    if (data.playing && audio.paused){
      audio.play().catch(()=>{
        if (!document.getElementById('m42Unlock')){
          const div = document.createElement('div');
          div.id = 'm42Unlock';
          div.className = 'mini-pop bottom-pop';
          div.innerHTML = `<button class="btn small">éŸ³å£°ã‚’æœ‰åŠ¹åŒ–ï¼ˆãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ï¼‰</button>`;
          div.onclick = async ()=>{
            try{ await audio.play(); }catch(_e){}
            div.remove();
          };
          document.getElementById('popLayer')?.appendChild(div);
        }
      });
    }
    if (!data.playing && !audio.paused){
      audio.pause();
    }
  }
}



/* ===== #15ï¼šæ•°å€¤ã‚«ãƒ¼ãƒ‰å±±æœ­ï¼ˆåŒæœŸè¡¨ç¤ºï½œ#39/#18ã«æº–æ‹ ï¼‰ ===== */
async function ensureM15MetaInit(vNow){
  const v = vNow || state.watching; if (!v) return;
  if (Array.isArray(v?.meta?.m15_deck)) return;   // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿
  if (!state.isHost) return;                       // åˆæœŸåŒ–ã¯ãƒ›ã‚¹ãƒˆã®ã¿
  const deck = MATERIALS.numbers.slice(); shuffle(deck); // 1..12 ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  await update(ref(db, `rooms/${state.roomCode}/meta`), {
    m15_deck: deck,
    m15_discards: []
  });
}

function renderM15(v){
 const mid   = (v?.mission?.id|0);
  const isM15 = (mid === 15 || mid === 45 || mid === 51); // â† #45ã§ã‚‚å‹•ã‹ã™
  const rowId = 'm15Row';
  const old   = document.getElementById(rowId);
  if (!isM15){ if (old) old.remove(); return; }
  // åˆå›ã®ã¿ãƒ›ã‚¹ãƒˆãŒãƒ¡ã‚¿ã‚’æº–å‚™ï¼ˆæœªç”¨æ„ãªã‚‰ç”¨æ„ã—ã¦æ¬¡ã®onValueã§æç”»ï¼‰
  if (!Array.isArray(v?.meta?.m15_deck)) { ensureM15MetaInit(v); if (old) old.remove(); return; }

  if (old) old.remove();
  const lane = document.createElement('div');
  lane.id = rowId;
  lane.className = 'numlane';

  // å±±æœ­ï¼ˆæ•°å€¤ï¼‰ãƒœã‚¿ãƒ³ã¨æ®‹æšæ•°
  const deckBtn = document.createElement('div');
  deckBtn.className = 'numdeck';
  deckBtn.title = 'ã‚ãã‚‹';

  const restLbl = document.createElement('span');
  restLbl.className = 'numrest';

  // å…¬é–‹æœ­ã®ç©ã¿é‡ã­
  const pile = document.createElement('div');
  pile.className = 'numcard-holder';
  pile.style.position = 'relative';

  lane.appendChild(deckBtn);
  lane.appendChild(restLbl);
  lane.appendChild(pile);

  const refresh = ()=>{
    const d = (v?.meta?.m15_deck||[]);
    const x = (v?.meta?.m15_discards||[]);
    const remain = d.filter(n=>!x.includes(n)).length;
    restLbl.textContent = `æ®‹:${remain}`;

    pile.innerHTML = '';
    x.forEach((n, i)=>{
      const node = document.createElement('div');
      node.className = 'numcard';
      node.style.backgroundImage = `url('${imgNumber(n)}')`;
      if (i>0){
        const off = i*2;
        node.style.position='absolute';
        node.style.left = off+'px';
        node.style.top  = off+'px';
      }
      pile.appendChild(node);
      const extra = i*2;
      pile.style.height = (48+extra)+'px';
      lane.style.marginBottom = extra+'px';
    });
  };
  refresh();

  // 1æšã‚ãã£ã¦å…¬é–‹æœ­ã¸ â†’ DB(meta.m15_discards) ã‚’æ›´æ–°ï¼ˆå…¨å“¡ã«å³åŒæœŸï¼‰
// 1æšã‚ãã‚‹ã€‚ç©ºãªã‚‰ã€Œå±±æœ­ã‚’ä½œã‚Šç›´ã™ã€ã‚¿ãƒ–ã‚’å‡ºã™ï¼ˆå…¨å“¡åŒæœŸï¼‰
deckBtn.onclick = async (ev)=>{
  try{
    const mRef = ref(db, `rooms/${state.roomCode}/meta`);
    const mSnap = await get(mRef);
    const meta  = mSnap.val()||{};
    const D = Array.isArray(meta.m15_deck) ? meta.m15_deck.slice() : [];
    const Xs = Array.isArray(meta.m15_discards) ? meta.m15_discards.slice() : [];

    const next = D.find(n=> !Xs.includes(n)); // å±±æœ­é †ã§æ¬¡
    if (next==null){
      // å±±æœ­åˆ‡ã‚Œ â†’ ä½œã‚Šç›´ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼
      openOneMini(ev.clientX, ev.clientY, 'å±±æœ­ã‚’ä½œã‚Šç›´ã™', async ()=>{
        const newDeck = MATERIALS.numbers.slice(); shuffle(newDeck);
        await update(mRef, { m15_deck: newDeck, m15_discards: [] });
      });
      return;
    }
    Xs.push(next);
    await update(mRef, { m15_discards: Xs });
  }catch(e){ console.error(e); }
};


  // DOMè¨­ç½®ï¼šã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ç›´ä¸‹
  mountLaneUnderItemsBar(lane);
}


/* ===== #30ï¼šæ•°å€¤ã‚«ãƒ¼ãƒ‰å±±æœ­ï¼ˆåŒæœŸï¼‰â”€ 1/2/3æšãƒãƒƒãƒ—å¯¾å¿œ ===== */
async function ensureM30MetaInit(vNow){
  const v = vNow || state.watching; if (!v) return;
  if (((v?.mission?.id|0) !== 30)) return;
  if (Array.isArray(v?.meta?.m30_deck)) return;  // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿
  if (!state.isHost) return;                      // åˆæœŸåŒ–ã¯ãƒ›ã‚¹ãƒˆã®ã¿
  const deck = MATERIALS.numbers.slice(); shuffle(deck); // 1..12 ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  await update(ref(db, `rooms/${state.roomCode}/meta`), {
    m30_deck: deck,       // å±±æœ­é †
    m30_used: [],         // å±±æœ­ã‹ã‚‰ä½¿ç”¨æ¸ˆã¿ï¼ˆ1/2/3ã„ãšã‚Œã‚‚ã“ã“ã«ç©ã‚€ï¼‰
    m30_pile: [],         // 1æšãƒ‰ãƒ­ãƒ¼åˆ†ï¼ˆå³ã®å…¬é–‹æœ­ã«ç©ã¿é‡ã­è¡¨ç¤ºï¼‰
    m30_row:  []          // 2æš or 3æšãƒ‰ãƒ­ãƒ¼ã®â€œæ¨ªä¸¦ã³è¡¨ç¤ºâ€ã®ç¾è¡Œã‚»ãƒƒãƒˆ
  });
}

function renderM30(v){
  const isM30 = ((v?.mission?.id|0) === 30);
  const rowId = 'm30Row';
  const old   = document.getElementById(rowId);
  if (!isM30){ if (old) old.remove(); return; }

  // åˆå›ï¼šãƒ›ã‚¹ãƒˆãŒ meta ã‚’ç”¨æ„ï¼ˆæœªç”¨æ„ãªã‚‰ç”¨æ„ã—ã¦æ¬¡ã® onValue ã§æç”»ï¼‰
  if (!Array.isArray(v?.meta?.m30_deck)){ ensureM30MetaInit(v); if (old) old.remove(); return; }

  if (old) old.remove();
  const lane = document.createElement('div');
  lane.id = rowId;
  lane.className = 'numlane';

  // å±±æœ­ãƒœã‚¿ãƒ³ + æ®‹è¡¨ç¤º
  const deckBtn = document.createElement('div');
  deckBtn.className = 'numdeck';
  deckBtn.title = 'ã‚ãã‚‹';

  const restLbl = document.createElement('span');
  restLbl.className = 'numrest';

  // å³ï¼š1æšãƒ‰ãƒ­ãƒ¼ã®å…¬é–‹æœ­ï¼ˆç©ã¿é‡ã­ï¼‰
  const pile = document.createElement('div');
  pile.className = 'numcard-holder';
  pile.style.position = 'relative';

  // ä¸‹ï¼š2/3æšãƒ‰ãƒ­ãƒ¼ã®æ¨ªä¸¦ã³
  const row = document.createElement('div');
  row.style.display = 'flex';
  row.style.gap = '6px';

  lane.appendChild(deckBtn);
  lane.appendChild(restLbl);
  lane.appendChild(pile);
  lane.appendChild(row);

  // æç”»ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆ#15/#39ã¨åŒã˜ç©ã¿é‡ã­ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ 
  const refresh = ()=>{
    const d = (v?.meta?.m30_deck||[]);
    const used = (v?.meta?.m30_used||[]);
    const remain = d.filter(n => !used.includes(n)).length;
    restLbl.textContent = `æ®‹:${remain}`;

    // å³å´ï¼š1æšå…¬é–‹æœ­ã®ç©ã¿é‡ã­ï¼ˆ2pxã‚ªãƒ•ã‚»ãƒƒãƒˆï¼‰
    pile.innerHTML = '';
    const xs = (v?.meta?.m30_pile||[]);
    xs.forEach((n,i)=>{
      const node = document.createElement('div');
      node.className = 'numcard';
      node.style.backgroundImage = `url('${imgNumber(n)}')`;
      if (i>0){
        const off = i*2;
        node.style.position='absolute';
        node.style.left = off+'px';
        node.style.top  = off+'px';
      }
      pile.appendChild(node);
      const extra = i*2;
      pile.style.height = (48+extra)+'px';
      lane.style.marginBottom = extra+'px';
    });

    // ä¸‹æ®µï¼š2/3ãƒ‰ãƒ­ãƒ¼ã®æ¨ªä¸¦ã³
    row.innerHTML = '';
    (v?.meta?.m30_row||[]).forEach(n=>{
      const nc = document.createElement('div');
      nc.className = 'numcard';
      nc.style.backgroundImage = `url('${imgNumber(n)}')`;
      row.appendChild(nc);
    });
  };
  refresh();

  // ã‚¯ãƒªãƒƒã‚¯ã§ 1/2/3 ã‚’é¸ã¶ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯æ—¢å­˜ã® openMenu ã‚’ä½¿ç”¨ï¼‰
  deckBtn.onclick = (ev)=>{
    const d = (v?.meta?.m30_deck||[]);
    const used = (v?.meta?.m30_used||[]);
    const remain = d.filter(n => !used.includes(n)).length;

    const make = (k)=> async ()=>{
      try{
        const mRef = ref(db, `rooms/${state.roomCode}/meta`);
        const mSnap = await get(mRef);
        const meta  = mSnap.val()||{};
        const D = Array.isArray(meta.m30_deck) ? meta.m30_deck.slice() : [];
        const U = Array.isArray(meta.m30_used) ? meta.m30_used.slice() : [];
        const P = Array.isArray(meta.m30_pile) ? meta.m30_pile.slice() : [];
        // å±±æœ­é †ã‹ã‚‰æœªä½¿ç”¨ã‚’ k æšå–å¾—
        const pick = [];
        for (const n of D){
          if (!U.includes(n)){ pick.push(n); if (pick.length===k) break; }
        }
        if (pick.length < k) return; // è¶³ã‚Šãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„

          // â˜… ä»¥å‰ã®æŒ™å‹•ã«åˆã‚ã›ã‚‹ï¼šå¸¸ã«ã€Œ1æšç›®â†’å³ã«ç©ã‚€ã€ã€Œæ®‹ã‚Šâ†’ä¸‹æ®µã€
        const first = pick[0];
        const rest  = pick.slice(1);
            // â˜… å¸¸ã«â€œæœ€æ–°ã®ã¿å¯è¦–åŒ–â€ï¼šå‰å›è¡¨ç¤ºã¯æ¶ˆã—ã€ä»Šå›åˆ†ã ã‘ã‚’ä¿å­˜
        const patch = {
          m30_used: U.concat(pick),  // ä½¿ç”¨å±¥æ­´ã¯è“„ç©
          m30_pile: [first],         // å³ã®å…¬é–‹æœ­ã¯å¸¸ã«1æšã ã‘ï¼ˆä¸Šæ›¸ãï¼‰
          m30_row : rest             // ä¸‹æ®µã¯ä»Šå›ã®æ®‹ã‚Šã ã‘ï¼ˆç½®ãæ›ãˆï¼‰
        };
        await update(mRef, patch);
      }catch(e){ console.error(e); }
    };

    const rebuild = async ()=>{
      try{
        const deck = MATERIALS.numbers.slice(); shuffle(deck);
        await update(ref(db, `rooms/${state.roomCode}/meta`), {
          m30_deck: deck, m30_used: [], m30_pile: [], m30_row: []
        });
      }catch(e){ console.error(e); }
    };

    const menu = [];
    if (remain >= 1) menu.push({label:'1', action: make(1)});
    if (remain >= 2) menu.push({label:'2', action: make(2)});
    if (remain >= 3) menu.push({label:'3', action: make(3)});
    if (remain === 0) menu.push({label:'å±±æœ­ã‚’ä½œã‚Šç›´ã™', action: rebuild});
    openMenu(ev.clientX, ev.clientY, menu);
  };

  // DOMè¨­ç½®ï¼šã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ç›´ä¸‹ï¼ˆä»–ãƒŸãƒƒã‚·ãƒ§ãƒ³ã¨åŒã˜ï¼‰
  mountLaneUnderItemsBar(lane);
}

/* ã“ã“ã‹ã‚‰è¿½åŠ ï¼š#36 æ•°å€¤5æšï¼‹å·¦2/å³2ï¼ˆåŒæœŸè¡¨ç¤ºï¼‰ */
async function ensureM36MetaInit(vNow){
  const v = vNow || state.watching; if (!v) return;
  if (((v?.mission?.id|0) !== 36)) return;

  // æ•°å€¤5æšãŒæœªç¢ºå®šãªã‚‰ãƒ›ã‚¹ãƒˆãŒä¸€åº¦ã ã‘ç¢ºå®š
  if (!Array.isArray(v?.meta?.m36_numbers) || v.meta.m36_numbers.length !== 5){
    if (!state.isHost) return;
    const picks = (typeof pickUnusedNumbers === 'function')
      ? pickUnusedNumbers(5)
      : MATERIALS.numbers.slice().sort(()=>Math.random()-0.5).slice(0,5);

    await update(ref(db, `rooms/${state.roomCode}/meta`), {
      m36_numbers: picks,
      m36_side: null    // â† å·¦å³ã©ã¡ã‚‰ã‚‚ãƒ–ãƒ©ãƒ³ã‚¯ã§é–‹å§‹
    });
     await update(ref(db, `rooms/${state.roomCode}/meta`), {
       m36_numbers: picks,
       m36_side: null,   // â† å·¦å³ã©ã¡ã‚‰ã‚‚ãƒ–ãƒ©ãƒ³ã‚¯ã§é–‹å§‹
       m36_faceDown: []  // â† è¿½åŠ ï¼šè£å‘ãã«ã—ã¦ã„ã‚‹æ•°å€¤ã®ãƒªã‚¹ãƒˆï¼ˆåŒæœŸï¼‰
     });
    return;
  }

  // æ•°å€¤ã¯ç¢ºå®šæ¸ˆã¿ã ãŒ m36_side ãŒæœªå®šç¾©ãªã‚‰è£œå®Œï¼ˆãƒ›ã‚¹ãƒˆã®ã¿ï¼‰
  if (typeof v?.meta?.m36_side === 'undefined' && state.isHost){
    await update(ref(db, `rooms/${state.roomCode}/meta`), { m36_side: null });
  }
}

function renderM36(v){
  const isM36 = ((v?.mission?.id|0) === 36);
  const rowId = 'm36Row';
  const old   = document.getElementById(rowId);
  if (!isM36){ if (old) old.remove(); return; }

  const nums = Array.isArray(v?.meta?.m36_numbers) ? v.meta.m36_numbers : null;
  if (!nums || nums.length < 5){ ensureM36MetaInit(v); if (old) old.remove(); return; }

  if (old) old.remove();

  // ãƒ¬ãƒ¼ãƒ³ï¼ˆåœŸå°ï¼‰
  const lane = document.createElement('div');
  lane.id = rowId;
  lane.className = 'numlane';

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼šã‚«ãƒ¼ãƒ‰DOMï¼ˆèƒŒæ™¯æœªæŒ‡å®šï¼ãƒ–ãƒ©ãƒ³ã‚¯ï¼‰
  const mkCard = (imgUrl)=>{
    const d = document.createElement('div');
    d.className = 'numcard';
    if (imgUrl) d.style.backgroundImage = `url('${imgUrl}')`;
    return d;
  };

  // å·¦ãƒ–ãƒ©ãƒ³ã‚¯ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å·¦ã« right2ï¼‰
  const leftSlot = mkCard(null);
  leftSlot.classList.add('m36-slot','m36-left');
  leftSlot.title = 'ã‚¯ãƒªãƒƒã‚¯ã§å³2ã‚’è¡¨ç¤º';
  leftSlot.classList.remove('numcard');
  leftSlot.classList.add('rulecard');
  leftSlot.onclick = async (ev)=>{
    ev.stopPropagation();
    await update(ref(db, `rooms/${state.roomCode}/meta`), { m36_side: 'L' });
  };

  // æ•°å€¤5æšï¼ˆä¸­å¤®ï¼‰
  const n0 = mkCard(imgNumber(nums[0]));
  const n1 = mkCard(imgNumber(nums[1]));
  const n2 = mkCard(imgNumber(nums[2]));
  const n3 = mkCard(imgNumber(nums[3]));
  const n4 = mkCard(imgNumber(nums[4]));
  // â˜… è¿½åŠ ï¼šè£å‘ããƒˆã‚°ãƒ«ï¼ˆåŒæœŸï¼‰
  const downs = new Set(Array.isArray(v?.meta?.m36_faceDown) ? v.meta.m36_faceDown : []);
  const nodes = [n0, n1, n2, n3, n4];
  nodes.forEach((node, i)=>{
    const num = nums[i];
    // åˆæœŸåæ˜ ï¼šè£å‘ããªã‚‰è£é¢ã‚’è¡¨ç¤º
    if (downs.has(num)) {
      node.style.backgroundImage = `url('${imgBack}')`;
    }
    // ã‚¯ãƒªãƒƒã‚¯ã§è¡¨â‡„è£ãƒˆã‚°ãƒ«ï¼ˆå…¨å“¡åŒæœŸï¼‰
    node.onclick = async (ev)=>{
      ev.stopPropagation();
      const cur = state.watching?.meta?.m36_faceDown;
      const arr = Array.isArray(cur) ? cur.slice() : [];
      const idx = arr.indexOf(num);
      if (idx >= 0) arr.splice(idx, 1); else arr.push(num);
      await update(ref(db, `rooms/${state.roomCode}/meta`), { m36_faceDown: arr });
    };
  });
  // å³ãƒ–ãƒ©ãƒ³ã‚¯ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å³å´ã« left2ï¼‰
  const rightSlot = mkCard(null);
  rightSlot.classList.add('m36-slot','m36-right');
  rightSlot.title = 'ã‚¯ãƒªãƒƒã‚¯ã§å·¦2ã‚’è¡¨ç¤º';
 rightSlot.classList.remove('numcard');
 rightSlot.classList.add('rulecard');
  rightSlot.onclick = async (ev)=>{
    ev.stopPropagation();
    await update(ref(db, `rooms/${state.roomCode}/meta`), { m36_side: 'R' });
  };

  // ç¾åœ¨ã®ã‚µã‚¤ãƒ‰çŠ¶æ…‹ã‚’åæ˜ ï¼š'L' â†’ å·¦=right2/å³=ãƒ–ãƒ©ãƒ³ã‚¯ã€'R' â†’ å³=left2/å·¦=ãƒ–ãƒ©ãƒ³ã‚¯ã€null â†’ ä¸¡æ–¹ãƒ–ãƒ©ãƒ³ã‚¯
  const side = v?.meta?.m36_side ?? null;
  if (side === 'L'){
    leftSlot.style.backgroundImage  = `url('${imgRule('right2')}')`;
    rightSlot.style.backgroundImage = ''; // ãƒ–ãƒ©ãƒ³ã‚¯
  }else if (side === 'R'){
    leftSlot.style.backgroundImage  = ''; // ãƒ–ãƒ©ãƒ³ã‚¯
    rightSlot.style.backgroundImage = `url('${imgRule('left2')}')`;
  } // null ã®ã¨ãã¯ä¸¡æ–¹ãƒ–ãƒ©ãƒ³ã‚¯ã®ã¾ã¾

  // ä¸¦ã¹ã‚‹ï¼šå·¦ãƒ–ãƒ©ãƒ³ã‚¯ â†’ æ•°å€¤5 â†’ å³ãƒ–ãƒ©ãƒ³ã‚¯
  lane.appendChild(leftSlot);
  lane.appendChild(n0); lane.appendChild(n1); lane.appendChild(n2); lane.appendChild(n3); lane.appendChild(n4);
  lane.appendChild(rightSlot);

  // æ—¢å­˜ã®è¨­ç½®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã§é…ç½®
  mountLaneUnderItemsBar(lane);
}
/* ã“ã“ã¾ã§è¿½åŠ  */



  
  
/* ===== #39ï¼šå·¦ã« Xã€å³ã«æ•°å€¤P1å±±ï¼‹å…¬é–‹æœ­ã€ä¸‹ã«è‡ªåˆ†ã®å—ã‘å–ã‚Šæ•°å€¤ ===== */
function renderM39(v){
  const isM39 = ((v?.mission?.id|0) === 39);
  const old = document.getElementById('m39Row');
  if (!isM39){
    if (old) old.remove();                 // ä¸Šéƒ¨ã®å…¬é–‹æœ­ãƒ¬ãƒ¼ãƒ³ã‚’æƒé™¤
    const hand = document.getElementById('m39HandRow');
    if (hand) hand.remove();               // ç”»é¢ä¸‹éƒ¨ã®æ‰‹æœ­å¸¯ã‚‚æƒé™¤ â† è¿½åŠ 
    return;
  }
  if (old) old.remove();
  const lane = document.createElement('div');
  lane.id = 'm39Row';
  lane.className = 'numlane';

  // å·¦ï¼šXï¼ˆå›ºå®šè¡¨ç¤ºï¼‰
  const X = v?.meta?.m39_x|0;
  if (X){
    const xNode = document.createElement('div');
    xNode.className = 'numcard';
    xNode.style.backgroundImage = `url('${imgNumber(X)}')`;
    lane.appendChild(xNode);
  }

  // ä¸­å¤®ï¼šP1é¢¨ã®å±±æœ­ï¼ˆæ®‹è¡¨ç¤ºï¼‰
  const deckBtn = document.createElement('div');
  deckBtn.className = 'numdeck';
  deckBtn.title = 'ã‚ãã‚‹';

  const restLbl = document.createElement('span');
  restLbl.className = 'numrest';

  // å³ï¼šå…¬é–‹æœ­ç©ã¿é‡ã­
  const pile = document.createElement('div');
  pile.className = 'numcard-holder';
  pile.style.position = 'relative';

  lane.appendChild(deckBtn);
  lane.appendChild(restLbl);
  lane.appendChild(pile);

  if (v?.meta?.m39_dealt) {
    deckBtn.remove();     // å±±æœ­ãƒœã‚¿ãƒ³ã‚’æ¶ˆã™
    restLbl.remove();     // æ®‹æ•°ãƒ©ãƒ™ãƒ«ã‚‚æ¶ˆã™ï¼ˆå±±æœ­ã¨ãƒšã‚¢ãªã®ã§ï¼‰
  }
  
  // æ—¢å­˜å…¬é–‹æœ­ã®å†æç”» & æ®‹è¡¨ç¤º
  const refresh = ()=>{
    const d = (v?.meta?.m39_deck||[]);
    const x = (v?.meta?.m39_discards||[]);
    const remain = d.filter(n=>!x.includes(n)).length;
    restLbl.textContent = `æ®‹:${remain}`;

    pile.innerHTML = '';
    x.forEach((n, i)=>{
      const node = document.createElement('div');
      node.className = 'numcard';
      node.style.backgroundImage = `url('${imgNumber(n)}')`;
      if (i>0){
        const off = i*2;
        node.style.position='absolute';
        node.style.left = off+'px';
        node.style.top  = off+'px';
      }
      pile.appendChild(node);
      const extra = i*2;
      pile.style.height = (48+extra)+'px';
      lane.style.marginBottom = extra+'px';
    });
  };
  refresh();

  deckBtn.onclick = async ()=>{
    try{
      const mRef = ref(db, `rooms/${state.roomCode}/meta`);
      const mSnap = await get(mRef);
      const meta  = mSnap.val()||{};
      if (meta.m39_dealt) return; // é…å¸ƒå¾Œã¯æ­¢ã‚ã‚‹
      const D = Array.isArray(meta.m39_deck) ? meta.m39_deck.slice() : [];
      const Xs = Array.isArray(meta.m39_discards) ? meta.m39_discards.slice() : [];
      const next = D.find(n=> !Xs.includes(n)); // å±±æœ­é †ã§æ¬¡
      if (next==null) return;
      Xs.push(next);
      await update(mRef, { m39_discards: Xs });
    }catch(e){ console.error(e); }
  };

  mountLaneUnderItemsBar(lane);

  // è‡ªåˆ†ã®å—ã‘å–ã‚Šæ•°å€¤ï¼ˆm39Handï¼‰ã‚’ãƒŸãƒƒã‚·ãƒ§ãƒ³è©³ç´°ã®ç›´ä¸Šã«è¡¨ç¤º
  const rowId = 'm39HandRow';
  const oldRow = document.getElementById(rowId);
  if (oldRow) oldRow.remove();

  const myIdx = (v?.tables||[]).findIndex(T => T.playerId === state.userId);
  const myT   = myIdx>=0 ? v.tables[myIdx] : null;
  const row = document.createElement('div');
  row.id = rowId;
  row.style.display = 'flex';
  row.style.gap = '6px';
  row.style.margin = '6px 0';
  (myT?.m39Hand||[]).forEach(n=>{
    const nc = document.createElement('div');
    nc.className = 'numcard';
    nc.style.backgroundImage = `url('${imgNumber(n)}')`;
    row.appendChild(nc);
  });
  missionFooter.insertAdjacentElement('beforebegin', row);
}





  
/* ===== #16ï¼šæ•°å€¤3 + å³4ï¼ˆå…¨å“¡åŒæœŸï¼‰ ===== */
function renderM16(v){
  const isM16 = ((v?.mission?.id|0) === 16);
  const old = document.getElementById('m16Row');
  if (!isM16){ if (old) old.remove(); return; }

  // â˜… ãƒ›ã‚¹ãƒˆãŒä¸€åº¦ã ã‘3æšã‚’ç¢ºå®šï¼ˆDBã«ä¿å­˜ï¼‰â€”ç„¡ã‘ã‚Œã°ä½œã£ã¦å³returnï¼ˆæ¬¡ã®onValueã§æç”»ï¼‰
  if (state.isHost){
    const ok = Array.isArray(v?.meta?.m16_nums) && v.meta.m16_nums.length === 3;
    if (!ok){
      const pool = MATERIALS.numbers.slice(); shuffle(pool);
      const three = pool.slice(0,3); // é‡è¤‡ãªã—
      update(ref(db, `rooms/${state.roomCode}/meta`), { m16_nums: three });
      return;
    }
  }

  const nums = Array.isArray(v?.meta?.m16_nums) ? v.meta.m16_nums.slice(0,3) : [];
  if (old) old.remove();
 const lane = document.createElement('div');
  lane.id = 'm16Row';
  lane.className = 'numlane';

  // å·¦ç«¯ï¼šå³4ã‚«ãƒ¼ãƒ‰ï¼ˆæ¨ªå‘ãï¼‰
 const rule = document.createElement('div');
  rule.className = 'rulecard';
 rule.style.backgroundImage = `url('${imgRule('right4')}')`;
  lane.appendChild(rule);

  // å³å´ï¼šæ•°å€¤ã‚«ãƒ¼ãƒ‰3æšï¼ˆé™çš„è¡¨ç¤ºãƒ»æ“ä½œãªã—ï¼‰
  nums.forEach(n=>{
   const node = document.createElement('div');
    node.className = 'numcard';
    node.style.backgroundImage = `url('${imgNumber(n)}')`;
    lane.appendChild(node);
  });

  // ã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ç›´ä¸‹ã«æ•·ãï¼ˆ#39ã¨åŒã˜ç½®ãæ–¹ï¼‰
 mountLaneUnderItemsBar(lane);
}

  
  async function performM39Deal(){
  try{
    const rRef = ref(db, `rooms/${state.roomCode}`);
    const [rSnap, tSnap] = await Promise.all([
      get(rRef),
      get(ref(db, `rooms/${state.roomCode}/tables`))
    ]);
    const R = rSnap.val()||{};
    const meta = R.meta||{};
    if (meta.m39_dealt) return;

    const deck = Array.isArray(meta.m39_deck) ? meta.m39_deck.slice() : [];
    const disc = Array.isArray(meta.m39_discards) ? meta.m39_discards.slice() : [];
    const rest = deck.filter(n => !disc.includes(n)); // â†â€œæ¨ã¦æœ­ã«ãªã‚‰ãªã‹ã£ãŸâ€ã‚«ãƒ¼ãƒ‰

    const tables = Array.isArray(tSnap.val()) ? tSnap.val().map(T=>({...T})) : [];
    const tCount = R.tableCount|0;
    const start  = R.captainTable|0;

    // ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³é…å¸ƒ
    rest.forEach((n, i)=>{
      const to = (start + i) % tCount;
      const T  = tables[to] || (tables[to]={});
      const arr = Array.isArray(T.m39Hand) ? T.m39Hand.slice() : [];
      arr.push(n);
      T.m39Hand = arr;
    });

    // æ¡ä»¶ä»˜ãï¼šæƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚­ãƒ£ãƒ©ä¸‹è¡Œã«1ã¤é…å¸ƒ
    tables.forEach(T=>{
      const got = Array.isArray(T.m39Hand) ? T.m39Hand : [];
      const hand = Array.isArray(T.hand) ? T.hand : [];
      const row  = Array.isArray(T.m22Tokens) ? T.m22Tokens.slice() : [];
      got.forEach(n=>{
        const hasSameNum = hand.some(c => c?.kind==='normal' && (c.num|0)===(n|0));
        const someNoNumToken = hand.some(c =>
          c?.kind==='normal' && (c.num|0)===(n|0) &&
          !(Array.isArray(c.tokens) && c.tokens.some(tk => String(tk.type)==='num' && (tk.value|0)===(n|0)))
        );
        if (hasSameNum && someNoNumToken && !row.includes(n)){
          row.push(n);
        }
      });
      T.m22Tokens = row;
    });

    await update(ref(db, `rooms/${state.roomCode}/meta`), { m39_dealt: true });
    await set(ref(db, `rooms/${state.roomCode}/tables`), tables);
  }catch(e){ console.error('performM39Deal', e); }
}

// #23ï¼šæ®‹ã‚Šã®ã‚¢ã‚¤ãƒ†ãƒ å±±æœ­ã‚’â€œã‚¢ã‚¤ãƒ†ãƒ æ¬„â€ã«ä¸¦ã¹ã‚‹ï¼ˆãƒ¡ã‚¿ã¸ç¢ºå®šä¿å­˜ï¼‰
async function performM23Spread(){
  try{
    const rRef   = ref(db, `rooms/${state.roomCode}`);
    const rSnap  = await get(rRef);
    const R      = rSnap.val() || {};
    const meta   = R.meta || {};

    // ã™ã§ã«å®Ÿè¡Œæ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„
    if (meta.m23_spread === true) return;

    // æ®‹ã£ã¦ã„ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆï¼å±±æœ­ - æ¨ã¦æœ­ï¼‰
    const deck = Array.isArray(meta.m23_deck)     ? meta.m23_deck.slice()     : [];
    const disc = Array.isArray(meta.m23_discards) ? meta.m23_discards.slice() : [];
    const rest = deck.filter(n => !disc.includes(n));
     // â˜… items ã¨ meta ã‚’åŒæ™‚ã«æ›´æ–°ï¼ˆãƒãƒ©ã¤ãé˜²æ­¢ï¼‰
     const list = rest.map(no => ({ id: crypto.randomUUID(), no, used: false, faceUp: true }));
    await update(ref(db, `rooms/${state.roomCode}`), {
      'items': list,
      'meta/m23_spread': true,
      'meta/m23_spreadRest': []
     });
   
  }catch(e){
    console.error('performM23Spread', e);
  }
}
  
function attachM23DeckUI(lane){
  const deckBtn = document.createElement('div');
 deckBtn.className = 'numdeck';
  deckBtn.style.backgroundImage = `url("./itemback.jpg")`;
  const restLbl = document.createElement('span');
  restLbl.className = 'numrest';
  const refreshRest = ()=>{
    const v=state.watching, meta=v?.meta||{};
    const d=(meta.m23_deck||[]), x=(meta.m23_discards||[]);
    const remain = d.filter(n=>!x.includes(n)).length;
    restLbl.textContent = `æ®‹:${remain}`;
  };
  refreshRest();
  lane.appendChild(deckBtn);
  lane.appendChild(restLbl);

  // â˜… è¿½åŠ ï¼šè¡¨å‘ãæ¨ã¦æœ­ã®ç©ã¿é‡ã­è¡¨ç¤ºï¼ˆã‚¢ã‚¤ãƒ†ãƒ ï¼‰
  const pile = document.createElement('div');
  pile.className = 'numcard-holder';
  pile.style.position = 'relative';
  pile.style.width = cssNum('--item-w') + 'px';
  pile.style.height = cssNum('--item-h') + 'px';
  lane.appendChild(pile);

  const addToItemPile = (no)=>{
    const already = pile.querySelectorAll('.item').length;
    const node = document.createElement('div');
    node.className = 'item';
    node.style.backgroundImage = `url("./item${no}.jpg")`;
    if(already>0){
      const off = already * 2; // æ•°å€¤å±±æœ­ã¨åŒã˜2pxåˆ»ã¿
      node.style.position = 'absolute';
      node.style.left = off + 'px';
      node.style.top  = off + 'px';
      // è¦‹åˆ‡ã‚Œé˜²æ­¢ï¼šé«˜ã•ã¨ä¸‹ãƒãƒ¼ã‚¸ãƒ³ã‚’å¢—ã‚„ã™
      const baseH = cssNum('--item-h');
      pile.style.height = (baseH + off) + 'px';
      lane.style.marginBottom = off + 'px';
    }
    pile.appendChild(node);
  };

  // â˜… æ—¢å­˜ã®æ¨ã¦æœ­ã‚’æç”»ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰/å†å…¥å®¤å¯¾ç­–ï¼‰
  (state.watching?.meta?.m23_discards || []).forEach(addToItemPile);

  deckBtn.onclick = async (ev)=>{
    const v=state.watching, meta=v?.meta||{};
    const d=(meta.m23_deck||[]), x=(meta.m23_discards||[]);
    const remain = d.filter(n=>!x.includes(n));

    // ã€Œåºƒã’ã‚‹ã€æ¡ä»¶ã¯å¾“æ¥é€šã‚Šãƒãƒƒãƒ—ã§æç¤ºï¼ˆæŒ‡ç¤ºã¯â€œã‚ãã‚‹â€ã®ã¿ãƒãƒƒãƒ—å»ƒæ­¢ï¼‰
    const drawn = new Set(meta.m23_drawnNumbers||[]);
    const openCountByNum = {};
    (v.tables||[]).forEach(T=> (T.hand||[]).forEach(c=>{
      if(c?.kind==='normal' && c.open===true){
        const nn=c.num|0; openCountByNum[nn]=(openCountByNum[nn]||0)+1;
      }
    }));
    const ready = Array.from(drawn).some(nn => (openCountByNum[nn]||0)===4);

    if (!meta.m23_spread && ready){
      openOneMini(ev.clientX, ev.clientY, 'åºƒã’ã‚‹', async ()=>{
        const list = remain.map(no=>({id:crypto.randomUUID(), no, used:false, faceUp:true}));
 await Promise.all([
  set(ref(db, `rooms/${state.roomCode}/items`), list),
   update(ref(db, `rooms/${state.roomCode}/meta`), { 
     m23_spread: true,
     m23_spreadRest: remain
   })
 ]);
        // å±•é–‹å¾Œã¯å³å´ç©ã¿ã¯ã‚¯ãƒªã‚¢
        pile.innerHTML = '';
        pile.style.height = cssNum('--item-h') + 'px';
        lane.style.marginBottom = '0px';
        refreshRest();
          // â˜…â˜…â˜… ã“ã“ã‹ã‚‰è¿½åŠ ï¼šã‚¢ã‚¤ãƒ†ãƒ å±±æœ­UIã‚’æ¶ˆæ»…ã•ã›ã‚‹ â˜…â˜…â˜…
        try{
          deckBtn.onclick = null;              // å¿µã®ãŸã‚ç„¡åŠ¹åŒ–
          if (restLbl?.parentNode) restLbl.remove();
          if (pile?.parentNode)    pile.remove();
          if (deckBtn?.parentNode) deckBtn.remove();
        }catch(_){}
    });
      return;
    }

    // â˜… ã€Œã‚ãã‚‹ã€ã¯å³æ™‚å®Ÿè¡Œï¼ˆãƒãƒƒãƒ—ãªã—ï¼‰
    if (remain.length<=0) return;
    const pick = remain[(Math.random()*remain.length)|0];
    await update(ref(db, `rooms/${state.roomCode}/meta`), { m23_discards: (x||[]).concat(pick) });
    addToItemPile(pick);  // å³å´ã«è¡¨ã§é‡ã­ã‚‹
    refreshRest();
  };

}

/* ===== â˜… #26ï¼š1ã€œ12 ã‚’ 3Ã—4 ã§ä¸¦ã¹ã€è£è¡¨ã‚’ãƒˆã‚°ãƒ« ===== */
function mountM26GridUnderItems(){
  const bar = document.getElementById('itemsBar');
  // äºŒé‡ç”Ÿæˆé˜²æ­¢ï¼ˆæ—¢ã«ã‚ã‚Œã°ä¸€æ—¦æ¶ˆã™ï¼‰
  const existed = document.getElementById('m26Grid');
  if (existed) existed.remove();

  // 2è¡Œ Ã— 6åˆ—ï¼ˆåˆè¨ˆ12æšï¼‰
  const wrap = document.createElement('div');
  wrap.id = 'm26Grid';                      // â˜… å¾Œã§removeã§ãã‚‹ã‚ˆã†ã«IDä»˜ä¸
  wrap.style.flexDirection = 'column';
 wrap.style.alignItems = 'flex-start';
  wrap.style.gap = '6px';
  const rows = [ [1,2,3,4,5,6], [7,8,9,10,11,12] ];
  rows.forEach(arr=>{
    const row = document.createElement('div');
    row.className = 'numlane';
    arr.forEach(n=>{
     const c = document.createElement('div');
      c.className = 'numcard';
      c.dataset.num = String(n);
      row.appendChild(c);
    });
   wrap.appendChild(row);
  });
  bar.insertAdjacentElement('afterend', wrap);

  const sync = ()=>{
    const v = state.watching||{}; const hidden = new Set((v.meta?.m26_hidden)||[]);
    wrap.querySelectorAll('.numcard').forEach(el=>{
      const n = parseInt(el.dataset.num,10);
      el.style.backgroundImage = hidden.has(n) ? `url('${imgBack}')` : `url('${imgNumber(n)}')`;
    });
  };
  sync();
  wrap._sync = sync;

  wrap.querySelectorAll('.numcard').forEach(el=>{
   el.onclick = (ev)=>{
      const n = parseInt(el.dataset.num,10);
      const v = state.watching||{}; const hidden = new Set((v.meta?.m26_hidden)||[]);
      const allHidden = hidden.size===12;
      // â˜… å…¨éƒ¨ãŒè£ã®ã¨ãã ã‘ãƒãƒƒãƒ—ã§ã€Œå…¨ã¦è¡¨ã«ã™ã‚‹ã€
      if (allHidden){
        openOneMini(ev.clientX, ev.clientY, 'å…¨ã¦è¡¨ã«ã™ã‚‹', async ()=>{
          await update(ref(db, `rooms/${state.roomCode}/meta`), { m26_hidden: [] });
          sync();
        });
        return;
      }
      // â˜… ãã‚Œä»¥å¤–ã¯å³æ™‚ãƒˆã‚°ãƒ«ï¼ˆãƒãƒƒãƒ—ã‚’å‡ºã•ãªã„ï¼‰
      (hidden.has(n) ? hidden.delete(n) : hidden.add(n));
      update(ref(db, `rooms/${state.roomCode}/meta`), { m26_hidden: Array.from(hidden) }).then(sync);
    };
  });
}
  
function missionInfo(id, opts={}){
  const mixLines = opts.mixLines || [];     // ä¾‹: ['èµ¤[1.5]', 'é»„[2.1][5.1]']
  const chooseLines = opts.chooseLines || [];// ä¾‹: ['èµ¤ã‚³ãƒ¼ãƒ‰[1.5] [3.5] ã®ã†ã¡1ã¤']
  const linesForMix = [...mixLines, ...chooseLines]; // è¡¨ç¤ºã®å…ˆé ­ã«å·®ã—è¾¼ã‚€

  switch(id){
    case 1:{ // èµ¤ã‚³ãƒ¼ãƒ‰1
      return {
        id:1, name:'#1', desc:'', 
        display: ['#1', ...linesForMix],
      };
    }
    case 2:{ // é»„ã‚³ãƒ¼ãƒ‰1
      return {
        id:2, name:'#2', desc:'',
        display: ['#2', ...linesForMix],
      };
    }
    case 3:{
      const list=[1.5,2.5,3.5,4.5,5.5,6.5,7.5,8.5,9.5,10.5,11.5]; shuffle(list);
      const pick=list.slice(0,3);
      return {
        id:3, name:'#3', desc:'',
        display:[ '#3', `${pick[0]} â€“ ${pick[1]} - ${pick[2]} ã®ã†ã¡1ã¤`, ...linesForMix ],
      };
    }

    /* === #9ã€œ#12ï¼ˆæŒ‡å®šã®å¼•ç”¨æ–‡ã¨èµ¤/é»„è¡¨ç¤ºã‚’åˆæˆï¼‰=== */
    case 9: {
      return {
        id:9, name:'#9', desc:'',
        display: [
          '#9',
          ...linesForMix, // â† èµ¤1ãƒ»é»„2ã®çµæœï¼ˆèµ¤[1.5] / é»„[2.1][â€¦] ãªã©ï¼‰
          'æœ€åˆã«å·¦ã«ã‚ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’åˆ‡æ–­ã—ãªã‘ã‚Œã°ã€å³ã«ã‚ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’åˆ‡æ–­ã§ããªã„ã€‚',
          'æ‰‹ç•ªã«åˆ‡æ–­ã§ãã‚‹ã‚³ãƒ¼ãƒ‰ãŒãªã‘ã‚Œã°èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’1é€²ã‚ã‚‹ã€‚'
        ],
        flags: { needsRuleRow:true, rule: { type:'R2with2', rightCount:2 } }
      };
    }
    case 10: {
      return {
        id:10, name:'#10', desc:'',
        display: [
          '#10',
          ...linesForMix,
          '15åˆ†ä»¥å†…ã«è§£é™¤ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ï¼',
          'æ™‚è¨ˆå›ã‚Šã§ã¯ãªãã€æ‰‹ç•ªã‚’è¡Œã„ãŸã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã€Œãƒãƒ§ã‚­ãƒ³ï¼ã€ã¨è¨€ã£ã¦ã‹ã‚‰ã€åˆ‡æ–­ã‚’å®Ÿè¡Œã™ã‚‹ã€‚',
          '2äººã«ãªã£ãŸå ´åˆã‚’é™¤ã„ã¦ã€é€£ç¶šã§æ‰‹ç•ªã‚’ãƒ—ãƒ¬ã‚¤ã§ããªã„ã€‚'
        ],
        flags: { timed:true, freeTurnCall:true }
      };
    }
    case 11: {
      return {
        id:11, name:'#11', desc:'',
        display: [
          '#11',
          ...linesForMix,
          'æ•°å€¤ã‚«ãƒ¼ãƒ‰ã®æ•°å­—ã®ã‚³ãƒ¼ãƒ‰ã¯å…¨ã¦èµ¤ã‚³ãƒ¼ãƒ‰ã¨è¦‹ãªã•ã‚Œã‚‹ã€‚',
          'æ‰‹æœ­ãŒã“ã®ã‚³ãƒ¼ãƒ‰ã ã‘ã«ãªã£ãŸå ´åˆã€å…¬é–‹ã—ã¦æ‰‹ç•ªã‚’çµ‚ãˆã‚‰ã‚Œã‚‹ã€‚'
        ],
        flags: { numberAsRed:true, needsNumberLane:true, pattern:'P1' }
      };
    }
    case 12: {
      return {
        id:12, name:'#12', desc:'',
        display: [
          '#12',
          ...linesForMix,
          'ãã‚Œãã‚Œã®è£…å‚™ã‚«ãƒ¼ãƒ‰ã®ä¸‹ã«æ•°å€¤ã‚«ãƒ¼ãƒ‰ã‚’ç½®ãã€‚',
          'ãã®è£…å‚™ã‚’ä½¿ã†ã«ã¯ãã®æ•°å€¤ã‚«ãƒ¼ãƒ‰ã®æ•°å­—ã¨ã€è£…å‚™ã‚«ãƒ¼ãƒ‰ã®æ•°å­—ã‚’2æœ¬ãšã¤è§£é™¤ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚'
        ],
        flags: { needsNumberLane:true, pattern:'P2-eachItem' }
      };
    }
    case 13: {
      return {
        id:13, name:'#13', desc:'',
        display:[
          '#13',
          ...linesForMix,
          'æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒ©ãƒ³ãƒ€ãƒ ã«1æšå¼•ã„ã¦ã‚³ãƒ¼ãƒ‰ã®å‰ã«ç½®ãã€‚ï¼ˆåŒã˜æ•°å­—ã®ã‚³ãƒ¼ãƒ‰ãŒãªã‘ã‚Œã°æ‰‹å…ƒã«æ®‹ã™ã€‚ï¼‰',
          'èµ¤ã‚³ãƒ¼ãƒ‰ã‚’3ã¤ã€éšŠé•·ã‹ã‚‰é †ç•ªé€šã‚Šã«é…å¸ƒã™ã‚‹ã€‚',
          'èª°ã§ã‚‚èµ¤ã‚³ãƒ¼ãƒ‰ã®å ´æ‰€ã‚’3ã¤åŒæ™‚ã«æŒ‡æ‘˜ã—ã¦è§£é™¤ã§ãã‚‹ãŒã€é–“é•ãˆã‚‹ã¨çˆ†ç™ºã™ã‚‹ã€‚',
          'èµ¤ã‚³ãƒ¼ãƒ‰ã®åˆ‡æ–­ã«ã€Œãƒ•ãƒ„ãƒ¼ãƒæ¢çŸ¥æ©Ÿã€ã‚„è£…å‚™ã‚«ãƒ¼ãƒ‰ã¯ä½¿ãˆãªã„ã€‚'
        ],
        flags:{ m13_distributeRedToCaptain3:true, m13_headerRandomInfoToken:true, m13_autoHideHeaderToken:true }
      };
    }

    case 14: {
      return {
        id:14, name:'#14', desc:'',
        display:[
          '#14', ...linesForMix,
          'éšŠé•·ã‚«ãƒ¼ãƒ‰ã®æŒã¡ä¸»ã¯ã€Œæ–°äººã€ã¨ãªã‚‹ã€‚',
          'æ–°äººãŒåˆ‡æ–­ã«å¤±æ•—ã™ã‚‹ã¨çˆ†ç™ºã™ã‚‹ã€‚',
          'æ–°äººã¯ã€Œä¸‡èƒ½æ°·ã€ãŒä½¿ãˆãªã„ã€‚'
        ],
        flags:{ m14_rookieIsCaptain:true }
      };
    }

    case 15: {
      return {
        id:15, name:'#15', desc:'',
        display:[
          '#15', ...linesForMix,
          'æ•°å€¤ã‚«ãƒ¼ãƒ‰ã®æ•°å­—ã¨åŒã˜æ•°å­—ã®ã‚³ãƒ¼ãƒ‰ã‚’4æœ¬åˆ‡æ–­ã—ãŸæ™‚ã€å³åº§ã«1æšç›®ã®è£…å‚™ã‚«ãƒ¼ãƒ‰ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚',
          'æ¬¡ã«ã‚ãã‚‹æ•°å€¤ãŒå…¨ã¦åˆ‡æ–­æ¸ˆã¿ãªã‚‰å¼•ãç›´ã™ã€‚'
        ],
        flags:{ itemsFaceDownStart:true, needsNumberLane:true, pattern:'P1' }
      };
    }

    case 16: {
      return {
        id:16, name:'#16', desc:'',
        display:[
          '#16', ...linesForMix,
          'å·¦å´ã®æ•°å€¤ã‚«ãƒ¼ãƒ‰ã¨åŒã˜æ•°å­—ã®ã‚³ãƒ¼ãƒ‰4æœ¬ã‚’åˆ‡æ–­ã—ãªã‘ã‚Œã°å³ã®æ•°å€¤ã®ã‚³ãƒ¼ãƒ‰ã‚’åˆ‡æ–­ã§ããªã„ã€',
          'æ‰‹ç•ªã«åˆ‡æ–­ã§ãã‚‹ã‚³ãƒ¼ãƒ‰ãŒãªã‘ã‚Œã°çˆ†ç™ºã™ã‚‹'
        ],
        flags:{ m16_ruleRight4With3:true }
      };
    }

    case 17: {
      return {
        id:17, name:'#17', desc:'',
        display:[
          '#17', ...linesForMix,
          'éšŠé•·ã‚«ãƒ¼ãƒ‰ã®æŒã¡ä¸»ã¯ã€Œã‚»ãƒ«ã‚¸ã‚ªãƒ»ã‚¨ãƒ«ãƒ»ãƒŸãƒˆãƒ¼ã€ã¨ãªã‚‹ã€‚',
          'ã€Œã‚»ãƒ«ã‚¸ã‚ªã€ã¯æœ€åˆã«èª¤ã£ãŸæƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‚’2æšç½®ãã€‚',ã€€ã€€
          'ã€Œã‚»ãƒ«ã‚¸ã‚ªã€ã¯ã€Œãƒ•ãƒ„ãƒ¼ãƒæ¢çŸ¥æ©Ÿã€ã‚„ä»–ã®è£…å‚™ãŒä½¿ãˆãªã„ã€‚'
        ],
        flags:{ m17_captainInverseNumberPop:true }
      };
    }

    case 18: {
      return {
        id:18, name:'#18', desc:'',
        display:[
          '#18', ...linesForMix,
          'ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã«æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç½®ã‹ãªã„',
          'â‘ æ‰‹ç•ªé–‹å§‹æ™‚ã«æ•°å€¤ã‚«ãƒ¼ãƒ‰ã®å±±æœ­ã‹ã‚‰1æšã‚ãã‚‹ã€‚',
          'â‘¡æ‰‹ç•ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ãã®æ•°å­—ã§ã€Œãªã‚“ã§ã‚‚ãƒ¬ãƒ¼ãƒ€ãƒ¼ã€ã‚’ä½¿ç”¨ã—ãŸå¾Œã€åˆ‡æ–­å½¹ã‚’æ±ºã‚ã‚‹ã€‚',
        ],
  flags:{ limitItemsTo:[8] }   
      };
    }

    case 19: {
      return {
        id:19, name:'#19', desc:'',
        display:[ '#19', ...linesForMix, 'éŸ³å£°ã‚’èã“ã†ã€‚' ],
        flags:{}
      };
    }

    case 20: {
      return {
        id:20, name:'#20', desc:'',
        display:[
          '#20', ...linesForMix,
          'ãƒ©ãƒ³ãƒ€ãƒ ã®ã‚³ãƒ¼ãƒ‰ã‚’å³å´ã«é…ç½®ã™ã‚‹ã€‚',
          'âœ•ãƒˆãƒ¼ã‚¯ãƒ³ãŒç½®ã‹ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã«ã¯ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½¿ç”¨ã§ããªã„ã€‚'
        ],
        flags:{ m20_rightmostX:true }
      };
    }

    case 21: {
      return {
        id:21, name:'#21', desc:'',
        display:[
          '#21', ...linesForMix,
          'æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã¯å¶æ•°ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆ2/4ï¼‰ã‹å¥‡æ•°ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆ1/3ï¼‰ã‚’ä½¿ã†ã€‚'
        ],
        flags:{ useParityToken:true }
      };
    }

    case 22: {
      return {
        id:22, name:'#22', desc:'',
        display:[
          '#22', ...linesForMix,
          'æ‰€æŒã—ã¦ã„ãªã„ã‚³ãƒ¼ãƒ‰ã®æ•°å­—ã®æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‚’2æšé¸ã³ã€æ‰‹å…ƒã«ç½®ã„ã¦ãŠãã€‚',
          'æœ€åˆã®2æœ¬ã®é»„ã‚³ãƒ¼ãƒ‰ãŒè§£é™¤ã•ã‚ŒãŸæ™‚ã€å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ä½™ã£ã¦ã„ã‚‹æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰1æšé¸ã³ã€æ¬¡ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æ¸¡ã™ã€‚',
          'æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¸¡ã•ã‚ŒãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ãã®æ•°å­—ã®ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Œã°ã€ãã®æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã§ãã‚‹ã€‚'
        ],
        flags:{
          m22_pick3:true,
          m22_showTableAfter2Yellows:true,
          m22_allowInfoTableFromMenu:true
        }
      };
    }

    case 23: {
      return {
        id:23, name:'#23', desc:'',
        display:[
          '#23', ...linesForMix,
          'æ•°å€¤ã‚«ãƒ¼ãƒ‰ã‚’1æšã‚’è¡¨ã«ã—ã¦ç½®ãã€‚ãã‚Œã‹ã‚‰è£…å‚™ã‚«ãƒ¼ãƒ‰7æšã®å±±æœ­ã‚’ä½œã‚‹ã€‚',
         'æ•°å€¤ã‚«ãƒ¼ãƒ‰ã¨åŒã˜æ•°å­—ã®ã‚³ãƒ¼ãƒ‰ã¯ã€å€‹äººè£…å‚™ã‚‚ä½¿ã‚ãšã«4æœ¬åŒæ™‚ã«è§£é™¤ã—ãªã‘ã‚Œã°ã„ã‘ãªã„ã€‚',
          'ã“ã‚Œã‚’è§£é™¤ã§ãã‚‹ã¾ã§ã€éšŠé•·ã®æ‰‹ç•ªã«ãªã‚‹ãŸã³ã«è£…å‚™ã‚«ãƒ¼ãƒ‰ã®å±±æœ­ã‹ã‚‰1æšãšã¤æ¨ã¦æœ­ã«ã™ã‚‹ã€‚',
          'ã“ã‚Œã‚’è§£é™¤ã§ããŸã‚‰ã€ã¾ã æ¨ã¦æœ­ã«ãªã£ã¦ã„ãªã„è£…å‚™ãŒå³åº§ã«å…¨ã¦ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚'
        ],
 flags:{ m23_hideItemsUntilSpread:true }
      };
    }

   case 24: {
      return {
        id:24, name:'#24', desc:'',
        display:[
          '#24', ...linesForMix,
          'æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã¯x1/x2/x3ãƒˆãƒ¼ã‚¯ãƒ³ã®ã¿ä½¿ç”¨ã™ã‚‹ã€‚',
          'èµ¤ã‚³ãƒ¼ãƒ‰ã®å‰ã«ã¯æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç½®ã‘ãªã„ã€‚'
        ],
        flags:{ useXTokens:true }
      };
    }

    case 25: {
      return {
        id:25, name:'#25', desc:'',
        display:[ '#25', ...linesForMix,
          'ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚«ãƒ¼ãƒ‰ã‚’å®£è¨€ã™ã‚‹æ™‚ã«ã€æ•°å­—ã‚’ç™ºè¨€ã™ã‚‹ã¨èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ãŒ1ã¤é€²ã‚€ã€‚',
          'ã€Œä¸€é€±é–“ã®æ—¥æ•°ã€ï¼ˆ=7ï¼‰ãªã©ã®ã‚ˆã†ã«è¨€ã„æ›ãˆãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚'
                  ],
        flags:{}
      };
    }

    case 26: {
      return {
        id:26, name:'#26', desc:'',
        display:[
         '#26', ...linesForMix,
          'è¡¨ã®æ•°å€¤ã‚«ãƒ¼ãƒ‰ã‹ã‚‰1æšé¸ã‚“ã§ã€ãã®ã‚³ãƒ¼ãƒ‰ã‚’åˆ‡æ–­ã™ã‚‹ã€‚',
          'ãã®å¾Œã€ãã®æ•°å€¤ã‚«ãƒ¼ãƒ‰ã‚’è£å‘ãã«ã™ã‚‹ã€‚',
          'å…¨ã¦ã®æ•°å€¤ã‚«ãƒ¼ãƒ‰ãŒè£å‘ãã«ãªã£ãŸã‚‰ã€å…¨ã¦ã‚’è¡¨ã«æˆ»ã™ã€‚',
          'è‡ªåˆ†ãŒæŒã£ã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã®æ•°å­—ãŒ1æšã‚‚è¡¨ã«ãªã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã€æ‰‹ç•ªã‚’é£›ã°ã™ã€‚'
        ],
        flags:{ m26_grid12:true }
      };
    }

    case 27: {
      return {
        id:27, name:'#27', desc:'',
        display:[
          '#27', ...linesForMix,
          'å…¨å“¡ã€Œãƒ•ãƒ„ãƒ¼ãƒæ¢çŸ¥æ©Ÿã€ã‚’æŒã£ã¦ã„ãªã„ã€‚',
          'æœ€åˆã®2æœ¬ã®é»„ã‚³ãƒ¼ãƒ‰ãŒåˆ‡æ–­ã•ã‚ŒãŸæ™‚ã€ãƒ—ãƒ¬ã‚¤äººæ•°ã«ç­‰ã—ã„æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã§å–ã‚Šã€éšŠé•·ã‹ã‚‰é †ç•ªã«é¸ã‚“ã§å–ã‚‹ã€‚'
        ],
        flags:{ m27_poolAfter2Yellows:true }
      };
    }

    case 28: {
      return {
        id:28, name:'#28', desc:'',
        display:[ '#28', ...linesForMix, 
                 ' éšŠé•·ã‚«ãƒ¼ãƒ‰ã®æŒã¡ä¸»ã¯ã€Œãƒ©ã‚¸ãƒã‚¹éšŠé•·ã€ã¨ãªã‚‹ã€‚', 
                 'ãƒ©ã‚¸ãƒã‚¹éšŠé•·ã¯ã€Œãƒ•ãƒ„ãƒ¼ãƒæ¢çŸ¥æ©Ÿã€ã‚’æŒã£ã¦ãŠã‚‰ãšã€è£…å‚™ã‚«ãƒ¼ãƒ‰ã‚‚ä½¿ã†ã“ã¨ãŒã§ããªã„ã€‚', 
                 'ãƒ©ã‚¸ãƒã‚¹éšŠé•·ãŒåˆ‡æ–­ã«å¤±æ•—ã—ãŸå ´åˆã€å³åº§ã«çˆ†ç™ºã™ã‚‹ã€‚' 
                ],
        flags:{}
      };
    }
 
  case 29: {
      return {
        id:29, name:'#29', desc:'',
        display:[
          '#29', ...linesForMix,
          'æ•°å€¤ã‚«ãƒ¼ãƒ‰ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ã€å…¨å“¡ã«2æšãšã¤é…ã‚‹ã€‚ï¼ˆéšŠé•·ã®ä¸€ã¤å‰ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã¯3æšé…ã‚‹ã€‚ï¼‰',
          'â‘ æ‰‹ç•ªã®æœ€åˆã«ã€æ‰‹ç•ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¸€ã¤å‰ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯æ•°å€¤ã‚«ãƒ¼ãƒ‰ã‚’1æšé¸ã‚“ã§è£å‘ãã§å‡ºã™ã€‚',
          'â‘¡æ‰‹ç•ªã®æœ€å¾Œã«æ•°å€¤ã‚«ãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¦ã€åˆ‡æ–­ã«æˆåŠŸã—ãŸã‚³ãƒ¼ãƒ‰ã¨æ•°å€¤ã‚«ãƒ¼ãƒ‰ãŒåŒã˜æ•°å­—ã ã£ãŸå ´åˆã€èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ãŒ1é€²ã‚€ã€‚',
          'â‘¢æ‰‹ç•ªã®æœ€å¾Œã«ã€åˆ‡æ–­ã‚’è©¦ã¿ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å ´ã®æ•°å€¤ã‚«ãƒ¼ãƒ‰ã‚’å›åã™ã‚‹ã€‚',
     'ï¼ˆæ•°å€¤ã‚«ãƒ¼ãƒ‰ãŒ1æšä»¥ä¸‹ã«ãªã£ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯æ•°å€¤ã‚«ãƒ¼ãƒ‰ã®å±±æœ­ã‹ã‚‰1æšè¿½åŠ ã•ã‚Œã‚‹ã€‚',
          'æ—¢ã«4æšåˆ‡æ–­ã‚’çµ‚ãˆãŸæ•°å­—ã®æ•°å€¤ã‚«ãƒ¼ãƒ‰ã¯å ´ã«æ¨ã¦ã‚‹ã€‚ï¼‰'
        ],
        // â€»UIã¯æ®µéšå°å…¥ã€‚åˆå›ã¯èª¬æ˜ã®ã¿ï¼ˆä»Šå¾Œã®PRã§ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè£…äºˆå®šï¼‰
        flags:{}
      };
    }

    case 30: {
      return {
        id:30, name:'#30', desc:'',
        display:[
          '#30', ...linesForMix,
          'ã€é‡è¦ã€‘éŸ³å£°ãŒé³´ã£ã¦ã„ã‚‹é–“ã¯ã€ã—ã£ã‹ã‚Šèã“ã†ï¼'
        ],
        flags:{ needsNumberLane:true, pattern:'P1-pop123' }
      };
    }

    case 31: {
      return {
        id:31, name:'#31', desc:'',
        display:[
          '#31',...linesForMix,
          'éšŠé•·ã‹ã‚‰é †ã«åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ã‚’1æšé¸ã‚“ã§è¡¨å‘ãã§ç½®ãã€‚',
          'å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã“ã‚Œã‚’å®ˆã‚‰ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
          'è‡ªåˆ†ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã€åˆ¶ç´„ã‚’å®ˆã‚Œãªããªã£ãŸæ™‚ã¯åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ã‚’è£å‘ãã«ã—ã¦é€šå¸¸é€šã‚Šãƒ—ãƒ¬ã‚¤ã™ã‚‹ã€‚'
        ],
        // â€»è¡¨ç¤ºãƒ»é…å¸ƒUIã¯ä»Šå¾Œè¿½åŠ äºˆå®šï¼ˆä»Šå›ã®å·®åˆ†ã¯èª¬æ˜è¡¨ç¤ºã®ã¿ï¼‰
        flags:{}
      };
    }

    case 32: {
      return {
        id:32, name:'#32', desc:'',
        display:[
          '#32',...linesForMix,
          'åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ã®å±±æœ­ã‹ã‚‰1æšå¼•ã„ã¦ã€è¡¨ã«ã™ã‚‹ã€‚',
          'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…¨å“¡ã¯ã“ã®åˆ¶ç´„ã‚’å®ˆã‚‰ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
          'éšŠé•·ã®æ‰‹ç•ªã«ãªã‚‹ã¨ã€åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ã‚’å¼•ãç›´ã™ã“ã¨ãŒã§ãã‚‹ã€‚',
          'åˆ¶ç´„ã‚’å®ˆã‚Œãªã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯æ‰‹ç•ªã‚’é£›ã°ã™ã€‚'
        ],
        // â€»ä»Šå›ï¼šèª¬æ˜è¡¨ç¤ºã®ã¿ã€‚å±±æœ­UIã¯æ¬¡ã®å·®åˆ†ã§è¿½åŠ äºˆå®š
        flags:{}
      };
    }

    case 33: {
      return {
        id:33, name:'#33', desc:'',
        display:[
          '#33',...linesForMix,
          'æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã¯å¶æ•°/å¥‡æ•°ãƒˆãƒ¼ã‚¯ãƒ³ã®ã¿ä½¿ç”¨ã™ã‚‹ã€‚'
        ],
        // æ—¢å­˜ã® #21 ã¨åŒæ§˜ã®ãƒ•ãƒ©ã‚°ã§å¶å¥‡ãƒˆãƒ¼ã‚¯ãƒ³ã ã‘ã‚’è¨±å¯
        flags:{ useParityToken:true }
      };
    }

    case 34: {
      return {
        id:34, name:'#34', desc:'',
        display:[
          '#34',...linesForMix,
 'A:å›ã¯å¶æ•°ã®ã‚³ãƒ¼ãƒ‰ã ã‘ã‚’åˆ‡æ–­ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
 'B:å›ã¯å¥‡æ•°ã®ã‚³ãƒ¼ãƒ‰ã ã‘ã‚’åˆ‡æ–­ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
 'C:1ï½6ã®ã‚³ãƒ¼ãƒ‰ã ã‘ã‚’åˆ‡æ–­ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
 'D:7ï½12ã®ã‚³ãƒ¼ãƒ‰ã ã‘ã‚’åˆ‡æ–­ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
 'E:4ï½9ã®ã‚³ãƒ¼ãƒ‰ã ã‘ã‚’åˆ‡æ–­ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
          'å…ˆã«éšŠé•·ã‚’æ±ºã‚ã¦ã€è‡ªåˆ†ã ã‘å½¹è·ã‚«ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹ã€‚',
          'éšŠé•·ã‚«ãƒ¼ãƒ‰ã®æŒã¡ä¸»ã¯ã€Œã‚¦ã‚£ãƒ¼ã‚±ã‚¹ãƒˆãƒ»ãƒªãƒ³ã‚¯ã€ã¨ãªã‚‹ã€‚',
          'ã€Œã‚¦ã‚£ãƒ¼ã‚±ã‚¹ãƒˆãƒ»ãƒªãƒ³ã‚¯ã€ã ã‘ãŒåˆ¶ç´„ã‚’å®ˆã‚‰ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
          'ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã„ã¤ã§ã‚‚ã€ã€Œã‚¦ã‚£ãƒ¼ã‚±ã‚¹ãƒˆãƒ»ãƒªãƒ³ã‚¯ã€ã¨åˆ¶ç´„ã®ç¨®é¡ã®ä¸¡æ–¹ã‚’ç‰¹å®šã§ããŸã‚‰ã€ã€Œã‚¦ã‚£ãƒ¼ã‚±ã‚¹ãƒˆãƒ»ãƒªãƒ³ã‚¯ã€ã¯åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ã‚’å…¬é–‹ã§ãã¦ã€åˆ¶ç´„ã‹ã‚‰è§£æ”¾ã•ã‚Œã‚‹ã€‚',
          'ãŸã ã—ã€ã©ã¡ã‚‰ã‹ã§ã‚‚é–“é•ãˆã‚‹ã¨èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ãŒ1é€²ã‚€ã€‚',
          'ã€Œã‚¦ã‚£ãƒ¼ã‚±ã‚¹ãƒˆãƒ»ãƒªãƒ³ã‚¯ã€ã¯è‡ªåˆ†ã®åˆ¶ç´„ã«ã‚ˆã‚Šåˆ‡æ–­ã§ããªããªã£ãŸæ™‚ç‚¹ã§åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¦ã€èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’2é€²ã‚ã‚‹ã€‚',
          'ã‚«ãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã‚‹ã¾ã§ã€ã„ãšã‚Œã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚‚å€‹äººè£…å‚™ã¯ä½¿ç”¨ã§ããªã„ã€‚',
        ],
        // â€»ä»Šå›ï¼šè¡¨ç¤ºã®ã¿ã€‚ç§˜åŒ¿/æ¨ç†UIã¯å¾Œç¶šPRã§
        flags:{}
      };
    }

    case 35: {
      return {
        id:35, name:'#35', desc:'',
        display:[
          '#35',...linesForMix,
          'ãƒ©ãƒ³ãƒ€ãƒ ã§ä¸€æšé¸ã³ã€è‡ªåˆ†ã®ã‚¹ã‚¿ãƒ³ãƒ‰ã®ä¸€ç•ªå³ã«ç½®ãã€‚',
          'ã“ã®ã‚³ãƒ¼ãƒ‰ã¯é»„ã‚³ãƒ¼ãƒ‰ã‚’å…¨ã¦åˆ‡æ–­ã—ãªã„ã¨ã€åˆ‡æ–­ã§ããªã„ã€‚',
          'ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’åˆ‡æ–­ã™ã‚‹ã®ã«å€‹äººè£…å‚™ã€è£…å‚™ã‚«ãƒ¼ãƒ‰ã¯ä½¿ç”¨ã§ããªã„ã€‚'
        ],
        // #20 ã¨åŒã˜å³ç«¯âœ•å‡¦ç†ã‚’æµç”¨
        flags:{ m20_rightmostX:true }
      };
    }

    case 36: {
      return {
        id:36, name:'#36', desc:'',
        display:[
          '#36',...linesForMix,
          'æ•°å€¤ã‚«ãƒ¼ãƒ‰ã‚’5æšä¸¦ã¹ã‚‹ã€‚',
          'æœ€åˆã«éšŠé•·ã¯ã©ã¡ã‚‰ã®æ–¹å‘ã‹ã‚‰åˆ‡æ–­ã™ã‚‹ã‹æ±ºã‚ã‚‹ã€‚',
          'æ•°å€¤ã‚«ãƒ¼ãƒ‰ä¸Šã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã®é †ã§2æœ¬åˆ‡æ–­ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
          'ã‚«ãƒ¼ãƒ‰ä¸Šã®2æœ¬ã®åˆ‡æ–­ã‚’çµ‚ãˆã‚‹ãŸã³ã«ã€åˆ‡æ–­ã«æˆåŠŸã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç›¸è«‡ã›ãšã«ã©ã¡ã‚‰ã®æ–¹å‘ã‹ã‚‰åˆ‡æ–­ã§ãã‚‹ã‹æ±ºã‚ç›´ã—ã¦ã‚ˆã„ã€‚',
          'ãã‚Œä»¥å¤–ã®æ•°å€¤ã¯è‡ªç”±ã«åˆ‡æ–­ã§ãã‚‹ã€‚'
        ],
        flags:{ m36_directionRow:true }
      };
    }

    case 37: {
      return {
        id:37, name:'#37', desc:'',
        display:[
          '#37',...linesForMix,
          'åˆ¶ç´„ã‚«ãƒ¼ãƒ‰12æšã®å±±æœ­ã‹ã‚‰1æšç›®ã‚’è¡¨å‘ãã«ã™ã‚‹ã€‚',
          'ç¢ºå®šãƒˆãƒ¼ã‚¯ãƒ³ãŒç½®ã‹ã‚Œã‚‹ãŸã³ã«åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ã‚’å¼•ãç›´ã™ã€‚',
          'åˆ¶ç´„ã‚’å®ˆã‚Œãªã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯æ‰‹ç•ªã‚’é£›ã°ã™ã€‚',
          '1ãƒ©ã‚¦ãƒ³ãƒ‰ã™ã‚‹ã¾ã§ã«å…¨å“¡ãŒæ‰‹ç•ªã‚’å®Ÿè¡Œã§ããªã‹ã£ãŸå ´åˆã€èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’1é€²ã‚ã¦ã€åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ã‚’å¼•ãç›´ã™ã€‚',
          'åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ãŒãªããªã‚Œã°ã€æ–°ã—ãå¼•ã‹ãªã„ã€‚'
        ],
        flags:{ }
      };
    }

    case 38: {
     return {
        id:38, name:'#38', desc:'',
        display:[
          '#38',...linesForMix,
          'éšŠé•·ã®æ‰‹æœ­ã‹ã‚‰1æšãƒ©ãƒ³ãƒ€ãƒ ã§é¸ã³ã€ã‚¹ã‚¿ãƒ³ãƒ‰ã®å³ã«ç½®ãã€‚',
          'éšŠé•·ã¯ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ããªã„ã€‚',
          'éšŠé•·ã¯å€‹äººè£…å‚™ã€è£…å‚™ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ã‚ãšã«ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’åˆ‡æ–­ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
          'ä½•ã‚‰ã‹ã®ç†ç”±ã§æ˜ã‚‰ã‹ã«ãªã£ã¦ã—ã¾ã£ãŸå ´åˆã¯èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ãŒ1é€²ã‚€ã€‚',
       ],
        flags:{ m38_captainRightmostX:true }
      };
    }
      
    case 39: {
     return {
        id:39, name:'#39', desc:'',
        display:[
          '#39',...linesForMix,
          'æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å¾—ã¦ã€ãã®æ•°å­—ã®ã‚³ãƒ¼ãƒ‰ã‚’æŒã£ã¦ã„ãªã‘ã‚Œã°æ‰‹å…ƒã«ç½®ã„ã¦ãŠãã€‚',
          'æ•°å€¤ã‚«ãƒ¼ãƒ‰ã‚’1æšè¡¨å‘ãã§ç½®ã„ã¦ã€æ®‹ã‚Šã®æ•°å€¤ã‚«ãƒ¼ãƒ‰ã‹ã‚‰8æšå–ã£ã¦å±±æœ­ã«ã—ã¦ç½®ãã€‚',
          'æ•°å€¤ã‚«ãƒ¼ãƒ‰ã®æ•°å­—ã¨åŒã˜æ•°å­—ã®ã‚³ãƒ¼ãƒ‰ãŒ4æœ¬åˆ‡æ–­ã•ã‚Œã‚‹ã¾ã§ã€éšŠé•·ã®æ‰‹ç•ªã«ãªã‚‹ãŸã³ã«æ•°å€¤ã‚«ãƒ¼ãƒ‰ã®å±±æœ­ã‹ã‚‰1æšæ¨ã¦æœ­ã«ã™ã‚‹ã€‚',
          'æ•°å€¤ã‚«ãƒ¼ãƒ‰ã®æ•°å­—ã¨åŒã˜æ•°å­—ã®ã‚³ãƒ¼ãƒ‰ãŒ4æœ¬åˆ‡æ–­ã•ã‚ŒãŸã‚‰ã€å±±æœ­ã«æ®‹ã£ã¦ã„ã‚‹æ•°å€¤ã‚«ãƒ¼ãƒ‰ã‚’å…¨å“¡ã«é…ã‚‹ã€‚',
          'é…ã‚‰ã‚ŒãŸæ•°å€¤ã‚«ãƒ¼ãƒ‰ã¨åŒã˜æ•°å­—ã®ã‚³ãƒ¼ãƒ‰ãŒæ‰‹å…ƒã«ã‚ã‚Œã°ã€æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚',
          'ã¤ã¾ã‚Šã€ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’æ—©ãåˆ‡æ–­ã™ã‚Œã°ã™ã‚‹ã»ã©ã€æƒ…å ±ãŒå¾—ã‚‰ã‚Œã‚‹ã¨ã„ã†ã“ã¨ã ã€‚'
                 ],
        flags:{  }
      };
    }
       case 40: {
     return {
        id:40, name:'#40', desc:'',
        display:[
          '#40',...linesForMix,
          'éšŠé•·ã¨3,5ç•ªæ‰‹ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯x1,x2,x3ãƒˆãƒ¼ã‚¯ãƒ³ã®ã¿ä½¿ç”¨ã™ã‚‹ã€‚',
          '2,4ç•ªæ‰‹ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å¥‡æ•°ã€å¶æ•°ãƒˆãƒ¼ã‚¯ãƒ³ã®ã¿ä½¿ç”¨ã™ã‚‹ã€‚'
       ],
        flags:{  }
      };
    }
       case 41: {
     return {
        id:41, name:'#41', desc:'',
        display:[
          '#41',...linesForMix,
          'æœ€åˆã«èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’æ®‹ã‚Š1ã¾ã§é€²ã‚ã‚‹ã€‚',
          'å…¨å“¡ã«é»„ã‚³ãƒ¼ãƒ‰ã‚’1æšãšã¤é…ã‚‹ã€‚ãŸã ã—ã€5äººãƒ—ãƒ¬ã‚¤æ™‚ã¯éšŠé•·ã«ã¯é»„ã‚³ãƒ¼ãƒ‰ã‚’é…ã‚‰ãªã„ã€‚',
          'æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒ©ãƒ³ãƒ€ãƒ ã«å¾—ã¦ã€ç½®ã‘ãªã„å ´åˆã¯æ‰‹å…ƒã«ç½®ã„ã¦ãŠãã€‚',
          'ã“ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã§ã¯å…±åŒã§é»„ã‚³ãƒ¼ãƒ‰ã®åˆ‡æ–­ã‚’è¡Œã‚ãšã€ãƒãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆã®é»„ã‚³ãƒ¼ãƒ‰ã®å ´æ‰€ã‚’1ã¤é¸ã‚“ã§ã€åˆ‡æ–­ã§ãã‚‹ã€‚',
          'é»„ã‚³ãƒ¼ãƒ‰ã®åˆ‡æ–­ã«æˆåŠŸã™ã‚‹ã¨èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ãŒ1æˆ»ã‚‹ãŒã€å¤±æ•—ã™ã‚‹ã¨èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ãŒ1é€²ã‚€ã€‚'
       ],
        flags:{  }
      };
    }
           case 42: {
     return {
        id:42, name:'#42', desc:'',
        display:[
          '#42',...linesForMix,
          'éŸ³å£°ã‚’èã“ã†ã€‚',
       ],
        flags:{  }
      };
    }  
           case 43: {
     return {
        id:43, name:'#43', desc:'',
        display:[
          '#43',...linesForMix,
          'ãƒ­ãƒœãƒƒãƒˆã®ãƒŠãƒã‚’ãƒœãƒ¼ãƒ‰ä¸Šã®ã‚¹ãƒšãƒ¼ã‚¹1ã«ç½®ãã€‚',
          'ã‚³ãƒ¼ãƒ‰ã‚’é…ã‚‹æ™‚ã€ãƒŠãƒã«æŒ‡å®šã®æ•°ã®ã‚³ãƒ¼ãƒ‰ã‚’ç½®ãã€‚',
          'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹ç•ªçµ‚äº†æ™‚ã«ãƒŠãƒã¯1ãƒã‚¹é€²ã¿ã€12ã§æ–¹å‘è»¢æ›ã™ã‚‹ã€‚',
          'ãƒŠãƒãŒã„ã‚‹ã‚¹ãƒšãƒ¼ã‚¹ã®æ•°å€¤ã«å¯¾å¿œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’åˆ‡æ–­ã—ãŸæ™‚ã«ã€ãƒŠãƒã®ã‚³ãƒ¼ãƒ‰ã‚’1æšå›åã§ãã‚‹ã€‚',
          'çˆ†å¼¾ã‚’è§£é™¤ã™ã‚‹ã«ã¯å…¨ã¦ã®ã‚³ãƒ¼ãƒ‰ã‚’å›åã—ã¦åˆ‡æ–­ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
          'â€»ã„ã¤ã§ã‚‚ã‚³ãƒ¼ãƒ’ãƒ¼ã‚’ä½¿ã£ã¦ã‚‚ã€ãƒŠãƒã¯1ãƒã‚¹é€²ã‚€ã€‚',
       ],
        flags:{  }
      };
    }  
           case 44: {
     return {
        id:44, name:'#44', desc:'',
        display:[
          '#44',...linesForMix,
          'æ‰‹ç•ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯åˆ‡æ–­ã™ã‚‹ç›´å‰ã«ã€åˆ‡æ–­ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã®æ•°å€¤ã«å¯¾å¿œã™ã‚‹æšæ•°ã®é…¸ç´ ã‚’ãƒªã‚¶ãƒ¼ãƒ–ã‹ã‚‰å–ã‚‰ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
          'éšŠé•·ã®æ‰‹ç•ªé–‹å§‹æ™‚ã«å…¨ã¦ã®é…¸ç´ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒªã‚¶ãƒ¼ãƒ–ã‚¨ãƒªã‚¢ã«æˆ»ã™ã€‚',
          'åˆ‡æ–­ã§ããªã„å ´åˆã€èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’1é€²ã‚ã‚‹ã€‚',
       ],
        flags:{  }
      };
    }  
           case 45: {
     return {
        id:45, name:'#45', desc:'',
        display:[
          '#45',...linesForMix,
          'åˆ‡æ–­ã™ã‚‹ãŸã³ã«ã€æ•°å€¤ã‚«ãƒ¼ãƒ‰ã‚’1æšã‚ãã‚Šã€ãã®æ•°å€¤ã®ã‚³ãƒ¼ãƒ‰ã‚’åˆ‡æ–­ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
          'æ™‚è¨ˆå›ã‚Šé †ã§ã¯ãƒ—ãƒ¬ã‚¤ã›ãšã€æœ€åˆã«ã€Œãƒãƒ§ã‚­ãƒ³ï¼ã€ã¨è¨€ã£ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒåˆ‡æ–­ã™ã‚‹ã€‚',
          'ãƒãƒ§ã‚­ãƒ³ï¼ã¨è¨€ã£ãŸã®ã«åˆ‡æ–­ã§ããªã‹ã£ãŸã‚Šã€æ‰‹æ›ã‹ã‚Šã‚’ä¸ãˆã‚‹ç™ºè¨€ï¼ˆã€Œãã®æ•°å€¤ã®ã‚³ãƒ¼ãƒ‰ã¯åˆ‡æ–­ã—ãŸããªã„ã€ãªã©ï¼‰ãŒã‚ã£ãŸå ´åˆã¯èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ãŒ1é€²ã‚€ã€‚',
          'èª°ã‚‚ãƒãƒ§ã‚­ãƒ³ï¼ã¨è¨€ã‚ãªã„å ´åˆã¯éšŠé•·ãŒä¸€äººé¸ã¶ã€‚',
          'ãã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã„ã‹ãªã‚‹ç†ç”±ã§ã‚‚åˆ‡æ–­ã§ããªã‘ã‚Œã°èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ãŒ1é€²ã‚€ã€‚',
          'èµ¤ã‚³ãƒ¼ãƒ‰ã—ã‹æŒã£ã¦ã„ãªã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã„ã¤ã§ã‚‚ãƒãƒ§ã‚­ãƒ³ï¼ã¨è¨€ã£ã¦èµ¤ã‚³ãƒ¼ãƒ‰ã‚’å…¬é–‹ã§ãã‚‹ã€‚',
       ],
        flags:{  }
      };
    }  
                 case 46: {
     return {
        id:46, name:'#46', desc:'',
        display:[
          '#46',...linesForMix,
          '7ã®ã‚³ãƒ¼ãƒ‰ã¯æœ€å¾Œã«åˆ‡æ–­ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
          'æ‰‹æœ­ã«7ã—ã‹ãªã„å ´åˆã€4æœ¬ã®7ã‚’åŒæ™‚ã«åˆ‡æ–­ã—ãªã‘ã‚Œã°ãªã‚‰ãšã€å¤±æ•—ã™ã‚Œã°çˆ†ç™ºã™ã‚‹ã€‚',
          'ãã‚Œã‚ˆã‚Šå‰ã®æ®µéšã§7ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€èµ·çˆ†ãƒ€ã‚¤ã‚¢ãƒ«ãŒ1é€²ã‚€ã€‚',
       ],
        flags:{  }
      };
    }  
               case 47: {
     return {
        id:47, name:'#47', desc:'',
        display:[
          '#47',...linesForMix,
          'ã‚³ãƒ¼ãƒ‰ã‚’åˆ‡æ–­ã™ã‚‹ãŸã‚ã«ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯2æšé¸ã‚“ã ãã®å’Œã‹å·®ã®æ•°å­—ã®ã‚³ãƒ¼ãƒ‰ã‚’åˆ‡æ–­ã§ãã‚‹ã€‚',
          'ãã®å¾Œã€é¸ã‚“ã ã‚«ãƒ¼ãƒ‰ã‚’è£å‘ãã«ã™ã‚‹ã€‚',
          'å…¨ã¦è£å‘ããªã‚‰ã€è¡¨ã«ã™ã‚‹ã€‚',
          'åˆ‡æ–­ãŒã§ããªã„å ´åˆã€ä»»æ„ã®2æšã‚’è£ã«ã—ã¦ã€èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’1é€²ã‚ã‚‹ã€‚',
       ],
        flags:{  }
      };
    }  
                   case 48: {
     return {
        id:48, name:'#48', desc:'',
        display:[
          '#48',...linesForMix,
          'ã“ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã§ã¯3æœ¬ã®é»„ã‚³ãƒ¼ãƒ‰ã‚’åŒæ™‚ã«åˆ‡æ–­ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
          'é»„ã‚³ãƒ¼ãƒ‰ã‚’æŒã£ã¦ã„ãªã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚‚ã“ã‚Œã‚’å®Ÿè¡Œã§ãã‚‹ã€‚',
          '',
       ],
        flags:{  }
      };
    }  
                case 49: {
     return {
        id:49, name:'#49', desc:'',
        display:[
          '#49',...linesForMix,
          'ã‚³ãƒ¼ãƒ‰ã‚’åˆ‡æ–­ã™ã‚‹ãŸã‚ã«ã€åˆ‡æ–­ã—ãŸã„æ•°å­—ã®æšæ•°åˆ†ã®é…¸ç´ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1äººã«æ¸¡ã•ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
          'é…¸ç´ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¸¡ã™ã®ã¯åˆ‡æ–­ã‚’è¡Œã†ç›¸æ‰‹ã˜ã‚ƒãªãã¦ã‚ˆã„ã€‚',
          'åˆ‡æ–­ãŒè¡Œãˆãªã„å ´åˆã€èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’1é€²ã‚ã‚‹ã€‚',
          'æ°´ä¸­ã«ã„ã‚‹ãŸã‚æ„æ€ç–é€šã¯é›£ã—ã„ã€‚',
       ],
        flags:{  }
      };
    }  
                case 50: {
     return {
        id:50, name:'#50', desc:'',
        display:[
          '#50',...linesForMix,
          'åˆ‡æ–­ã«å¤±æ•—ã—ãŸæ™‚ã€æŒ‡ã—ç¤ºã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã«ã§ã¯ãªãã€ã‚³ãƒ¼ãƒ‰ã®å¤–å´ã«æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç½®ãã€‚',
          '',
          '',
       ],
        flags:{  }
      };
    }  
case 51: {
  return {
    id:51, name:'#51', desc:'',
    display:[
      '#51',
      ...linesForMix,
      'èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’1ã¾ã§é€²ã‚ã‚‹ã€‚',
      'æ‰‹ç•ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã€Œã‚µãƒ¼ã€ã¨ãªã‚‹ã€‚',
      'ã€Œã‚µãƒ¼ã€ã¯æ•°å€¤ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã£ã¦ã€ãã®æ•°å­—ã§åˆ‡æ–­ã‚’è¡Œã†ãƒ—ãƒ¬ã‚¤ãƒ¤ï¼ã‚’æ±ºã‚ã‚‹ã€‚ï¼ˆè‡ªåˆ†ã§ã‚‚å¯ï¼‰',
      'æŒ‡åã•ã‚ŒãŸäººã¯ã€Œã‚µãƒ¼ãƒ»ã‚¤ã‚¨ã‚¹ãƒ»ã‚µãƒ¼ï¼ã€ã¨è¨€ã„ã€åˆ‡æ–­ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ã€‚',
      'åˆ‡æ–­ã‚’è¡Œãˆãªã„å ´åˆã¯èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’1é€²ã‚ã‚‹ã€‚',
      'ã€Œã‚µãƒ¼ã€ã®æ¬¡ã®äººãŒæ¬¡ã®æ‰‹ç•ªã‚’è¡Œã†ã€‚',
    ],
    flags:{}
  };
}
case 52: {
  return {
    id:52, name:'#52', desc:'',
    display:[
      '#52',
      ...linesForMix,
      'æœ€åˆã«å¿…ãšå½ã®æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‚’2æšç½®ãã€‚ï¼ˆæ•°å­—ã‚³ãƒ¼ãƒ‰ã§ã‚‚èµ¤ã‚³ãƒ¼ãƒ‰ã§ã‚‚ã‚ˆã„ã€‚ï¼‰',
      'ã“ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã§ä½¿ã†æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã¯å…¨ã¦å½ã®æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã†ã€‚',
      'é–“é•ãˆã¦æŒ‡ã—ç¤ºã•ã‚ŒãŸå ´åˆã¯å®£è¨€ã•ã‚ŒãŸæ•°å­—ã®æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç½®ãã€‚',
    ],
    flags:{}
  };
}
case 53: {
  return {
    id:53, name:'#53', desc:'',
    display:[
      '#53',
      ...linesForMix,
      '',
      'ã‚³ãƒ¼ãƒ‰ã®åˆ‡æ–­ã«æˆåŠŸã—ãŸï¼š+1',
      'ãƒŠãƒãŒã„ã‚‹ã‚¹ãƒšãƒ¼ã‚¹ã®æ•°å­—ã®ã‚³ãƒ¼ãƒ‰ã®åˆ‡æ–­ã«æˆåŠŸã—ãŸï¼š-1',
      'ã‚³ãƒ¼ãƒ‰ã®åˆ‡æ–­ã«å¤±æ•—ã—ãŸï¼š-2',
      'ãƒŠãƒãŒã‚¹ãƒšãƒ¼ã‚¹12ã«åˆ°é”ã—ãŸå ´åˆã€ãƒ‰ã‚«ãƒ¼ãƒ³ï¼',
    ],
    flags:{}
  };
}
case 54: {
  return {
    id:54, name:'#54', desc:'',
    display:[
      '#54',
      ...linesForMix,
      'æœ€åˆã«æŒ‡å®šã®æ•°ã®é…¸ç´ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é…ã‚Šã€æ®‹ã‚Šã®é…¸ç´ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒªã‚¶ãƒ¼ãƒ–ã«ç½®ãã€‚',
      'ã‚³ãƒ¼ãƒ‰ã‚’åˆ‡æ–­ã™ã‚‹æ™‚ã¯æŒ‡å®šã®æ•°ã®é…¸ç´ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒªã‚¶ãƒ¼ãƒ–ã¸æ”¯æ‰•ã‚ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
      'åˆ‡æ–­ã§ããªã„å ´åˆã¯èµ·çˆ†ãƒˆãƒ¼ã‚¯ãƒ³ãŒ1é€²ã‚€ã€‚',
      'ç¢ºå®šãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç½®ããŸã³ã«å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯é…¸ç´ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’1ã¤å¾—ã‚‹ã€‚',
    ],
    flags:{}
  };
}
case 55: {
  return {
    id:55, name:'#55', desc:'',
    display:[
      '#55',
      ...linesForMix,
      'èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’1ã¾ã§é€²ã‚ã‚‹ã€‚',
      'äººæ•°åˆ†ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç½®ãã€‚',
      'ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰ã‚’é”æˆã™ã‚‹ãŸã³ã«èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’1ã¤å¾Œé€€ã•ã›ã‚‹ã€‚',
    ],
    flags:{}
  };
}
case 56: {
  return {
    id:56, name:'#56', desc:'',
    display:[
      '#56',
      ...linesForMix,
      'æ‰‹æœ­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã§1æšã¨ã‚Šã€ã‚³ãƒ¼ãƒ‰ã®å³å´ã«è£å‘ãã§è¨­ç½®ã™ã‚‹ã€‚',
      'ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½¿ã‚ãšã«è‡ªåˆ†ã§åˆ‡æ–­ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
      'ãƒãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆã®å³å´ã®ã‚³ãƒ¼ãƒ‰ã‚’åˆ‡æ–­ã—ã¦ã—ã¾ã£ãŸå ´åˆã€èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ãŒ1ã¤é€²ã‚€ã€‚',
    ],
    flags:{ m20_rightmostX:true }
  };
}
case 57: {
  return {
    id:57, name:'#57', desc:'',
    display:[
      '#57',
      ...linesForMix,
      'ç¢ºå®šãƒˆãƒ¼ã‚¯ãƒ³ãŒç½®ã‹ã‚Œã‚‹ãŸã³ã«ã€ãã®æ•°å€¤ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ã‚’ãƒœãƒ¼ãƒ‰ä¸Šã«ç½®ãã€‚',
      'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã“ã®åˆ¶ç´„ã‚’å®ˆã‚‰ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
      'æ—¢ã«åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã¯ãã®ä¸Šã«é‡ã­ã¦ç½®ãã€æ–°ãŸãª1æšã ã‘ãŒç™ºå‹•ã™ã‚‹ã€‚',
    ],
    flags:{}
  };
}
case 58: {
  return {
    id:58, name:'#58', desc:'',
    display:[
      '#58',
      ...linesForMix,
      'ã“ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã§ã¯æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã‚ãªã„ã€‚',
      'åˆ‡æ–­ã«å¤±æ•—ã—ãŸå ´åˆä½•ã‚‚æƒ…å ±ã¯å¾—ã‚‰ã‚Œãªã„ã€‚',
      'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯æ‰‹ç•ªã”ã¨ã«ãƒ•ãƒ„ãƒ¼ãƒæ¢çŸ¥æ©ŸãŒä½¿ç”¨ã§ãã‚‹ã€‚',
    ],
    flags:{}
  };
}
case 59: {
  return {
    id:59, name:'#59', desc:'',
    display:[
      '#59',
      ...linesForMix,
      'æ•°å€¤ã‚«ãƒ¼ãƒ‰12æšã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸¦ã¹ã¦ã€7ã®ä½ç½®ã«12ã®æ–¹å‘ã‚’å‘ãã‚ˆã†ã«ãƒŠãƒã‚’é…ç½®ã™ã‚‹ã€‚',
      'â¶ãƒŠãƒã‚’å‹•ã‹ã•ãªã„ã‹ã€ä¸€ã¤å‰æ–¹ã«ç§»å‹•ã•ã›ã‚‹ã“ã¨ãŒã§ãã€ãƒŠãƒãŒç½®ã„ã¦ã‚ã‚‹ã‚«ãƒ¼ãƒ‰ã®æ•°å­—ã‚’å®£è¨€ã—ã¦åˆ‡æ–­ã§ãã‚‹ã€‚',
      'â·ãã®å¾Œã€ãƒŠãƒã‚’å³å‘ãã«ã™ã‚‹ã‹å·¦å‘ãã«ã™ã‚‹ã‹è‡ªç”±ã«æ±ºã‚ã‚‹ã€‚',
      'é¸æŠã§ãã‚‹æ•°å€¤ãŒãªã„å ´åˆã¯ã€ãƒŠãƒã‚’åè»¢ã•ã›ã¦ã‹ã‚‰èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’1é€²ã‚ã‚‹ã€‚ãã®å¾Œã€é¸æŠã§ãã‚‹å ´åˆã¯åˆ‡æ–­ã‚’è¡Œã†ã€‚',
      'ã€Œã„ã¤ã§ã‚‚ã‚³ãƒ¼ãƒ’ãƒ¼ã€ã¯æ‰‹ç•ªå…¨ä½“ã‚’é£›ã°ã™ã€‚',
    ],
    flags:{}
  };
}
case 60: {
  return {
    id:60, name:'#60', desc:'',
    display:[
      '#60',
      ...linesForMix,
      'èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’1ã¾ã§é€²ã‚ã‚‹ã€‚',
      'äººæ•°åˆ†ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç½®ãã€‚',
      'ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚«ãƒ¼ãƒ‰ã‚’é”æˆã™ã‚‹ãŸã³ã«èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’1ã¤å¾Œé€€ã•ã›ã‚‹ã€‚',
    ],
    flags:{}
  };
}
case 61: {
  return {
    id:61, name:'#61', desc:'',
    display:[
      '#61',
      ...linesForMix,
      'å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯è‡ªåˆ†ã®åˆ¶ç´„ã‚’å®ˆã‚‰ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
      'åˆ¶ç´„ã‚’å®ˆã‚Œãªã„å ´åˆã¯æ‰‹ç•ªã‚’é£›ã°ã™ã€‚',
      'å…¨å“¡ãŒåˆ¶ç´„ã‚’å®ˆã‚Œãšã«1ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†ã—ãŸå ´åˆã€çˆ†å¼¾ã¯çˆ†ç™ºã™ã‚‹ã€‚',
      'éšŠé•·ã®æ‰‹ç•ªã®æœ€åˆã«ç›¸è«‡ã—ã¦å…¨å“¡ä¸€æ–‰ã«åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ã‚’å³ã‹å·¦ã«æ¸¡ã›ã‚‹ã€‚',
      'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã„ã¤ã§ã‚‚åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ã‚’å±±æœ­ã®åˆ¶ç´„ã‚«ãƒ¼ãƒ‰ã¨äº¤æ›ã§ãã‚‹ã€‚',
      'ãã®éš›ã«èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’1ã¤é€²ã‚ã‚‹ã€‚',
    ],
    flags:{}
  };
}
case 62: {
  return {
    id:62, name:'#62', desc:'',
    display:[
      '#62',
      ...linesForMix,
      'æ•°å€¤ã‚«ãƒ¼ãƒ‰ã‚’äººæ•°åˆ†ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¸¦ã¹ã‚‹ã€‚',
      'è¦‹ãˆã¦ã„ã‚‹æ•°å€¤ã‚«ãƒ¼ãƒ‰ã®ã†ã¡1æšã®ã‚³ãƒ¼ãƒ‰ã‚’4æœ¬åˆ‡æ–­ã™ã‚‹ãŸã³ã«ã€èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’1ã¤å¾Œé€€ã•ã›ã‚‹ã€‚',
    ],
    flags:{}
  };
}
case 63: {
  return {
    id:63, name:'#63', desc:'',
    display:[
      '#63',
      ...linesForMix,
      'éšŠé•·ã¯ç‰¹å®šã®æšæ•°ã®é…¸ç´ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ‰‹å…ƒã«ç½®ãã€‚',
      'åˆ‡æ–­ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯åˆ‡æ–­ã—ãŸã„ã‚³ãƒ¼ãƒ‰ã®æ•°å€¤ã®åˆ†ã ã‘ãƒªã‚¶ãƒ¼ãƒ–ã«æ”¯æ‰•ã‚ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
      'æ‰‹ç•ªçµ‚äº†å¾Œã€æŒã£ã¦ã„ã‚‹å…¨ã¦ã®é…¸ç´ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¬¡ã®æ‰‹ç•ªã®äººã«æ¸¡ã™ã€‚',
      'éšŠé•·ã®æ‰‹ç•ªã®æœ€åˆã«ãƒªã‚¶ãƒ¼ãƒ–ã‹ã‚‰å…¨ã¦ã®é…¸ç´ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å›åã™ã‚‹ã€‚',
      'åˆ‡æ–­ãŒã§ããªã„å ´åˆã¯èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’1é€²ã‚ã‚‹ã€‚',
      'æ°´ä¸­ã«ã„ã‚‹ãŸã‚æ„æ€ç–é€šã¯é›£ã—ã„ã¯ãšã ã€‚',
    ],
    flags:{}
  };
}
case 64: {
  return {
    id:64, name:'#64', desc:'',
    display:[
      '#64',
      ...linesForMix,
      'å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã§2æšã‚’æŠœãã€æ•°å­—ã®å°ã•ã„æ–¹ã‚’å·¦å´ã«ç½®ãã€å¤§ãã„æ–¹ã‚’å³å´ã«ç½®ãã€‚',
      'ã“ã®ã‚«ãƒ¼ãƒ‰ã¯ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½¿ã‚ãšã«è‡ªåˆ†ã§åˆ‡æ–­ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
      'ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã“ã‚Œã‚‰ã®ã‚³ãƒ¼ãƒ‰ã‚’åˆ‡æ–­ã—ãŸå ´åˆã€èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’1ã¤é€²ã‚ã‚‹ã€‚',
    ],
    flags:{}
  };
}
case 65: {
  return {
    id:65, name:'#65', desc:'',
    display:[
      '#65',
      ...linesForMix,
      'æ•°å€¤ã‚«ãƒ¼ãƒ‰ã‚’å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é…å¸ƒã™ã‚‹ã€‚',
      'å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯è‡ªåˆ†ã®æ•°å€¤ã‚«ãƒ¼ãƒ‰ã«ã‚ã‚‹æ•°å­—ã®ã‚³ãƒ¼ãƒ‰ã‚’åˆ‡æ–­ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚',
      'æ‰‹ç•ªçµ‚äº†å¾Œã€1æšé¸ã‚“ã§æ¬¡ã®æ‰‹ç•ªã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æ¸¡ã™ã€‚',
      '4æœ¬åˆ‡æ–­ã•ã‚Œã¦ã„ã‚‹æ•°å€¤ã‚«ãƒ¼ãƒ‰ã¯è£å‘ãã«ã™ã‚‹ã€‚',
      'è£å‘ãã®ã‚«ãƒ¼ãƒ‰ã‚’æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æ¸¡ã—ã¦ã‚‚ã‚ˆã„ã€‚',
      'åˆ‡æ–­ã§ããªã„å ´åˆã¯èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’1é€²ã‚ã‚‹ã€‚',
    ],
    flags:{}
  };
}
case 66: {
  return {
    id:66, name:'#66', desc:'',
    display:[
      '#66',
      ...linesForMix,
      '',
      '',
    ],
    flags:{}
  };
}
        
      
    default:  { return {id, name:`#${id}`, desc:'', display:[`#${id}`, ...linesForMix]}; }
  }
}


// ç”»é¢ã‚¿ãƒƒãƒ—ã§å„ç¨®ãƒãƒƒãƒ—ã¯å¤–å´ã‚¿ãƒƒãƒ—ã§æ¶ˆãˆã‚‹
 document.addEventListener('click',(e)=>{ if(!miniPop.contains(e.target)) H(miniPop,true); }, true);
</script>
</body>
</html>